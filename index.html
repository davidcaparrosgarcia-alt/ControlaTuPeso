<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF--8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ControlaTuPeso+ v2.1</title>

  <!-- PWA y Metadatos -->
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="iconos/favicon.ico" type="image/x-icon">
  <link rel="apple-touch-icon" href="iconos/icono-192.png">
  <meta name="theme-color" content="#1f2937">

  <!-- Librerías Externas (CDNs) -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            gray: {
              600: '#4b5563',
              700: '#374151',
              800: '#1f2937',
              900: '#111827',
            }
          },
          fontFamily: {
            sans: ['Inter', 'sans-serif'],
            handwriting: ['Caveat', 'cursive']
          }
        }
      }
    }
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  
  <!-- Fuentes de Google -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@500&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  
  <!-- Estilos y Script de Errores -->
  <style>
    body { font-family: 'Inter', sans-serif; }
    .elevated-border{border:2px solid rgba(107,114,128,.8)}
    .dark .elevated-border{border-color:rgba(75,85,99,.9)}
    .btn-ghost{border:2px solid rgba(156,163,175,.8)}
    .calendar-cell{border:2px solid rgba(156,163,175,.8)}
    .dark .calendar-cell{border-color:rgba(75,85,99,.9)}
    .tooltip{position:absolute; left:50%; transform:translateX(-50%); bottom:calc(100% + .5rem); background:#111827; color:#fff; padding:.75rem; font-size:.8rem; border-radius:.5rem; box-shadow:0 10px 15px -3px rgb(0 0 0 / 0.1); display:none; width:280px; max-width:90vw; z-index: 60; text-align:left;}
    .tooltip-wrap:hover .tooltip{display:block}
@media (max-width: 767px) {
      html {
        -webkit-text-size-adjust: 100%;
        text-size-adjust: 100%;
        /* Cambiamos el valor a 80% para una reducción mayor */
        font-size: 60%;
      }
    }
 .splash { 
        position: fixed; 
        inset: 0; 
        z-index: 9999; 
        background-color: #000; 
        transition: opacity 0.5s ease-out, visibility 0.5s ease-out; 
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .splash-video { width: 100%; height: 100%; object-fit: contain; }
    .splash-hidden { opacity: 0; visibility: hidden; }
  </style>
  <script>
    window.onerror = function(msg, src, line, col, err){
      console.error('WINDOW ONERROR:', { msg, src, line, col, err });
      const root = document.getElementById('root');
      if(root){
        root.innerHTML = '<div style="padding:16px;font-family:sans-serif;color:#b91c1c;background:#fee2e2;border:2px solid #ef4444;border-radius:12px">'+
          '<h3>Se ha producido un error en la app</h3>'+
          '<div><b>Mensaje:</b> '+String(msg)+'</div>'+
          '<div><b>Archivo:</b> '+String(src)+'  <b>Línea:</b> '+String(line)+':'+String(col)+'</div>'+
          '<pre style="white-space:pre-wrap;margin-top:8px">'+(err && err.stack ? err.stack : '')+'</pre>'+
          '<div style="margin-top:8px;font-size:12px;color:#111">Sugerencia: asegúrate de estar conectado a Internet para cargar las librerías. Revisa la Consola (F12) para más detalles.</div>'+
        '</div>';
      }
    };
  </script>
</head>
<body class="bg-gray-50 dark:bg-gray-800">

  <div id="animated-splash" class="splash">
    <video autoplay muted playsinline id="splash-video" class="splash-video">
      <source src="videos/intro.webm" type="video/webm">
      <source src="videos/intro.mp4" type="video/mp4">
      Tu navegador no soporta vídeos.
    </video>
  </div>

  <div id="root"></div>
  
  <!-- Contenedor oculto para renderizar los gráficos para el PDF -->
  <div id="pdf-charts-container" style="position: fixed; left: -9999px; top: -9999px; width: 800px; height: 1200px;"></div>

  <script type="text/babel" data-presets="env,react">
    // ====================== Constantes y Utilidades ======================
    const USERS_KEY = 'health_tracker_users';
    const CURRENT_KEY = 'health_tracker_current';
    const THEME_KEY = 'health_tracker_theme';
    const SCENARIO_KEY = 'health_tracker_scenario';
    const MASTER_PIN = '0987';

    const EXERCISE_TIME = [ {value:'0min', label:'Sin ejercicio'}, {value:'30min', label:'30m'}, {value:'1h', label:'1h'}, {value:'1h30', label:'1.5h'}, {value:'2h', label:'2h'}, {value:'+2h', label:'+2h'} ];
    const EXERCISE_TYPE = [ {value:'fuerza', label:'Fuerza'}, {value:'anaerobico', label:'Anaeróbico'} ];
    const SLEEP = [ {value:'<6h', label:'Menos de 6h'}, {value:'6h', label:'6 horas'}, {value:'7h', label:'7 horas'}, {value:'8h', label:'8 horas'}, {value:'+8h', label:'Más de 8h'}, ];
    const FASTING = [ {value:'0h', label:'Sin ayuno'}, {value:'12h', label:'12/12'}, {value:'14h', label:'14/10'}, {value:'16h', label:'16/8'}, {value:'20h', label:'20/4'}, {value:'24h', label:'24 horas'}, ];
    const DIET = [ {value:'estricta', label:'Estricta'}, {value:'correcta', label:'Correcta'}, {value:'incorrecta', label:'Incorrecta'}, {value:'mala', label:'Autodestrucción'}, ];
    const WATER = [ {value:'0.5L', label:'0,5 L'}, {value:'1L', label:'1 L'}, {value:'1.5L', label:'1,5 L'}, {value:'2L', label:'2 L'}, {value:'+2L', label:'Más de 2 L'}, ];
    const WEEKDAYS = ['domingo', 'lunes', 'martes', 'miércoles', 'jueves', 'viernes', 'sábado'];


    const fmt = (d) => { const y = d.getFullYear(), m = String(d.getMonth() + 1).padStart(2, '0'), day = String(d.getDate()).padStart(2, '0'); return `${y}-${m}-${day}`; };
    const sleepHours = c => c === '<6h' ? 5.5 : c === '+8h' ? 9 : parseFloat((c || '7h').replace('h', '')) || 7;
    const exerciseHours = c => c === '0min' ? 0 : c === '30min' ? 0.5 : c === '1h' ? 1 : c === '1h30' ? 1.5 : c === '2h' ? 2 : c === '+2h' ? 2.5 : 0;
    const waterLiters = c => c === '+2L' ? 2.5 : parseFloat((c || '1.5L').replace('L', '').replace(',', '.')) || 1.5;
    const humanizeDays = (n) => {
      if (!isFinite(n) || n < 0) return '—'; if (n < 1) return '¡Hoy!'; const days = Math.round(n); if (days < 30) return `${days} día${days > 1 ? 's' : ''}`; const months = Math.floor(days / 30); const remDays = days % 30; if (remDays === 0) return `${months} ${months === 1 ? 'mes' : 'meses'}`; return `${months} ${months === 1 ? 'mes' : 'meses'} y ${remDays} día${remDays > 1 ? 's' : ''}`;
    };

    // ====================== Lógica de Proyección (Sin cambios) ======================
    function calculateProjectionScenarios(user) {
      const MS_DAY = 86400000;
      const windowDays = 7, alpha = 0.12, changeLimit = 0.20;
      const MAX_WEEKLY_LOSS_FRAC = 0.0125, MIN_WEEKLY_LOSS_FRAC = 0.005;
      const SCENARIO_80  = { optimista: -0.10, neutro: 0.00, pesimista: +0.10 };
      const SCENARIO_100 = { optimista: -0.20, neutro: 0.00, pesimista: +0.20 };

      const entries = (user.entries || []).filter(e => e && e.weight != null && e.date).sort((a, b) => new Date(a.date) - new Date(b.date));
      if (entries.length < 3) return { message: 'Se necesitan más registros para una proyección fiable.' };

      const today = entries[entries.length - 1], prev  = entries[entries.length - 2];
      const { startWeight: W_ini, targetWeight: W_obj } = user.profile || {};
      const W_today = today.weight, total_goal_loss = (W_ini - W_obj);

      if (!isFinite(total_goal_loss) || total_goal_loss <= 0) return { message: 'Objetivo o peso inicial inválidos.' };
      
      const remaining_final = Math.max(0, W_today - W_obj);
      if (remaining_final <= 0) return { results: { optimista: { daysTo80: 0, eta80: new Date(), daysToFinal: 0, etaFinal: new Date() }, neutro: { daysTo80: 0, eta80: new Date(), daysToFinal: 0, etaFinal: new Date() }, pesimista: { daysTo80: 0, eta80: new Date(), daysToFinal: 0, etaFinal: new Date() } }, message: '¡Objetivo alcanzado!' };

      const lastWindow = entries.slice(Math.max(0, entries.length - windowDays));
      let sumDays = 0, sumLoss = 0;
      for (let i = 0; i < lastWindow.length - 1; i++) {
        const d0 = new Date(lastWindow[i].date), d1 = new Date(lastWindow[i+1].date);
        const days = (d1 - d0) / MS_DAY;
        if (days > 0) { sumDays += days; sumLoss += (lastWindow[i].weight - lastWindow[i+1].weight); }
      }
      const avgLossPerDay = (sumDays > 0) ? (sumLoss / sumDays) : ((prev.weight - W_today) / Math.max(1, (new Date(today.date) - new Date(prev.date)) / MS_DAY));
      const r_prev = prev.r_est || avgLossPerDay;
      let r_est = alpha * avgLossPerDay + (1 - alpha) * r_prev;
      r_est = Math.max(r_prev * (1 - changeLimit), Math.min(r_prev * (1 + changeLimit), r_est));

      const B = { activity:1.0, diet:1.0, sleep:1.0, water:1.0 };
      const ex = typeof today.exerciseTime !== 'undefined' ? exerciseHours(today.exerciseTime) : 0;
      if (ex >= 1) B.activity = 1.05; else if (ex < 0.5) B.activity = 0.97;
      const d = (today.diet || '').toString().toLowerCase();
      if (d.includes('estrict')) B.diet = 1.10; else if (d.includes('correct')) B.diet = 1.00; else if (d.includes('incorrect')) B.diet = 0.90; else if (d.includes('mala') || d.includes('autodestruccion')) B.diet = 0.80;
      const sl = typeof today.sleep !== 'undefined' ? sleepHours(today.sleep) : 7;
      if (sl >= 8) B.sleep = 1.02; else if (sl < 7) B.sleep = 0.97;
      const w = typeof today.water !== 'undefined' ? waterLiters(today.water) : 1.5;
      if (w >= 2.0) B.water = 1.02; else if (w < 1.5) B.water = 0.98;
      let r_est_mod = r_est * B.activity * B.diet * B.sleep * B.water;

      const maxDaily = (W_today * MAX_WEEKLY_LOSS_FRAC) / 7, minDaily = (W_today * MIN_WEEKLY_LOSS_FRAC) / 7;
      if (r_est_mod > maxDaily) r_est_mod = maxDaily;
      if (r_est_mod <= 0 && avgLossPerDay > 0) r_est_mod = Math.max(minDaily, avgLossPerDay * 0.5);
      if (!(r_est_mod > 0)) return { message: 'Ritmo nulo o negativo. Revisa hábitos.' };

      const target80 = W_ini - 0.8 * total_goal_loss;
      const remaining80 = Math.max(0, W_today - target80), remaining20 = Math.max(0, target80 - W_obj);
      const days80_neutral  = remaining80 / r_est_mod, days20_neutral  = remaining20 / r_est_mod;

      const applyScenario = (days80, days20, scenarioName) => {
        const d80  = remaining80 > 0 ? days80 * (1 + SCENARIO_80[scenarioName]) : 0;
        const d100 = (remaining20 > 0 ? days20 * (1 + SCENARIO_100[scenarioName]) : 0) + d80;
        return { daysTo80: d80, eta80: new Date(Date.now() + d80 * MS_DAY), daysToFinal: d100, etaFinal: new Date(Date.now() + d100 * MS_DAY) };
      };
      const results = { optimista: applyScenario(days80_neutral, days20_neutral, 'optimista'), neutro: applyScenario(days80_neutral, days20_neutral, 'neutro'), pesimista: applyScenario(days80_neutral, days20_neutral, 'pesimista') };
      today.r_est = r_est;
      return { results };
    }

    // ====================== Lógica de Feedback (Sin cambios) ======================
    function generateDailyFeedback(user, historyIn = {}) {
      const entries = (user.entries || []).filter(e => e && e.weight != null && e.date).sort((a, b) => new Date(a.date) - new Date(b.date));
      const { startWeight: W_ini, targetWeight: W_obj, name: userName } = user.profile || {};
      if (entries.length < 2 || !isFinite(W_ini) || !isFinite(W_obj)) return { globalMessage: `¡Bienvenido/a, ${userName}! Este es tu panel de progreso.`, actionMessages: ["Registra tu peso diariamente para activar las proyecciones.", "Puedes cambiar entre escenarios (Optimista, Neutro, Pesimista) para ver diferentes proyecciones."], historyOut: historyIn };

      const today = entries[entries.length - 1], yesterday = entries[entries.length - 2];
      const W_today = today.weight, W_prev = yesterday.weight;
      const goal = Math.max(0.0001, W_ini - W_obj), progress = Math.max(0, Math.min(1, (W_ini - W_today) / goal));
      const inFinalPhase = (progress >= 0.80);

      if (progress >= 1.0) return { globalMessage: `¡EXTRAORDINARIO, ${userName}! Has alcanzado tu objetivo. ¡Enhorabuena!`, actionMessages: ["Has demostrado una constancia increíble. ¡Disfruta de tu logro!"], historyOut: historyIn };
      const prev_progress = (W_ini - W_prev) / goal;
      if (progress >= 0.8 && prev_progress < 0.8) return { globalMessage: `¡Felicidades, ${userName}! Ya has superado el 80% de tu objetivo.`, actionMessages: ["Estás en la recta final. ¡Ahora más foco y constancia que nunca!"], historyOut: historyIn };

      const T = inFinalPhase ? Math.max(0.0005 * W_today, 0.05) : Math.max(0.0015 * W_today, 0.15);
      const delta = W_today - W_prev;
      const last7 = entries.slice(Math.max(0, entries.length - 8));
      let r7 = 0;
      if (last7.length >= 2) { const first = last7[0], days = (new Date(today.date) - new Date(first.date)) / 86400000; if (days > 0) r7 = (W_today - first.weight) / days; }
      let dailyClass = 'flat';
      if (delta <= -2 * T) dailyClass = 'loss_strong'; else if (delta <= -T) dailyClass = 'loss_light'; else if (Math.abs(delta) <= T) dailyClass = 'flat'; else if (delta <= 2 * T) dailyClass = 'gain_light'; else dailyClass = 'gain_strong';
      const trendIsGood = (r7 < 0);

      const variants = {
        global: { initial: { loss_strong: ["Muy bien, hoy tu esfuerzo se ha reflejado en la báscula. ¡Sigue así!", "Gran paso adelante. Estás construyendo inercia positiva.", "Excelente avance para esta fase. Mantén tu estrategia.", "Buen trabajo: se nota tu constancia en el resultado de hoy.", "Tu disciplina se nota: ¡paso firme hacia tu objetivo!"], loss_light: ["Buen paso adelante. La constancia está dando resultados.", "Progreso diario correcto: suma y sigue.", "Pequeña bajada hoy, que cuenta para la tendencia.", "Bien: el plan va en la dirección adecuada.", "Buen ajuste: cada día que cumples acerca el objetivo."], flat: ["Peso estable: completamente normal en esta fase. La tendencia semanal manda.", "Día plano: la clave es seguir acumulando días buenos.", "Estabilidad esperable. Mantén hábitos; verás el efecto en la semana.", "Sin cambios hoy; no te distraigas de lo importante: constancia.", "Hoy plano, mañana oportunidad. La media semanal es lo que importa."], gain_light_goodtrend: ["Pequeña subida, pero la tendencia semanal es buena. Mantén el rumbo.", "Ligera subida hoy; tu semana sigue en positivo.", "Fluctuación normal. La tendencia te respalda.", "Un día no define el camino: la semana va bien.", "Subida suave; la inercia general es favorable."], gain_light_badtrend: ["Subida ligera. Ajustar algunos hábitos puede ayudarte a recuperar ritmo.", "Un repunte leve; pon el foco en agua, sueño y calidad de comida.", "Señal suave de ajuste: prioriza comidas simples y movimiento.", "Pequeño repunte: revisa sal, agua y horarios.", "Subida leve; hoy es buen día para volver a lo básico."], gain_strong: ["La báscula subió más de lo habitual. Ajusta hábitos para retomar el ritmo.", "Subida significativa hoy. Recupera la estructura de tus comidas y horarios.", "Día exigente. Centrémonos en agua, descanso y comida real."] }, final: { loss_strong: ["¡Gran avance en un tramo exigente! Cada gramo cuenta ahora.", "Excelente bajada en la recta final. Mantén el foco.", "Avance sólido cuando más cuesta. Enhorabuena.", "Muy buen día en un tramo difícil; sigue así.", "Esto es progreso de calidad: bien por tu constancia."], loss_light: ["Bien hecho: en la fase final, pérdidas pequeñas son victorias.", "Pequeña bajada, muy valiosa en esta etapa.", "Buen progreso para este tramo: conta mucho.", "Bajada discreta pero importante cerca de la meta.", "Cada pequeño descenso marca la diferencia ahora."], flat: ["Estabilidad normal en la recta final. La tendencia y los hábitos mandan.", "Día plano típico en el último tramo. La constancia decide.", "Sin cambios hoy; evita sobre-reaccionar y sigue el plan.", "Plano en fase final es común: paciencia activa.", "La recta final es irregular; mantén tu rutina."], gain_light_goodtrend: ["Ligera subida hoy, pero la tendencia semanal te favorece.", "Pequeño repunte; tu semana sigue bien orientada.", "Subida leve en tramo final: normal si el plan es sólido.", "Fluctuación menor; mantén disciplina y descanso.", "Repunte leve sin romper la inercia positiva."], gain_light_badtrend: ["Subida ligera en un tramo sensible. Refuerza agua, sueño y alimentos simples.", "Repunte en la recta final: cuida sal, horarios y cantidad.", "Señal de ajuste fina: prioriza comida real y buen descanso.", "Pequeña subida que conviene corregir cuanto antes.", "Momento de afinar: hidrátate y vuelve a la base del plan."], gain_strong: ["Subida significativa en la recta final. Reencuadra hábitos hoy.", "Día difícil cerca de la meta; estructura tus comidas y descansa.", "Señal clara de ajuste: vuelve a lo simple y prioriza recuperación."] } },
        explain: { low_sleep: ["Dormiste poco: puede aumentar apetito y retención. Apunta a 7–8 h.", "Pocas horas de sueño; afecta el peso a corto plazo. Prioriza descansar.", "Sueño corto hoy. Dormir mejor facilita la pérdida."], low_water: ["Bebiste poca agua; puede favorecer retención. Objetivo ≥2 L.", "Hidratación escasa. Sube agua para mejorar sensación y progreso.", "Poca agua hoy; hidratarte ayuda a controlar apetito y líquidos."], hard_training: ["Entrenamiento intenso: posible inflamación muscular temporal.", "Sesión fuerte; el peso puede subir por glucógeno. Normal.", "Carga alta hoy. La báscula puede tardar 24–48 h en responder."], salty_foods: ["Comidas saladas/ultraprocesadas elevan retención. Vuelve a comida simple.", "Alta sal/ultraprocesados hoy; suben líquidos. Prioriza fresco.", "Día muy salado. Compensa con agua y verduras."] },
        diet_good: ["Tu alimentación va muy bien, es tu ancla.", "Buena calidad de comidas; eso marca diferencia.", "La estructura de tus comidas está ayudando mucho."], diet_tune: ["Pequeño ajuste: reduce azúcares líquidos o cenas tardías.", "Afina porciones y prioriza proteína y fibra.", "Evita ultraprocesados hoy; centra comida real."], diet_warn: ["La alimentación frenó el progreso: retoma comidas completas.", "Vuelve a la base del plan y evita extras hoy.", "Hoy te alejaste del plan; mañana, vuelta a lo simple."],
        ex_good: ["Excelente actividad; mantenerla sostiene la tendencia.", "Buen movimiento hoy; tu cuerpo lo agradece.", "Suma de pasos/entreno muy positiva."], ex_more: ["Añade 10–20 min de movimiento suave hoy.", "Intenta una caminata extra; suma sin fatigar.", "Un poco más de NEAT puede destrabar la báscula."],
        sleep_good: ["Dormir bien te protege en días planos.", "Buen descanso: mantiene el apetito a raya.", "Sueño adecuado: clave para rendir y recuperar."], sleep_more: ["Prioriza 7–8 h de sueño para apoyar el plan.", "Acuéstate antes para dormir más y mejor.", "Una noche corta se nota: recupera horas hoy."],
        water_good: ["Hidratación correcta: aliada de tu progreso.", "Buen nivel de agua hoy; sigue así.", "Mantener ≥2 L al día te ayuda mucho."], water_more: ["Objetivo ≥2 L hoy: ayuda a reducir retención.", "Lleva una botella encima para facilitarlo.", "Aumenta agua entre comidas para saciedad."],
        trend_good: ["La tendencia semanal es tu aliada: no cambies por un dato aislado.", "Semana en positivo: mantén los básicos.", "La dirección general es buena; sigue el plan."]
      };
      
      const history = { ...historyIn };
      const pickVariant = (key, options) => {
        const lastKey = history.lastPicked?.[key];
        const pool = options.map((t, idx) => ({ t, idx })).filter(item => item.idx !== lastKey);
        const chosen = pool.length ? pool[Math.floor(Math.random() * pool.length)] : { t: options[0], idx: 0 };
        history.lastPicked = history.lastPicked || {}; history.lastPicked[key] = chosen.idx;
        return chosen.t;
      };

      const todayBehaviors = { ex: exerciseHours(today.exerciseTime || 0), sl: sleepHours(today.sleep || 0), w: waterLiters(today.water || 0), d: (today.diet || '').toLowerCase() };
      const gBucket = (() => { const phase = inFinalPhase ? 'final' : 'initial'; switch (dailyClass) { case 'loss_strong': return `global.${phase}.loss_strong`; case 'loss_light': return `global.${phase}.loss_light`; case 'flat': return `global.${phase}.flat`; case 'gain_light': return trendIsGood ? `global.${phase}.gain_light_goodtrend` : `global.${phase}.gain_light_badtrend`; case 'gain_strong': return `global.${phase}.gain_strong`; default: return `global.${phase}.flat`; } })();
      const getByPath = (obj, path) => path.split('.').reduce((o, k) => (o && o[k] != null ? o[k] : null), obj);
      const globalOptions = getByPath(variants, gBucket) || ["Sigue registrando tus datos para recibir recomendaciones."];
      const globalMessage = pickVariant(gBucket, globalOptions);

      const actions = [];
      if (dailyClass === 'flat' || dailyClass.startsWith('gain')) {
        if (todayBehaviors.sl < 6.5) actions.push(pickVariant('explain.low_sleep', variants.explain.low_sleep));
        else if (todayBehaviors.w < 1.5) actions.push(pickVariant('explain.low_water', variants.explain.low_water));
        else if (todayBehaviors.ex >= 1.2) actions.push(pickVariant('explain.hard_training', variants.explain.hard_training));
        else if (todayBehaviors.d.includes('autodestru') || todayBehaviors.d.includes('mala')) actions.push(pickVariant('explain.salty_foods', variants.explain.salty_foods));
      }
      const pushIfRoom = (msg) => { if (msg && actions.length < 2) actions.push(msg); };
      if (todayBehaviors.d.includes('estrict')) pushIfRoom(pickVariant('diet_good', variants.diet_good)); else if (todayBehaviors.d.includes('correct')) pushIfRoom(pickVariant('diet_tune', variants.diet_tune)); else if (todayBehaviors.d.includes('incorrect') || todayBehaviors.d.includes('mala')) pushIfRoom(pickVariant('diet_warn', variants.diet_warn));
      if (actions.length < 2) { if (todayBehaviors.ex >= 1) pushIfRoom(pickVariant('ex_good', variants.ex_good)); else if (todayBehaviors.ex < 0.5) pushIfRoom(pickVariant('ex_more', variants.ex_more)); }
      if (actions.length < 2) { if (todayBehaviors.sl >= 7) pushIfRoom(pickVariant('sleep_good', variants.sleep_good)); else pushIfRoom(pickVariant('sleep_more', variants.sleep_more)); }
      if (actions.length < 2) { if (todayBehaviors.w >= 2) pushIfRoom(pickVariant('water_good', variants.water_good)); else pushIfRoom(pickVariant('water_more', variants.water_more)); }
      if (actions.length < 2 && trendIsGood) pushIfRoom(pickVariant('trend_good', variants.trend_good));

      return { globalMessage, actionMessages: actions, historyOut: history };
    }

    // ====================== Hooks Personalizados (useLocalStorage, useTheme) ======================
    function useLocalStorage(key, initial){
      const [state,setState]=React.useState(()=>{ 
        try {
          const raw=localStorage.getItem(key);
          if (!raw) return initial;
          return JSON.parse(raw);
        } catch(e) {
          console.warn(`Error parsing localStorage key “${key}”:`, e);
          return initial;
        }
      }); 
      React.useEffect(()=>{ 
        try {
          localStorage.setItem(key, JSON.stringify(state)) 
        } catch(e) {
          console.error(`Error saving localStorage key “${key}”:`, e);
        }
      },[key,state]); 
      return [state,setState]; 
    }
    
    function useTheme(){ const [theme,setTheme]=useLocalStorage(THEME_KEY,'light'); React.useEffect(()=>{ document.documentElement.classList.toggle('dark', theme === 'dark') },[theme]); return {theme, toggle:()=>setTheme(t=>t==='light'?'dark':'light')}; }
    
    // ====================== Componentes Base (Card, Button, etc.) ======================
    const Card = ({children, className='', ...props})=> <div className={`bg-white dark:bg-gray-700 rounded-2xl elevated-border shadow-sm p-4 ${className}`} {...props}>{children}</div>;
    const Button = ({children,onClick,type='button',variant='primary',title, className='', disabled=false})=>{ const base='inline-flex items-center justify-center gap-2 rounded-lg transition px-4 py-2 font-semibold disabled:opacity-50 disabled:cursor-not-allowed'; const v = variant==='primary'?'bg-blue-600 text-white hover:bg-blue-700' : variant==='secondary'?'bg-gray-100 text-gray-800 hover:bg-gray-200 dark:bg-gray-600 dark:text-gray-100 dark:hover:bg-gray-500' : variant==='danger'?'bg-red-600 text-white hover:bg-red-700':'btn-ghost bg-white hover:bg-gray-50 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-100'; return <button type={type} onClick={onClick} className={`${base} ${v} ${className}`} title={title} disabled={disabled}>{children}</button>; };
    const Input = ({label, containerClassName='', ...props})=>( <div className={`space-y-1 ${containerClassName}`}>{label && <label className="text-sm font-medium text-gray-700 dark:text-gray-300">{label}</label>}<input {...props} className={`w-full px-3 py-2 rounded-lg border-2 border-gray-400 focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-800 dark:text-white dark:border-gray-500 ${props.className||''}`}/></div> );
    const Select = ({label, options=[], value, onChange, containerClassName=''})=> ( <div className={`space-y-1 ${containerClassName}`}>{label && <label className="text-sm font-medium text-gray-700 dark:text-gray-300">{label}</label>}<select value={value??''} onChange={onChange} className="w-full px-3 py-2 rounded-lg border-2 border-gray-400 focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-800 dark:text-white dark:border-gray-500">{options.map(o=> <option key={o.value} value={o.value}>{o.label}</option>)}</select></div> );
    const Modal = ({open,onClose,children,size='md', customHeader})=>{ if(!open) return null; const w = size==='lg'?'max-w-4xl':size==='md'?'max-w-2xl':'max-w-lg'; return (<div className="fixed inset-0 z-50 bg-black/60 flex items-center justify-center p-4"><div className={`w-full ${w} max-h-[90vh] overflow-y-auto bg-white dark:bg-gray-700 rounded-2xl elevated-border shadow-lg flex flex-col`}>{customHeader}{children}</div></div>); };

    {/* ====================== Iconos SVG (CORREGIDOS Y COMPLETOS v2.2) ====================== */}
    const SunIcon = ({ className }) => ( <svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" className={className}> <path fillRule="evenodd" fill="#fcc667" d="M43.88,54.57l1.25,2.18a1,1,0,0,0,1.74-1l-1.26-2.18a1,1,0,0,0-1.37-.36A1,1,0,0,0,43.88,54.57Z"/> <path fillRule="evenodd" fill="#fcc667" d="M18.39,53.57l-1.26,2.18a1,1,0,0,0,1.74,1l1.25-2.18a1,1,0,0,0-.36-1.36A1,1,0,0,0,18.39,53.57Z"/> <path fillRule="evenodd" fill="#fcc667" d="M6.51,31H4a1,1,0,0,0,0,2H6.51a1,1,0,0,0,0-2Z"/> <path fillRule="evenodd" fill="#fcc667" d="M57.49,33H60a1,1,0,0,0,0-2H57.49a1,1,0,0,0,0,2Z"/> <path fillRule="evenodd" fill="#fcc667" d="M20.12,9.43,18.87,7.25a1,1,0,0,0-1.74,1l1.26,2.18a1,1,0,0,0,1.37.36A1,1,0,0,0,20.12,9.43Z"/> <path fillRule="evenodd" fill="#fcc667" d="M45.61,10.43l1.26-2.18a1,1,0,0,0-1.74-1L43.88,9.43a1,1,0,0,0,.36,1.36A1,1,0,0,0,45.61,10.43Z"/> <path fill="#fcc667" d="M31.71,4.23,29.08,15.74a2.19,2.19,0,0,1-3.61,1.12l-3.42-3a.46.46,0,0,0-.75.43l.85,4.45a2.58,2.58,0,0,1-.73,2.14,2.24,2.24,0,0,1-2,.42L8.1,17.86a.3.3,0,0,0-.29.51l8.65,8a2.42,2.42,0,0,1,.61,2.15,2.39,2.39,0,0,1-1.45,1.53l-4.27,1.49a.45.45,0,0,0,0,.86l4.27,1.48a2.63,2.63,0,0,1,1.5,1.72,2.27,2.27,0,0,1-.66,2l-8.65,8a.3.3,0,0,0,.29.51l11.28-3.49a2.46,2.46,0,0,1,2.17.55,2.4,2.4,0,0,1,.6,2l-.85,4.45a.46.46,0,0,0,.75.43l3.42-3a2.64,2.64,0,0,1,2.23-.44,2.25,2.25,0,0,1,1.38,1.56l2.63,11.51a.3.3,0,0,0,.58,0l2.63-11.51a2.19,2.19,0,0,1,3.61-1.12l3.42,3a.46.46,0,0,0,.75-.43l-.85-4.45a2.61,2.61,0,0,1,.73-2.15,2.27,2.27,0,0,1,2-.42L55.9,46.14a.3.3,0,0,0,.29-.51l-8.65-8a2.2,2.2,0,0,1,.84-3.69l4.27-1.48a.45.45,0,0,0,0-.86l-4.27-1.49a2.62,2.62,0,0,1-1.5-1.71,2.27,2.27,0,0,1,.66-2l8.65-8a.3.3,0,0,0-.29-.51L44.62,21.34a2.19,2.19,0,0,1-2.77-2.56l.85-4.45A.46.46,0,0,0,42,13.9l-3.42,3a2.61,2.61,0,0,1-2.23.43,2.21,2.21,0,0,1-1.38-1.55L32.29,4.23A.3.3,0,0,0,31.71,4.23Z"/> <path fill="#fbae36" d="M43.07,32A11.07,11.07,0,1,1,32,20.93,11.07,11.07,0,0,1,43.07,32Z"/> <g> <path fill="#fa8e1b" d="M32,44.07A12.07,12.07,0,1,1,44.07,32,12.09,12.09,0,0,1,32,44.07Zm0-22.14A10.07,10.07,0,1,0,42.07,32,10.08,10.08,0,0,0,32,21.93Z"/> </g> </svg> );
    const MoonIcon = ({ ...props }) => ( <svg xmlns="http://www.w3.org/2000/svg" version="1.1" viewBox="0 0 1024 1024" {...props} className="w-6 h-6"> <g><path style={{opacity:1}} fill="#fefefe" d="M -0.5,-0.5 C 340.833,-0.5 682.167,-0.5 1023.5,-0.5C 1023.5,340.833 1023.5,682.167 1023.5,1023.5C 682.167,1023.5 340.833,1023.5 -0.5,1023.5C -0.5,682.167 -0.5,340.833 -0.5,-0.5 Z"/></g> <g><path style={{opacity:1}} fill="#7d909c" d="M 511.5,140.5 C 522.34,139.176 533.34,139.176 544.5,140.5C 544.376,141.107 544.043,141.44 543.5,141.5C 533.013,140.506 522.346,140.172 511.5,140.5 Z"/></g> <g><path style={{opacity:1}} fill="#425660" d="M 497.5,141.5 C 491.712,142.81 485.712,143.477 479.5,143.5C 485.274,142.054 491.274,141.388 497.5,141.5 Z"/></g> <g><path style={{opacity:1}} fill="#012c49" d="M 511.5,140.5 C 522.346,140.172 533.013,140.506 543.5,141.5C 512.083,151.909 482.75,166.409 455.5,185C 448.951,190.097 442.285,194.93 435.5,199.5C 431.324,199.168 427.824,200.502 425,203.5C 424.667,203.167 424.333,202.833 424,202.5C 422.667,205.167 421.333,207.833 420,210.5C 416.766,213.015 413.433,215.349 410,217.5C 409.316,218.784 409.483,219.951 410.5,221C 409.244,221.417 408.577,222.25 408.5,223.5C 340.481,292.956 308.648,376.622 313,474.5C 320.859,576.743 366.026,657.909 448.5,718C 488.561,745.523 532.228,765.857 579.5,779C 584.827,779.943 590.16,780.777 595.5,781.5C 601.911,783.344 608.578,784.344 615.5,784.5C 663.104,787.478 709.104,780.312 753.5,763C 780.12,751.857 805.454,738.357 829.5,722.5C 830.391,721.89 831.391,721.557 832.5,721.5C 833.492,721.328 834.158,721.662 834.5,722.5C 797.065,777.097 748.398,818.597 688.5,847C 603.984,885.649 516.651,892.982 426.5,869C 370.022,852.115 320.355,823.948 277.5,784.5C 278.329,782.067 277.829,779.733 276,777.5C 272.966,776.399 270.133,774.899 267.5,773C 267.957,772.586 268.291,772.086 268.5,771.5C 266.076,769.697 264.409,767.363 263.5,764.5C 260.489,761.988 257.656,759.322 255,756.5C 253.334,757.34 253.167,756.84 254.5,755C 252.431,752.466 249.765,751.299 246.5,751.5C 243.899,748.396 241.066,745.396 238,742.5C 231.303,732.984 224.47,723.651 217.5,714.5C 173.96,644.685 154.294,568.351 158.5,485.5C 160.311,475.685 161.644,465.685 162.5,455.5C 162.5,454.167 162.5,452.833 162.5,451.5C 164.311,449.615 165.478,447.281 166,444.5C 166.499,440.848 166.665,437.182 166.5,433.5C 176.952,382.278 197.452,335.611 228,293.5C 235.322,283.683 243.155,274.35 251.5,265.5C 253.482,265.005 255.482,264.505 257.5,264C 258.851,262.383 260.518,261.216 262.5,260.5C 265.103,256.598 267.603,252.598 270,248.5C 270.741,247.359 271.575,247.359 272.5,248.5C 273.551,247.115 274.884,246.115 276.5,245.5C 277.795,243.672 278.795,241.672 279.5,239.5C 282.213,238.086 284.88,236.753 287.5,235.5C 287.281,234.325 287.614,233.325 288.5,232.5C 291.53,231.568 294.363,230.235 297,228.5C 297.348,225.042 298.848,222.209 301.5,220C 305.188,220.47 307.854,218.804 309.5,215C 309.167,214.667 308.833,214.333 308.5,214C 310.167,213.667 311.833,213.333 313.5,213C 314.223,210.982 315.223,209.148 316.5,207.5C 358.398,177.56 404.732,157.394 455.5,147C 463.366,145.078 471.366,143.912 479.5,143.5C 485.712,143.477 491.712,142.81 497.5,141.5C 502.07,140.559 506.737,140.226 511.5,140.5 Z"/></g> <g><path style={{opacity:1}} fill="#435c6c" d="M 718.5,169.5 C 717.71,168.391 717.21,167.058 717,165.5C 716.667,159.167 716.333,152.833 716,146.5C 715.825,151.019 715.325,155.353 714.5,159.5C 714.5,154.833 714.5,150.167 714.5,145.5C 715.5,145.5 716.5,145.5 717.5,145.5C 717.442,153.521 717.776,161.521 718.5,169.5 Z"/></g> <g><path style={{opacity:1}} fill="#4f6778" d="M 714.5,162.5 C 714.679,168.404 714.012,174.071 712.5,179.5C 712.596,173.627 713.263,167.96 714.5,162.5 Z"/></g> <g><path style={{opacity:1}} fill="#113047" d="M 435.5,199.5 C 426.455,207.551 417.455,215.551 408.5,223.5C 408.577,222.25 409.244,221.417 410.5,221C 409.483,219.951 409.316,218.784 410,217.5C 413.433,215.349 416.766,213.015 420,210.5C 421.333,207.833 422.667,205.167 424,202.5C 424.333,202.833 424.667,203.167 425,203.5C 427.824,200.502 431.324,199.168 435.5,199.5 Z"/></g> <g><path style={{opacity:1}} fill="#042c49" d="M 718.5,169.5 C 719.692,192.662 724.525,214.995 733,236.5C 743.674,260.17 761.507,275.67 786.5,283C 793.26,285.585 800.26,287.085 807.5,287.5C 810.577,288.856 813.91,289.689 817.5,290C 826.488,291.054 835.488,291.887 844.5,292.5C 851.52,292.901 858.52,293.568 865.5,294.5C 865.167,294.833 864.833,295.167 864.5,295.5C 854.856,296.25 845.189,296.916 835.5,297.5C 826.318,298.437 817.318,299.77 808.5,301.5C 760.571,308.596 732.071,335.929 723,383.5C 719.852,399.348 718.019,415.348 717.5,431.5C 716.676,435.312 716.176,439.312 716,443.5C 715.722,442.584 715.222,441.918 714.5,441.5C 714.509,416.744 711.342,392.41 705,368.5C 695.048,335.216 673.215,314.05 639.5,305C 615.469,299.662 591.136,296.162 566.5,294.5C 590.398,293.04 614.065,289.873 637.5,285C 667.896,277.924 689.062,260.091 701,231.5C 706.868,214.633 710.701,197.3 712.5,179.5C 714.012,174.071 714.679,168.404 714.5,162.5C 714.5,161.5 714.5,160.5 714.5,159.5C 715.325,155.353 715.825,151.019 716,146.5C 716.333,152.833 716.667,159.167 717,165.5C 717.21,167.058 717.71,168.391 718.5,169.5 Z"/></g> <g><path style={{opacity:1}} fill="#123148" d="M 316.5,207.5 C 315.223,209.148 314.223,210.982 313.5,213C 311.833,213.333 310.167,213.667 308.5,214C 308.833,214.333 309.167,214.667 309.5,215C 307.854,218.804 305.188,220.47 301.5,220C 298.848,222.209 297.348,225.042 297,228.5C 294.363,230.235 291.53,231.568 288.5,232.5C 287.614,233.325 287.281,234.325 287.5,235.5C 284.88,236.753 282.213,238.086 279.5,239.5C 278.795,241.672 277.795,243.672 276.5,245.5C 274.884,246.115 273.551,247.115 272.5,248.5C 271.575,247.359 270.741,247.359 270,248.5C 267.603,252.598 265.103,256.598 262.5,260.5C 260.518,261.216 258.851,262.383 257.5,264C 255.482,264.505 253.482,265.005 251.5,265.5C 267.095,247.069 284.429,230.569 303.5,216C 307.734,212.918 312.067,210.084 316.5,207.5 Z"/></g> <g><path style={{opacity:1}} fill="#d8e4ea" d="M 807.5,287.5 C 812.387,288.055 817.22,288.055 822,287.5C 829.596,289.324 837.096,290.99 844.5,292.5C 835.488,291.887 826.488,291.054 817.5,290C 813.91,289.689 810.577,288.856 807.5,287.5 Z"/></g> <g><path style={{opacity:1}} fill="#bdcfd8" d="M 835.5,297.5 C 826.814,300.047 817.814,301.381 808.5,301.5C 817.318,299.77 826.318,298.437 835.5,297.5 Z"/></g> <g><path style={{opacity:1}} fill="#042d49" d="M 681.5,442.5 C 685.982,443.326 690.649,443.826 695.5,444C 692.635,444.183 689.969,444.683 687.5,445.5C 684.833,445.5 682.167,445.5 679.5,445.5C 674.586,445.362 669.919,446.028 665.5,447.5C 653.92,448.645 642.92,451.812 632.5,457C 629.734,458.371 627.401,460.204 625.5,462.5C 615.779,470.242 609.279,480.242 606,492.5C 604.686,496.754 603.853,501.087 603.5,505.5C 601.434,516.64 599.934,527.974 599,539.5C 598.411,528.62 597.245,517.953 595.5,507.5C 595.483,505.435 595.15,503.435 594.5,501.5C 593.003,491.194 589.336,481.86 583.5,473.5C 577.77,464.301 569.77,457.968 559.5,454.5C 559.577,453.25 560.244,452.417 561.5,452C 560.5,451.667 559.5,451.333 558.5,451C 559.696,450.346 559.696,449.846 558.5,449.5C 555.004,450.61 551.671,450.11 548.5,448C 544.5,447.667 540.5,447.333 536.5,447C 538.595,446.444 538.762,445.944 537,445.5C 533.895,446.367 530.728,446.701 527.5,446.5C 516.912,444.758 516.912,443.092 527.5,441.5C 543.759,440.485 558.759,435.651 572.5,427C 586.224,414.209 594.057,398.375 596,379.5C 597.057,368.818 598.223,358.152 599.5,347.5C 600.712,362.242 602.545,376.909 605,391.5C 607.808,402.114 612.474,411.781 619,420.5C 631.689,431.758 646.522,438.591 663.5,441C 669.465,441.963 675.465,442.463 681.5,442.5 Z"/></g> <g><path style={{opacity:1}} fill="#798e9b" d="M 717.5,431.5 C 717.5,435.833 717.5,440.167 717.5,444.5C 716.5,444.5 715.5,444.5 714.5,444.5C 714.5,443.5 714.5,442.5 714.5,441.5C 715.222,441.918 715.722,442.584 716,443.5C 716.176,439.312 716.676,435.312 717.5,431.5 Z"/></g> <g><path style={{opacity:1}} fill="#2f4657" d="M 527.5,441.5 C 516.912,443.092 516.912,444.758 527.5,446.5C 522.167,446.167 516.833,445.833 511.5,445.5C 509.031,444.683 506.365,444.183 503.5,444C 506.365,443.817 509.031,443.317 511.5,442.5C 516.833,442.167 522.167,441.833 527.5,441.5 Z"/></g> <g><path style={{opacity:1}} fill="#334c60" d="M 166.5,433.5 C 166.665,437.182 166.499,440.848 166,444.5C 165.478,447.281 164.311,449.615 162.5,451.5C 162.99,445.191 164.323,439.191 166.5,433.5 Z"/></g> <g><path style={{opacity:1}} fill="#a7b0b4" d="M 511.5,442.5 C 509.031,443.317 506.365,443.817 503.5,444C 506.365,444.183 509.031,444.683 511.5,445.5C 508.5,445.5 505.5,445.5 502.5,445.5C 502.5,444.5 502.5,443.5 502.5,442.5C 505.5,442.5 508.5,442.5 511.5,442.5 Z"/></g> <g><path style={{opacity:1}} fill="#a8b1b6" d="M 681.5,442.5 C 686.5,442.5 691.5,442.5 696.5,442.5C 696.5,443.5 696.5,444.5 696.5,445.5C 693.5,445.5 690.5,445.5 687.5,445.5C 689.969,444.683 692.635,444.183 695.5,444C 690.649,443.826 685.982,443.326 681.5,442.5 Z"/></g> <g><path style={{opacity:1}} fill="#96afc1" d="M 679.5,445.5 C 675.409,446.895 671.076,447.562 666.5,447.5C 666.167,447.5 665.833,447.5 665.5,447.5C 669.919,446.028 674.586,445.362 679.5,445.5 Z"/></g> <g><path style={{opacity:1}} fill="#233e52" d="M 559.5,454.5 C 549.159,450.433 538.492,447.766 527.5,446.5C 530.728,446.701 533.895,446.367 537,445.5C 538.762,445.944 538.595,446.444 536.5,447C 540.5,447.333 544.5,447.667 548.5,448C 551.671,450.11 555.004,450.61 558.5,449.5C 559.696,449.846 559.696,450.346 558.5,451C 559.5,451.333 560.5,451.667 561.5,452C 560.244,452.417 559.577,453.25 559.5,454.5 Z"/></g> <g><path style={{opacity:1}} fill="#e4eff3" d="M 665.5,447.5 C 665.833,447.5 666.167,447.5 666.5,447.5C 664.854,450.569 662.187,452.069 658.5,452C 659.5,452.333 660.5,452.667 661.5,453C 659.782,453.346 658.115,453.846 656.5,454.5C 655.614,453.675 655.281,452.675 655.5,451.5C 645.527,453.443 636.361,457.443 628,463.5C 627.329,462.748 626.496,462.414 625.5,462.5C 627.401,460.204 629.734,458.371 632.5,457C 642.92,451.812 653.92,448.645 665.5,447.5 Z"/></g> <g><path style={{opacity:1}} fill="#405867" d="M 162.5,455.5 C 161.644,465.685 160.311,475.685 158.5,485.5C 158.865,475.235 160.199,465.235 162.5,455.5 Z"/></g> <g><path style={{opacity:1}} fill="#34515f" d="M 761.5,489.5 C 759.853,486.797 758.686,483.797 758,480.5C 757.768,481.737 757.268,482.737 756.5,483.5C 756.99,477.158 757.657,470.825 758.5,464.5C 759.72,472.811 760.72,481.145 761.5,489.5 Z"/></g> <g><path style={{opacity:1}} fill="#dce7eb" d="M 583.5,473.5 C 589.336,481.86 593.003,491.194 594.5,501.5C 593.275,500.063 592.275,498.396 591.5,496.5C 590.167,495.833 588.833,495.167 587.5,494.5C 587.959,488.682 586.626,483.182 583.5,478C 584.413,476.586 584.413,475.086 583.5,473.5 Z"/></g> <g><path style={{opacity:1}} fill="#072d49" d="M 761.5,489.5 C 764.651,506.817 774.651,517.984 791.5,523C 801.033,525.311 810.7,526.644 820.5,527C 807.091,527.173 794.091,529.506 781.5,534C 769.068,541.694 762.401,552.861 761.5,567.5C 759.896,571.9 759.229,576.566 759.5,581.5C 759.5,582.167 759.5,582.833 759.5,583.5C 758.833,582.5 758.167,581.5 757.5,580.5C 757.564,567.078 754.064,554.745 747,543.5C 742.075,538.287 736.241,534.454 729.5,532C 718.348,529.121 707.015,527.455 695.5,527C 705.26,526.271 714.927,524.937 724.5,523C 736.533,520.607 745.366,514.107 751,503.5C 753.656,497.05 755.489,490.383 756.5,483.5C 757.268,482.737 757.768,481.737 758,480.5C 758.686,483.797 759.853,486.797 761.5,489.5 Z"/></g> <g><path style={{opacity:1}} fill="#dde9ed" d="M 603.5,505.5 C 602.339,517.018 602.339,528.518 603.5,540C 602.281,543.345 600.114,544.179 597,542.5C 597.015,530.866 596.515,519.199 595.5,507.5C 597.245,517.953 598.411,528.62 599,539.5C 599.934,527.974 601.434,516.64 603.5,505.5 Z"/></g> <g><path style={{opacity:1}} fill="#b2c3c9" d="M 761.5,567.5 C 761.638,572.414 760.972,577.081 759.5,581.5C 759.229,576.566 759.896,571.9 761.5,567.5 Z"/></g> <g><path style={{opacity:1}} fill="#6f898f" d="M 757.5,580.5 C 758.167,581.5 758.833,582.5 759.5,583.5C 759.662,585.527 759.495,587.527 759,589.5C 757.608,586.722 757.108,583.722 757.5,580.5 Z"/></g> <g><path style={{opacity:1}} fill="#f1f2f2" d="M 854.5,703.5 C 856.705,700.423 858.372,697.09 859.5,693.5C 858.325,693.281 857.325,693.614 856.5,694.5C 853.276,699.668 849.61,704.335 845.5,708.5C 845.167,708.5 844.833,708.5 844.5,708.5C 840.906,710.297 837.24,712.13 833.5,714C 831.612,716.707 829.612,719.207 827.5,721.5C 825.199,720.94 822.866,720.44 820.5,720C 823.122,716.043 826.122,712.376 829.5,709C 835.936,707.516 841.603,704.516 846.5,700C 847.264,697.931 847.764,695.764 848,693.5C 851.195,691.665 854.028,689.998 856.5,688.5C 857.593,690.77 859.093,691.103 861,689.5C 862.28,689.613 863.113,690.28 863.5,691.5C 872.482,692.332 881.482,692.832 890.5,693C 891.5,694.667 892.5,696.333 893.5,698C 890.331,699.459 886.998,700.292 883.5,700.5C 877.254,699.949 871.087,698.949 865,697.5C 863.354,699.141 862.354,698.807 862,696.5C 860.456,698.468 859.289,700.635 858.5,703C 857.207,703.49 855.873,703.657 854.5,703.5 Z"/></g> <g><path style={{opacity:1}} fill="#98a0a2" d="M 854.5,703.5 C 853.833,704.167 853.167,704.833 852.5,705.5C 852.44,704.957 852.107,704.624 851.5,704.5C 849.754,706.252 847.754,707.585 845.5,708.5C 849.61,704.335 853.276,699.668 856.5,694.5C 857.325,693.614 858.325,693.281 859.5,693.5C 858.372,697.09 856.705,700.423 854.5,703.5 Z"/></g> <g><path style={{opacity:1}} fill="#636c6e" d="M 852.5,705.5 C 848.521,708.484 845.188,712.15 842.5,716.5C 841.17,717.832 839.503,718.665 837.5,719C 836.748,719.671 836.414,720.504 836.5,721.5C 835.833,721.833 835.167,722.167 834.5,722.5C 834.158,721.662 833.492,721.328 832.5,721.5C 836.84,717.493 840.84,713.16 844.5,708.5C 844.833,708.5 845.167,708.5 845.5,708.5C 847.754,707.585 849.754,706.252 851.5,704.5C 852.107,704.624 852.44,704.957 852.5,705.5 Z"/></g> <g><path style={{opacity:1}} fill="#b5babb" d="M 844.5,708.5 C 840.84,713.16 836.84,717.493 832.5,721.5C 831.391,721.557 830.391,721.89 829.5,722.5C 829.158,721.662 828.492,721.328 827.5,721.5C 829.612,719.207 831.612,716.707 833.5,714C 837.24,712.13 840.906,710.297 844.5,708.5 Z"/></g> <g><path style={{opacity:1}} fill="#a5abab" d="M 842.5,716.5 C 842.512,720.446 840.512,722.113 836.5,721.5C 836.414,720.504 836.748,719.671 837.5,719C 839.503,718.665 841.17,717.832 842.5,716.5 Z"/></g> <g><path style={{opacity:1}} fill="#e5f0f4" d="M 217.5,714.5 C 224.47,723.651 231.303,732.984 238,742.5C 241.066,745.396 243.899,748.396 246.5,751.5C 251.5,757.5 256.5,763.5 261.5,769.5C 260.883,769.611 260.383,769.944 260,770.5C 257.782,768.908 256.115,766.908 255,764.5C 254.282,765.451 253.449,765.617 252.5,765C 250.743,762.154 248.743,759.488 246.5,757C 245.552,756.517 244.552,756.351 243.5,756.5C 242.805,752.447 241.139,748.781 238.5,745.5C 237.167,745.167 235.833,744.833 234.5,744.5C 232.432,741.843 231.099,738.843 230.5,735.5C 226.499,732.354 223.999,728.354 223,723.5C 222.667,724.167 222.333,724.833 222,725.5C 221.19,723.694 220.024,722.194 218.5,721C 218.645,720.228 218.978,719.561 219.5,719C 218.418,717.67 217.751,716.17 217.5,714.5 Z"/></g> <g><path style={{opacity:1}} fill="#143146" d="M 246.5,751.5 C 249.765,751.299 252.431,752.466 254.5,755C 253.167,756.84 253.334,757.34 255,756.5C 257.656,759.322 260.489,761.988 263.5,764.5C 264.409,767.363 266.076,769.697 268.5,771.5C 268.291,772.086 267.957,772.586 267.5,773C 270.133,774.899 272.966,776.399 276,777.5C 277.829,779.733 278.329,782.067 277.5,784.5C 272.167,779.5 266.833,774.5 261.5,769.5C 256.5,763.5 251.5,757.5 246.5,751.5 Z"/></g> <g><path style={{opacity:1}} fill="#b2c4cd" d="M 595.5,781.5 C 602.422,781.656 609.089,782.656 615.5,784.5C 608.578,784.344 601.911,783.344 595.5,781.5 Z"/></g> </svg> );
    const WeightlifterIcon = ({ className, ...props }) => ( <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" className={className} {...props} fill="currentColor"> <path fillRule="evenodd" d="M 71.5,-0.5 C 72.8333,-0.5 74.1667,-0.5 75.5,-0.5C 79.8872,24.1028 83.8872,48.7695 87.5,73.5C 103.456,71.4122 119.456,69.5789 135.5,68C 139.35,64.7414 143.85,63.2414 149,63.5C 153.256,63.474 157.256,64.474 161,66.5C 192.435,64.0945 223.935,63.0945 255.5,63.5C 287.065,63.0945 318.565,64.0945 350,66.5C 358.901,62.0634 367.401,62.5634 375.5,68C 390.903,69.4334 406.236,71.2668 421.5,73.5C 426.48,48.9549 430.813,24.2883 434.5,-0.5C 438.833,-0.5 443.167,-0.5 447.5,-0.5C 468.599,3.795 489.933,7.46167 511.5,10.5C 511.5,12.1667 511.5,13.8333 511.5,15.5C 501.196,72.9871 491.196,130.654 481.5,188.5C 455.654,184.582 429.987,179.915 404.5,174.5C 409.167,148.5 413.833,122.5 418.5,96.5C 417.624,95.7492 416.624,95.2492 415.5,95C 404.846,93.6496 394.18,92.4829 383.5,91.5C 383.667,126.835 383.5,162.168 383,197.5C 382.08,200.101 381.413,202.768 381,205.5C 364.58,230.007 347.914,254.34 331,278.5C 326.523,292.095 322.357,305.761 318.5,319.5C 342.193,326.174 365.859,333.007 389.5,340C 392.58,342.29 395.747,344.457 399,346.5C 403.788,352.317 405.788,358.984 405,366.5C 398,408.5 391,450.5 384,492.5C 381.874,501.447 376.707,507.78 368.5,511.5C 364.5,511.5 360.5,511.5 356.5,511.5C 346.437,507.927 341.103,500.76 340.5,490C 346.015,453.741 352.015,417.575 358.5,381.5C 327.168,380.612 295.835,380.779 264.5,382C 235.116,402.695 206.449,424.361 178.5,447C 142.237,468.794 105.904,490.294 69.5,511.5C 65.5,511.5 61.5,511.5 57.5,511.5C 44.7211,505.943 39.8878,496.276 43,482.5C 44.0804,480.004 45.4138,477.67 47,475.5C 79.9034,454.936 113.07,434.77 146.5,415C 167.667,391.167 188.833,367.333 210,343.5C 210.781,342.271 211.281,340.938 211.5,339.5C 204.767,318.802 197.934,298.135 191,277.5C 169.954,252.122 149.287,226.456 129,200.5C 127.519,164.228 127.019,127.895 127.5,91.5C 115.43,92.4522 103.43,93.9522 91.5,96C 96.6478,123.053 101.314,150.219 105.5,177.5C 79.8456,181.609 54.1789,185.609 28.5,189.5C 19.3533,132.949 9.68663,76.6161 -0.5,20.5C -0.5,17.8333 -0.5,15.1667 -0.5,12.5C 23.6544,8.36475 47.6544,4.03142 71.5,-0.5ZM255.5,213.5C287.721,209.061 301.555,190.728 297,158.5C288.407,135.106 271.573,124.772 246.5,127.5C 227.963,132.54 216.796,144.54 213,163.5C211.836,193.171 226.003,209.838 255.5,213.5Z M 216.5,85.5 C 257.851,85.2267 299.185,85.8934 340.5,87.5C 340.833,119.174 340.5,150.84 339.5,182.5C 318.978,199.523 298.312,216.356 277.5,233C 262.833,233.667 248.167,233.667 233.5,233C 212.667,216.167 191.833,199.333 171,182.5C 170.5,150.835 170.333,119.168 170.5,87.5C 186.01,87.2969 201.343,86.6303 216.5,85.5 Z" /> </svg> );
const AnaerobicIcon = ({ className, ...props }) => (
  <svg
    version="1.0"
    xmlns="http://www.w3.org/2000/svg"
    viewBox="0 0 512 512"
    preserveAspectRatio="xMidYMid meet"
    className={className}
    {...props}
  >
    <g
      transform="translate(0.000000,512.000000) scale(0.100000,-0.100000)"
      fill="currentColor" 
      stroke="none"
    >
      <path d="M2545 4783 c-147 -53 -252 -164 -289 -308 -55 -207 40 -417 229 -511 254 -125 559 11 629 281 55 208 -41 418 -232 513 -71 34 -82 37 -181 40 -82 2 -117 -2 -156 -15z"/>
      <path d="M2030 3831 c-86 -23 -765 -326 -809 -360 -19 -15 -43 -44 -54 -65 -36 -70 -33 -112 28 -381 31 -137 61 -257 66 -266 16 -30 69 -68 104 -75 52 -10 101 4 140 37 56 50 60 80 36 271 -12 90 -21 174 -21 184 0 18 17 23 180 47 99 15 185 25 190 22 6 -3 10 -13 10 -21 0 -8 -36 -135 -81 -282 -47 -156 -82 -294 -86 -332 -7 -78 15 -172 55 -242 41 -72 1377 -1525 1423 -1549 75 -38 185 -22 247 35 60 54 82 178 45 249 -9 18 -233 320 -497 672 -265 352 -485 645 -489 652 -4 7 35 198 88 426 102 443 108 487 80 606 -44 187 -203 341 -393 380 -76 16 -187 13 -262 -8z"/>
      <path d="M3260 3468 c-19 -5 -97 -37 -173 -70 l-138 -59 -46 40 c-25 23 -49 41 -52 41 -3 0 -6 -33 -7 -73 0 -42 -14 -128 -32 -208 -18 -75 -32 -143 -32 -152 0 -31 106 -54 171 -37 48 13 423 218 469 257 37 31 64 102 56 145 -19 103 -104 148 -216 116z"/>
      <path d="M4544 3399 c-253 -133 -433 -316 -520 -530 -66 -162 -94 -337 -76 -487 6 -49 74 -411 151 -805 78 -393 141 -735 141 -759 0 -57 -27 -106 -79 -143 l-43 -30 -1683 -5 c-1681 -5 -1684 -5 -1711 -26 -44 -32 -66 -68 -71 -117 -7 -61 25 -128 75 -159 l37 -23 1645 -3 c1192 -2 1668 0 1727 9 196 27 356 161 413 347 39 126 35 157 -136 1025 -166 842 -173 887 -141 995 44 146 131 244 313 352 209 123 226 141 226 230 0 79 -44 139 -117 159 -59 16 -67 15 -151 -30z"/>
      <path d="M805 2362 c-48 -23 -69 -45 -90 -95 -28 -68 -13 -146 38 -196 37 -36 760 -494 827 -524 68 -30 163 -27 234 7 30 15 67 41 81 58 30 35 135 240 135 262 0 8 -73 94 -162 191 -90 98 -178 198 -195 223 -18 25 -34 47 -37 49 -2 2 -23 -52 -46 -122 -35 -106 -45 -125 -59 -120 -10 3 -146 66 -302 141 -314 150 -351 161 -424 126z"/>
    </g>
  </svg>
);

    const InjectionIcon = ({ className = "w-6 h-6", ...props }) => {
      return (
        <svg 
          id="Icons" 
          viewBox="0 0 60 60" 
          xmlns="http://www.w3.org/2000/svg" 
          className={className} 
          {...props}
          style={{
            '--needle-color': '#262626',
            '--needle-color-dark': '#e5e7eb'
          }}
        >
          <style>
            {`
              .needle-path {
                fill: var(--needle-color);
              }
              /* Se corrige el selector para que coincida con el sistema de temas de la app (.dark) */
              .dark .needle-path {
                fill: var(--needle-color-dark);
              }
            `}
          </style>
          
          <path fill="#d6dbe3" d="M16.622,48.248a.5.5,0,0,1-.38-.824l1.391-1.63-2.654,1.531a.5.5,0,0,1-.6-.787l1.376-1.371-1.858,1.072a.5.5,0,0,1-.626-.761l1.809-2.068-2.353,1.359a.5.5,0,0,1-.587-.8l.7-.639-.377.217a.5.5,0,0,1-.627-.105.5.5,0,0,1-.018-.635l2.141-2.742a.39.39,0,0,1-.036-.054.5.5,0,0,1,.183-.683l.866-.5a.5.5,0,0,1,.644.74L14.184,41.4l2.132-1.231a.5.5,0,0,1,.587.8l-.7.636.984-.569a.5.5,0,0,1,.626.762l-1.809,2.068,2.551-1.472a.5.5,0,0,1,.6.787l-1.375,1.37,1.861-1.074a.5.5,0,0,1,.63.756l-1.391,1.631,1.076-.62a.5.5,0,0,1,.5.865l-3.592,2.074A.489.489,0,0,1,16.622,48.248Z"/>
          <path fill="#d6dbe3" d="M41.43,31.943a.5.5,0,0,1-.336-.87l1.285-1.168L39.69,31.457a.5.5,0,0,1-.548-.834L41.183,29.1,37.8,31.058a.5.5,0,0,1-.564-.823l4.381-3.517-6.528,3.768a.5.5,0,0,1-.533-.844l.753-.517-1.787,1.031a.5.5,0,0,1-.534-.844l1.819-1.253-3,1.734a.5.5,0,0,1-.548-.834L36.8,24.842l-7.619,4.4a.5.5,0,0,1-.541-.839L34.2,24.423l-7.455,4.3a.5.5,0,0,1-.525-.85l1.688-1.116-2.691,1.553a.5.5,0,0,1-.535-.842l6.091-4.236-6.383,3.685a.5.5,0,0,1-.526-.85l2.143-1.418L23.8,25.927a.5.5,0,0,1-.543-.838L30.431,19.9l-6.934,4a.5.5,0,0,1-.533-.844l4.1-2.822a.491.491,0,0,1-.516-.21.5.5,0,0,1,.109-.674l4.508-3.483a.487.487,0,0,1-.254-.181.5.5,0,0,1,.066-.664l3.171-2.9a.505.505,0,0,1,.246-.5l.866-.5a.5.5,0,0,1,.587.8l-.8.729,1.107-.638a.5.5,0,0,1,.556.828l-3.551,2.743,4.165-2.4a.5.5,0,0,1,.533.844l-3.841,2.64L38.33,14.18a.5.5,0,0,1,.543.838l-7.177,5.2,8.034-4.638a.5.5,0,0,1,.526.85l-2.137,1.414,2.458-1.419a.5.5,0,0,1,.535.843L35.021,21.5,41.767,17.6a.5.5,0,0,1,.525.85L40.6,19.574l1.991-1.149a.5.5,0,0,1,.541.839l-5.559,3.975,6.237-3.6a.5.5,0,0,1,.547.834L38.812,24.59l6.309-3.642a.5.5,0,0,1,.534.845l-1.818,1.253,2.145-1.238a.5.5,0,0,1,.534.844l-.757.52,1.008-.582a.5.5,0,0,1,.563.822L42.949,26.93l5.175-2.988a.5.5,0,0,1,.549.834l-2.511,1.869a.5.5,0,0,1,.334.87l-3.534,3.212a.5.5,0,0,1-.237.545l-1.045.6A.489.489,0,0,1,41.43,31.943Z"/>
          <path fill="#8991a0" d="M44.773,21.233a.5.5,0,0,1-.337-.868l1.608-1.476-2.1,1.209a.5.5,0,0,1-.552-.831l4.12-3.123L42.741,18.9a.5.5,0,0,1-.53-.846l2.567-1.735-2.931,1.693a.5.5,0,0,1-.529-.848l2.06-1.383-2.389,1.379a.5.5,0,0,1-.537-.842l4.87-3.421-5.455,3.15a.5.5,0,0,1-.524-.851l.481-.316a.5.5,0,0,1-.386-.9l3.54-2.413a.494.494,0,0,1-.359-.226.5.5,0,0,1,.132-.678l2.9-2.046a.473.473,0,0,1-.133-.124.5.5,0,0,1,.061-.663l4.291-3.995a.5.5,0,0,1,.243-.515l.868-.5a.5.5,0,0,1,.59.8L49.478,5.56l2.694-1.555a.5.5,0,0,1,.539.841l-.485.342.719-.415a.5.5,0,0,1,.532.846l-2.4,1.634,2.76-1.593a.5.5,0,0,1,.524.851l-.137.091.355-.206a.5.5,0,0,1,.537.842L50.246,10.66,55.7,7.511a.5.5,0,0,1,.528.847L54.166,9.744l2.4-1.382a.5.5,0,0,1,.53.847l-2.985,2.016a.511.511,0,0,1,.489.218.5.5,0,0,1-.116.675l-4.7,3.568a.5.5,0,0,1,.293.866l-3.81,3.5a.5.5,0,0,1-.238.541l-1,.574A.491.491,0,0,1,44.773,21.233Z"/>
          <path fill="#b9bfcc" d="M50.289,29.565a.5.5,0,0,1-.425-.763l1.188-1.908-1.979,1.141a.5.5,0,0,1-.666-.709l1.155-1.738L47.7,26.662a.5.5,0,0,1-.632-.756l.825-.972-1.219.7a.5.5,0,0,1-.618-.771l.591-.644-.879.507a.5.5,0,0,1-.665-.712l1.143-1.69L44.42,23.382a.5.5,0,0,1-.648-.736l1.017-1.332-1.545.892a.5.5,0,0,1-.61-.779L43.046,21l-.64.369a.5.5,0,0,1-.666-.709L42.9,18.921,41.034,20a.5.5,0,0,1-.654-.727L41.454,17.8l-1.662.959a.5.5,0,0,1-.6-.788l.179-.177-.344.2a.5.5,0,0,1-.66-.718l1.117-1.6-1.758,1.015a.5.5,0,0,1-.607-.784l.313-.317-.512.295a.5.5,0,0,1-.606-.784l.3-.307-.5.288a.5.5,0,0,1-.622-.766l.662-.737-.978.565a.5.5,0,0,1-.628-.106.5.5,0,0,1-.015-.637l.968-1.228-1.455.84a.5.5,0,0,1-.643-.742l.966-1.226-1.453.839a.5.5,0,0,1-.671-.7l1.175-1.828L31.5,10.458a.5.5,0,0,1-.674-.7l1.13-1.812a.5.5,0,0,1-.391-.912l1.61-.93a.5.5,0,0,1,.674.7L32.73,8.591,34.7,7.452a.5.5,0,0,1,.671.7L34.2,9.983l1.923-1.11a.5.5,0,0,1,.643.742L35.8,10.841,37.254,10a.5.5,0,0,1,.642.742l-.967,1.23,1.456-.841a.5.5,0,0,1,.622.766l-.662.737.978-.565a.5.5,0,0,1,.606.784l-.3.307.5-.288a.5.5,0,0,1,.606.783l-.312.318.512-.295a.5.5,0,0,1,.66.718L40.475,16l1.758-1.015a.5.5,0,0,1,.6.789l-.179.176.344-.2a.5.5,0,0,1,.654.728L42.58,17.948l1.661-.959a.5.5,0,0,1,.666.709l-1.154,1.739,1.861-1.075a.5.5,0,0,1,.611.78l-.413.427.64-.369a.5.5,0,0,1,.648.737l-1.017,1.331,1.545-.892a.5.5,0,0,1,.664.713l-1.143,1.688,1.827-1.053a.5.5,0,0,1,.618.77L49,23.14l.882-.509a.5.5,0,0,1,.632.756l-.824.971,1.217-.7a.5.5,0,0,1,.666.709L50.42,26.1l1.861-1.075a.5.5,0,0,1,.675.7l-1.187,1.908,1.3-.749a.5.5,0,1,1,.5.865L50.539,29.5A.489.489,0,0,1,50.289,29.565Z"/>
          <path fill="#31b5a5" d="M22.807,48.152a.5.5,0,0,1-.288-.909l.47-.331-1.3.748a.5.5,0,0,1-.541-.839l8.16-5.854-9.355,5.4a.5.5,0,0,1-.521-.852l5.458-3.537L18.98,45.391a.5.5,0,0,1-.518-.855l2.922-1.863-3.247,1.874a.5.5,0,0,1-.525-.851l7.413-4.878-8,4.619a.5.5,0,0,1-.516-.856L16.8,42.4l-.518.3a.5.5,0,0,1-.517-.855l1.082-.684-1.334.77a.5.5,0,0,1-.525-.851l6.7-4.4-7.246,4.183A.5.5,0,0,1,13.928,40l2.406-1.541-2.641,1.524a.5.5,0,0,1-.542-.839l7.953-5.71-8.32,4.8a.5.5,0,0,1-.545-.836l6.706-4.9L12.6,36.167a.5.5,0,0,1-.537-.842l3.637-2.55-2.159,1.246a.5.5,0,0,1-.554-.83l4.738-3.622a.5.5,0,0,1-.44-.856l4.2-3.9a.5.5,0,0,1,.244-.518l.877-.506a.5.5,0,0,1,.59.8l-1.985,1.844,2.554-1.474a.5.5,0,0,1,.553.83l-4.578,3.5,5.328-3.075a.5.5,0,0,1,.537.842l-3.636,2.548L26.482,27a.5.5,0,0,1,.545.836l-6.708,4.9,9.01-5.2a.5.5,0,0,1,.542.839l-7.953,5.711L34.708,26.7a.5.5,0,0,1,.52.854l-2.4,1.534L36.286,27.1a.5.5,0,0,1,.525.85l-6.706,4.4,7.719-4.456a.5.5,0,0,1,.518.855l-1.077.681,1.394-.8a.5.5,0,0,1,.517.856l-.3.188.483-.279a.5.5,0,0,1,.525.85l-7.411,4.877,8.006-4.623a.5.5,0,0,1,.519.855l-2.932,1.87L41.215,31.4a.5.5,0,0,1,.521.853l-5.448,3.531,1.284-.741a.5.5,0,0,1,.541.839l-8.158,5.853,2.187-1.261a.5.5,0,0,1,.538.841L29.788,43.35a.5.5,0,0,1-.015.857l-6.716,3.878A.491.491,0,0,1,22.807,48.152Z"/>
          <path className="needle-path" d="M12.869,32.95a5.509,5.509,0,0,0-.048,7.116c.066.077.14.148.207.225a4.265,4.265,0,0,0-1.577,2.738,3.306,3.306,0,0,0,.735,2.308,11.26,11.26,0,0,0,.828.851L2.005,57.2.4,58.8a.393.393,0,0,0,.179.667A1.04,1.04,0,0,0,1.6,59.2l11.29-11.291.921-.92.26.26a3.885,3.885,0,0,0,4.132.744,4.568,4.568,0,0,0,1.521-1.044,6,6,0,0,0,8.137-.61c1.275-1.261,2.536-2.536,3.8-3.8L44.519,29.677l2.7-2.7q1.18,1.18,2.362,2.362c1.257.96,2.561-.1,3.453-.991.733-.733,1.7-1.478.83-2.529-.956-1.152-2.163-2.164-3.22-3.221l-3.229-3.229,8.123-8.125a3.339,3.339,0,0,0,3.293-.589.994.994,0,0,0,.212-.165,2.3,2.3,0,0,0-.066-3.29c-.532-.539-1.071-1.071-1.607-1.607C55.994,4.216,54.626,2.83,53.24,1.462a3.111,3.111,0,0,0-3.787-.311,2.347,2.347,0,0,0-.83,3.437L40.63,12.582Q39.287,11.241,37.947,9.9C36.852,8.8,35.8,7.54,34.6,6.556a2.226,2.226,0,0,0-2.845.3c-.715.644-2.333,1.828-1.686,2.925a5.235,5.235,0,0,0,.861.912l1.977,1.977.111.11L20.936,24.864,14.1,31.7C13.688,32.112,13.248,32.509,12.869,32.95Zm5.039,14.208a1.768,1.768,0,0,1-1.153.186,2.52,2.52,0,0,1-1.345-.7l-1.1-1.1A5.151,5.151,0,0,1,13.174,44.2a2.748,2.748,0,0,1,.189-2.691,3.336,3.336,0,0,1,.372-.448c1.663,1.789,3.485,3.465,5.225,5.175A4.441,4.441,0,0,1,17.908,47.158ZM41.685,30.807c-1.256-.93-2.059-2.351-3.442-3.149a7.575,7.575,0,0,0-5.621-.727,20.494,20.494,0,0,1-2.405.673,6.064,6.064,0,0,1-3.611-.807,7.69,7.69,0,0,1-1.925-1.722,7.024,7.024,0,0,0-1.091-1.16l2.873-2.873,1.952,1.951.369.37c.069.068.3.049.369.043a2.1,2.1,0,0,0,.564-.127c.113-.043.613-.229.433-.408l-2.6-2.6-.162-.161L29.808,17.7l.362-.362,1.952,1.952.37.37c.068.068.3.05.368.044a2.067,2.067,0,0,0,.565-.127c.113-.043.613-.229.432-.41l-2.6-2.6-.162-.162,2.748-2.748L46.341,26.151ZM49.418,5.5,54.5,10.58l-7.907,7.907L44.4,16.294l4.93-4.931.739-.738c.207-.207.172-.437-.134-.5a1.267,1.267,0,0,0-1.024.274l-5.193,5.193-.01.01L41.511,13.41Q45.465,9.456,49.418,5.5ZM49.843,2a1.108,1.108,0,0,1,.824-.652,1.7,1.7,0,0,1,1.11.534c.086.081.167.168.251.251l3.723,3.724L57.5,7.6a2.008,2.008,0,0,1,.219,2.929c-.557.515-1.158.12-1.644-.325a.67.67,0,0,0-.1-.132L50.079,4.182A1.931,1.931,0,0,1,49.843,2Zm-17.2,8.529a13.3,13.3,0,0,1-.979-.979c-.79-.981.406-1.762,1.059-2.415.036-.037.225-.277.284-.284l.007,0a1.407,1.407,0,0,0,.184.176c.016.013.029.029.043.042.109.106.215.216.322.323l1.421,1.421,4.923,4.923a.642.642,0,0,0,.126.18l5.931,5.932a.489.489,0,0,0,.137.082l.025.025,5.33,5.331a12.19,12.19,0,0,1,1.054,1.054c.447.573.245.993-.163,1.446-.247.275-.527.526-.789.788a1.867,1.867,0,0,1-.274.274A.478.478,0,0,0,51.1,29a.423.423,0,0,0-.158-.173l-3-3a.671.671,0,0,0-.125-.179L34.469,12.3c-.03-.03-.071-.033-.106-.053Q33.5,11.389,32.646,10.53ZM15.325,32.18l0,0L17.3,34.15l.369.37c.224.224.7.12.958.007.161-.072.622-.337.389-.569l-2.6-2.6-.14-.139,2.751-2.751,1.977,1.977.37.369c.229.23.7.141.961.021.168-.077.621-.355.383-.593q-1.3-1.3-2.6-2.6l-.137-.136,2.653-2.653c.093.093.187.184.276.281.275.3.531.613.8.913A6.479,6.479,0,0,0,25.8,27.606a7.771,7.771,0,0,0,5.65.287,7.723,7.723,0,0,1,2.49-.536A6.335,6.335,0,0,1,37.381,28.5c1.306.944,2.089,2.3,3.463,3.147L27.658,44.834c-.382.383-.753.782-1.15,1.15a4.241,4.241,0,0,1-5.954-.147c-2.02-2.019-4.069-4.012-6.06-6.06a4.655,4.655,0,0,1-.156-6.61C14.657,32.829,15,32.509,15.325,32.18Z"/>
        </svg>
      );
    };
    const MedicalVisitIcon = ({ className, ...props }) => ( <svg version="1.0" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" className={className} {...props} fill="currentColor"> <g transform="scale(0.1, -0.1) translate(0, -5120)"> <path d="M1665 4643 c-27 -2 -90 -13 -139 -25 -81 -20 -110 -38 -92 -56 4 -3 82 -13 174 -22 l167 -15 0 -90 0 -90 -185 0 -184 0 -14 88 c-14 87 -14 89 8 119 22 30 22 32 5 45 -25 17 -34 17 -73 -7 -39 -24 -57 -63 -67 -146 -6 -59 -8 -61 -43 -74 -102 -36 -194 -126 -247 -242 -97 -211 -60 -531 81 -704 l33 -41 -30 -28 c-93 -90 -89 -200 12 -306 24 -26 174 -168 334 -315 381 -354 557 -523 574 -554 8 -15 17 -69 21 -131 8 -150 31 -179 141 -179 l49 0 -6 -152 c-4 -84 -7 -154 -8 -155 -1 -1 -179 -5 -396 -9 -262 -4 -420 -11 -468 -20 -258 -47 -442 -265 -442 -521 0 -201 116 -383 300 -472 150 -73 270 -87 590 -68 217 13 307 44 393 136 109 117 138 283 114 669 l-8 132 343 0 c390 0 816 15 898 31 175 35 309 185 318 357 4 71 5 72 32 72 43 0 135 36 195 76 73 48 120 103 162 191 124 258 -41 575 -309 591 -50 3 -71 0 -82 -10 -12 -13 -8 -17 38 -31 156 -50 264 -177 274 -323 7 -109 -17 -174 -89 -244 -31 -31 -83 -69 -115 -85 -51 -26 -70 -30 -139 -30 -67 0 -88 5 -131 27 -148 78 -223 276 -163 433 30 81 110 164 202 210 38 19 77 35 85 35 14 0 14 2 -1 18 -14 13 -35 17 -90 17 -59 0 -82 -5 -132 -29 -152 -75 -249 -251 -231 -418 26 -224 182 -396 391 -428 38 -6 71 -13 73 -14 1 -2 -7 -29 -18 -60 -46 -121 -124 -198 -239 -234 -61 -19 -190 -19 -933 -6 l-346 6 -6 32 c-3 17 -8 86 -12 154 l-7 122 58 0 c67 0 118 21 134 56 6 14 11 60 11 102 0 133 -5 125 258 382 231 225 597 602 669 688 27 32 37 54 41 91 4 43 1 52 -28 84 -18 20 -36 34 -41 31 -6 -3 -17 0 -26 8 -9 7 -3 -7 13 -32 57 -85 55 -96 -46 -185 -296 -262 -867 -796 -900 -843 -38 -51 -51 -97 -53 -186 l-2 -77 -93 3 -92 3 -4 92 c-5 150 -5 150 -378 509 -178 171 -389 373 -471 449 -85 81 -147 146 -147 157 0 24 67 97 96 104 28 7 24 11 544 -481 198 -188 351 -325 375 -336 52 -24 109 -24 164 1 32 15 154 132 463 442 l419 423 44 0 44 0 -20 20 c-13 14 -33 20 -63 20 -49 0 -60 -7 -316 -219 -161 -134 -277 -236 -487 -433 -86 -80 -150 -133 -163 -133 -21 0 -20 -1 -530 480 -177 168 -341 317 -364 332 -53 36 -111 44 -159 24 l-37 -15 -13 32 c-26 62 -57 194 -65 277 -20 194 30 347 159 491 l48 54 26 -32 c47 -59 90 -67 308 -59 214 8 247 16 281 75 21 36 33 170 22 245 -15 101 -88 139 -241 129z m507 -3460 c-1 -126 -7 -258 -12 -295 -24 -163 -103 -251 -256 -283 -54 -11 -120 -13 -304 -9 -323 8 -384 25 -489 140 -72 78 -95 144 -95 269 0 128 23 191 101 275 67 73 141 111 232 120 36 4 237 8 446 9 l380 1 -3 -227z"/> <path d="M2930 4640 c-106 -9 -208 -37 -220 -61 -13 -24 -7 -25 182 -40 93 -7 159 -17 161 -23 2 -6 1 -47 -2 -91 l-6 -80 -185 0 -185 0 -8 55 c-15 104 -13 136 8 160 19 21 19 22 0 36 -24 17 -29 17 -64 0 -42 -22 -60 -57 -71 -138 -19 -128 5 -208 72 -245 29 -16 57 -18 230 -16 222 1 257 8 306 62 l32 35 40 -39 c179 -175 217 -446 110 -776 -31 -94 -37 -139 -20 -139 25 0 91 42 113 72 34 46 50 80 83 178 26 76 29 99 29 210 0 134 -19 221 -70 320 -56 109 -145 195 -236 227 l-49 18 0 63 c0 94 -17 147 -57 182 -18 17 -41 30 -51 30 -9 0 -26 2 -37 4 -11 2 -58 0 -105 -4z"/> <path d="M3650 2452 c-120 -120 -37 -312 135 -312 169 0 259 194 138 300 -27 25 -42 30 -70 28 -55 -5 -64 -30 -25 -66 37 -35 43 -79 14 -105 -22 -20 -73 -22 -90 -5 -21 21 -14 84 13 116 30 36 31 44 7 65 -33 30 -80 21 -122 -21z"/> </g> </svg> );
    const AnalysisIcon = ({ className, ...props }) => ( <svg version="1.0" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" className={className} {...props} fill="currentColor"> <g transform="scale(0.1, -0.1) translate(0, -5120)"> <path d="M3231 4740 c-137 -28 -256 -169 -300 -355 l-12 -50 -173 3 c-217 4 -206 14 -206 -170 l0 -128 -282 0 c-156 -1 -302 -5 -325 -9 -50 -10 -143 -71 -185 -121 -60 -73 -99 -185 -118 -337 -8 -63 -7 -129 5 -272 8 -105 15 -215 15 -245 l0 -56 -77 -39 c-455 -229 -662 -775 -474 -1246 18 -44 42 -95 53 -113 l21 -34 -35 -28 c-45 -38 -68 -86 -68 -145 0 -40 -3 -48 -22 -53 -42 -10 -146 -69 -208 -117 -60 -46 -296 -263 -451 -415 -86 -84 -106 -127 -95 -214 15 -131 155 -237 290 -220 127 17 183 56 461 324 236 227 278 275 296 337 11 41 14 44 40 38 35 -8 93 10 134 40 l30 22 68 -26 68 -26 -7 -55 c-26 -203 -19 -322 25 -416 48 -103 129 -169 246 -200 40 -11 248 -14 1055 -14 1202 0 1678 16 1776 59 78 35 70 97 -15 108 -37 5 -41 8 -35 27 4 11 11 37 15 56 13 54 11 3197 -2 3243 -5 21 -24 54 -42 74 -57 65 -68 67 -400 71 l-298 4 2 130 c2 117 0 133 -16 145 -14 9 -55 13 -146 13 l-127 0 -12 48 c-57 229 -279 400 -469 362z m167 -131 c104 -52 180 -157 207 -288 20 -95 30 -101 174 -101 l117 0 -3 -147 c-4 -149 -18 -282 -31 -295 -27 -26 -663 -45 -995 -30 -114 5 -209 11 -211 13 -2 2 -7 109 -11 237 l-7 232 175 0 c201 0 201 0 211 82 18 141 82 252 175 300 71 37 120 37 199 -3z m-858 -788 c0 -60 3 -116 6 -125 15 -40 205 -56 664 -56 465 0 654 15 713 54 38 26 54 69 63 167 l7 69 294 0 295 0 29 -29 29 -29 0 -1612 0 -1612 -30 -30 -31 -30 -1002 6 c-551 3 -1148 9 -1326 12 -323 6 -324 7 -348 30 -22 23 -23 27 -23 211 l0 188 158 0 c186 1 272 19 421 91 260 124 444 332 535 605 122 367 35 713 -258 1027 -196 209 -494 329 -771 309 l-85 -6 0 408 c0 428 0 425 45 449 13 8 122 11 318 12 l297 0 0 -109z m-420 -862 c292 -36 543 -212 685 -482 66 -126 86 -201 92 -349 8 -173 -18 -300 -90 -443 -113 -227 -290 -377 -534 -452 -80 -24 -103 -27 -253 -27 -191 -1 -242 10 -387 79 -545 263 -667 991 -238 1420 140 140 320 229 520 255 88 11 112 11 205 -1z m-845 -1534 c20 -24 68 -69 106 -101 60 -49 67 -59 58 -75 -52 -98 -259 18 -259 145 0 40 22 76 46 76 7 0 29 -20 49 -45z m-106 -236 c46 -50 52 -62 47 -86 -8 -30 -368 -395 -528 -535 -102 -88 -134 -99 -201 -70 -55 25 -88 69 -89 122 -1 54 19 80 142 190 58 51 152 139 210 195 58 56 130 120 160 143 66 49 166 102 189 101 9 -1 40 -28 70 -60z"/> <path d="M3233 4500 c-61 -37 -62 -134 -2 -184 56 -47 145 -22 175 50 20 48 10 86 -32 124 -42 36 -93 40 -141 10z"/> <path d="M2932 4084 c-27 -18 -29 -55 -4 -77 16 -15 53 -17 314 -17 273 0 296 1 311 18 23 26 21 58 -5 76 -19 14 -66 16 -308 16 -242 0 -289 -2 -308 -16z"/> <path d="M2917 3092 c-26 -28 -21 -46 23 -85 112 -102 271 -133 525 -103 77 10 181 22 230 28 50 5 191 11 315 11 l225 2 9 28 c8 23 6 31 -12 50 -22 22 -27 22 -265 21 -172 0 -280 -5 -372 -18 -334 -45 -480 -30 -588 60 -34 29 -68 31 -90 6z"/> <path d="M4045 2333 c-11 -3 -72 -26 -135 -51 -111 -45 -118 -46 -215 -45 -76 0 -124 7 -200 28 -141 39 -153 40 -175 20 -44 -39 -18 -72 80 -103 107 -35 206 -52 303 -52 78 0 105 5 177 31 216 79 222 81 267 74 24 -3 56 -17 72 -31 47 -39 101 -28 101 21 0 59 -96 115 -195 114 -33 -1 -69 -3 -80 -6z"/> <path d="M3925 1514 c-11 -3 -78 -22 -150 -42 -122 -35 -139 -37 -265 -36 -86 0 -168 7 -225 18 -163 32 -180 32 -200 2 -16 -24 -16 -28 -2 -50 13 -20 34 -27 129 -45 258 -48 391 -47 580 8 206 59 269 63 366 21 55 -24 85 -18 97 20 10 30 -10 55 -62 81 -39 18 -68 23 -148 25 -55 2 -109 0 -120 -2z"/> <path d="M2178 2644 c-17 -36 -4 -52 73 -94 83 -45 204 -166 247 -247 62 -118 89 -301 62 -418 -11 -49 8 -85 45 -85 53 0 71 57 69 220 -1 118 -21 199 -79 317 -56 113 -162 228 -271 291 -84 50 -128 55 -146 16z"/> <path d="M2485 1720 c-25 -27 -10 -71 27 -84 53 -19 91 50 50 87 -25 23 -55 21 -77 -3z"/> </g> </svg> );
    const DrinkIcon = ({ className, ...props }) => ( <svg version="1.0" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" className={className} {...props} fill="currentColor"> <g transform="scale(0.1, -0.1) translate(0, -5120)"> <path d="M3080 5059 c-25 -11 -60 -35 -78 -52 -54 -51 -66 -80 -146 -347 l-26 -86 -82 12 c-170 26 -362 12 -539 -40 -197 -57 -362 -157 -515 -310 -159 -159 -258 -327 -308 -528 l-23 -90 -50 -28 c-56 -32 -109 -102 -119 -158 -4 -20 -4 -115 -1 -212 6 -204 13 -229 85 -299 l49 -47 7 -89 c27 -359 176 -1479 290 -2182 36 -225 49 -284 74 -338 38 -81 102 -144 190 -187 l67 -33 600 0 600 0 50 23 c28 13 68 35 89 50 51 35 120 129 140 190 39 118 273 1771 342 2409 15 137 20 164 35 168 25 8 89 81 106 123 10 25 16 91 20 223 5 166 4 194 -12 235 -23 60 -73 115 -125 139 -28 13 -42 26 -46 44 -49 229 -143 411 -301 581 l-76 81 37 99 c84 227 146 417 146 450 0 86 -51 168 -124 201 -62 28 -293 27 -356 -2z m215 -241 c-4 -13 -20 -63 -35 -113 -16 -49 -40 -129 -54 -176 l-26 -86 -54 28 c-30 15 -60 29 -67 31 -9 3 3 49 45 163 31 88 63 163 69 167 7 4 38 8 70 8 56 0 58 -1 52 -22z m-546 -484 c4 -5 -18 -103 -50 -219 -32 -115 -73 -270 -91 -342 l-32 -133 -181 -1 c-99 0 -353 -4 -565 -8 -212 -4 -387 -6 -389 -5 -2 2 13 34 34 71 182 333 505 570 870 638 88 16 389 16 404 -1z m324 -106 c32 -16 38 -23 32 -41 -3 -12 -36 -140 -73 -284 l-66 -263 -129 0 c-99 0 -128 3 -124 13 3 6 39 95 80 197 41 102 96 240 122 307 l47 121 36 -15 c21 -8 54 -24 75 -35z m341 -241 c45 -45 108 -116 138 -157 58 -78 123 -188 116 -195 -7 -7 -559 8 -556 15 2 4 43 105 92 223 80 193 92 215 108 206 10 -5 56 -47 102 -92z m-734 -592 l1035 -4 8 -156 c8 -137 7 -159 -7 -174 -14 -15 -42 -19 -189 -25 -211 -8 -553 -31 -790 -52 -162 -14 -198 -14 -395 0 -119 8 -272 18 -339 22 l-122 7 -22 121 c-26 144 -34 166 -54 166 -26 0 -26 -21 0 -149 14 -68 23 -126 20 -129 -2 -3 -97 -1 -211 4 -188 8 -207 11 -220 29 -12 17 -14 47 -8 175 4 88 11 161 18 169 9 11 33 12 126 6 63 -4 581 -9 1150 -10z m195 -489 c231 -20 685 -46 786 -46 44 0 79 -4 79 -9 0 -5 -18 -83 -39 -173 -90 -375 -270 -1207 -356 -1648 -14 -74 -28 -140 -30 -147 -2 -7 -83 22 -219 79 -229 97 -277 127 -320 201 -13 23 -66 173 -116 332 -51 160 -100 306 -111 326 -44 87 -114 143 -238 189 -103 38 -152 63 -194 99 -67 59 -81 103 -146 440 -34 173 -61 320 -61 327 0 8 32 14 108 19 59 4 184 13 277 20 189 15 313 13 580 -9z m-1011 -75 l9 -53 -190 -190 -190 -190 -15 58 -15 59 186 188 c102 103 190 186 196 184 5 -2 14 -27 19 -56z m-259 -101 c-82 -82 -152 -146 -156 -142 -3 4 -12 29 -18 56 l-12 49 83 85 c46 46 92 88 103 92 11 5 49 9 85 9 l65 1 -150 -150z m-135 85 c-30 -30 -57 -55 -61 -55 -6 0 -29 78 -29 99 0 7 28 11 72 11 l72 0 -54 -55z m254 -406 c-203 -203 -194 -199 -209 -110 l-7 44 188 189 189 189 14 -62 13 -62 -188 -188z m214 51 l10 -55 -181 -182 c-100 -101 -184 -183 -188 -183 -3 0 -12 27 -19 61 l-13 61 184 184 c101 101 186 180 190 176 3 -4 11 -32 17 -62z m37 -199 l7 -44 -178 -178 c-98 -99 -181 -179 -185 -179 -3 0 -11 25 -18 56 l-13 57 183 183 c198 198 189 193 204 105z m67 -142 l26 -36 -207 -207 -208 -208 -12 63 -13 62 188 188 c104 104 191 185 194 181 3 -4 18 -23 32 -43z m112 -97 l45 -29 -254 -253 -253 -253 -11 52 c-6 29 -11 57 -11 64 0 9 428 447 437 447 1 0 22 -13 47 -28z m166 -68 c22 -9 40 -19 40 -23 0 -3 -141 -147 -314 -320 l-314 -314 -11 52 c-6 29 -11 60 -11 69 0 22 530 552 552 552 10 0 36 -7 58 -16z m132 -81 c15 -15 28 -32 28 -37 0 -21 -709 -721 -714 -705 -3 7 -9 34 -14 59 l-9 45 331 333 c182 182 335 332 340 332 6 0 23 -12 38 -27z m81 -145 l17 -53 -373 -373 -372 -372 -13 62 -12 63 362 362 c200 200 365 363 369 363 3 0 13 -24 22 -52z m53 -163 l18 -56 -379 -379 c-240 -240 -382 -375 -386 -368 -4 7 -11 34 -14 61 l-7 50 373 373 c206 206 375 374 376 374 1 0 10 -25 19 -55z m58 -180 l16 -50 -387 -387 c-213 -214 -391 -388 -394 -388 -3 0 -11 28 -17 63 l-10 62 381 382 c210 211 384 379 388 375 3 -4 14 -29 23 -57z m-328 -614 c-292 -292 -399 -392 -405 -382 -5 7 -11 34 -15 59 l-6 47 392 392 393 393 19 -56 18 -56 -396 -397z m458 312 l35 -38 -377 -377 c-298 -299 -382 -378 -402 -378 -21 0 -52 14 -80 37 -3 3 780 793 787 793 2 0 18 -17 37 -37z m131 -94 l48 -21 -344 -344 -344 -344 -67 0 c-38 0 -68 3 -68 7 0 9 712 723 721 723 4 0 28 -9 54 -21z m165 -70 l44 -20 -310 -309 -310 -310 -72 0 c-40 0 -72 3 -72 7 0 15 645 653 660 653 8 0 35 -10 60 -21z m153 -63 l49 -19 -279 -279 -278 -278 -75 0 -75 0 300 300 c165 165 302 299 305 298 3 -2 27 -12 53 -22z m57 -157 l-17 -91 -164 -164 -164 -164 -75 0 -75 0 255 255 c140 140 255 255 256 255 0 0 -7 -41 -16 -91z m-51 -259 c-20 -102 -86 -160 -181 -160 l-43 0 115 115 c63 63 116 113 118 111 2 -2 -2 -32 -9 -66z"/> </g> </svg> );
const StarIcon = ({ className, ...props }) => {
      // Genera un ID único para el degradado para evitar conflictos
      const gradientId = React.useId();
      return (
        <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg" className={className} {...props}>
          <defs>
            <linearGradient id={gradientId} x1="0%" y1="0%" x2="100%" y2="100%">
              <stop offset="0%" style={{stopColor: '#FAE388', stopOpacity: 1}} />
              <stop offset="50%" style={{stopColor: '#E8CD75', stopOpacity: 1}} />
              <stop offset="100%" style={{stopColor: '#4E7A9F', stopOpacity: 1}} />
            </linearGradient>
          </defs>
          <path d="M50 10 L58 32 C58.5 33.5 59.5 34 61 34 L82 34 C84 34 85 35 84.5 36.5 C84 38 82.5 39 81 40 L65 52 C63.5 53 63 54.5 63.5 56 L68 77 C68.5 79 67.5 80.5 66 80 C64.5 79.5 63 78 61.5 76.5 L50 65 C48.5 63.5 46.5 63.5 45 65 L33.5 76.5 C32 78 30.5 79.5 29 80 C27.5 80.5 26.5 79 27 77 L31.5 56 C32 54.5 31.5 53 30 52 L14 40 C12.5 39 11 38 10.5 36.5 C10 35 11 34 13 34 L34 34 C35.5 34 36.5 33.5 37 32 L42 11 C43 9 44 8 45 8 C46.5 8 48.5 8 50 10 Z"
            fill={`url(#${gradientId})`} stroke="#a1882b" strokeWidth="2" strokeLinejoin="round" strokeLinecap="round"/>
          <ellipse cx="48" cy="45" rx="12" ry="8" fill="#FDFDFD" opacity="0.7" transform="rotate(-15 48 45)"/>
          <circle cx="50" cy="50" r="4" fill="#FAE388" opacity="0.9"/>
        </svg>
      );
    };
    
    const PillIcon = ({ className, ...props }) => {
      // Genera IDs únicos para el degradado y el filtro de sombra
      const gradientId = React.useId();
      const shadowId = React.useId();
      return (
        <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg" className={className} {...props}>
          <defs>
            <linearGradient id={gradientId} x1="0%" y1="0%" x2="100%" y2="100%">
              <stop offset="0%" style={{stopColor: '#A7E991', stopOpacity: 1}} />
              <stop offset="30%" style={{stopColor: '#73CB5D', stopOpacity: 1}} />
              <stop offset="70%" style={{stopColor: '#FB91C2', stopOpacity: 1}} />
              <stop offset="100%" style={{stopColor: '#FB5595', stopOpacity: 1}} />
            </linearGradient>
            <filter id={shadowId}>
              <feGaussianBlur in="SourceAlpha" stdDeviation="2"/>
              <feOffset dx="1" dy="3" result="offset"/>
              <feFlood floodColor="#000000" floodOpacity="0.15"/>
              <feComposite in2="offset" operator="in"/>
              <feMerge>
                <feMergeNode/>
                <feMergeNode in="SourceGraphic"/>
              </feMerge>
            </filter>
          </defs>
          <rect x="25" y="40" width="50" height="20" rx="10" ry="10"
            fill={`url(#${gradientId})`} stroke="rgba(0,0,0,0.2)" strokeWidth="1"
            strokeLinejoin="round" strokeLinecap="round" filter={`url(#${shadowId})`}
            transform="rotate(-35 50 50)"/>
          <line x1="50" y1="42" x2="50" y2="58"
            stroke="rgba(255,255,255,0.4)" strokeWidth="1" opacity="0.8"
            transform="rotate(-35 50 50)"/>
          <ellipse cx="35" cy="45" rx="4" ry="2" fill="#FDFDFD" opacity="0.8" transform="rotate(-35 50 50)"/>
          <circle cx="62" cy="52" r="1.5" fill="#FDFDFD" opacity="0.6" transform="rotate(-35 50 50)"/>
        </svg>
      );
    };


    // ====================== Gestión de Datos de Usuario ======================
  function useUsers(){ 
        const [users,setUsers]=useLocalStorage(USERS_KEY,[]); 
        const [current,setCurrent]=useLocalStorage(CURRENT_KEY,null); 
        const saveUser=(data, autoLogin=true, isImport=false)=>{
            // AÑADIMOS UN ID ÚNICO A CADA PERFIL SI NO LO TIENE
            // Esto asegura que tanto los nuevos usuarios como los importados tengan un identificador.
            if (!data.profile.id) {
                data.profile.id = `user_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            }

            const safeData = {
                ...data,
                profile: {
                    ...data.profile,
                    medication: { name: '', dose: '', startDate: null, frequency: null, ...data.profile.medication },
                    medication2: { name: '', dose: '', startDate: null, frequency: null, ...data.profile.medication2 }
                },
                events: data.events || []
            };
            
            if (isImport) {
                const next = [...users, safeData];
                setUsers(next);
                if(autoLogin) setCurrent(safeData);
                return;
            }
            
            // La lógica de actualización ahora buscará por ID si existe, si no, por nombre (para perfiles antiguos)
            const idx = users.findIndex(u => (safeData.profile.id && u.profile.id === safeData.profile.id) || (!safeData.profile.id && u.profile.name === safeData.profile.name)); 
            const next = [...users]; 
            if(idx>=0) next[idx]=safeData; else next.push(safeData); 
            setUsers(next); 
            if(autoLogin) setCurrent(safeData); 
        }; 
        // MODIFICAMOS removeUser PARA QUE ACEPTE UN ID
        const removeUser=(userId)=>{ 
            const next = users.filter(u=>u.profile.id !== userId); 
            setUsers(next); 
            if(current?.profile.id === userId) setCurrent(null) 
        }; 
        return {users,current, setCurrent, saveUser, removeUser}; 
    }

    // ====================== Componentes de Login y PIN ======================
    const LoginHeader = () => (<div className="p-3 bg-white dark:bg-gray-700 rounded-t-2xl border-b-2 border-gray-300 dark:border-gray-600 relative overflow-hidden"><div className="absolute inset-0 bg-gradient-to-l from-blue-300 dark:from-blue-900 from-30% to-transparent pointer-events-none"></div><h2 className="text-2xl font-bold text-center text-gray-800 dark:text-white relative z-10">ControlaTuPeso+</h2></div>);

    const PinPrompt = ({ open, title, message, onCancel, onValidate, onForgotPassword }) => {
        const [pin, setPin] = React.useState('');
        if (!open) return null;
        return (
            <Modal open={open} onClose={onCancel} customHeader={<LoginHeader/>}>
                <div className="p-6 text-center">
                    <h3 className="text-lg font-semibold text-gray-800 dark:text-white">{title}</h3>
                    <p className="text-gray-600 dark:text-gray-300 mt-1">{message}</p>
                    <input type="password" value={pin} onChange={(e) => setPin(e.target.value.replace(/[^0-9]/g, '').slice(0, 4))} maxLength="4" className="mt-4 w-32 text-center text-2xl tracking-[.5em] p-2 rounded-lg border-2 border-gray-400 focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-800 dark:text-white dark:border-gray-500" autoFocus />
                    <div className="mt-6 flex justify-between items-center">
                        <Button variant="secondary" onClick={onCancel}>Cancelar</Button>
                        <a href="#" onClick={(e)=>{e.preventDefault(); onForgotPassword();}} className="text-sm text-blue-600 hover:underline dark:text-blue-400">¿Olvidaste tu PIN?</a>
                        <Button onClick={() => onValidate(pin)} disabled={pin.length !== 4}>Confirmar</Button>
                    </div>
                </div>
            </Modal>
        );
    };
    
    const PinRecoveryModal = ({ open, user, onClose, onRecovered }) => {
        const [formData, setFormData] = React.useState({ initial: '', target: '' });
        const handleChange = (key, value) => {
            setFormData(s => ({ ...s, [key]: value }));
        };
        const recoverPin = () => {
            const initialMatch = parseFloat(formData.initial) === user.profile.startWeight;
            const targetMatch = parseFloat(formData.target) === user.profile.targetWeight;

            if (initialMatch && targetMatch) {
                alert(`¡Datos correctos!\nEl PIN para ${user.profile.name} es: ${user.profile.pin}`);
                onRecovered();
            } else {
                alert('Los datos introducidos no coinciden con los del perfil. Inténtalo de nuevo.');
            }
        };
        if (!open) return null;
        return (
            <Modal open={open} onClose={onClose} customHeader={<LoginHeader/>}>
                <div className="p-6 space-y-4">
                    <h3 className="text-lg font-semibold text-gray-800 dark:text-white text-center">Recuperación de PIN</h3>
                    <p className="text-gray-600 dark:text-gray-300 mt-1 text-center">Para verificar tu identidad, responde a las siguientes preguntas.</p>
                    <Input label="¿Qué peso inicial (kg) registraste?" type="number" step="0.1" value={formData.initial} onChange={(e) => handleChange('initial', e.target.value)} autoFocus />
                    <Input label="¿Cuál es tu peso objetivo (kg)?" type="number" step="0.1" value={formData.target} onChange={(e) => handleChange('target', e.target.value)} />
                    <div className="mt-6 flex justify-end gap-2">
                        <Button variant="secondary" onClick={onClose}>Cancelar</Button>
                        <Button onClick={recoverPin} disabled={!formData.initial || !formData.target}>Verificar y Recuperar</Button>
                    </div>
                </div>
            </Modal>
        );
    };


    // ====================== Componentes de Onboarding y Selección de Usuario ======================
    const ImportUserModal = ({open,onClose,onImport})=>{ const input=React.useRef(null); const handle=(file)=>{ if(!file) return; const reader = new FileReader(); reader.onload=(e)=>{ try{ const data=JSON.parse(e.target.result); if(!data.profile?.name || !data.profile.pin) throw new Error(); data.entries = Array.isArray(data.entries)?data.entries:[]; data.events = Array.isArray(data.events)?data.events:[]; if(!data.profile.createdAt) data.profile.createdAt=new Date().toISOString(); onImport(data); }catch{ alert('Archivo JSON inválido.'); } }; reader.readAsText(file); }; return (<Modal open={open} onClose={onClose} customHeader={<LoginHeader/>}><div className="p-4"><h3 className="text-lg font-semibold text-gray-800 dark:text-white text-center mb-4">Importar usuario desde JSON</h3><div className="rounded-lg border-2 border-dashed border-gray-400 p-8 text-center space-y-3"><p className="text-lg text-gray-800 dark:text-white">Arrastra tu archivo aquí</p><p className="text-sm text-gray-500 dark:text-gray-300">o selecciona desde el explorador</p><Button variant="outline" onClick={()=>input.current.click()}>Seleccionar archivo</Button><input ref={input} type="file" accept=".json,application/json" className="hidden" onChange={(e)=>handle(e.target.files[0])}/></div><div className="mt-4 flex justify-end"><Button variant="secondary" onClick={onClose}>Cancelar</Button></div></div></Modal>); };
 const UserSelect = ({users,onChoose,onCreate,onImport, onDelete})=>{ return (<div className="min-h-screen flex flex-col items-center justify-center p-4 bg-gray-50 dark:bg-gray-800"><Modal open={true} onClose={()=>{}} size="lg" customHeader={<LoginHeader/>}><div className="p-4"><h3 className="text-lg font-semibold text-gray-800 dark:text-white text-center mb-4">Seleccionar usuario</h3><div className="grid grid-cols-1 md:grid-cols-2 gap-4">{users.map((u)=>(<Card key={u.profile.id || u.profile.name} className="cursor-pointer hover:shadow-lg transition" onClick={()=>onChoose(u)}><div className="flex items-start justify-between"><h4 className="text-lg font-semibold text-gray-800 dark:text-white">{u.profile.name}</h4><button className="text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300" onClick={(e)=>{e.stopPropagation(); onDelete(u.profile.id)}} title="Eliminar">🗑</button></div><p className="text-sm text-gray-600 dark:text-gray-300 mt-1">Registros: {u.entries?.length||0}</p></Card>))}</div><div className="mt-4 flex flex-wrap gap-3 justify-end"><Button onClick={onCreate}>Crear nuevo usuario</Button><Button variant="outline" onClick={onImport}>Importar desde JSON</Button></div></div></Modal></div>);};
    const Onboarding = ({onDone,onCancel})=>{ const [form,setForm]=React.useState({name:'', age:'', biology: 'hombre', height:'', startWeight:'', targetWeight:'', pin:'', pin2:'', med1_name:'', med1_dose:'', med1_start:'', med1_freq: '', med2_name:'', med2_dose:'', med2_start:'', med2_freq:'' }); const change = (k,v)=>setForm(s=>({...s,[k]:v})); const submit=()=>{ if(!form.name.trim() || !form.startWeight || !form.targetWeight || form.pin.length!==4 || form.pin!==form.pin2) return alert('Por favor, completa todos los campos requeridos y asegúrate de que los PIN coincidan.'); const data = { profile:{ name:form.name.trim(), age:parseInt(form.age||'0'), biology: form.biology, height:parseInt(form.height||'0'), startWeight:parseFloat(form.startWeight), targetWeight:parseFloat(form.targetWeight), pin:form.pin, createdAt:new Date().toISOString(), dietStartDate:new Date().toISOString(), medication:{name:form.med1_name||'', dose:form.med1_dose||'', startDate:form.med1_start||null, frequency: parseInt(form.med1_freq) || null}, medication2:{name:form.med2_name||'', dose:form.med2_dose||'', startDate:form.med2_start||null, frequency: parseInt(form.med2_freq) || null} }, entries:[], events: [] }; onDone(data); }; return (<div className="min-h-screen flex flex-col items-center justify-center p-4 bg-gray-50 dark:bg-gray-800"><Modal open={true} onClose={onCancel} size="lg" customHeader={<LoginHeader/>}><div className="p-4 space-y-4">{/* La línea del título <h3> ha sido eliminada de aquí */}<div><h4 className="font-semibold mb-2 text-gray-800 dark:text-white">Datos Personales y de Acceso</h4><div className="grid grid-cols-2 md:grid-cols-3 gap-3 border-t-2 pt-3 dark:border-gray-600"><Input containerClassName="col-span-2 md:col-span-1" label="Nombre" value={form.name} onChange={(e)=>change('name',e.target.value)}/><Input containerClassName="col-span-1" label="Edad" type="number" value={form.age} onChange={(e)=>change('age',e.target.value)}/><Select containerClassName="col-span-1" label="Biología" options={[{value:'hombre', label:'Hombre'}, {value:'mujer', label:'Mujer'}]} value={form.biology} onChange={e=>change('biology', e.target.value)}/><Input containerClassName="col-span-1" label="Altura (cm)" type="number" value={form.height} onChange={(e)=>change('height',e.target.value)}/><Input containerClassName="col-span-1" label="Peso inicial (kg)" type="number" step="0.1" value={form.startWeight} onChange={(e)=>change('startWeight',e.target.value)}/><Input containerClassName="col-span-2 md:col-span-1" label="Peso objetivo (kg)" type="number" step="0.1" value={form.targetWeight} onChange={(e)=>change('targetWeight',e.target.value)}/><Input containerClassName="md:col-span-1" label="PIN (4 dígitos)" type="password" maxLength={4} value={form.pin} onChange={(e)=>change('pin',e.target.value.replace(/[^0-9]/g,''))}/><Input containerClassName="md:col-span-2" label="Confirmar PIN" type="password" maxLength={4} value={form.pin2} onChange={(e)=>change('pin2',e.target.value.replace(/[^0-9]/g,''))}/></div></div><div><h4 className="font-semibold mb-2 text-gray-800 dark:text-white">Medicación (Opcional)</h4><div className="space-y-3 border-t-2 pt-3 dark:border-gray-600"><div className="grid grid-cols-2 md:grid-cols-4 gap-3"><Input label="Medicación 1" value={form.med1_name} onChange={(e)=>change('med1_name',e.target.value)}/><Input label="Dosis 1" value={form.med1_dose} onChange={(e)=>change('med1_dose',e.target.value)}/><Input type="date" label="Día de inicio" value={form.med1_start} onChange={(e)=>change('med1_start', e.target.value)}/><Input type="number" label="Cada ___ días" value={form.med1_freq} onChange={(e)=>change('med1_freq', e.target.value)}/></div><div className="grid grid-cols-2 md:grid-cols-4 gap-3"><Input label="Medicación 2" value={form.med2_name} onChange={(e)=>change('med2_name',e.target.value)}/><Input label="Dosis 2" value={form.med2_dose} onChange={(e)=>change('med2_dose',e.target.value)}/><Input type="date" label="Día de inicio" value={form.med2_start} onChange={(e)=>change('med2_start', e.target.value)}/><Input type="number" label="Cada ___ días" value={form.med2_freq} onChange={(e)=>change('med2_freq', e.target.value)}/></div></div></div><div className="mt-4 flex justify-between"><Button variant="secondary" onClick={onCancel}>Cancelar</Button><Button onClick={submit}>Crear</Button></div></div></Modal></div>);};
    // --- Componentes de la App Principal ---

    const EventModal = ({ open, onClose, date, onSave, onDelete, existingEvent, eventType }) => {
      const [type, setType] = React.useState(eventType || 'especial');
      const [frequency, setFrequency] = React.useState('unico');

      React.useEffect(() => {
        if (open) {
          if (existingEvent) {
            setType(existingEvent.type || 'especial');
            setFrequency(existingEvent.frequency || 'unico');
          } else {
            setType(eventType || 'especial');
            setFrequency('unico');
          }
        }
      }, [existingEvent, open, eventType]);

      const handleSubmit = () => {
        const eventData = {
          id: existingEvent ? existingEvent.id : Date.now(),
          date: date,
          type: type,
          frequency: frequency
        };
        onSave(eventData);
        onClose();
      };
      
      const handleDelete = () => {
          onDelete(existingEvent.id);
          onClose();
      };
      
      const eventOptions = [
        { value: 'especial', label: 'Día especial', icon: <StarIcon className="w-6 h-6"/> },
        { value: 'medico', label: 'Visita Médica', icon: <MedicalVisitIcon className="w-6 h-6"/> },
        { value: 'analisis', label: 'Control/análisis', icon: <AnalysisIcon className="w-6 h-6"/> },
        { value: 'bebida', label: 'Batido/infusión', icon: <DrinkIcon className="w-6 h-6"/> }
      ];

      return (
        <Modal open={open} onClose={onClose} size="md">
          <div className="flex items-center justify-between border-b-2 border-gray-300 dark:border-gray-600 p-4">
            <h3 className="text-lg font-semibold text-gray-800 dark:text-white">{existingEvent ? 'Editar Evento' : 'Añadir Evento'} del {new Date(date + 'T00:00:00').toLocaleDateString('es-ES', { day: '2-digit', month: 'long' })}</h3>
            <button onClick={onClose} className="px-2 py-1 rounded hover:bg-gray-100 dark:hover:bg-gray-600">✕</button>
          </div>
          <div className="p-4 space-y-4">
            <div>
              <label className="text-sm font-medium text-gray-700 dark:text-gray-300">Tipo de Evento</label>
              <div className="grid grid-cols-2 gap-2 mt-1">
                {eventOptions.map(opt => (
                  <button key={opt.value} onClick={() => setType(opt.value)} className={`flex items-center gap-3 p-3 rounded-lg border-2 transition ${type === opt.value ? 'bg-blue-100 dark:bg-blue-900 border-blue-500' : 'bg-gray-50 dark:bg-gray-800 border-gray-400 dark:border-gray-600'}`}>
                    {opt.icon}
                    <span className="font-semibold text-gray-800 dark:text-gray-100">{opt.label}</span>
                  </button>
                ))}
              </div>
            </div>
            <Select label="Frecuencia del Evento" value={frequency} onChange={e => setFrequency(e.target.value)}
              options={[
                { value: 'unico', label: 'Evento único' },
                { value: 'diario', label: 'Diario' },
                { value: 'semanal', label: 'Semanal' },
                { value: 'quincenal', label: 'Quincenal' },
                { value: 'mensual', label: 'Mensual' },
              ]}
            />
            <div className="flex justify-between items-center gap-2 pt-2">
              {existingEvent ? <Button variant="danger" onClick={handleDelete} type="button">Eliminar</Button> : <div/>}
              <div className="flex gap-2">
                <Button variant="secondary" onClick={onClose}>Cancelar</Button>
                <Button onClick={handleSubmit}>Guardar</Button>
              </div>
            </div>
          </div>
        </Modal>
      );
    };

    const DayModal = ({open, onClose, date, data, onSave, onDelete, onOpenEventModal})=>{
      const [form,setForm]=React.useState({weight:'', glucose:'', exerciseTime:'0min', exerciseType: 'fuerza', sleep:'7h', fasting:'0h', diet:'correcta', water:'1.5L'});
      const [showConverter, setShowConverter] = React.useState(false);
      const [mmolValue, setMmolValue] = React.useState('');
      const isExistingEntry = React.useMemo(() => data.entries.some(e => e.date === date), [open, date, data.entries]);
      const modalRef = React.useRef(null);

       React.useEffect(() => {
        if (showConverter) {
            const timer = setTimeout(() => {
                setShowConverter(false);
            }, 8000);
            return () => clearTimeout(timer);
        }
      }, [showConverter]);

      React.useEffect(()=>{
        if(!open || !date) return;
        setShowConverter(false);
        setMmolValue('');
        const sameDay = data.entries.find(e=>e.date===date);
        if (sameDay) {
            setForm({
                weight: sameDay.weight ?? '',
                glucose: sameDay.glucose ?? '',
                exerciseTime: sameDay.exerciseTime || '0min',
                exerciseType: sameDay.exerciseType || 'fuerza',
                sleep: sameDay.sleep || '7h',
                fasting: sameDay.fasting || '0h',
                diet: sameDay.diet || 'correcta',
                water: sameDay.water || '1.5L'
            });
        } else {
            const yesterday = new Date(new Date(date + 'T00:00:00').setDate(new Date(date + 'T00:00:00').getDate() - 1));
            const prevDay = data.entries
                .filter(e => new Date(e.date + 'T00:00:00') <= yesterday)
                .sort((a, b) => new Date(b.date) - new Date(a.date))[0];

            setForm({
                weight: prevDay?.weight ?? '',
                glucose: prevDay?.glucose ?? '',
                exerciseTime: '0min',
                exerciseType: 'fuerza',
                sleep: '7h',
                fasting: '0h',
                diet: 'correcta',
                water: '1.5L'
            });
        }
    }, [open, date, data]);
      
      const change=(k,v)=>setForm(s=>({...s,[k]:v}));
      const submit=(e)=>{ e.preventDefault(); onSave(date,{ ...form, weight: form.weight!=='' ? parseFloat(form.weight) : null, glucose: form.glucose!=='' ? parseFloat(form.glucose) : null }); onClose(); };
      const handleDelete = () => { onDelete(date); onClose(); };
      
      const handleMmolChange = (e) => {
          const mmol = e.target.value;
          setMmolValue(mmol);
          if (mmol && !isNaN(mmol)) {
              const mgdl = Math.round(parseFloat(mmol) * 18.018 * 2) / 2;
              change('glucose', mgdl);
          } else {
              change('glucose', '');
          }
      };

      const eventOptions = [
        { value: 'especial', label: 'Día especial', icon: <StarIcon className="w-6 h-6"/> },
        { value: 'medico', label: 'Visita Médica', icon: <MedicalVisitIcon className="w-6 h-6"/> },
        { value: 'analisis', label: 'Análisis', icon: <AnalysisIcon className="w-6 h-6"/> },
        { value: 'bebida', label: 'Batido/Infusión', icon: <DrinkIcon className="w-6 h-6"/> }
      ];

      return (<Modal open={open} onClose={onClose} size="lg">
        <div ref={modalRef} onClick={() => {if(showConverter) setShowConverter(false)}}>
          <div className="flex items-center justify-between border-b-2 border-gray-300 dark:border-gray-600 p-4">
              <h3 className="text-lg font-semibold text-gray-800 dark:text-white">{`Registro del ${new Date(date+'T00:00:00').toLocaleDateString('es-ES',{weekday:'long',day:'2-digit',month:'long'})}`}</h3>
              <button onClick={onClose} className="px-2 py-1 rounded hover:bg-gray-100 dark:hover:bg-gray-600">✕</button>
          </div>
          <div className="p-4">
              <form onSubmit={submit} className="space-y-4">
                <div className="grid grid-cols-2 gap-4">
                    <Input label="Peso (kg)" type="number" step="0.1" value={form.weight} onChange={(e)=>change('weight',e.target.value)}/>
                    <div>
                      <div className="flex justify-between items-center mb-1">
                          <label className="text-sm font-medium text-gray-700 dark:text-gray-300">Glucosa</label>
                          <button type="button" onClick={(e) => {e.stopPropagation(); setShowConverter(s => !s)}} className="text-xs text-blue-600 dark:text-blue-400 hover:underline px-2 py-1 border border-gray-400 dark:border-gray-500 rounded-md">mmol/L ↔ mg/dL</button>
                      </div>
                      <div className="relative flex items-center w-full px-3 py-2 rounded-lg border-2 border-gray-400 focus-within:ring-2 focus-within:ring-blue-500 focus-within:border-transparent dark:bg-gray-800 dark:border-gray-500">
                          <input type="number" value={form.glucose} onChange={(e) => change('glucose', e.target.value)} className="w-full bg-transparent outline-none dark:text-white" />
                          <span className="text-gray-500 dark:text-gray-400">mg/dl</span>
                      </div>
                    </div>
                </div>
                <div className="relative grid grid-cols-2 gap-4">
                    <Select label="Tiempo de Ejercicio" options={EXERCISE_TIME} value={form.exerciseTime} onChange={(e)=>change('exerciseTime',e.target.value)}/>
                    <div className="relative">
                        <Select label="Tipo de Ejercicio" options={EXERCISE_TYPE} value={form.exerciseType} onChange={(e)=>change('exerciseType',e.target.value)}/>
                        {showConverter && (
                          <div onClick={e => e.stopPropagation()} className="absolute top-0 left-0 w-full h-full bg-gray-100 dark:bg-gray-800 p-3 rounded-lg shadow-xl z-10 border-2 border-blue-500 flex flex-col justify-start">
                            <div className="flex items-start gap-2">
                                <Input containerClassName="flex-grow" label="Glucosa (mmol/L)" type="number" step="0.1" value={mmolValue} onChange={handleMmolChange} autoFocus />
                                <Button variant="secondary" className="mt-auto border-2 border-blue-500" onClick={()=>setShowConverter(false)}>OK</Button>
                            </div>
                          </div>
                        )}
                    </div>
                </div>
                <div className="grid grid-cols-2 gap-4">
                  <Select label="Consumo de agua" options={WATER} value={form.water} onChange={(e)=>change('water',e.target.value)}/>
                  <Select label="Horas de sueño" options={SLEEP} value={form.sleep} onChange={(e)=>change('sleep',e.target.value)}/>
                </div>
                <div className="grid grid-cols-2 gap-4">
                    <Select label="Calidad de la dieta" options={DIET} value={form.diet} onChange={(e)=>change('diet',e.target.value)}/>
                    <Select label="Tipo de ayuno" options={FASTING} value={form.fasting} onChange={(e)=>change('fasting',e.target.value)}/>
                </div>
                
                <div className="pt-4 border-t-2 dark:border-gray-600">
                  <label className="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2 block">Añadir o ver eventos</label>
                  <div className="grid grid-cols-2 sm:grid-cols-4 gap-2">
                      {eventOptions.map(opt => (
                        <Button key={opt.value} variant="outline" type="button" onClick={() => onOpenEventModal(opt.value)} className="flex-col h-20">
                            {opt.icon}
                            <span className="text-xs text-center">{opt.label}</span>
                        </Button>
                      ))}
                  </div>
                </div>

                <div className="flex justify-between items-center gap-2 pt-4">
                    {isExistingEntry ? <Button variant="danger" onClick={handleDelete} type="button">Eliminar Registro</Button> : <div></div>}
                    <div className="flex gap-2">
                        <Button variant="secondary" onClick={onClose}>Cancelar</Button>
                        <Button type="submit">Guardar</Button>
                    </div>
                </div>
              </form>
          </div>
        </div>
      </Modal>);
    };

    const CalendarView = ({user, setUser, date, calendarRef})=>{
      const [dayModalDate, setDayModalDate] = React.useState(null);
      const [eventModal, setEventModal] = React.useState({ open: false, date: null, type: null, existing: null });

      // ========= INICIO DE LA LÓGICA DE AUTO-SCROLL MEJORADA =========
      React.useEffect(() => {
          // No hacemos nada si no hay ref, si no es móvil, o si no hay usuario
          if (!calendarRef.current || window.innerWidth >= 640 || !user) {
              return;
          }

          const lastEntry = user.entries?.slice().sort((a, b) => new Date(a.date) - new Date(b.date)).pop();
          let targetDate;

          if (lastEntry) {
              const lastRegisteredDate = new Date(lastEntry.date + 'T00:00:00');
              const nextDayToRegister = new Date(lastRegisteredDate);
              nextDayToRegister.setDate(lastRegisteredDate.getDate() + 1);
              
              if (nextDayToRegister <= new Date()) {
                  targetDate = nextDayToRegister;
              } else {
                  targetDate = lastRegisteredDate;
              }
          } else {
              targetDate = new Date();
          }

          const dateToScrollString = fmt(targetDate);
          const targetElement = calendarRef.current.querySelector(`button[data-date="${dateToScrollString}"]`);

          if (targetElement) {
              setTimeout(() => {
                  targetElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
              }, 150); // Un retardo ligeramente mayor para máxima compatibilidad
          }
      }, [user, date]); // Se ejecuta cuando los datos del usuario o el mes visible cambian
      // ========= FIN DE LA LÓGICA DE AUTO-SCROLL =========

      const handleOpenEventModal = (dayStr, eventType = null) => {
          const dayEvents = getEventsForDay(new Date(dayStr + 'T00:00:00'));
          const existing = eventType ? dayEvents.find(e => e.type === eventType) : dayEvents[0];
          setDayModalDate(null);
          setEventModal({ open: true, date: dayStr, type: eventType, existing: existing });
      };
      
      const saveEntry=(d,p)=>{ const e=[...user.entries]; const i=e.findIndex(x=>x.date===d); const nE={...(e[i]||{}),date:d,...p}; if(i>=0)e[i]=nE; else e.push(nE); e.sort((a,b)=>new Date(a.date)-new Date(b.date)); setUser({...user,entries:e}); };
      const removeEntry=(d)=>{ const updatedEntries = user.entries.filter(e => e.date !== d); setUser({...user, entries: updatedEntries}); };
      
      const saveEvent = (eventData) => {
        const events = [...(user.events || [])];
        const index = events.findIndex(e => e.id === eventData.id);
        if (index > -1) {
            events[index] = eventData;
        } else {
            events.push(eventData);
        }
        setUser({ ...user, events });
      };

      const deleteEvent = (eventId) => {
        const events = (user.events || []).filter(e => e.id !== eventId);
        setUser({ ...user, events });
      };
      
      const isMedicationDay = (day, med) => {
          if (!med || !med.name || !med.frequency || !med.startDate) return false;
          const startDate = new Date(med.startDate + 'T00:00:00');
          const currentDay = new Date(day);
          currentDay.setHours(0,0,0,0);
          if (currentDay < startDate) return false;
          const diffTime = Math.abs(currentDay - startDate);
          const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
          return diffDays % med.frequency === 0;
      };

      const getEventsForDay = (day) => {
        const events = user.events || [];
        const dayOfWeek = day.getDay();
        const dateOfMonth = day.getDate();
        const dayDate = new Date(day);
        dayDate.setHours(0,0,0,0);

        return events.filter(event => {
            const eventDate = new Date(event.date + 'T00:00:00');
            switch (event.frequency) {
                case 'unico': return event.date === fmt(day);
                case 'diario': return dayDate >= eventDate;
                case 'semanal': return dayDate >= eventDate && dayOfWeek === eventDate.getDay();
                case 'quincenal':
                    if (dayDate < eventDate) return false;
                    const diffTime = Math.abs(dayDate - eventDate);
                    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                    return diffDays % 14 === 0;
                case 'mensual': return dayDate >= eventDate && dateOfMonth === eventDate.getDate();
                default: return false;
            }
        });
      };

      const firstOfMonth = new Date(date.getFullYear(), date.getMonth(), 1);
      const lastOfMonth = new Date(date.getFullYear(), date.getMonth() + 1, 0);
      const firstDayOfWeek = (firstOfMonth.getDay() + 6) % 7;
      const calendarStart = new Date(firstOfMonth);
      calendarStart.setDate(firstOfMonth.getDate() - firstDayOfWeek);
      const lastDayOfWeek = (lastOfMonth.getDay() + 6) % 7;
      const calendarEnd = new Date(lastOfMonth);
      calendarEnd.setDate(lastOfMonth.getDate() + (6 - lastDayOfWeek));

      const days = [];
      for (let d = new Date(calendarStart); d <= calendarEnd; d.setDate(d.getDate() + 1)) {
          days.push(new Date(d));
      }
      
      const WeeklyLossAnnotation = ({ day, entries, profile, isMobile=false }) => {
        if (day.getDay() !== 0) return null; // Only for Sundays
        const allEntriesSorted = [...entries].sort((a, b) => new Date(a.date) - new Date(b.date));
        if (allEntriesSorted.length < 1) return null;
        
        const firstEntryDate = new Date(allEntriesSorted[0].date + 'T00:00:00');
        const thisSunday = new Date(day);
        thisSunday.setHours(23, 59, 59, 999);
        
        if (thisSunday < firstEntryDate) return null;
        
        const lastEntryThisWeek = allEntriesSorted.filter(e => e.weight != null && new Date(e.date + 'T00:00:00') <= thisSunday).pop();
        if (!lastEntryThisWeek) return null;
        
        const previousSunday = new Date(thisSunday);
        previousSunday.setDate(thisSunday.getDate() - 7);
        
        let weightToCompare;
        if (previousSunday < firstEntryDate) {
            weightToCompare = profile.startWeight;
        } else {
            const lastEntryPrevWeek = allEntriesSorted.filter(e => e.weight != null && new Date(e.date + 'T00:00:00') <= previousSunday).pop();
            weightToCompare = lastEntryPrevWeek ? lastEntryPrevWeek.weight : profile.startWeight;
        }

        const currentWeight = lastEntryThisWeek.weight;
        const totalChange = currentWeight - weightToCompare;

        if (Math.abs(totalChange) < 0.05) return null;
        
        const symbol = totalChange < 0 ? "-" : "+";
        const value = Math.abs(totalChange).toFixed(1).replace('.', ',');

        if (isMobile) {
            return (
                <div className="absolute top-2 right-2 flex items-center justify-center w-12 h-12 rounded-full border-2 border-red-500 bg-white/50 dark:bg-black/50">
                    <span className="font-handwriting text-black dark:text-white text-2xl font-bold">{symbol}{value}</span>
                </div>
            );
        }
        
        return (
            <div className="absolute top-1 right-1 w-12 h-12 flex items-center justify-center pointer-events-none">
                <svg viewBox="0 0 100 100" className="absolute w-full h-full">
                    <path d="M 50,5 A 45,45 0 1,1 49.9,5.01 Z" stroke="#dc2626" strokeWidth="4" fill="none" transform="rotate(-15 50 50)" />
                </svg>
                <span className="font-handwriting text-black dark:text-white text-xl font-bold z-10">{symbol}{value}</span>
            </div>
        );
      };

      return(<div className="space-y-4" ref={calendarRef}>
        <div className="hidden sm:block"> {/* Desktop Calendar */}
            <Card>
                <div className="grid grid-cols-7 gap-1 md:gap-2">
                    {days.map((d,i)=>{ 
                        const isCurrentMonth = d.getMonth() === date.getMonth();
                        const dayString = fmt(d);
                        const entry = user.entries.find(e=>e.date===dayString); 
                        const prevEntry = user.entries.filter(e=>e.weight!=null&&e.date<dayString).pop(); 
                        const diff = entry?.weight!=null&&prevEntry?.weight!=null?entry.weight-prevEntry.weight:null; 
                        const eventsOnDay = getEventsForDay(d);
                        const specialEvent = eventsOnDay.find(e => e.type === 'especial');
                        const otherEvents = eventsOnDay.filter(e => e.type !== 'especial');
                        const weekdayAbbr = d.toLocaleString('es-ES', { weekday: 'short' }).replace('.', '');

                        const iconPriority = { 'injection': 6, 'exercise': 5, 'pill': 4, 'medico': 3, 'analisis': 2, 'bebida': 1 };
                        let allIcons = [];

                        if (isMedicationDay(d, user.profile.medication)) { allIcons.push({ key: 'med1', type: 'injection' }); }
                        if (isMedicationDay(d, user.profile.medication2)) { allIcons.push({ key: 'med2', type: 'pill' }); }
                        if (entry?.exerciseTime && entry.exerciseTime !== '0min') { allIcons.push({ key: 'exercise', type: 'exercise', data: entry }); }
                        otherEvents.forEach(e => { if(!allIcons.some(ic => ic.type === e.type)) allIcons.push({ key: e.id, type: e.type }); });

                        const sortedIcons = allIcons.sort((a,b) => (iconPriority[b.type] || 0) - (iconPriority[a.type] || 0));

                        return(
                            <button key={i} data-date={dayString} onClick={()=>setDayModalDate(dayString)} className={`relative rounded-lg calendar-cell p-2 text-left hover:shadow-lg transition-all duration-200 flex flex-col items-start justify-start min-h-[9rem] ${dayString===fmt(new Date())?'ring-2 ring-blue-500 border-blue-500':''} ${!isCurrentMonth ? 'opacity-60 hover:opacity-100' : ''}`}>
                                 <div className="flex items-center justify-between w-full gap-1">
                                    <span className="text-sm font-medium text-gray-700 dark:text-gray-200">{weekdayAbbr} {d.getDate()}</span>
                                    <div className={`flex items-center gap-1 ${d.getDay() === 0 && specialEvent ? 'mr-12' : ''}`}>
                                        {specialEvent && <StarIcon className="w-6 h-6"/>}
                                    </div>
                                </div>
                                
                                <div className="w-full flex-grow flex flex-col justify-center mt-1">
                                    {entry?.weight!=null && (
                                        <>
                                            <div className="text-2xl font-bold text-gray-800 dark:text-white leading-5">{entry.weight.toFixed(1)} kg</div>
                                            {diff!=null && <div className={`text-sm font-semibold ${diff<0?'text-green-600':(diff>0?'text-red-600':'text-gray-500')}`}>{diff<0?'▼':(diff>0?'▲':'▬')} {Math.abs(diff).toFixed(1)} kg</div>}
                                        </>
                                    )}
                                </div>
                                
                                <div className="w-full mt-auto flex flex-row-reverse flex-wrap-reverse items-end justify-start gap-x-1 gap-y-0.5">
                                    {sortedIcons.slice(0, 6).map((icon) => {
                                        let iconEl;
                                        const themedClass = "w-6 h-6 text-gray-800 dark:text-white";
                                        const themedClassAnaerobic = "w-8 h-8 text-gray-800 dark:text-white";
                                        
                                        switch (icon.type) {
                                            case 'injection': iconEl = <InjectionIcon className="w-6 h-6"/>; break;
                                            case 'pill': iconEl = <PillIcon className="w-6 h-6"/>; break;
                                            case 'exercise': iconEl = (
                                                <div className="flex items-center gap-1">
                                                    <span className="text-xs font-semibold text-gray-800 dark:text-white">{EXERCISE_TIME.find(opt => opt.value === icon.data.exerciseTime)?.label || ''}</span>
                                                    {icon.data.exerciseType === 'anaerobico' ? <AnaerobicIcon className={themedClassAnaerobic}/> : <WeightlifterIcon className={themedClass}/>}
                                                </div>
                                            ); break;
                                            case 'medico': iconEl = <MedicalVisitIcon className={themedClass}/>; break;
                                            case 'analisis': iconEl = <AnalysisIcon className={themedClass}/>; break;
                                            case 'bebida': iconEl = <DrinkIcon className={themedClass}/>; break;
                                            default: iconEl = null;
                                        }
                                        return <div key={icon.key}>{iconEl}</div>;
                                    })}
                                </div>
                                <WeeklyLossAnnotation day={d} entries={user.entries} profile={user.profile} isMobile={false} />
                            </button>
                        );
                    })}
                </div>
            </Card>
        </div>
        
        <div className="sm:hidden space-y-2"> {/* Mobile Calendar */}
             {days.map((d, i) => {
                const isCurrentMonth = d.getMonth() === date.getMonth();
                if (!isCurrentMonth) return null;

                const dayString = fmt(d);
                const entry = user.entries.find(e => e.date === dayString);
                const prevEntry = user.entries.filter(e => e.weight != null && e.date < dayString).pop();
                const diff = entry?.weight != null && prevEntry?.weight != null ? entry.weight - prevEntry.weight : null;
                const eventsOnDay = getEventsForDay(d);
                const specialEvent = eventsOnDay.find(e => e.type === 'especial');
                const otherEvents = eventsOnDay.filter(e => e.type !== 'especial');
                const weekdayAbbr = d.toLocaleDateString('es-ES', { weekday: 'short' }).replace('.', '');
                
                const hasIcons = isMedicationDay(d, user.profile.medication) || isMedicationDay(d, user.profile.medication2) || (entry?.exerciseTime && entry.exerciseTime !== '0min') || otherEvents.length > 0;
                const isSundayWithIcons = d.getDay() === 0 && hasIcons;

                const iconPriority = { 'injection': 6, 'exercise': 5, 'pill': 4, 'medico': 3, 'analisis': 2, 'bebida': 1 };
                let allIcons = [];
                if (isMedicationDay(d, user.profile.medication)) { allIcons.push({ key: 'med1', type: 'injection' }); }
                if (isMedicationDay(d, user.profile.medication2)) { allIcons.push({ key: 'med2', type: 'pill' }); }
                if (entry?.exerciseTime && entry.exerciseTime !== '0min') { allIcons.push({ key: 'exercise', type: 'exercise', data: entry }); }
                otherEvents.forEach(e => { if(!allIcons.some(ic => ic.type === e.type)) allIcons.push({ key: e.id, type: e.type }); });
                const sortedIcons = allIcons.sort((a,b) => (iconPriority[b.type] || 0) - (iconPriority[a.type] || 0));

                return (
                    <button key={i} data-date={dayString} onClick={() => setDayModalDate(dayString)} className={`relative w-full rounded-lg calendar-cell p-3 text-left hover:shadow-lg transition-all duration-200 flex items-center justify-between ${dayString === fmt(new Date()) ? 'ring-2 ring-blue-500 border-blue-500' : ''} ${isSundayWithIcons ? 'min-h-[6.5rem]' : 'min-h-[4.5rem]'}`}>
                        <div className="flex items-center gap-4">
                            <div className="flex flex-col items-center justify-center w-12 text-center">
                                <span className="text-xs font-bold uppercase text-gray-600 dark:text-gray-300">{weekdayAbbr}</span>
                                <span className="text-2xl font-bold leading-none text-gray-700 dark:text-white">{d.getDate()}</span>
                            </div>

                            <div>
                                {entry?.weight != null && (
                                    <div className="flex items-center gap-2">
                                        <div>
                                            <div className="flex items-baseline gap-2">
                                                <span className="text-2xl font-bold text-gray-800 dark:text-white">{entry.weight.toFixed(1)} kg</span>
                                                {specialEvent && <StarIcon className="w-6 h-6"/>}
                                            </div>
                                            {diff != null && (
                                                <div className={`text-base font-semibold ${diff < 0 ? 'text-green-600' : (diff > 0 ? 'text-red-600' : 'text-gray-500')}`}>
                                                    {diff < 0 ? '▼' : (diff > 0 ? '▲' : '▬')} {Math.abs(diff).toFixed(1)} kg
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                )}
                                {(!entry || entry.weight == null) && specialEvent && (
                                    <StarIcon className="w-7 h-7"/>
                                )}
                            </div>
                        </div>
                        
                        <div className="absolute bottom-2 right-2 flex flex-row-reverse flex-wrap-reverse items-end justify-start gap-2" style={{maxWidth: isSundayWithIcons ? 'calc(100% - 9rem)' : 'calc(100% - 5rem)' }}>
                            {sortedIcons.map((icon) => {
                                let iconEl;
                                const themedClass = "w-7 h-7 text-gray-800 dark:text-white";
                                const themedClassAnaerobic = "w-8 h-8 text-gray-800 dark:text-white";
                                
                                switch (icon.type) {
                                    case 'injection': iconEl = <InjectionIcon className="w-7 h-7"/>; break;
                                    case 'pill': iconEl = <PillIcon className="w-7 h-7"/>; break;
                                    case 'exercise': iconEl = (
                                        <div className="flex items-center gap-1">
                                            <span className="text-xs font-semibold text-gray-800 dark:text-white">{EXERCISE_TIME.find(opt => opt.value === icon.data.exerciseTime)?.label || ''}</span>
                                            {icon.data.exerciseType === 'anaerobico' ? <AnaerobicIcon className={themedClassAnaerobic}/> : <WeightlifterIcon className={themedClass}/>}
                                        </div>
                                    ); break;
                                    case 'medico': iconEl = <MedicalVisitIcon className={themedClass}/>; break;
                                    case 'analisis': iconEl = <AnalysisIcon className={themedClass}/>; break;
                                    case 'bebida': iconEl = <DrinkIcon className={themedClass}/>; break;
                                    default: iconEl = null;
                                }
                                return <div key={icon.key}>{iconEl}</div>;
                            })}
                        </div>
                        <WeeklyLossAnnotation day={d} entries={user.entries} profile={user.profile} isMobile={true} />
                    </button>
                );
            })}
        </div>

        {dayModalDate && <DayModal open={!!dayModalDate} onClose={()=>setDayModalDate(null)} date={dayModalDate} data={user} onSave={saveEntry} onDelete={removeEntry} onOpenEventModal={(type) => handleOpenEventModal(dayModalDate, type)} />}
        {eventModal.open && <EventModal open={eventModal.open} onClose={() => setEventModal({ open: false, date: null, type: null, existing: null })} date={eventModal.date} onSave={saveEvent} onDelete={deleteEvent} existingEvent={eventModal.existing} eventType={eventModal.type} />}
      </div>);
    };

    const MilestoneIndicator = ({label, position}) => (
      <div className="absolute transition-transform duration-500" style={{top: 'calc(100% + 0.5rem)', left: `${position}%`, transform: 'translateX(-50%)'}}>
        <div className="relative flex flex-col items-center">
          <div className="mb-1 w-0 h-0 border-l-4 border-r-4 border-b-4 border-l-transparent border-r-transparent border-b-gray-700 dark:border-b-gray-300"></div>
          <span className="px-2 py-0.5 bg-gray-700 text-white dark:bg-gray-300 dark:text-black text-xs font-bold rounded-md shadow-lg">{label}</span>
        </div>
      </div>
    );

    const ProgressView = ({user, scenario})=>{
      const proj = calculateProjectionScenarios(user);
      const feedback = generateDailyFeedback(user, {});
      const {startWeight:firstW, targetWeight} = user.profile;
      const allEntriesSorted = (user.entries || []).slice().sort((a,b)=>new Date(a.date)-new Date(b.date));
      const lastW=(allEntriesSorted.filter(e=>e.weight!=null).pop()?.weight)??firstW;
      const totalToLose=Math.max(0,firstW-targetWeight);
      const lost=Math.max(0,firstW-lastW);
      const pct=totalToLose>0?Math.min(100,(lost/totalToLose)*100):0;
      const target80_kg = (firstW - (totalToLose * 0.8)).toFixed(1);
      
      const avgWater=allEntriesSorted.length?(allEntriesSorted.reduce((a,e)=>a+waterLiters(e.water),0)/allEntriesSorted.length):0;
      const avgSleep=allEntriesSorted.length?(allEntriesSorted.reduce((a,e)=>a+sleepHours(e.sleep),0)/allEntriesSorted.length):0;
      
      const avgExWeek = React.useMemo(() => {
        if (allEntriesSorted.length < 2) return 0;
        const firstDate = new Date(allEntriesSorted[0].date);
        const lastDate = new Date(allEntriesSorted[allEntriesSorted.length - 1].date);
        const totalDaysSpan = ((lastDate - firstDate) / 86400000) + 1;
        if (totalDaysSpan <= 0) return 0;
        const totalExerciseHours = allEntriesSorted.reduce((acc, entry) => acc + exerciseHours(entry.exerciseTime || '0min'), 0);
        const dailyAverage = totalExerciseHours / totalDaysSpan;
        return dailyAverage * 7;
      }, [allEntriesSorted]);
      
      const h=user.profile.height/100;
      const currentProjection = proj.results ? proj.results[scenario] : null;

      return(<div className="space-y-4">
        <Card className="p-6">
          {feedback.globalMessage && <div className="mb-4 text-center text-4xl font-handwriting text-gray-800 dark:text-gray-100 bg-gray-100 dark:bg-gray-600/50 p-4 rounded-lg">{feedback.globalMessage}</div>}
          
          <div className="relative pt-8 pb-12 px-4">
            {pct > 0 && <div className="absolute top-0 transition-transform duration-500" style={{left: `${pct}%`, transform: 'translateX(-50%)'}}>
              <div className="relative flex flex-col items-center">
                <span className="px-2 py-0.5 bg-black dark:bg-white text-white dark:text-black text-sm font-bold rounded-md shadow-lg">{pct.toFixed(1)}%</span>
                <div className="mt-1 w-0 h-0 border-l-4 border-r-4 border-t-4 border-l-transparent border-r-transparent border-t-black dark:border-t-white"></div>
              </div>
            </div>}
            <div className="relative">
                <div className="w-full h-8 bg-gray-200 dark:bg-gray-600 rounded-full border-2 border-gray-400 dark:border-gray-500 shadow-inner overflow-hidden">
                    <div className="h-full transition-all duration-500 rounded-full" style={{width: `${pct}%`, background: 'linear-gradient(90deg, #06b6d4 0%, #3b82f6 100%)'}}></div>
                </div>
                <MilestoneIndicator label="80%" position={80} />
                <MilestoneIndicator label="100%" position={100} />
            </div>
          </div>
          
          {feedback.actionMessages && feedback.actionMessages.length > 0 && <div className="mt-4 text-center text-3xl font-handwriting text-gray-700 dark:text-gray-200 bg-gray-100 dark:bg-gray-600/50 p-4 rounded-lg">{feedback.actionMessages.join(' • ')}</div>}
        </Card>

        <div className="grid grid-cols-1 md:grid-cols-10 gap-4">
          <Card className="col-span-10 md:col-span-7 p-3 text-center">
            <div className="text-sm font-semibold text-gray-700 dark:text-gray-200">Objetivo intermedio <span className="font-bold text-blue-600 dark:text-blue-400">{target80_kg} kg</span> (80%)</div>
            {currentProjection ? (<>
              <div className="text-2xl font-bold text-gray-800 dark:text-white mt-1">{new Date(currentProjection.eta80).toLocaleDateString('es-ES',{day:'2-digit',month:'long', year:'numeric'})}</div>
              <div className="text-xs text-gray-500 dark:text-gray-400">Estimado en {humanizeDays(currentProjection.daysTo80)}</div>
            </>) : <div className="text-lg text-gray-500 mt-2">{proj.message || 'Calculando...'}</div>}
          </Card>
          <Card className="col-span-10 md:col-span-3 p-3 text-center">
            <div className="text-sm font-semibold text-gray-700 dark:text-gray-200">Objetivo final <span className="font-bold text-green-600 dark:text-green-400">{targetWeight} kg</span></div>
            {currentProjection ? (<>
              <div className="text-2xl font-bold text-gray-800 dark:text-white mt-1">{new Date(currentProjection.etaFinal).toLocaleDateString('es-ES',{day:'2-digit',month:'long', year:'numeric'})}</div>
              <div className="text-xs text-gray-500 dark:text-gray-400">Estimado en {humanizeDays(currentProjection.daysToFinal)}</div>
            </>) : <div className="text-lg text-gray-500 mt-2">{proj.message || 'Calculando...'}</div>}
          </Card>
        </div>

        <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
          <Card className="text-center"><div className="text-sm text-gray-600 dark:text-gray-300">Peso perdido</div><div className="text-3xl font-bold text-gray-800 dark:text-white">{lost.toFixed(1)} kg</div><div className="text-xs text-gray-500 dark:text-gray-400 mt-1">Actual: {lastW.toFixed(1)} kg</div></Card>
          <Card className="text-center"><div className="text-sm text-gray-600 dark:text-gray-300">Peso restante</div><div className="text-3xl font-bold text-gray-800 dark:text-white">{(Math.max(0,lastW-targetWeight)).toFixed(1)} kg</div><div className="text-xs text-gray-500 dark:text-gray-400 mt-1">Objetivo: {targetWeight} kg</div></Card>
          <Card className="text-center"><div className="text-sm text-gray-600 dark:text-gray-300">IMC</div><div className="text-2xl font-bold text-gray-800 dark:text-white">{h>0?`${(firstW/(h*h)).toFixed(1)} → ${(lastW/(h*h)).toFixed(1)}`:'N/A'}</div><div className="text-xs text-gray-500 dark:text-gray-400 mt-1">Obj: {h>0 ? (targetWeight/(h*h)).toFixed(1) : 'N/A'}</div></Card>
          <Card className="text-center"><div className="text-sm text-gray-600 dark:text-gray-300">Media de agua</div><div className="text-2xl font-bold text-gray-800 dark:text-white">{avgWater.toFixed(2)} L</div></Card>
          <Card className="text-center"><div className="text-sm text-gray-600 dark:text-gray-300">Media de sueño</div><div className="text-2xl font-bold text-gray-800 dark:text-white">{avgSleep.toFixed(1)} h</div></Card>
          <Card className="text-center"><div className="text-sm text-gray-600 dark:text-gray-300">Ejercicio semanal</div><div className="text-2xl font-bold text-gray-800 dark:text-white">{avgExWeek.toFixed(1)} h</div></Card>
        </div>
      </div>); 
    };
    
    const ChartsView = ({user, theme})=>{ 
        const refs=[React.useRef(null),React.useRef(null),React.useRef(null),React.useRef(null)]; 
        React.useEffect(()=>{ 
            const charts=[]; 
            const destroy=()=>charts.forEach(c=>c.destroy()); 
            destroy(); 
            const entries=user.entries.slice().sort((a,b)=>new Date(a.date)-new Date(b.date));
            if(entries.length === 0) return;

            const chartEntries = entries.slice(-12);
            const dietMap = { 'estricta': 1, 'correcta': 2, 'incorrecta': 3, 'mala': 4 };
            const dietColors = { 'estricta': 'rgba(34, 197, 94, 0.35)', 'correcta': 'rgba(59, 130, 246, 0.35)', 'incorrecta': 'rgba(245, 158, 11, 0.35)', 'mala': 'rgba(239, 68, 68, 0.35)' };
            
            const weightsData = chartEntries.map(e => e.weight);
            const shiftedWeights = chartEntries.length > 0 ? [...weightsData.slice(1), null] : [];

            const visibleWeights = weightsData.filter(w => w != null);
            const minWeight = visibleWeights.length ? Math.min(...visibleWeights) : null;
            const maxWeight = visibleWeights.length ? Math.max(...visibleWeights) : null;

            const weights=entries.filter(e=>e.weight!=null); 
            const gluc=entries.filter(e=>e.glucose!=null); 
            const ctxs=refs.map(r=>r.current?.getContext('2d')); 
            const isDark = theme === 'dark';
            const axisColor = isDark ? '#FFFFFF' : '#1f2937';
            const gridColor = isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)'; 
            const commonOptions = { responsive:true, maintainAspectRatio:false, interaction:{ intersect:false, mode:'index'}, plugins:{legend:{labels:{color:axisColor}}}, scales:{x:{ticks:{color:axisColor}, grid:{color:gridColor}}, y:{ticks:{color:axisColor}, grid:{color:gridColor}}} }; 
            
            if(chartEntries.length&&ctxs[0]){ 
                const labels = chartEntries.map(e => e.date);
                charts.push(new Chart(ctxs[0],{type:'bar', data:{ labels, datasets:[ 
                    {type: 'line', label:'Peso(kg)', yAxisID:'y', data: shiftedWeights, borderColor: isDark ? 'rgba(255, 255, 255, 0.9)' : 'rgba(0, 0, 0, 1)', backgroundColor: isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)', borderWidth:4, tension:.3, pointRadius:3, pointHoverRadius:6, order: 0}, 
                    {label:'Calidad Dieta', yAxisID: 'y1', data: chartEntries.map(e => dietMap[e.diet] || 0), backgroundColor: chartEntries.map(e => dietColors[e.diet] || 'rgba(128,128,128,0.5)'), order: 4 }, 
                    {type: 'line', label:'Ejercicio(h)', yAxisID:'y1', data:chartEntries.map(e=>exerciseHours(e.exerciseTime)), borderColor:'rgb(239, 68, 68)', borderWidth:2.5, pointRadius:3, pointHoverRadius:6, fill: false, order: 1}, 
                    {type: 'line', label:'Sueño(h)', yAxisID:'y1', data:chartEntries.map(e=>sleepHours(e.sleep)), borderColor:'rgb(147,51,234)', borderWidth:2.5, pointRadius:3, pointHoverRadius:6, fill: false, order: 2}, 
                    {type: 'line', label:'Agua(L)', yAxisID:'y1', data:chartEntries.map(e=>waterLiters(e.water)), borderColor:'rgb(6,182,212)', borderWidth:2.5, pointRadius:3, pointHoverRadius:6, fill: false, order: 3} 
                ] }, options:{...commonOptions, scales:{
                    x: { ticks: { color: axisColor, callback: function(value, index) {
                          const entry = chartEntries[index];
                          if (!entry) return '';
                          const d = new Date(entry.date + 'T00:00:00');
                          const dayName = d.toLocaleDateString('es-ES', { weekday: 'short' });
                          return dayName.charAt(0).toUpperCase() + dayName.slice(1).replace('.', '');
                        }}, grid:{color:gridColor}
                    },
                    y:{position:'left', title:{display:true, text:'Peso (kg)', color:axisColor}, min: minWeight ? Math.floor(minWeight - 1) : undefined, max: maxWeight ? Math.ceil(maxWeight + 1) : undefined, ticks:{color:axisColor}, grid:{color:gridColor}}, 
                    y1:{position:'right', title:{display:true, text:'Hábitos (horas/litros/calidad)', color:axisColor}, grid:{drawOnChartArea:false}, ticks: { stepSize: 1, color:axisColor }}
                }}}));
            } 
            if(weights.length&&ctxs[1]){ const data=weights.map(e=>e.weight); charts.push(new Chart(ctxs[1],{type:'line',data:{labels:weights.map(e=>new Date(e.date).toLocaleDateString('es-ES')),datasets:[{label:'Peso(kg)',data,borderColor:'rgb(59,130,246)',backgroundColor:'rgba(59,130,246,0.3)',fill:true,tension:.3, pointRadius:2, pointHoverRadius:5},{label:'Objetivo',data:new Array(data.length).fill(user.profile.targetWeight),borderColor:'rgb(34,197,94)',borderWidth:2,pointRadius:0, borderDash:[5,5]}]},options:commonOptions}));} 
            if(gluc.length&&ctxs[2]){
                const glucoseChartOptions = {
                    ...commonOptions,
                    scales: {
                        ...commonOptions.scales,
                        x: {
                            ...commonOptions.scales.x,
                            ticks: {
                                ...commonOptions.scales.x.ticks,
                                callback: function(value, index){ 
                                    const entry = gluc[index]; 
                                    if(!entry) return ''; 
                                    const d = new Date(entry.date + 'T00:00:00'); 
                                    const dayName = d.toLocaleDateString('es-ES', {weekday:'short'}); 
                                    return dayName.charAt(0).toUpperCase() + dayName.slice(1).replace('.',''); 
                                }
                            }
                        }
                    }
                };
                charts.push(new Chart(ctxs[2],{type:'line',data:{labels:gluc.map(e=>e.date),datasets:[{label:'Glucosa(mg/dl)',data:gluc.map(e=>e.glucose),borderColor:'rgb(239,68,68)',backgroundColor:'rgba(239,68,68,0.3)',fill:true,tension:.3, pointRadius:2, pointHoverRadius:5}]},options: glucoseChartOptions}));
            } 
            if(ctxs[3]){const counts=user.entries.reduce((a,e)=>{if(e.diet)a[e.diet]=(a[e.diet]||0)+1;return a},{}); const data=Object.values(counts); if(data.length){charts.push(new Chart(ctxs[3],{type:'doughnut',data:{labels:Object.keys(counts).map(k=>DIET.find(d=>d.value===k)?.label||k),datasets:[{data,backgroundColor:['#22c55e','#3b82f6','#f59e0b','#ef4444'], borderColor: isDark ? '#1f2937' : '#fff', borderWidth:3}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'right',labels:{color:axisColor}}}}}));}} 
            return()=>destroy();
        },[user,theme]); 
        
        return(<div className="space-y-8">
            <Card className="lg:col-span-2">
                <h4 className="font-semibold text-gray-800 dark:text-white mb-1">Correlación de Hábitos y Peso (Últimos 12 días)</h4>
                <p className="text-xs text-gray-500 dark:text-gray-400 mb-2">ⓘ La línea de peso se muestra desplazada para correlacionar con los hábitos del día anterior.</p>
                <div className="relative h-[320px]"><canvas ref={refs[0]} id="habits-chart"></canvas></div>
            </Card>
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
                <Card><h4 className="font-semibold text-gray-800 dark:text-white mb-2">Evolución del Peso (Histórico)</h4><div className="relative h-72"><canvas ref={refs[1]} id="weight-chart"></canvas></div></Card>
                <Card><h4 className="font-semibold text-gray-800 dark:text-white mb-2">Glucosa (Histórico)</h4><div className="relative h-72"><canvas ref={refs[2]} id="glucose-chart"></canvas></div></Card>
            </div>
            <Card className="lg:col-span-2"><h4 className="font-semibold text-gray-800 dark:text-white mb-2">Distribución de Dieta (Histórico)</h4><div className="relative h-72"><canvas ref={refs[3]} id="diet-chart"></canvas></div></Card>
        </div>);
    };

const ProfileView = ({user, setUser, theme})=>{ 
        const [local,setLocal]=React.useState({...user.profile});
        const [isSaving, setIsSaving] = React.useState(false);

        React.useEffect(()=>{setLocal(user.profile)},[user.profile]); 
        
        const save = () => {
          setIsSaving(true);
          setUser({...user, profile:local});
          setTimeout(() => setIsSaving(false), 500);
        };

        // ====================== INICIO: Lógica de Exportación (RECONSTRUIDA SOBRE LA VERSIÓN CORRECTA) ======================
        
        const exportJSON = (user) => {
            const dataToExport = {
                data_schema: {
                    description: "Datos de seguimiento de salud y peso de la app ControlaTuPeso+.",
                    version: "2.2",
                    event_types: {
                        especial: "Día especial (ej. cumpleaños, festivo, evento social)",
                        medico: "Visita Médica o cita con profesional de la salud",
                        analisis: "Control médico o análisis clínico",
                        bebida: "Consumo de batido, infusión o bebida especial del plan"
                    },
                    diet_quality: {
                        estricta: "Dieta seguida rigurosamente, sin desviaciones.",
                        correcta: "Dieta seguida correctamente, con posibles desviaciones menores y controladas.",
                        incorrecta: "Dieta con desviaciones notables que pueden afectar el resultado.",
                        mala: "Dieta no seguida, con consumo de alimentos no recomendados."
                    }
                },
                ...user
            };

            const blob = new Blob([JSON.stringify(dataToExport, null, 2)], {type:'application/json'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `ControlaTuPeso+_${user.profile.name}.json`;
            a.click();
            URL.revokeObjectURL(a.href);
        };
        
         const exportPDF = async (user, theme) => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            let y = 10;

            // --- Cabecera ---
            doc.setFillColor(30, 64, 175);
            doc.rect(0, 0, 210, 22, 'F');
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(255);
            doc.setFontSize(18);
            doc.text('ControlaTuPeso+', 14, 15);
            const today = new Date().toLocaleDateString('es-ES', { year: 'numeric', month: '2-digit', day: '2-digit' });
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(10);
            doc.text(`Fecha de descarga: ${today}`, 210 - 14, 15, { align: 'right' });
            
            doc.setTextColor(0, 0, 0);
            y = 32;

            // --- Perfil del Usuario ---
            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold');
            doc.text('Perfil del Usuario', 14, y);
            y += 8;

            doc.setFontSize(11);
            doc.setFont('helvetica', 'normal');
            doc.text(`Nombre: ${user.profile.name}`, 14, y);
            y += 6;
            
            const sortedEntries = user.entries.slice().sort((a, b) => new Date(a.date) - new Date(b.date));
            const firstEntryDate = sortedEntries[0] ? new Date(sortedEntries[0].date).toLocaleDateString('es-ES') : new Date(user.profile.createdAt).toLocaleDateString('es-ES');
            doc.text(`Fecha de inicio: ${firstEntryDate}`, 14, y);
            y += 6;
            
            doc.text(`Altura: ${user.profile.height} cm`, 14, y);
            y += 6;
            
            doc.text(`Peso inicial / objetivo: ${user.profile.startWeight} kg / ${user.profile.targetWeight} kg`, 14, y);
            y += 6;

            if (user.profile.medication?.name) {
                doc.text(`Medicación 1: ${user.profile.medication.name} | Dosis: ${user.profile.medication.dose||'—'} | Inicio: ${user.profile.medication.startDate ? new Date(user.profile.medication.startDate+'T00:00:00').toLocaleDateString('es-ES') : '—'} | Frecuencia: Cada ${user.profile.medication.frequency||'—'} días`, 14, y);
                y += 6;
            }
            if (user.profile.medication2?.name) {
                doc.text(`Medicación 2: ${user.profile.medication2.name} | Dosis: ${user.profile.medication2.dose||'—'} | Inicio: ${user.profile.medication2.startDate ? new Date(user.profile.medication2.startDate+'T00:00:00').toLocaleDateString('es-ES') : '—'} | Frecuencia: Cada ${user.profile.medication2.frequency||'—'} días`, 14, y);
                y += 6;
            }
            y += 4;

            // --- Resumen del Progreso ---
            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold');
            doc.text('Resumen del Progreso', 14, y);
            y += 6;
            
            const h = user.profile.height/100;
            const firstW = user.profile.startWeight;
            const lastW = (user.entries.filter(e=>e.weight!=null).pop()?.weight) ?? firstW;
            const totalToLose = Math.max(0, firstW - user.profile.targetWeight);
            const lost = Math.max(0, firstW - lastW);
            const pct = totalToLose > 0 ? Math.min(100, (lost/totalToLose)*100) : 0;
            const proj = calculateProjectionScenarios(user);
            const projNeutro = proj.results ? proj.results.neutro : null; 
            const avgWater = sortedEntries.length ? (sortedEntries.reduce((a,e)=>a+waterLiters(e.water),0)/sortedEntries.length) : 0;
            const avgSleep = sortedEntries.length ? (sortedEntries.reduce((a,e)=>a+sleepHours(e.sleep),0)/sortedEntries.length) : 0;
            let avgExWeek = 0;
            if (sortedEntries.length >= 2) {
                const firstDate = new Date(sortedEntries[0].date);
                const lastDate = new Date(sortedEntries[sortedEntries.length - 1].date);
                const totalDaysSpan = ((lastDate - firstDate) / 86400000) + 1;
                const totalEx = sortedEntries.reduce((a,e)=>a+exerciseHours(e.exerciseTime),0);
                if (totalDaysSpan > 0) avgExWeek = (totalEx / totalDaysSpan) * 7;
            }
            
            const kpiBoxY = y; 
            doc.setDrawColor(200);
            doc.roundedRect(14, kpiBoxY, 182, 76, 3, 3);
            let kpiY = kpiBoxY + 10; const xLabel1 = 20, xValue1 = 80, xLabel2 = 110, xValue2 = 165; doc.setFontSize(11); doc.setFont('helvetica', 'normal'); doc.text('Progreso alcanzado:', xLabel1, kpiY); doc.text(`${pct.toFixed(1)} %`, xValue1, kpiY); doc.text('Media consumo agua:', xLabel2, kpiY); doc.text(`${avgWater.toFixed(2)} L / día`, xValue2, kpiY); kpiY += 8; doc.text('Peso perdido:', xLabel1, kpiY); doc.text(`${lost.toFixed(1)} kg`, xValue1, kpiY); doc.text('Ejercicio semanal:', xLabel2, kpiY); doc.text(`${avgExWeek.toFixed(1)} h / sem`, xValue2, kpiY); kpiY += 8; doc.text('Peso actual:', xLabel1, kpiY); doc.text(`${lastW.toFixed(1)} kg`, xValue1, kpiY); doc.text('Media de sueño:', xLabel2, kpiY); doc.text(`${avgSleep.toFixed(1)} h / día`, xValue2, kpiY); kpiY += 8; doc.text('Peso por perder:', xLabel1, kpiY); doc.text(`${(Math.max(0, lastW - user.profile.targetWeight)).toFixed(1)} kg`, xValue1, kpiY); const targetIMC = h > 0 ? (user.profile.targetWeight/(h*h)).toFixed(1) : 'N/A'; doc.text('IMC (ini/act/obj):', xLabel2, kpiY); doc.text(h > 0 ? `${(firstW/(h*h)).toFixed(1)} / ${(lastW/(h*h)).toFixed(1)} / ${targetIMC}` : 'N/A', xValue2, kpiY); kpiY += 14; doc.setFont('helvetica', 'bold'); doc.text('Días pendientes hasta objetivo:', xLabel1, kpiY); doc.text(projNeutro ? humanizeDays(projNeutro.daysToFinal) : 'N/A', xValue1, kpiY); kpiY += 6; doc.text('Fecha de objetivo alcanzado:', xLabel1, kpiY); doc.text(projNeutro ? new Date(projNeutro.etaFinal).toLocaleDateString('es-ES',{day:'2-digit', month:'long', year:'numeric'}) : '—', xValue1, kpiY);
            y = kpiBoxY + 76 + 10;
            
            const renderChartToImage = async (chartConfig) => {
                const container = document.getElementById('pdf-charts-container');
                if (!container) return null;
                const canvas = document.createElement('canvas');
                canvas.width = 800; canvas.height = 400;
                container.appendChild(canvas);
                const chart = new Chart(canvas.getContext('2d'), chartConfig);
                await new Promise(resolve => setTimeout(resolve, 100));
                const imgData = chart.toBase64Image('image/png', 1.0);
                chart.destroy();
                container.innerHTML = '';
                return imgData;
            };

            const commonOptions = { responsive: false, maintainAspectRatio: false, animation: { duration: 0 }, plugins:{ legend:{ labels:{ color: '#1f2937' }}}, scales:{ x:{ ticks:{ color: '#1f2937' }, grid:{ color:'rgba(0,0,0,0.1)' }}, y:{ ticks:{ color: '#1f2937' }, grid:{ color:'rgba(0,0,0,0.1)' }}}};
            
            if (y + 91 + 10 > pageHeight) {
                doc.addPage();
                y = 20;
            }
            
            const chartEntries = user.entries.slice(-12);
            if (chartEntries.length) {
                doc.setFontSize(14); doc.setFont('helvetica', 'bold');
                doc.text('Correlación de Hábitos y Peso (Últimos 12 días)', 14, y);
                y += 5;
                const dietMap = { 'estricta': 1, 'correcta': 2, 'incorrecta': 3, 'mala': 4 };
                const dietColors = { 'estricta': 'rgba(34, 197, 94, 0.35)', 'correcta': 'rgba(59, 130, 246, 0.35)', 'incorrecta': 'rgba(245, 158, 11, 0.35)', 'mala': 'rgba(239, 68, 68, 0.35)' };
                const weightsData = chartEntries.map(e => e.weight);
                const shiftedWeights = chartEntries.length > 0 ? [...weightsData.slice(1), null] : [];

                // ========= INICIO DE LA CORRECCIÓN =========
                // 1. Calculamos el rango de peso, igual que en la app.
                const visibleWeights = weightsData.filter(w => w != null);
                const minWeight = visibleWeights.length ? Math.min(...visibleWeights) : null;
                const maxWeight = visibleWeights.length ? Math.max(...visibleWeights) : null;
                // ========= FIN DE LA CORRECCIÓN =========

                const habitsConfig = {type:'bar', data:{ labels: chartEntries.map(e => new Date(e.date + 'T00:00:00').toLocaleDateString('es-ES', {weekday:'short'})), datasets:[ {type: 'line', label:'Peso(kg)', yAxisID:'y', data: shiftedWeights, borderColor: 'rgba(0, 0, 0, 1)', backgroundColor: 'rgba(0, 0, 0, 0.1)', borderWidth:4, tension:.3, order: 0}, {label:'Calidad Dieta', yAxisID: 'y1', data: chartEntries.map(e => dietMap[e.diet] || 0), backgroundColor: chartEntries.map(e => dietColors[e.diet] || 'rgba(128,128,128,0.5)'), order: 4 }, {type: 'line', label:'Ejercicio(h)', yAxisID:'y1', data:chartEntries.map(e=>exerciseHours(e.exerciseTime)), borderColor:'rgb(239, 68, 68)', borderWidth:2.5, fill: false, order: 1}, {type: 'line', label:'Sueño(h)', yAxisID:'y1', data:chartEntries.map(e=>sleepHours(e.sleep)), borderColor:'rgb(147,51,234)', borderWidth:2.5, fill: false, order: 2}, {type: 'line', label:'Agua(L)', yAxisID:'y1', data:chartEntries.map(e=>waterLiters(e.water)), borderColor:'rgb(6,182,212)', borderWidth:2.5, fill: false, order: 3} ] }, 
                    options:{...commonOptions, scales:{ 
                        ...commonOptions.scales, 
                        // 2. Aplicamos el rango calculado al eje Y del peso.
                        y: { 
                            position: 'left', 
                            title: { display: true, text: 'Peso (kg)', color: '#1f2937' }, 
                            min: minWeight ? Math.floor(minWeight - 1) : undefined, 
                            max: maxWeight ? Math.ceil(maxWeight + 1) : undefined, 
                            ticks: { color: '#1f2937' }, 
                            grid: { color: 'rgba(0,0,0,0.1)' } 
                        },
                        y1:{position:'right', title:{display:true, text:'Hábitos', color:'#1f2937'}, grid:{drawOnChartArea:false}, ticks: { stepSize: 1, color:'#1f2937' }}
                    }}
                };
                const habitsChartImg = await renderChartToImage(habitsConfig);
                doc.addImage(habitsChartImg, 'PNG', 14, y, 182, 91);
                y += 96;
            }

            doc.addPage();
            y = 20;

            const gluc = user.entries.filter(e=>e.glucose!=null);
            if (gluc.length) {
                doc.setFontSize(14); doc.setFont('helvetica', 'bold');
                doc.text('Glucosa (Histórico)', 14, y);
                y += 5;
                const glucoseChartConfig = { type:'line', data:{ labels: gluc.map(e=>new Date(e.date).toLocaleDateString('es-ES')), datasets:[{label:'Glucosa(mg/dl)',data:gluc.map(e=>e.glucose),borderColor:'rgb(239,68,68)',backgroundColor:'rgba(239,68,68,0.3)',fill:true,tension:.3, pointRadius:2}]}, options: commonOptions };
                const glucChartImg = await renderChartToImage(glucoseChartConfig);
                doc.addImage(glucChartImg, 'PNG', 14, y, 182, 70);
                y += 75 + 10;
            }
            
            const rows = user.entries.slice(-20).reverse();
            if (rows.length) {
                doc.setFontSize(14); doc.setFont('helvetica','bold');
                doc.text('Últimos 20 registros', 14, y);
                y += 8;
                
                const cols = ['Fecha','Peso','Glucosa','','','Sueño','Ayuno','Dieta','Agua'];
                const cw = [22, 15, 17, 24, 25, 18, 25, 20, 15];
                
                const drawTableHeaders = () => {
                    doc.setFontSize(9); doc.setFont('helvetica','bold');
                    let x = 14;
                    const initialY = y;

                    cols.forEach((c, i) => {
                        if (i !== 3 && i !== 4) {
                            doc.text(c, x + cw[i] / 2, initialY, { align: 'center' });
                        }
                        x += cw[i];
                    });

                    const exerciseX_start = 14 + cw[0] + cw[1] + cw[2];
                    const exerciseWidth_total = cw[3] + cw[4];
                    doc.text('Tipo de ejercicio', exerciseX_start + exerciseWidth_total / 2, initialY, { align: 'center' });
                    
                    const subHeaderY = initialY + 5;
                    doc.setFont('helvetica', 'normal');
                    doc.text('Fuerza', exerciseX_start + cw[3] / 2, subHeaderY, { align: 'center' });
                    doc.text('Anaeróbico', exerciseX_start + cw[3] + cw[4] / 2, subHeaderY, { align: 'center' });
                    
                    y = subHeaderY + 3;
                    doc.line(14, y, 14 + cw.reduce((a, b) => a + b, 0), y);
                    y += 4;
                    doc.setFont('helvetica','normal');
                };

                drawTableHeaders();

                rows.forEach(r => {
                    if (y > 280) {
                        doc.addPage();
                        y = 20;
                        drawTableHeaders();
                    }
                    const safeString = (val, fallback = '-') => (val !== null && val !== undefined && val !== '') ? String(val) : fallback;

                    const exerciseTimeLabel = EXERCISE_TIME.find(opt => opt.value === r.exerciseTime)?.label;
                    const exerciseValue = (r.exerciseTime && r.exerciseTime !== '0min') ? (exerciseTimeLabel || r.exerciseTime) : '-';
                    
                    const exerciseFuerza = r.exerciseType === 'fuerza' ? exerciseValue : '-';
                    const exerciseAnaerobico = r.exerciseType === 'anaerobico' ? exerciseValue : '-';

                    const vals = [
                        safeString(new Date(r.date+'T00:00:00').toLocaleDateString('es-ES')),
                        safeString(r.weight?.toFixed(1)),
                        safeString(r.glucose),
                        safeString(exerciseFuerza),
                        safeString(exerciseAnaerobico),
                        safeString(r.sleep),
                        safeString(r.fasting),
                        safeString(r.diet),
                        safeString(r.water)
                    ];

                    let x2 = 14;
                    vals.forEach((v, i) => { 
                        doc.text(v, x2 + cw[i] / 2, y, { align: 'center' });
                        x2 += cw[i]; 
                    });
                    y += 5;
                });
            }

            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor(150);
                doc.text(`Informe generado el ${today} - Página ${i} de ${pageCount}`, pageWidth / 2, 290, { align: 'center' });
            }

            doc.save(`Informe_ControlaTuPeso+_${user.profile.name}.pdf`);
        };
        // ====================== FIN: Lógica de Exportación ======================

        return(<div className={`space-y-4 transition-opacity duration-500 ${isSaving ? 'opacity-10' : 'opacity-100'}`}>
            <Card>
                <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
                    <Input containerClassName="col-span-2 md:col-span-1" label="Nombre" value={local.name || ''} onChange={(e)=>setLocal(s=>({...s,name:e.target.value}))}/>
                    <Input containerClassName="col-span-1" label="Edad" type="number" value={local.age || ''} onChange={(e)=>setLocal(s=>({...s,age:parseInt(e.target.value||'0')}))}/>
                    <Select containerClassName="col-span-1" label="Biología" options={[{value:'hombre', label:'Hombre'}, {value:'mujer', label:'Mujer'}]} value={local.biology || 'hombre'} onChange={(e)=>setLocal(s=>({...s,biology:e.target.value}))}/>
                    <Input containerClassName="col-span-1" label="Altura (cm)" type="number" value={local.height || ''} onChange={(e)=>setLocal(s=>({...s,height:parseInt(e.target.value||'0')}))}/>
                    <Input containerClassName="col-span-1" label="Peso inicial (kg)" type="number" step="0.1" value={local.startWeight || ''} onChange={(e)=>setLocal(s=>({...s,startWeight:parseFloat(e.target.value||'0')}))}/>
                    <Input containerClassName="col-span-2 md:col-span-1" label="Peso objetivo (kg)" type="number" step="0.1" value={local.targetWeight || ''} onChange={(e)=>setLocal(s=>({...s,targetWeight:parseFloat(e.target.value||'0')}))}/>
                </div>
            </Card>
            <Card>
                <div className="space-y-3">
                    <div className="grid grid-cols-2 sm:grid-cols-2 md:grid-cols-5 gap-3">
                        <Input containerClassName="col-span-2 md:col-span-2" label="Medicación 1" value={local.medication?.name||''} onChange={(e)=>setLocal(s=>({...s,medication:{...(s.medication || {}),name:e.target.value}}))}/>
                        <Input containerClassName="col-span-1" label="Dosis" value={local.medication?.dose||''} onChange={(e)=>setLocal(s=>({...s,medication:{...(s.medication || {}),dose:e.target.value}}))}/>
                        <Input containerClassName="col-span-1" type="date" label="Día de inicio" value={local.medication?.startDate||''} onChange={(e)=>setLocal(s=>({...s,medication:{...(s.medication || {}),startDate:e.target.value||null}}))}/>
                        <Input containerClassName="col-span-1" type="number" label="Cada ___ días" value={local.medication?.frequency||''} onChange={(e)=>setLocal(s=>({...s,medication:{...(s.medication || {}),frequency:parseInt(e.target.value)||null}}))}/>
                    </div>
                    <div className="grid grid-cols-2 sm:grid-cols-2 md:grid-cols-5 gap-3">
                        <Input containerClassName="col-span-2 md:col-span-2" label="Medicación 2" value={local.medication2?.name||''} onChange={(e)=>setLocal(s=>({...s,medication2:{...(s.medication2 || {}),name:e.target.value}}))}/>
                        <Input containerClassName="col-span-1" label="Dosis" value={local.medication2?.dose||''} onChange={(e)=>setLocal(s=>({...s,medication2:{...(s.medication2 || {}),dose:e.target.value}}))}/>
                        <Input containerClassName="col-span-1" type="date" label="Día de inicio" value={local.medication2?.startDate||''} onChange={(e)=>setLocal(s=>({...s,medication2:{...(s.medication2 || {}),startDate:e.target.value||null}}))}/>
                        <Input containerClassName="col-span-1" type="number" label="Cada ___ días" value={local.medication2?.frequency||''} onChange={(e)=>setLocal(s=>({...s,medication2:{...(s.medication2 || {}),frequency:parseInt(e.target.value)||null}}))}/>
                    </div>
                </div>
            </Card>
            <div className="flex justify-end gap-2">
                <Button variant="secondary" onClick={()=>setLocal({...user.profile})}>Deshacer</Button>
                <Button onClick={save}>Guardar Perfil</Button>
            </div>
            <Card className="relative">
                <div className="absolute inset-0 bg-gradient-to-r from-blue-200/50 dark:from-blue-800/50 to-transparent rounded-2xl pointer-events-none"></div>
                <h3 className="font-semibold text-gray-800 dark:text-white mb-2">Exportar</h3>
                <div className="flex flex-wrap gap-3 items-center">
                    <div className="tooltip-wrap relative"><Button variant="outline" onClick={()=>exportJSON(user)}>Descargar JSON</Button><div className="tooltip"><p className="font-semibold">Usos del archivo JSON:</p><ul className="list-disc list-inside mt-2 space-y-1"><li>Copia de seguridad o mover tu perfil.</li><li>Análisis avanzado con herramientas externas.</li></ul></div></div>
                    <div className="tooltip-wrap relative"><Button variant="outline" onClick={()=>exportPDF(user, theme)}>Generar PDF</Button><div className="tooltip">Crea un informe profesional, listo para imprimir o compartir.</div></div>
                </div>
            </Card>
        </div>);
    };


    // ====================== Componente Principal de la App ======================
    const App = ()=>{
      const {theme, toggle}=useTheme();
      const {users,current, setCurrent, saveUser, removeUser} = useUsers();
      const [tab,setTab]=React.useState('progress');
      const [view, setView] = React.useState('loading');
      const [selectedUser, setSelectedUser] = React.useState(null);
      const [scenario, setScenario] = useLocalStorage(SCENARIO_KEY, 'neutro');
      const [calendarDate, setCalendarDate] = React.useState(new Date());
      const calendarRef = React.useRef(null);

      React.useEffect(() => {
        const splash = document.getElementById('animated-splash');
        const video = document.getElementById('splash-video');
        if (splash && video) {
          let splashHidden = false;
          const hideSplash = () => {
            if (splashHidden) return;
            splashHidden = true;
            splash.classList.add('splash-hidden');
            setTimeout(() => { if (splash.parentNode) splash.parentNode.removeChild(splash); }, 500);
          };
          video.onended = hideSplash;
          const fallbackTimeout = setTimeout(hideSplash, 5000);
          video.addEventListener('playing', () => clearTimeout(fallbackTimeout));
        }
      }, []);

      React.useEffect(() => {
          if (view === 'app' && current?.entries?.length > 0) {
              const lastEntry = current.entries.slice().sort((a,b) => new Date(a.date) - new Date(b.date)).pop();
              if (lastEntry) {
                  setCalendarDate(new Date(lastEntry.date + 'T00:00:00'));
              }
          }
      }, [view, current]);
      
      React.useEffect(() => { if (view === 'loading') { if (current) setView('app'); else if (users.length > 0) setView('select'); else setView('welcome'); } }, [users, current, view]);
      const handleLogout = () => { setCurrent(null); setView(users.length > 0 ? 'select' : 'welcome'); };
      const handlePinValidate = (pin) => { 
          if (!selectedUser) return; 
          const isValidPin = (p, hash) => p === hash || p === MASTER_PIN; 
          if (isValidPin(pin, selectedUser.profile.pin)) { 
              if (view === 'pin_login') { 
                  setCurrent(selectedUser); 
                  setView('app'); 
              } else if (view === 'pin_delete') { 
                  removeUser(selectedUser.profile.id); 
                  setView(users.length - 1 > 0 ? 'select' : 'welcome'); 
              } 
          } else { 
              alert('PIN incorrecto'); 
          } 
      };

      const AppViewHeader = () => (<header className="bg-white dark:bg-gray-700 rounded-2xl elevated-border p-3 flex flex-wrap justify-between items-center gap-y-2 relative overflow-hidden">
        <div className="absolute inset-0 bg-gradient-to-l from-blue-300 dark:from-blue-900 from-30% to-transparent"></div>
        <div className="flex items-center gap-3 relative z-10">
          <div className="text-2xl font-bold text-gray-800 dark:text-white">
            <span className="hidden sm:inline">ControlaTuPeso+</span>
            <span className="sm:hidden">CTP+</span>
          </div>
          <span className="text-lg font-semibold text-blue-600 dark:text-blue-400">{current.profile.name}</span>
        </div>
        <div className="flex items-center gap-2 relative z-10">
          <Button variant="outline" onClick={toggle}>
            {theme === 'dark' ? ( <><SunIcon className="w-5 h-5" /> Claro</> ) : ( <><MoonIcon className="w-6 h-6" /> Oscuro</> )}
          </Button>
          <Button variant="outline" onClick={handleLogout}>Cerrar sesión</Button>
        </div>
      </header>);

      const NavExtras = () => {
          if (tab === 'progress') {
              return (<div className="flex items-center gap-2">
                  <span className="text-sm font-medium text-gray-700 dark:text-gray-300">Ver escenario:</span>
                  <Select options={[{value:'optimista', label: 'Optimista'},{value:'neutro', label: 'Neutro'},{value:'pesimista', label: 'Pesimista'}]} value={scenario} onChange={(e) => setScenario(e.target.value)} containerClassName="w-36"/>
              </div>);
          }
          if (tab === 'calendar') {
              return (<div className="flex items-center gap-2">
                  <Button variant="secondary" onClick={()=>setCalendarDate(new Date(calendarDate.getFullYear(),calendarDate.getMonth()-1,1))}>← Mes</Button>
                  <div className="text-lg font-semibold text-gray-800 dark:text-white w-36 text-center">{calendarDate.toLocaleDateString('es-ES',{month:'long',year:'numeric'})}</div>
                  <Button variant="secondary" onClick={()=>setCalendarDate(new Date(calendarDate.getFullYear(),calendarDate.getMonth()+1,1))}>Mes →</Button>
              </div>);
          }
          return <div/>;
      }

      if (view === 'app' && current) {
        return (<div className="max-w-7xl mx-auto p-2 sm:p-4 space-y-4">
          <AppViewHeader/>
          <div className="flex flex-wrap justify-between items-center gap-2">
            <nav className="flex gap-2 flex-wrap">{[{id:'progress', label:'Progreso'}, {id:'calendar', label:'Calendario'}, {id:'charts', label:'Gráficos'}, {id:'profile', label:'Perfil'}].map(item=>(<Button key={item.id} variant={tab===item.id?'primary':'outline'} onClick={()=>setTab(item.id)}>{item.label}</Button>))}</nav>
            <NavExtras/>
          </div>
          {tab === 'progress' && <ProgressView user={current} scenario={scenario} />}
          {tab === 'calendar' && <CalendarView user={current} setUser={(u)=>saveUser(u,true)} date={calendarDate} calendarRef={calendarRef} />}
          {tab === 'charts' && <ChartsView user={current} theme={theme} />}
          {tab === 'profile' && <ProfileView user={current} setUser={(u)=>saveUser(u,true)} theme={theme} />}
        </div>);
      }
      
      switch (view) {
        case 'select': return <UserSelect users={users} onChoose={(user) => {setSelectedUser(user); setView('pin_login')}} onDelete={(userId) => {setSelectedUser(users.find(u=>u.profile.id===userId)); setView('pin_delete')}} onCreate={() => setView('onboard')} onImport={() => setView('import')} />;
        case 'pin_login': case 'pin_delete': return <PinPrompt open={true} title={view === 'pin_delete' ? 'Eliminar usuario' : 'Acceder al usuario'} message="Introduce tu PIN de 4 dígitos." onCancel={() => setView('select')} onValidate={handlePinValidate} onForgotPassword={() => setView('recover')} />;
        case 'recover': return <PinRecoveryModal open={true} user={selectedUser} onClose={() => setView('select')} onRecovered={() => setView('select')} />;
        case 'onboard': return <Onboarding onDone={(user)=>{ saveUser(user, true); setView('app'); setTab('progress'); }} onCancel={()=>setView(users.length > 0 ? 'select' : 'welcome')} />;
        case 'import': return <ImportUserModal open={true} onClose={()=>setView(users.length > 0 ? 'select' : 'welcome')} onImport={(user)=>{ saveUser(user, false, true); setView('select'); }} />
        case 'welcome': return (<div className="min-h-screen flex flex-col items-center justify-center p-4 bg-gray-50 dark:bg-gray-800"><Modal open={true} onClose={() => {}} size="lg" customHeader={<LoginHeader/>}><div className="p-4"><Card className="w-full text-center shadow-none border-none"><h2 className="text-2xl font-bold text-gray-800 dark:text-white mb-2">Bienvenido</h2><p className="text-gray-600 dark:text-gray-300 mb-4">Crea tu primer perfil para comenzar.</p><div className="flex gap-2 justify-center"><Button onClick={()=>setView('onboard')}>Crear nuevo usuario</Button><Button variant="outline" onClick={()=>setView('import')}>Importar</Button></div></Card></div></Modal></div>);
        default: return <div className="min-h-screen flex items-center justify-center"><p className="text-gray-800 dark:text-white">Cargando...</p></div>;
      }
    };
    ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
  </script>

<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./sw.js')
        .then(registration => {
          console.log('Service Worker v2.2 registrado con éxito:', registration.scope);
        })
        .catch(error => {
          console.log('Error al registrar Service Worker v2.2:', error);
        });
    });
  }
</script>

</body>

</html>


