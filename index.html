<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF--8"/>
  <meta name="viewport" content="width=device-width, initial-scale=0.6"/>
  <title>ControlaTuPeso+ v2.1</title>
  <!-- PWA y Metadatos -->
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="iconos/favicon.ico" type="image/x-icon">
  <link rel="apple-touch-icon" href="iconos/icono-192.png">
  <meta name="theme-color" content="#1f2937">
  <!-- Librerías Externas (CDNs) -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            gray: {
              600: '#4b5563',
              700: '#374151',
              800: '#1f2937',
              900: '#111827',
            }
          },
          fontFamily: {
            sans: ['Inter', 'sans-serif'],
            handwriting: ['Caveat', 'cursive']
          }
        }
      }
    }
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- Fuentes de Google -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@500&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <!-- Estilos y Script de Errores -->
<style>
  body { font-family: 'Inter', sans-serif; }
  .elevated-border{border:2px solid rgba(107,114,128,0.9)}
  .dark .elevated-border{border-color: rgba(255,255,255,0.3)}

.btn-ghost{border:2px solid rgba(156,163,175,0.4)}

/* BORDES MEJORADOS PARA EL CALENDARIO (MEJORADO: hover con efecto 'flotante' sin mover layout) */
.calendar-cell {
  border: 2px solid rgba(0, 0, 0, 0.45); /* Base: 2px negro semi-transparente */
  transition: background-color 180ms ease, box-shadow 220ms ease, outline 180ms ease, border-color 180ms ease;
  background-clip: padding-box; /* evitar que outline aumente el tamaño visual */
  position: relative;
  will-change: box-shadow, background-color, outline;
}

/* Hover / focus (efecto levantado visual sin desplazar) */
.calendar-cell:hover,
.calendar-cell:focus {
  /* ligero aclarado del fondo (en modo claro se notará más) */
  background-color: rgba(255,255,255,0.14);
  /* sombra visible para dar profundidad en modo claro */
  box-shadow: 0 8px 22px rgba(0,0,0,0.28);
  /* outline para dar sensación de borde más grueso sin cambiar layout */
  outline: 3px solid rgba(0,0,0,0.85);
  outline-offset: -3px; /* se superpone al borde sin modificar el tamaño de la caja */
}

/* Pequeño highlight interior (sutileza que da un aspecto 'pulido') */
.calendar-cell:hover::after {
  content: "";
  pointer-events: none;
  position: absolute;
  inset: 0;
  border-radius: inherit;
  box-shadow: inset 0 1px 0 rgba(255,255,255,0.06);
}

/* Ajustes para modo oscuro (contraste invertido: sombra/outline claros) */
.dark .calendar-cell {
  border-color: rgba(255, 255, 255, 0.7);
}

.dark .calendar-cell:hover,
.dark .calendar-cell:focus {
  /* en oscuro no aclaramos tanto para no quemar la lectura */
  background-color: rgba(255,255,255,0.06);
  /* sombra blancuzca y muy sutil para levantar la celda sobre fondo oscuro */
  box-shadow: 0 10px 30px rgba(255,255,255,0.06);
  /* outline claro para contraste fuerte aunque el borde base sea ya claro */
  outline: 3px solid rgba(255,255,255,0.92);
  outline-offset: -3px;
}

.dark .calendar-cell:hover::after {
  content: "";
  pointer-events: none;
  position: absolute;
  inset: 0;
  border-radius: inherit;
  box-shadow: inset 0 1px 0 rgba(255,255,255,0.02);
}

/* --- INICIO: CÓDIGO PARA GESTIÓN DE TEMAS VISUALES (CORREGIDO PARA MÓVILES) --- */
:root {
  /* Los temas se definen igual que antes */
  --app-background-light: url('imagenes/fondo-app.png');
  --app-background-dark: url('imagenes/fondo-app-oscuro.png');
  --modal-background-image: var(--app-background-light); 
}

body {
  /* El body ya no necesita la imagen. Solo lo preparamos para el pseudo-elemento */
  position: relative;
  background-color: transparent;
}

/* Esta es la capa que contendrá nuestro fondo de forma fiable */
body::before {
  content: "";
  position: fixed; /* LOGRA EL MISMO EFECTO FIJO que 'background-attachment' pero funciona en móviles */
  top: 0;
  left: 0;
  width: 100vw; /* Ocupa el 100% del ancho de la ventana */
  height: 100vh; /* Ocupa el 100% del alto de la ventana */
  z-index: -1; /* Se asegura de que esté detrás de todo el contenido */

  /* MISMAS PROPIEDADES VISUALES que tenías para que se vea idéntico */
  background-image: var(--app-background-light);
  background-size: cover; /* <- Mantiene el escalado perfecto */
  background-position: center center; /* <- Mantiene el centrado perfecto */
  
  /* Mantenemos la transición suave al cambiar de tema */
  transition: background-image 0.5s ease-in-out;
}

/* En modo oscuro, simplemente cambiamos la imagen del pseudo-elemento */
.dark body::before {
  background-image: var(--app-background-dark);
}

/* El estilo para los modales no cambia en absoluto */
.modal-background {
  background-image: var(--modal-background-image);
}
/* --- FIN: CÓDIGO PARA GESTIÓN DE TEMAS VISUALES --- */
/* --- ESTILOS UNIFICADOS PARA TOOLTIPS --- */
.tooltip-wrap {
  position: relative;
  display: inline-block;
}

.tooltip {
  display: none;
  position: absolute;
  bottom: 120%;
  left: 50%;
  transform: translateX(-50%);
  background-color: #333;
  color: #fff;
  padding: 8px 12px; /* Un poco menos de padding */
  border-radius: 8px; /* Bordes un poco más suaves */
  white-space: normal;
  width: auto; /* ¡CAMBIO CLAVE! Se ajusta al contenido */
  max-width: 380px; /* ¡CAMBIO CLAVE! Ancho máximo para textos largos */
  box-sizing: border-box;
  font-size: 0.85rem; /* Texto ligeramente más pequeño */
  text-align: center; /* Texto centrado */
  z-index: 999;
  word-wrap: break-word;
  border: 2px solid #fff; /* ¡NUEVO! Borde blanco */
  box-shadow: 0 4px 8px -2px rgba(0, 0, 0, 0.2), 0 2px 4px -2px rgba(0, 0, 0, 0.1); /* ¡MEJORADO! Sombra más pronunciada para compensar el borde */
}

/* Flecha del tooltip (por defecto, centrada) */
.tooltip::after {
  content: "";
  position: absolute;
  top: 100%;
  left: 50%;
  transform: translateX(-50%);
  border-width: 6px;
  border-style: solid;
  border-color: #333 transparent transparent transparent;
}

/* Flecha para tooltips alineados a la izquierda (JSON) */
.tooltip-wrap.left-edge .tooltip::after {
  left: 16px; /* Alineada con el borde izquierdo */
  right: auto;
  transform: none;
  border-color: #333 transparent transparent transparent;
}

/* Flecha para tooltips alineados a la derecha (PDF) */
.tooltip-wrap.right-edge .tooltip::after {
  left: auto;
  right: 16px; /* Alineada con el borde derecho */
  transform: none;
  border-color: #333 transparent transparent transparent;
}

/* Mostrar el tooltip al pasar el ratón o hacer hover */
.tooltip-wrap:hover .tooltip {
  display: block;
}

/* --- POSICIÓN INFERIOR PARA TOOLTIPS --- */
.bottom-tooltip {
  bottom: auto; /* Anula el "bottom: 120%" */
  top: 120%; /* Aparece debajo del elemento */
}
.bottom-tooltip::after {
  top: -6px; /* Mueve la flecha hacia arriba */
  bottom: auto; /* Anula el "top: 100%" */
  border-color: transparent transparent #333 transparent; /* Flecha apuntando hacia arriba */
}

/* --- ALINEACIÓN INTELIGENTE PARA BOTONES A LA DERECHA --- */
/* Aplica esta clase a los botones que están en el borde derecho de la pantalla */
.tooltip-wrap.right-edge .tooltip {
  left: auto; /* Anula el "left: 50%" */
  right: 0; /* Alinea el borde derecho del tooltip con el borde derecho del botón */
  transform: none; /* Anula el "transform: translateX(-50%)" */
  text-align: right; /* Opcional: alinea el texto a la derecha */
}

.tooltip-wrap.right-edge .tooltip::after {
  left: auto; /* Anula el posicionamiento centrado de la flecha */
  right: 16px; /* Alinea la flecha con el borde derecho del tooltip (ajusta según el padding) */
  transform: none;
}
  .splash { position: fixed; inset: 0; z-index: 9999; background-color: #000; transition: opacity 0.5s ease-out, visibility 0.5s ease-out; display: flex; align-items: center; justify-content: center; }
  .splash-video { width: 100%; height: 100%; object-fit: contain; }
  .splash-hidden { opacity: 0; visibility: hidden; }
</style>

<style>
/* --- AEROBIC ICON THEME (NUEVA REGLA CENTRALIZADA) --- */
.aerobic-icon-themed {
  fill: #1e40af !important;  /* Azul en modo claro */
  color: #1e40af !important;
}
.dark .aerobic-icon-themed {
  fill: #facc15 !important;  /* Amarillo en modo oscuro */
  color: #facc15 !important;
}

/* --- ANAEROBIC ICON THEME (NUEVA REGLA CENTRALIZADA) --- */
.anaerobic-icon-themed {
  fill: #000000 !important;  /* Negro en modo claro */
  color: #000000 !important;
}
.dark .anaerobic-icon-themed {
  fill: #ffffff !important;  /* Blanco en modo oscuro */
  color: #ffffff !important;
}

/* --- CORRECCIÓN PARA OCULTAR ICONO NATIVO DE CALENDARIO --- */
/* Esto oculta el icono por defecto que los navegadores Chrome/Safari
   añaden a los campos de tipo "date", evitando que aparezca duplicado */
input[type="date"]::-webkit-calendar-picker-indicator {
  display: none;
  -webkit-appearance: none;
}
/* --- ICONOS PERSONALIZADOS CON BORDE TEMÁTICO --- */
/* Por defecto, los bordes serán negros */
.themed-stroke {
  stroke: #000000;
}
/* En modo oscuro, los bordes serán blancos */
.dark .themed-stroke {
  stroke: #FFFFFF;
}

/* --- ICONO DE AJUSTES (MONOCROMÁTICO) --- */
/* Este es un caso especial ya que es de un solo color */
.themed-fill {
  fill: #000000; /* Negro en modo claro */
}
.dark .themed-fill {
  fill: #FFFFFF; /* Blanco en modo oscuro */
}
</style>
<style>
/* --- TOOLTIP ESPECIAL PARA EL CALENDARIO (ANCHO Y TEXTO AJUSTADOS) --- */
.calendar-view .tooltip,
.day-modal .tooltip {
  max-width: 280px;
  min-width: 180px;
  width: auto;
  font-size: 0.85rem;
  padding: 8px 12px;
  white-space: normal;
  word-wrap: break-word;
  text-align: center;
}
/* --- EFECTO HOVER PARA LOS DÍAS DEL CALENDARIO (CONTRASTE AJUSTADO + SOMBRA MÁS MARCADA) --- */
.calendar-cell, .calendar-day {
  border: 2px solid rgba(0, 0, 0, 0.45);
  transition: background-color 200ms ease, box-shadow 200ms ease, border-color 200ms ease, transform 150ms ease;
  background-clip: padding-box;
  position: relative;
}

/* Modo claro */
.calendar-cell:hover, .calendar-day:hover,
.calendar-cell:focus, .calendar-day:focus {
  background-color: #f9fafb; /* gris claro (un poco más bajo que #f3f4f6) */
  box-shadow: 0 15px 30px rgba(200,200,200,200.75); /* sombra más concentrada y visible */
  border-color: #000;
  z-index: 10;
}

/* Modo oscuro */
.dark .calendar-cell:hover, .dark .calendar-day:hover,
.dark .calendar-cell:focus, .dark .calendar-day:focus {
  background-color: #1f2937; /* gris más oscuro que #2d3748 */
  box-shadow: 0 10px 18px rgba(255,255,255,0.40); /* sombra blanca más marcada */
  border-color: #fff;
}

/* --- CORRECCIÓN DE COLOR PARA ETIQUETAS Y TEXTOS EN MODALES --- */
.backdrop-blur-md label,
.backdrop-blur-md p {
  color: #FFFFFF; /* Blanco puro para modo claro */
}
.dark .backdrop-blur-md label,
.dark .backdrop-blur-md p {
  color: #E5E7EB; /* Gris claro (casi blanco) para modo oscuro */
}

/* --- CORRECCIÓN ESPECÍFICA PARA ENLACES Y BOTÓN mmol/L EN DAYMODAL --- */
/* Esta regla ahora es más específica para no afectar a otros botones */
.day-modal a,
.day-modal button.text-xs {
    color: #000000; /* Negro puro para modo claro */
}
.dark .day-modal a,
.dark .day-modal button.text-xs {
    color: #60A5FA; /* Azul claro para modo oscuro */
}

/* --- REGLA DE EXCEPCIÓN PARA RESTAURAR COLORES EN TARJETAS DE "VER MEDIDAS" --- */
/* Esto asegura que el texto dentro de las tarjetas de medidas se vea bien */
.modal-background .p-3 p {
  color: #4b5563;
}
.dark .modal-background .p-3 p {
  color: #d1d5db;
}
.modal-background .p-3 p.font-semibold {
  color: #1f2937;
}
.dark .modal-background .p-3 p.font-semibold {
  color: #ffffff;
}

/* --- CORRECCIÓN FORZADA PARA BOTONES "CERRAR" Y "DESCARGAR" SOBRE FOTO --- */
/* Selectores simplificados y correctos */
button.btn-cerrar {
  color: #000000 !important; /* Negro fijo, sin importar el tema */
}
button.btn-descargar {
  color: #ffffff !important; /* Blanco fijo, sin importar el tema */
}

/* --- REFUERZO GLOBAL PARA EL BOTÓN DE BORRAR (ROJO) --- */
/* Esta regla ahora funcionará correctamente al no haber errores de sintaxis antes */
button[class*="bg-red-600"] {
    color: #FFFFFF !important;
}

/* --- CORRECCIÓN FINAL DE TEXTO PARA MODAL DE DETALLE DE EJERCICIO --- */
/* Esta regla es más específica que la regla global y corrige el color del texto */
.ExerciseDetailModal-text-fix p {
    color: #1f2937 !important; /* Texto negro en modo claro */
}
.dark .ExerciseDetailModal-text-fix p {
    color: #e5e7eb !important; /* Texto blanco en modo oscuro */
}
</style>
  <script>
    window.onerror = function(msg, src, line, col, err){
      console.error('WINDOW ONERROR:', { msg, src, line, col, err });
      const root = document.getElementById('root');
      if(root){
        root.innerHTML = '<div style="padding:16px;font-family:sans-serif;color:#b91c1c;background:#fee2e2;border:2px solid #ef4444;border-radius:12px">'+
          '<h3>Se ha producido un error en la app</h3>'+
          '<div><b>Mensaje:</b> '+String(msg)+'</div>'+
          '<div><b>Archivo:</b> '+String(src)+'  <b>Línea:</b> '+String(line)+':'+String(col)+'</div>'+
          '<pre style="white-space:pre-wrap;margin-top:8px">'+(err && err.stack ? err.stack : '')+'</pre>'+
          '<div style="margin-top:8px;font-size:12px;color:#111">Sugerencia: asegúrate de estar conectado a Internet para cargar las librerías. Revisa la Consola (F12) para más detalles.</div>'+
        '</div>';
      }
    };
  </script>
</head>
<body>
  <div id="animated-splash" class="splash">
    <video autoplay muted playsinline id="splash-video" class="splash-video">
      <source src="videos/intro.webm" type="video/webm">
      <source src="videos/intro.mp4" type="video/mp4">
      Tu navegador no soporta vídeos.
    </video>
  </div>
  <div id="root"></div>
  <!-- Contenedor oculto para renderizar los gráficos para el PDF -->
  <div id="pdf-charts-container" style="position: fixed; left: -9999px; top: -9999px; width: 800px; height: 1200px;"></div>
  <script type="text/babel" data-presets="env,react">
    // ====================== Constantes y Utilidades ======================
    const VISUAL_THEME_KEY = 'health_tracker_visual_theme';

    // Definimos los temas disponibles
    const VISUAL_THEMES = {
  'verde-saludable': {
    name: 'Verde saludable',
    cssVariables: {
      '--app-background-light': "url('imagenes/fondo-app.png')",
      '--app-background-dark': "url('imagenes/fondo-app-oscuro.png')",
      '--modal-background-image': "url('imagenes/fondo-app.png')",
    }
  },
  'claridad-calma': {
    name: 'Azul en la calma', // <- renombrado
    cssVariables: {
      '--app-background-light': "url('imagenes/fondo-app-2.png')",
      '--app-background-dark': "url('imagenes/fondo-app-oscuro-2.png')",
      '--modal-background-image': "url('imagenes/Fondo-app-ventanas-2.png')",
    }
  },
  'tierra-santa': {
    name: 'Tierra santa',
    cssVariables: {
      '--app-background-light': "url('imagenes/Fondo-app-3.png')",
      '--app-background-dark': "url('imagenes/Fondo-app-oscuro-3.png')",
      '--modal-background-image': "url('imagenes/Fondo-app-ventanas-3.png')",
    }
  },
  'calida-galaxia': {
    name: 'Cálida Galáxia',
    cssVariables: {
      '--app-background-light': "url('imagenes/Fondo-app-4.png')",
      '--app-background-dark': "url('imagenes/Fondo-app-oscuro-4.png')",
      '--modal-background-image': "url('imagenes/Fondo-app-ventanas-4.png')",
    }
  },
  'universo-absorbente': {
    name: 'Universo absorbente',
    cssVariables: {
      '--app-background-light': "url('imagenes/Fondo-app-5.png')",
      '--app-background-dark': "url('imagenes/Fondo-app-oscuro-5.png')",
      '--modal-background-image': "url('imagenes/Fondo-app-ventanas-5.png')",
    }
  }
};

    const USERS_KEY = 'health_tracker_users';
    const CURRENT_KEY = 'health_tracker_current';
    const THEME_KEY = 'health_tracker_theme';
    const SCENARIO_KEY = 'health_tracker_scenario';
    const MASTER_PIN = '0987';
    const EXERCISE_TIME = [ {value:'15min', label:'15m'}, {value:'30min', label:'30m'}, {value:'45min', label:'45m'}, {value:'1h', label:'1h'}, {value:'1h15', label:'1.15h'}, {value:'1h30', label:'1.5h'}, {value:'2h', label:'2h'}, {value:'+2h', label:'+2h'} ];
    const EXERCISE_TYPE = [ 
  {value:'fuerza', label:'Fuerza'}, 
  {value:'anaerobico', label:'Anaeróbico', description: 'Esfuerzo intenso, sin oxígeno'}, 
  {value:'aerobico', label:'Aeróbico', description: 'Ejercicio con oxígeno, ritmo constante'}, 
  {value:'paseo', label:'Caminata'}, 
  {value:'baile', label:'Baile'} 
];
    const EXERCISE_INTENSITY = [ {value:'suave', label:'Suave'}, {value:'normal', label:'Normal'}, {value:'intenso', label:'Intenso'} ];
    const MEDITATION_TIME = [ {value:'0min', label:'Sin meditación'}, {value:'5min', label:'5m'}, {value:'10min', label:'10m'}, {value:'15min', label:'15m'}, {value:'20min', label:'20m'}, {value:'+20min', label:'+20m'} ];
    const SLEEP = [ {value:'<6h', label:'Menos de 6h'}, {value:'6h', label:'6 horas'}, {value:'7h', label:'7 horas'}, {value:'8h', label:'8 horas'}, {value:'+8h', label:'Más de 8h'}, ];
    const FASTING = [ {value:'0h', label:'Sin ayuno'}, {value:'12h', label:'12/12'}, {value:'14h', label:'14/10'}, {value:'16h', label:'16/8'}, {value:'20h', label:'20/4'}, {value:'24h', label:'24 horas'}, ];
    const DIET = [ {value:'estricta', label:'Estricta'}, {value:'correcta', label:'Correcta'}, {value:'incorrecta', label:'Incorrecta'}, {value:'mala', label:'Autodestrucción'}, ];
    const WATER = [ {value:'0.5L', label:'0,5 L'}, {value:'1L', label:'1 L'}, {value:'1.5L', label:'1,5 L'}, {value:'2L', label:'2 L'}, {value:'+2L', label:'Más de 2 L'}, ];
    const WEEKDAYS = ['domingo', 'lunes', 'martes', 'miércoles', 'jueves', 'viernes', 'sábado'];
const fmt = (d) => { const y = d.getFullYear(), m = String(d.getMonth() + 1).padStart(2, '0'), day = String(d.getDate()).padStart(2, '0'); return `${y}-${m}-${day}`; };
    const sleepHours = c => c === '<6h' ? 5.5 : c === '+8h' ? 9 : parseFloat((c || '7h').replace('h', '')) || 7;
    const exerciseHours = c => { switch(c) { case '0min': return 0; case '15min': return 0.25; case '30min': return 0.5; case '45min': return 0.75; case '1h': return 1; case '1h15': return 1.25; case '1h30': return 1.5; case '2h': return 2; case '+2h': return 2.5; default: return 0; } };
    const waterLiters = c => c === '+2L' ? 2.5 : parseFloat((c || '1.5L').replace('L', '').replace(',', '.')) || 1.5;
    const meditationMinutes = c => { switch(c) { case '0min': return 0; case '5min': return 5; case '10min': return 10; case '15min': return 15; case '20min': return 20; case '+20min': return 25; default: return 0; } };
    const humanizeDays = (n) => {
      if (!isFinite(n) || n < 0) return '—'; if (n < 1) return '¡Hoy!'; const days = Math.round(n); if (days < 30) return `${days} día${days > 1 ? 's' : ''}`; const months = Math.floor(days / 30); const remDays = days % 30; if (remDays === 0) return `${months} ${months === 1 ? 'mes' : 'meses'}`; return `${months} ${months === 1 ? 'mes' : 'meses'} y ${remDays} día${remDays > 1 ? 's' : ''}`;
    };
    // ====================== Lógica de Proyección (Sin cambios) ======================
    function calculateProjectionScenarios(user) {
      const MS_DAY = 86400000;
      const windowDays = 7, alpha = 0.12, changeLimit = 0.20;
      const MAX_WEEKLY_LOSS_FRAC = 0.0125, MIN_WEEKLY_LOSS_FRAC = 0.005;
      const SCENARIO_80  = { optimista: -0.10, neutro: 0.00, pesimista: +0.10 };
      const SCENARIO_100 = { optimista: -0.20, neutro: 0.00, pesimista: +0.20 };
      const entries = (user.entries || []).filter(e => e && e.weight != null && e.date).sort((a, b) => new Date(a.date) - new Date(b.date));
      if (entries.length < 3) return { message: 'Se necesitan más registros para una proyección fiable.' };
      const today = entries[entries.length - 1], prev  = entries[entries.length - 2];
      const { startWeight: W_ini, targetWeight: W_obj } = user.profile || {};
      const W_today = today.weight, total_goal_loss = (W_ini - W_obj);
      if (!isFinite(total_goal_loss) || total_goal_loss <= 0) return { message: 'Objetivo o peso inicial inválidos.' };
      const remaining_final = Math.max(0, W_today - W_obj);
      if (remaining_final <= 0) return { results: { optimista: { daysTo80: 0, eta80: new Date(), daysToFinal: 0, etaFinal: new Date() }, neutro: { daysTo80: 0, eta80: new Date(), daysToFinal: 0, etaFinal: new Date() }, pesimista: { daysTo80: 0, eta80: new Date(), daysToFinal: 0, etaFinal: new Date() } }, message: '¡Objetivo alcanzado!' };
      const lastWindow = entries.slice(Math.max(0, entries.length - windowDays));
      let sumDays = 0, sumLoss = 0;
      for (let i = 0; i < lastWindow.length - 1; i++) {
        const d0 = new Date(lastWindow[i].date), d1 = new Date(lastWindow[i+1].date);
        const days = (d1 - d0) / MS_DAY;
        if (days > 0) { sumDays += days; sumLoss += (lastWindow[i].weight - lastWindow[i+1].weight); }
      }
      const avgLossPerDay = (sumDays > 0) ? (sumLoss / sumDays) : ((prev.weight - W_today) / Math.max(1, (new Date(today.date) - new Date(prev.date)) / MS_DAY));
      const r_prev = prev.r_est || avgLossPerDay;
      let r_est = alpha * avgLossPerDay + (1 - alpha) * r_prev;
      r_est = Math.max(r_prev * (1 - changeLimit), Math.min(r_prev * (1 + changeLimit), r_est));
      const B = { activity:1.0, diet:1.0, sleep:1.0, water:1.0 };
      const ex = typeof today.exerciseTime !== 'undefined' ? exerciseHours(today.exerciseTime) : 0;
      if (ex >= 1) B.activity = 1.05; else if (ex < 0.5) B.activity = 0.97;
      const d = (today.diet || '').toString().toLowerCase();
      if (d.includes('estrict')) B.diet = 1.10; else if (d.includes('correct')) B.diet = 1.00; else if (d.includes('incorrect')) B.diet = 0.90; else if (d.includes('mala') || d.includes('autodestruccion')) B.diet = 0.80;
      const sl = typeof today.sleep !== 'undefined' ? sleepHours(today.sleep) : 7;
      if (sl >= 8) B.sleep = 1.02; else if (sl < 7) B.sleep = 0.97;
      const w = typeof today.water !== 'undefined' ? waterLiters(today.water) : 1.5;
      if (w >= 2.0) B.water = 1.02; else if (w < 1.5) B.water = 0.98;
      let r_est_mod = r_est * B.activity * B.diet * B.sleep * B.water;
      const maxDaily = (W_today * MAX_WEEKLY_LOSS_FRAC) / 7, minDaily = (W_today * MIN_WEEKLY_LOSS_FRAC) / 7;
      if (r_est_mod > maxDaily) r_est_mod = maxDaily;
      if (r_est_mod <= 0 && avgLossPerDay > 0) r_est_mod = Math.max(minDaily, avgLossPerDay * 0.5);
      if (!(r_est_mod > 0)) return { message: 'Ritmo nulo o negativo. Revisa hábitos.' };
      const target80 = W_ini - 0.8 * total_goal_loss;
      const remaining80 = Math.max(0, W_today - target80), remaining20 = Math.max(0, target80 - W_obj);
      const days80_neutral  = remaining80 / r_est_mod, days20_neutral  = remaining20 / r_est_mod;
      const applyScenario = (days80, days20, scenarioName) => {
        const d80  = remaining80 > 0 ? days80 * (1 + SCENARIO_80[scenarioName]) : 0;
        const d100 = (remaining20 > 0 ? days20 * (1 + SCENARIO_100[scenarioName]) : 0) + d80;
        return { daysTo80: d80, eta80: new Date(Date.now() + d80 * MS_DAY), daysToFinal: d100, etaFinal: new Date(Date.now() + d100 * MS_DAY) };
      };
      const results = { optimista: applyScenario(days80_neutral, days20_neutral, 'optimista'), neutro: applyScenario(days80_neutral, days20_neutral, 'neutro'), pesimista: applyScenario(days80_neutral, days20_neutral, 'pesimista') };
      today.r_est = r_est;
      return { results };
    }
    // ====================== Lógica de Feedback (Sin cambios) ======================
    function generateDailyFeedback(user, historyIn = {}) {
      const entries = (user.entries || []).filter(e => e && e.weight != null && e.date).sort((a, b) => new Date(a.date) - new Date(b.date));
      const { startWeight: W_ini, targetWeight: W_obj, name: userName } = user.profile || {};
      if (entries.length < 2 || !isFinite(W_ini) || !isFinite(W_obj)) return { globalMessage: `¡Bienvenido/a, ${userName}! Este es tu panel de progreso.`, actionMessages: ["Registra tu peso diariamente para activar las proyecciones.", "Puedes cambiar entre escenarios (Optimista, Neutro, Pesimista) para ver diferentes proyecciones."], historyOut: historyIn };
      const today = entries[entries.length - 1], yesterday = entries[entries.length - 2];
      const W_today = today.weight, W_prev = yesterday.weight;
      const goal = Math.max(0.0001, W_ini - W_obj), progress = Math.max(0, Math.min(1, (W_ini - W_today) / goal));
      const inFinalPhase = (progress >= 0.80);
      if (progress >= 1.0) return { globalMessage: `¡EXTRAORDINARIO, ${userName}! Has alcanzado tu objetivo. ¡Enhorabuena!`, actionMessages: ["Has demostrado una constancia increíble. ¡Disfruta de tu logro!"], historyOut: historyIn };
      const prev_progress = (W_ini - W_prev) / goal;
      if (progress >= 0.8 && prev_progress < 0.8) return { globalMessage: `¡Felicidades, ${userName}! Ya has superado el 80% de tu objetivo.`, actionMessages: ["Estás en la recta final. ¡Ahora más foco y constancia que nunca!"], historyOut: historyIn };
      const T = inFinalPhase ? Math.max(0.0005 * W_today, 0.05) : Math.max(0.0015 * W_today, 0.15);
      const delta = W_today - W_prev;
      const last7 = entries.slice(Math.max(0, entries.length - 8));
      let r7 = 0;
      if (last7.length >= 2) { const first = last7[0], days = (new Date(today.date) - new Date(first.date)) / 86400000; if (days > 0) r7 = (W_today - first.weight) / days; }
      let dailyClass = 'flat';
      if (delta <= -2 * T) dailyClass = 'loss_strong'; else if (delta <= -T) dailyClass = 'loss_light'; else if (Math.abs(delta) <= T) dailyClass = 'flat'; else if (delta <= 2 * T) dailyClass = 'gain_light'; else dailyClass = 'gain_strong';
      const trendIsGood = (r7 < 0);
      const variants = {
        global: { initial: { loss_strong: ["Muy bien, hoy tu esfuerzo se ha reflejado en la báscula. ¡Sigue así!", "Gran paso adelante. Estás construyendo inercia positiva.", "Excelente avance para esta fase. Mantén tu estrategia.", "Buen trabajo: se nota tu constancia en el resultado de hoy.", "Tu disciplina se nota: ¡paso firme hacia tu objetivo!"], loss_light: ["Buen paso adelante. La constancia está dando resultados.", "Progreso diario correcto: suma y sigue.", "Pequeña bajada hoy, que cuenta para la tendencia.", "Bien: el plan va en la dirección adecuada.", "Buen ajuste: cada día que cumples acerca el objetivo."], flat: ["Peso estable: completamente normal en esta fase. La tendencia semanal manda.", "Día plano: la clave es seguir acumulando días buenos.", "Estabilidad esperable. Mantén hábitos; verás el efecto en la semana.", "Sin cambios hoy; no te distraigas de lo importante: constancia.", "Hoy plano, mañana oportunidad. La media semanal es lo que importa."], gain_light_goodtrend: ["Pequeña subida, pero la tendencia semanal es buena. Mantén el rumbo.", "Ligera subida hoy; tu semana sigue en positivo.", "Fluctuación normal. La tendencia te respalda.", "Un día no define el camino: la semana va bien.", "Subida suave; la inercia general es favorable."], gain_light_badtrend: ["Subida ligera. Ajustar algunos hábitos puede ayudarte a recuperar ritmo.", "Un repunte leve; pon el foco en agua, sueño y calidad de comida.", "Señal suave de ajuste: prioriza comidas simples y movimiento.", "Pequeño repunte: revisa sal, agua y horarios.", "Subida leve; hoy es buen día para volver a lo básico."], gain_strong: ["La báscula subió más de lo habitual. Ajusta hábitos para retomar el ritmo.", "Subida significativa hoy. Recupera la estructura de tus comidas y horarios.", "Día exigente. Centrémonos en agua, descanso y comida real."] }, final: { loss_strong: ["¡Gran avance en un tramo exigente! Cada gramo cuenta ahora.", "Excelente bajada en la recta final. Mantén el foco.", "Avance sólido cuando más cuesta. Enhorabuena.", "Muy buen día en un tramo difícil; sigue así.", "Esto es progreso de calidad: bien por tu constancia."], loss_light: ["Bien hecho: en la fase final, pérdidas pequeñas son victorias.", "Pequeña bajada, muy valiosa en esta etapa.", "Buen progreso para este tramo: conta mucho.", "Bajada discreta pero importante cerca de la meta.", "Cada pequeño descenso marca la diferencia ahora."], flat: ["Estabilidad normal en la recta final. La tendencia y los hábitos mandan.", "Día plano típico en el último tramo. La constancia decide.", "Sin cambios hoy; evita sobre-reaccionar y sigue el plan.", "Plano en fase final es común: paciencia activa.", "La recta final es irregular; mantén tu rutina."], gain_light_goodtrend: ["Ligera subida hoy, pero la tendencia semanal te favorece.", "Pequeño repunte; tu semana sigue bien orientada.", "Subida leve en tramo final: normal si el plan es sólido.", "Fluctuación menor; mantén disciplina y descanso.", "Repunte leve sin romper la inercia positiva."], gain_light_badtrend: ["Subida ligera en un tramo sensible. Refuerza agua, sueño y alimentos simples.", "Repunte en la recta final: cuida sal, horarios y cantidad.", "Señal de ajuste fina: prioriza comida real y buen descanso.", "Pequeña subida que conviene corregir cuanto antes.", "Momento de afinar: hidrátate y vuelve a la base del plan."], gain_strong: ["Subida significativa en la recta final. Reencuadra hábitos hoy.", "Día difícil cerca de la meta; estructura tus comidas y descansa.", "Señal clara de ajuste: vuelve a lo simple y prioriza recuperación."] } },
        explain: { low_sleep: ["Dormiste poco: puede aumentar apetito y retención. Apunta a 7–8 h.", "Pocas horas de sueño; afecta el peso a corto plazo. Prioriza descansar.", "Sueño corto hoy. Dormir mejor facilita la pérdida."], low_water: ["Bebiste poca agua; puede favorecer retención. Objetivo ≥2 L.", "Hidratación escasa. Sube agua para mejorar sensación y progreso.", "Poca agua hoy; hidratarte ayuda a controlar apetito y líquidos."], hard_training: ["Entrenamiento intenso: posible inflamación muscular temporal.", "Sesión fuerte; el peso puede subir por glucógeno. Normal.", "Carga alta hoy. La báscula puede tardar 24–48 h en responder."], salty_foods: ["Comidas saladas/ultraprocesadas elevan retención. Vuelve a comida simple.", "Alta sal/ultraprocesados hoy; suben líquidos. Prioriza fresco.", "Día muy salado. Compensa con agua y verduras."] },
        diet_good: ["Tu alimentación va muy bien, es tu ancla.", "Buena calidad de comidas; eso marca diferencia.", "La estructura de tus comidas está ayudando mucho."], diet_tune: ["Pequeño ajuste: reduce azúcares líquidos o cenas tardías.", "Afina porciones y prioriza proteína y fibra.", "Evita ultraprocesados hoy; centra comida real."], diet_warn: ["La alimentación frenó el progreso: retoma comidas completas.", "Vuelve a la base del plan y evita extras hoy.", "Hoy te alejaste del plan; mañana, vuelta a lo simple."],
        ex_good: ["Excelente actividad; mantenerla sostiene la tendencia.", "Buen movimiento hoy; tu cuerpo lo agradece.", "Suma de pasos/entreno muy positiva."], ex_more: ["Añade 10–20 min de movimiento suave hoy.", "Intenta una caminata extra; suma sin fatigar.", "Un poco más de NEAT puede destrabar la báscula."],
        sleep_good: ["Dormir bien te protege en días planos.", "Buen descanso: mantiene el apetito a raya.", "Sueño adecuado: clave para rendir y recuperar."], sleep_more: ["Prioriza 7–8 h de sueño para apoyar el plan.", "Acuéstate antes para dormir más y mejor.", "Una noche corta se nota: recupera horas hoy."],
        water_good: ["Hidratación correcta: aliada de tu progreso.", "Buen nivel de agua hoy; sigue así.", "Mantener ≥2 L al día te ayuda mucho."], water_more: ["Objetivo ≥2 L hoy: ayuda a reducir retención.", "Lleva una botella encima para facilitarlo.", "Aumenta agua entre comidas para saciedad."],
        trend_good: ["La tendencia semanal es tu aliada: no cambies por un dato aislado.", "Semana en positivo: mantén los básicos.", "La dirección general es buena; sigue el plan."]
      };
      const history = { ...historyIn };
      const pickVariant = (key, options) => {
        const lastKey = history.lastPicked?.[key];
        const pool = options.map((t, idx) => ({ t, idx })).filter(item => item.idx !== lastKey);
        const chosen = pool.length ? pool[Math.floor(Math.random() * pool.length)] : { t: options[0], idx: 0 };
        history.lastPicked = history.lastPicked || {}; history.lastPicked[key] = chosen.idx;
        return chosen.t;
      };
      const todayBehaviors = { ex: exerciseHours(today.exerciseTime || 0), sl: sleepHours(today.sleep || 0), w: waterLiters(today.water || 0), d: (today.diet || '').toLowerCase() };
      const gBucket = (() => { const phase = inFinalPhase ? 'final' : 'initial'; switch (dailyClass) { case 'loss_strong': return `global.${phase}.loss_strong`; case 'loss_light': return `global.${phase}.loss_light`; case 'flat': return `global.${phase}.flat`; case 'gain_light': return trendIsGood ? `global.${phase}.gain_light_goodtrend` : `global.${phase}.gain_light_badtrend`; case 'gain_strong': return `global.${phase}.gain_strong`; default: return `global.${phase}.flat`; } })();
      const getByPath = (obj, path) => path.split('.').reduce((o, k) => (o && o[k] != null ? o[k] : null), obj);
      const globalOptions = getByPath(variants, gBucket) || ["Sigue registrando tus datos para recibir recomendaciones."];
      const globalMessage = pickVariant(gBucket, globalOptions);
      const actions = [];
      if (dailyClass === 'flat' || dailyClass.startsWith('gain')) {
        if (todayBehaviors.sl < 6.5) actions.push(pickVariant('explain.low_sleep', variants.explain.low_sleep));
        else if (todayBehaviors.w < 1.5) actions.push(pickVariant('explain.low_water', variants.explain.low_water));
        else if (todayBehaviors.ex >= 1.2) actions.push(pickVariant('explain.hard_training', variants.explain.hard_training));
        else if (todayBehaviors.d.includes('autodestru') || todayBehaviors.d.includes('mala')) actions.push(pickVariant('explain.salty_foods', variants.explain.salty_foods));
      }
      const pushIfRoom = (msg) => { if (msg && actions.length < 2) actions.push(msg); };
      if (todayBehaviors.d.includes('estrict')) pushIfRoom(pickVariant('diet_good', variants.diet_good)); else if (todayBehaviors.d.includes('correct')) pushIfRoom(pickVariant('diet_tune', variants.diet_tune)); else if (todayBehaviors.d.includes('incorrect') || todayBehaviors.d.includes('mala')) pushIfRoom(pickVariant('diet_warn', variants.diet_warn));
      if (actions.length < 2) { if (todayBehaviors.ex >= 1) pushIfRoom(pickVariant('ex_good', variants.ex_good)); else if (todayBehaviors.ex < 0.5) pushIfRoom(pickVariant('ex_more', variants.ex_more)); }
      if (actions.length < 2) { if (todayBehaviors.sl >= 7) pushIfRoom(pickVariant('sleep_good', variants.sleep_good)); else pushIfRoom(pickVariant('sleep_more', variants.sleep_more)); }
      if (actions.length < 2) { if (todayBehaviors.w >= 2) pushIfRoom(pickVariant('water_good', variants.water_good)); else pushIfRoom(pickVariant('water_more', variants.water_more)); }
      if (actions.length < 2 && trendIsGood) pushIfRoom(pickVariant('trend_good', variants.trend_good));
      return { globalMessage, actionMessages: actions, historyOut: history };
    }

// ====================== Función para generar PDF de Medidas ======================
function generateMeasurementsPDF(user, measurements) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'mm', 'a4'); // A4 Vertical
    const pageWidth = doc.internal.pageSize.getWidth();
    const pageHeight = doc.internal.pageSize.getHeight();
    let y = 15;

    // --- CABECERA ---
    doc.setFillColor(30, 64, 175);
    doc.rect(0, 0, 210, 22, 'F');
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(255);
    doc.setFontSize(18);
    doc.text('ControlaTuPeso+', 14, 15);
    const today = new Date().toLocaleDateString('es-ES', { year: 'numeric', month: '2-digit', day: '2-digit' });
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(10);
    doc.text(`Informe de Medidas Corporales - ${today}`, 210 - 14, 15, { align: 'right' });
    doc.setTextColor(0, 0, 0);

    y += 15;
    doc.setFontSize(14);
    doc.setFont('helvetica', 'bold');
    doc.text('Datos del Usuario', 14, y);
    y += 8;
    doc.setFontSize(11);
    doc.setFont('helvetica', 'normal');
    doc.text(`Nombre: ${user.profile.name}`, 14, y);
    y += 6;
    const sortedEntries = user.entries.slice().sort((a, b) => new Date(a.date) - new Date(b.date));
    const firstEntryDate = sortedEntries.length > 0 ? new Date(sortedEntries[0].date + 'T00:00:00').toLocaleDateString('es-ES') : new Date(user.profile.processStartDate || user.profile.createdAt).toLocaleDateString('es-ES');
    doc.text(`Fecha de inicio del proceso: ${firstEntryDate}`, 14, y);
    y += 6;
    doc.text(`Altura: ${user.profile.height} cm`, 14, y);
    y += 6;
    doc.text(`Peso inicial / objetivo: ${user.profile.startWeight} kg / ${user.profile.targetWeight} kg`, 14, y);
    y += 10;

    // --- TÍTULO DEL INFORME ---
    doc.setFontSize(14);
    doc.setFont('helvetica', 'bold');
    doc.text('Medidas Corporales Registradas', 14, y);
    y += 10;

    // --- DEFINIR COLUMNAS ---
    const headers = ['Fecha', 'Tipo', 'Cuello', 'Muslos', 'Cadera', 'Cintura', 'Pecho', 'Brazo'];
    const colWidths = [30, 30, 25, 25, 25, 25, 25, 25]; // Anchos de columna
    const totalTableWidth = colWidths.reduce((a, b) => a + b, 0);
    const startX = (pageWidth - totalTableWidth) / 2; // Centrar tabla

    // --- DIBUJAR CABECERAS DE TABLA ---
    doc.setFontSize(10);
    doc.setFont('helvetica', 'bold');
    headers.forEach((header, index) => {
        doc.text(header, startX + colWidths.slice(0, index).reduce((a, b) => a + b, 0) + colWidths[index] / 2, y, { align: 'center' });
    });
    y += 5;
    doc.line(startX, y, startX + totalTableWidth, y); // Línea debajo de las cabeceras
    y += 5;

    // --- DIBUJAR DATOS ---
    doc.setFont('helvetica', 'normal');
    const sortedMeasurements = [...measurements].sort((a, b) => new Date(b.date) - new Date(a.date));
    sortedMeasurements.forEach((m, rowIndex) => {
        if (y > 270) {
            doc.addPage();
            y = 20;
            // Redibujar cabeceras en nueva página
            doc.setFont('helvetica', 'bold');
            headers.forEach((header, index) => {
                doc.text(header, startX + colWidths.slice(0, index).reduce((a, b) => a + b, 0) + colWidths[index] / 2, y, { align: 'center' });
            });
            y += 5;
            doc.line(startX, y, startX + totalTableWidth, y);
            y += 5;
            doc.setFont('helvetica', 'normal');
        }

        // Alternar color de fondo
        if (rowIndex % 2 === 1) {
            doc.setFillColor(240, 249, 255); // Azul muy clarito (bg-blue-50)
            doc.rect(startX, y - 4, totalTableWidth, 7, 'F');
        }

        const row = [
            new Date(m.date).toLocaleDateString('es-ES'),
            m.type === 'circunferencia' ? 'cm' : 'mm',
            m.cuello ?? '—',
            m.muslos ?? '—',
            m.cadera ?? '—',
            m.cintura ?? '—',
            m.pecho ?? '—',
            m.brazo ?? '—'
        ];
        row.forEach((cell, index) => {
            doc.text(String(cell), startX + colWidths.slice(0, index).reduce((a, b) => a + b, 0) + colWidths[index] / 2, y, { align: 'center' });
        });
        y += 7;
    });

    // --- PIE DE PÁGINA ---
    const pageCount = doc.internal.getNumberOfPages();
    for (let i = 1; i <= pageCount; i++) {
        doc.setPage(i);
        doc.setFontSize(8);
        doc.setTextColor(150);
        doc.text(`Informe generado el ${today} - Página ${i} de ${pageCount}`, pageWidth / 2, 290, { align: 'center' });
    }

    doc.save(`Medidas_Corporales_${new Date().toISOString().split('T')[0]}.pdf`);
}
    // ====================== Hooks Personalizados (useLocalStorage, useTheme) ======================
    function useLocalStorage(key, initial){
      const [state,setState]=React.useState(()=>{ 
        try {
          const raw=localStorage.getItem(key);
          if (!raw) return initial;
          return JSON.parse(raw);
        } catch(e) {
          console.warn(`Error parsing localStorage key “${key}”:`, e);
          return initial;
        }
      }); 
      React.useEffect(()=>{ 
        try {
          localStorage.setItem(key, JSON.stringify(state)) 
        } catch(e) {
          console.error(`Error saving localStorage key “${key}”:`, e);
        }
      },[key,state]); 
      return [state,setState]; 
    }
    function useTheme(){ const [theme,setTheme]=useLocalStorage(THEME_KEY,'light'); React.useEffect(()=>{ document.documentElement.classList.toggle('dark', theme === 'dark') },[theme]); return {theme, toggle:()=>setTheme(t=>t==='light'?'dark':'light')}; }
    // Hook para gestionar el tema visual (fondos, colores, etc.)
    function useVisualTheme() {
      const [themeName, setThemeName] = useLocalStorage(VISUAL_THEME_KEY, 'verde-saludable');

      React.useEffect(() => {
        const theme = VISUAL_THEMES[themeName] || VISUAL_THEMES['verde-saludable'];
        for (const key in theme.cssVariables) {
          document.documentElement.style.setProperty(key, theme.cssVariables[key]);
        }
      }, [themeName]);

      return [themeName, setThemeName];
    }
    // ====================== Componentes Base (Card, Button, etc.) ======================
const Card = ({children, className='', ...props})=> <div className={`bg-white/75 dark:bg-gray-800/80 backdrop-blur-sm rounded-2xl elevated-border shadow-sm p-4 ${className}`} {...props}>{children}</div>;
    const Button = ({children,onClick,type='button',variant='primary',title, className='', disabled=false})=>{ const base='inline-flex items-center justify-center gap-2 rounded-lg transition px-4 py-2 font-semibold disabled:opacity-50 disabled:cursor-not-allowed'; const v = variant==='primary'?'bg-blue-600 text-white hover:bg-blue-700' : variant==='secondary'?'bg-gray-100 text-gray-800 hover:bg-gray-200 dark:bg-gray-600 dark:text-gray-100 dark:hover:bg-gray-500' : variant==='danger'?'bg-red-600 text-white hover:bg-red-700':'btn-ghost bg-white/75 backdrop-blur-sm hover:bg-gray-50 dark:bg-gray-700/80 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-100'; return <button type={type} onClick={onClick} className={`${base} ${v} ${className}`} title={title} disabled={disabled}>{children}</button>; };
                const Input = ({label, containerClassName='', ...props})=>( <div className={`space-y-1 ${containerClassName}`}>{label && <label className="text-base font-medium text-gray-800 dark:text-gray-200">{label}</label>}<input {...props} className={`w-full px-3 py-2 rounded-lg border-2 border-gray-400 focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-800 dark:text-white dark:border-gray-500 ${props.className||''}`}/></div> );
    const Select = ({label, options=[], value, onChange, containerClassName='', className=''})=> ( <div className={`space-y-1 ${containerClassName}`}>{label && <label className="text-base font-medium text-gray-800 dark:text-gray-200">{label}</label>}<select value={value??''} onChange={onChange} className={`w-full px-3 py-2 rounded-lg border-2 border-gray-400 focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-800 dark:text-white dark:border-gray-500 ${className}`}>{options.map(o=> <option key={o.value} value={o.value}>{o.label}</option>)}</select></div> );

// Componente de entrada de fecha personalizado
const CustomDateInput = ({ label, value, onChange, containerClassName = "" }) => {
  // 1. Creamos una "referencia" para poder comunicarnos con el campo de fecha.
  const inputRef = React.useRef(null);

  return (
    <div className={`space-y-1 ${containerClassName}`}>
      {label && <label className="text-base font-medium text-gray-800 dark:text-gray-200">{label}</label>}
      <div className="relative">
        <input
          ref={inputRef} // 2. Asignamos la referencia a nuestro campo de fecha.
          type="date"
          value={value}
          onChange={onChange}
          className="w-full px-3 py-2 pr-10 rounded-lg border-2 border-gray-400 focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-800 dark:text-white dark:border-gray-500 appearance-none"
        />
        {/* 3. ¡Aquí está la magia! Hacemos que el icono sea clicable. */}
<CalendarIcon
  onClick={() => inputRef.current?.showPicker()}
  className="w-6 h-6 absolute right-3 top-1/2 transform -translate-y-1/2 cursor-pointer text-gray-800 dark:text-white"
/>
      </div>
    </div>
  );
};
// ====================== INICIO DEL NUEVO COMPONENTE AppModalHeader ======================
const AppModalHeader = ({ title, onClose }) => (
  <div className="relative overflow-hidden flex items-center justify-between border-b-2 border-gray-300 dark:border-gray-600 p-4">
    {/*
      * CORRECCIÓN CLAVE: La opacidad ahora es /80 en lugar de /50
    */}
    <div className="absolute inset-0 bg-gradient-to-l from-blue-200/100 dark:from-blue-800/55 to-transparent pointer-events-none z-0"></div>
    <h3 className="relative z-10 text-lg font-semibold text-gray-800 dark:text-white">{title}</h3>
    {onClose && (
      <button onClick={onClose} className="relative z-20 px-2 py-1 rounded hover:bg-gray-100 dark:hover:bg-gray-600 text-gray-800 dark:text-white">✕</button>
    )}
  </div>
);
// ====================== FIN DEL NUEVO COMPONENTE AppModalHeader ======================
// ====================== INICIO DEL CÓDIGO ACTUALIZADO Y CORRECTO PARA Modal ======================
const Modal = ({open, onClose, children, size = 'md', customHeader}) => {
  if (!open) return null;
  const w = size === 'lg' ? 'max-w-4xl' : size === 'md' ? 'max-w-2xl' : 'max-w-lg';

  return (
    <div className="fixed inset-0 z-50 bg-black/60 flex items-center justify-center p-4">
      {/* Contenedor principal del modal */}
      <div className={`w-full ${w} max-h-[90vh] modal-background bg-cover bg-center rounded-2xl elevated-border shadow-lg flex flex-col`}>
        {/* Capa de cristal esmerilado que envuelve todo */}
        <div className="w-full h-full bg-white/30 dark:bg-gray-900/30 backdrop-blur-md rounded-2xl flex flex-col overflow-hidden">
          {/*
            * INICIO DE LA CORRECCIÓN CLAVE
            * 1. El encabezado (customHeader) se renderiza aquí, en la parte superior y FIJA.
            *    Ya no está dentro de la zona de scroll.
          */}
          {customHeader}

          {/*
            * 2. Creamos un nuevo div que envolverá el contenido principal (children).
            *    - `flex-1` (o flex-grow) hace que ocupe todo el espacio vertical restante.
            *    - `overflow-y-auto` hace que SOLO este div sea el que tenga scroll si el contenido es demasiado largo.
          */}
          <div className="flex-1 overflow-y-auto">
            {children}
          </div>
        </div>
      </div>
    </div>
  );
};
// ====================== FIN DEL CÓDIGO ACTUALIZADO Y CORRECTO PARA Modal ======================

    {/* ====================== Iconos SVG (CORREGIDOS Y COMPLETOS v2.2) ====================== */}
    const SunIcon = ({ className }) => ( <svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" className={className}> <path fillRule="evenodd" fill="#fcc667" d="M43.88,54.57l1.25,2.18a1,1,0,0,0,1.74-1l-1.26-2.18a1,1,0,0,0-1.37-.36A1,1,0,0,0,43.88,54.57Z"/> <path fillRule="evenodd" fill="#fcc667" d="M18.39,53.57l-1.26,2.18a1,1,0,0,0,1.74,1l1.25-2.18a1,1,0,0,0-.36-1.36A1,1,0,0,0,18.39,53.57Z"/> <path fillRule="evenodd" fill="#fcc667" d="M6.51,31H4a1,1,0,0,0,0,2H6.51a1,1,0,0,0,0-2Z"/> <path fillRule="evenodd" fill="#fcc667" d="M57.49,33H60a1,1,0,0,0,0-2H57.49a1,1,0,0,0,0,2Z"/> <path fillRule="evenodd" fill="#fcc667" d="M20.12,9.43,18.87,7.25a1,1,0,0,0-1.74,1l1.26,2.18a1,1,0,0,0,1.37.36A1,1,0,0,0,20.12,9.43Z"/> <path fillRule="evenodd" fill="#fcc667" d="M45.61,10.43l1.26-2.18a1,1,0,0,0-1.74-1L43.88,9.43a1,1,0,0,0,.36,1.36A1,1,0,0,0,45.61,10.43Z"/> <path fill="#fcc667" d="M31.71,4.23,29.08,15.74a2.19,2.19,0,0,1-3.61,1.12l-3.42-3a.46.46,0,0,0-.75.43l.85,4.45a2.58,2.58,0,0,1-.73,2.14,2.24,2.24,0,0,1-2,.42L8.1,17.86a.3.3,0,0,0-.29.51l8.65,8a2.42,2.42,0,0,1,.61,2.15,2.39,2.39,0,0,1-1.45,1.53l-4.27,1.49a.45.45,0,0,0,0,.86l4.27,1.48a2.63,2.63,0,0,1,1.5,1.72,2.27,2.27,0,0,1-.66,2l-8.65,8a.3.3,0,0,0,.29.51l11.28-3.49a2.46,2.46,0,0,1,2.17.55,2.4,2.4,0,0,1,.6,2l-.85,4.45a.46.46,0,0,0,.75.43l3.42-3a2.64,2.64,0,0,1,2.23-.44,2.25,2.25,0,0,1,1.38,1.56l2.63,11.51a.3.3,0,0,0,.58,0l2.63-11.51a2.19,2.19,0,0,1,3.61-1.12l3.42,3a.46.46,0,0,0,.75-.43l-.85-4.45a2.61,2.61,0,0,1,.73-2.15,2.27,2.27,0,0,1,2-.42L55.9,46.14a.3.3,0,0,0,.29-.51l-8.65-8a2.2,2.2,0,0,1,.84-3.69l4.27-1.48a.45.45,0,0,0,0-.86l-4.27-1.49a2.62,2.62,0,0,1-1.5-1.71,2.27,2.27,0,0,1,.66-2l8.65-8a.3.3,0,0,0-.29-.51L44.62,21.34a2.19,2.19,0,0,1-2.77-2.56l.85-4.45A.46.46,0,0,0,42,13.9l-3.42,3a2.61,2.61,0,0,1-2.23.43,2.21,2.21,0,0,1-1.38-1.55L32.29,4.23A.3.3,0,0,0,31.71,4.23Z"/> <path fill="#fbae36" d="M43.07,32A11.07,11.07,0,1,1,32,20.93,11.07,11.07,0,0,1,43.07,32Z"/> <g> <path fill="#fa8e1b" d="M32,44.07A12.07,12.07,0,1,1,44.07,32,12.09,12.09,0,0,1,32,44.07Zm0-22.14A10.07,10.07,0,1,0,42.07,32,10.08,10.08,0,0,0,32,21.93Z"/> </g> </svg> );
    const MoonIcon = ({ ...props }) => ( <svg xmlns="http://www.w3.org/2000/svg" version="1.1" viewBox="0 0 1024 1024" {...props} className="w-6 h-6"> <g><path style={{opacity:1}} fill="none" d="M -0.5,-0.5 C 340.833,-0.5 682.167,-0.5 1023.5,-0.5C 1023.5,340.833 1023.5,682.167 1023.5,1023.5C 682.167,1023.5 340.833,1023.5 -0.5,1023.5C -0.5,682.167 -0.5,340.833 -0.5,-0.5 Z"/></g> <g><path style={{opacity:1}} fill="#7d909c" d="M 511.5,140.5 C 522.34,139.176 533.34,139.176 544.5,140.5C 544.376,141.107 544.043,141.44 543.5,141.5C 533.013,140.506 522.346,140.172 511.5,140.5 Z"/></g> <g><path style={{opacity:1}} fill="#425660" d="M 497.5,141.5 C 491.712,142.81 485.712,143.477 479.5,143.5C 485.274,142.054 491.274,141.388 497.5,141.5 Z"/></g> <g><path style={{opacity:1}} fill="#012c49" d="M 511.5,140.5 C 522.346,140.172 533.013,140.506 543.5,141.5C 512.083,151.909 482.75,166.409 455.5,185C 448.951,190.097 442.285,194.93 435.5,199.5C 431.324,199.168 427.824,200.502 425,203.5C 424.667,203.167 424.333,202.833 424,202.5C 422.667,205.167 421.333,207.833 420,210.5C 416.766,213.015 413.433,215.349 410,217.5C 409.316,218.784 409.483,219.951 410.5,221C 409.244,221.417 408.577,222.25 408.5,223.5C 340.481,292.956 308.648,376.622 313,474.5C 320.859,576.743 366.026,657.909 448.5,718C 488.561,745.523 532.228,765.857 579.5,779C 584.827,779.943 590.16,780.777 595.5,781.5C 601.911,783.344 608.578,784.344 615.5,784.5C 663.104,787.478 709.104,780.312 753.5,763C 780.12,751.857 805.454,738.357 829.5,722.5C 830.391,721.89 831.391,721.557 832.5,721.5C 833.492,721.328 834.158,721.662 834.5,722.5C 797.065,777.097 748.398,818.597 688.5,847C 603.984,885.649 516.651,892.982 426.5,869C 370.022,852.115 320.355,823.948 277.5,784.5C 278.329,782.067 277.829,779.733 276,777.5C 272.966,776.399 270.133,774.899 267.5,773C 267.957,772.586 268.291,772.086 268.5,771.5C 266.076,769.697 264.409,767.363 263.5,764.5C 260.489,761.988 257.656,759.322 255,756.5C 253.334,757.34 253.167,756.84 254.5,755C 252.431,752.466 249.765,751.299 246.5,751.5C 243.899,748.396 241.066,745.396 238,742.5C 231.303,732.984 224.47,723.651 217.5,714.5C 173.96,644.685 154.294,568.351 158.5,485.5C 160.311,475.685 161.644,465.685 162.5,455.5C 162.5,454.167 162.5,452.833 162.5,451.5C 164.311,449.615 165.478,447.281 166,444.5C 166.499,440.848 166.665,437.182 166.5,433.5C 176.952,382.278 197.452,335.611 228,293.5C 235.322,283.683 243.155,274.35 251.5,265.5C 253.482,265.005 255.482,264.505 257.5,264C 258.851,262.383 260.518,261.216 262.5,260.5C 265.103,256.598 267.603,252.598 270,248.5C 270.741,247.359 271.575,247.359 272.5,248.5C 273.551,247.115 274.884,246.115 276.5,245.5C 277.795,243.672 278.795,241.672 279.5,239.5C 282.213,238.086 284.88,236.753 287.5,235.5C 287.281,234.325 287.614,233.325 288.5,232.5C 291.53,231.568 294.363,230.235 297,228.5C 297.348,225.042 298.848,222.209 301.5,220C 305.188,220.47 307.854,218.804 309.5,215C 309.167,214.667 308.833,214.333 308.5,214C 310.167,213.667 311.833,213.333 313.5,213C 314.223,210.982 315.223,209.148 316.5,207.5C 358.398,177.56 404.732,157.394 455.5,147C 463.366,145.078 471.366,143.912 479.5,143.5C 485.712,143.477 491.712,142.81 497.5,141.5C 502.07,140.559 506.737,140.226 511.5,140.5 Z"/></g> <g><path style={{opacity:1}} fill="#435c6c" d="M 718.5,169.5 C 717.71,168.391 717.21,167.058 717,165.5C 716.667,159.167 716.333,152.833 716,146.5C 715.825,151.019 715.325,155.353 714.5,159.5C 714.5,154.833 714.5,150.167 714.5,145.5C 715.5,145.5 716.5,145.5 717.5,145.5C 717.442,153.521 717.776,161.521 718.5,169.5 Z"/></g> <g><path style={{opacity:1}} fill="#4f6778" d="M 714.5,162.5 C 714.679,168.404 714.012,174.071 712.5,179.5C 712.596,173.627 713.263,167.96 714.5,162.5 Z"/></g> <g><path style={{opacity:1}} fill="#113047" d="M 435.5,199.5 C 426.455,207.551 417.455,215.551 408.5,223.5C 408.577,222.25 409.244,221.417 410.5,221C 409.483,219.951 409.316,218.784 410,217.5C 413.433,215.349 416.766,213.015 420,210.5C 421.333,207.833 422.667,205.167 424,202.5C 424.333,202.833 424.667,203.167 425,203.5C 427.824,200.502 431.324,199.168 435.5,199.5 Z"/></g> <g><path style={{opacity:1}} fill="#042c49" d="M 718.5,169.5 C 719.692,192.662 724.525,214.995 733,236.5C 743.674,260.17 761.507,275.67 786.5,283C 793.26,285.585 800.26,287.085 807.5,287.5C 810.577,288.856 813.91,289.689 817.5,290C 826.488,291.054 835.488,291.887 844.5,292.5C 851.52,292.901 858.52,293.568 865.5,294.5C 865.167,294.833 864.833,295.167 864.5,295.5C 854.856,296.25 845.189,296.916 835.5,297.5C 826.318,298.437 817.318,299.77 808.5,301.5C 760.571,308.596 732.071,335.929 723,383.5C 719.852,399.348 718.019,415.348 717.5,431.5C 716.676,435.312 716.176,439.312 716,443.5C 715.722,442.584 715.222,441.918 714.5,441.5C 714.509,416.744 711.342,392.41 705,368.5C 695.048,335.216 673.215,314.05 639.5,305C 615.469,299.662 591.136,296.162 566.5,294.5C 590.398,293.04 614.065,289.873 637.5,285C 667.896,277.924 689.062,260.091 701,231.5C 706.868,214.633 710.701,197.3 712.5,179.5C 714.012,174.071 714.679,168.404 714.5,162.5C 714.5,161.5 714.5,160.5 714.5,159.5C 715.325,155.353 715.825,151.019 716,146.5C 716.333,152.833 716.667,159.167 717,165.5C 717.21,167.058 717.71,168.391 718.5,169.5 Z"/></g> <g><path style={{opacity:1}} fill="#123148" d="M 316.5,207.5 C 315.223,209.148 314.223,210.982 313.5,213C 311.833,213.333 310.167,213.667 308.5,214C 308.833,214.333 309.167,214.667 309.5,215C 307.854,218.804 305.188,220.47 301.5,220C 298.848,222.209 297.348,225.042 297,228.5C 294.363,230.235 291.53,231.568 288.5,232.5C 287.614,233.325 287.281,234.325 287.5,235.5C 284.88,236.753 282.213,238.086 279.5,239.5C 278.795,241.672 277.795,243.672 276.5,245.5C 274.884,246.115 273.551,247.115 272.5,248.5C 271.575,247.359 270.741,247.359 270,248.5C 267.603,252.598 265.103,256.598 262.5,260.5C 260.518,261.216 258.851,262.383 257.5,264C 255.482,264.505 253.482,265.005 251.5,265.5C 267.095,247.069 284.429,230.569 303.5,216C 307.734,212.918 312.067,210.084 316.5,207.5 Z"/></g> <g><path style={{opacity:1}} fill="#d8e4ea" d="M 807.5,287.5 C 812.387,288.055 817.22,288.055 822,287.5C 829.596,289.324 837.096,290.99 844.5,292.5C 835.488,291.887 826.488,291.054 817.5,290C 813.91,289.689 810.577,288.856 807.5,287.5 Z"/></g> <g><path style={{opacity:1}} fill="#bdcfd8" d="M 835.5,297.5 C 826.814,300.047 817.814,301.381 808.5,301.5C 817.318,299.77 826.318,298.437 835.5,297.5 Z"/></g> <g><path style={{opacity:1}} fill="#042d49" d="M 681.5,442.5 C 685.982,443.326 690.649,443.826 695.5,444C 692.635,444.183 689.969,444.683 687.5,445.5C 684.833,445.5 682.167,445.5 679.5,445.5C 674.586,445.362 669.919,446.028 665.5,447.5C 653.92,448.645 642.92,451.812 632.5,457C 629.734,458.371 627.401,460.204 625.5,462.5C 615.779,470.242 609.279,480.242 606,492.5C 604.686,496.754 603.853,501.087 603.5,505.5C 601.434,516.64 599.934,527.974 599,539.5C 598.411,528.62 597.245,517.953 595.5,507.5C 595.483,505.435 595.15,503.435 594.5,501.5C 593.003,491.194 589.336,481.86 583.5,473.5C 577.77,464.301 569.77,457.968 559.5,454.5C 559.577,453.25 560.244,452.417 561.5,452C 560.5,451.667 559.5,451.333 558.5,451C 559.696,450.346 559.696,449.846 558.5,449.5C 555.004,450.61 551.671,450.11 548.5,448C 544.5,447.667 540.5,447.333 536.5,447C 538.595,446.444 538.762,445.944 537,445.5C 533.895,446.367 530.728,446.701 527.5,446.5C 516.912,444.758 516.912,443.092 527.5,441.5C 543.759,440.485 558.759,435.651 572.5,427C 586.224,414.209 594.057,398.375 596,379.5C 597.057,368.818 598.223,358.152 599.5,347.5C 600.712,362.242 602.545,376.909 605,391.5C 607.808,402.114 612.474,411.781 619,420.5C 631.689,431.758 646.522,438.591 663.5,441C 669.465,441.963 675.465,442.463 681.5,442.5 Z"/></g> <g><path style={{opacity:1}} fill="#798e9b" d="M 717.5,431.5 C 717.5,435.833 717.5,440.167 717.5,444.5C 716.5,444.5 715.5,444.5 714.5,444.5C 714.5,443.5 714.5,442.5 714.5,441.5C 715.222,441.918 715.722,442.584 716,443.5C 716.176,439.312 716.676,435.312 717.5,431.5 Z"/></g> <g><path style={{opacity:1}} fill="#2f4657" d="M 527.5,441.5 C 516.912,443.092 516.912,444.758 527.5,446.5C 522.167,446.167 516.833,445.833 511.5,445.5C 509.031,444.683 506.365,444.183 503.5,444C 506.365,443.817 509.031,443.317 511.5,442.5C 516.833,442.167 522.167,441.833 527.5,441.5 Z"/></g> <g><path style={{opacity:1}} fill="#334c60" d="M 166.5,433.5 C 166.665,437.182 166.499,440.848 166,444.5C 165.478,447.281 164.311,449.615 162.5,451.5C 162.99,445.191 164.323,439.191 166.5,433.5 Z"/></g> <g><path style={{opacity:1}} fill="#a7b0b4" d="M 511.5,442.5 C 509.031,443.317 506.365,443.817 503.5,444C 506.365,444.183 509.031,444.683 511.5,445.5C 508.5,445.5 505.5,445.5 502.5,445.5C 502.5,444.5 502.5,443.5 502.5,442.5C 505.5,442.5 508.5,442.5 511.5,442.5 Z"/></g> <g><path style={{opacity:1}} fill="#a8b1b6" d="M 681.5,442.5 C 686.5,442.5 691.5,442.5 696.5,442.5C 696.5,443.5 696.5,444.5 696.5,445.5C 693.5,445.5 690.5,445.5 687.5,445.5C 689.969,444.683 692.635,444.183 695.5,444C 690.649,443.826 685.982,443.326 681.5,442.5 Z"/></g> <g><path style={{opacity:1}} fill="#96afc1" d="M 679.5,445.5 C 675.409,446.895 671.076,447.562 666.5,447.5C 666.167,447.5 665.833,447.5 665.5,447.5C 669.919,446.028 674.586,445.362 679.5,445.5 Z"/></g> <g><path style={{opacity:1}} fill="#233e52" d="M 559.5,454.5 C 549.159,450.433 538.492,447.766 527.5,446.5C 530.728,446.701 533.895,446.367 537,445.5C 538.762,445.944 538.595,446.444 536.5,447C 540.5,447.333 544.5,447.667 548.5,448C 551.671,450.11 555.004,450.61 558.5,449.5C 559.696,449.846 559.696,450.346 558.5,451C 559.5,451.333 560.5,451.667 561.5,452C 560.244,452.417 559.577,453.25 559.5,454.5 Z"/></g> <g><path style={{opacity:1}} fill="#e4eff3" d="M 665.5,447.5 C 665.833,447.5 666.167,447.5 666.5,447.5C 664.854,450.569 662.187,452.069 658.5,452C 659.5,452.333 660.5,452.667 661.5,453C 659.782,453.346 658.115,453.846 656.5,454.5C 655.614,453.675 655.281,452.675 655.5,451.5C 645.527,453.443 636.361,457.443 628,463.5C 627.329,462.748 626.496,462.414 625.5,462.5C 627.401,460.204 629.734,458.371 632.5,457C 642.92,451.812 653.92,448.645 665.5,447.5 Z"/></g> <g><path style={{opacity:1}} fill="#405867" d="M 162.5,455.5 C 161.644,465.685 160.311,475.685 158.5,485.5C 158.865,475.235 160.199,465.235 162.5,455.5 Z"/></g> <g><path style={{opacity:1}} fill="#34515f" d="M 761.5,489.5 C 759.853,486.797 758.686,483.797 758,480.5C 757.768,481.737 757.268,482.737 756.5,483.5C 756.99,477.158 757.657,470.825 758.5,464.5C 759.72,472.811 760.72,481.145 761.5,489.5 Z"/></g> <g><path style={{opacity:1}} fill="#dce7eb" d="M 583.5,473.5 C 589.336,481.86 593.003,491.194 594.5,501.5C 593.275,500.063 592.275,498.396 591.5,496.5C 590.167,495.833 588.833,495.167 587.5,494.5C 587.959,488.682 586.626,483.182 583.5,478C 584.413,476.586 584.413,475.086 583.5,473.5 Z"/></g> <g><path style={{opacity:1}} fill="#072d49" d="M 761.5,489.5 C 764.651,506.817 774.651,517.984 791.5,523C 801.033,525.311 810.7,526.644 820.5,527C 807.091,527.173 794.091,529.506 781.5,534C 769.068,541.694 762.401,552.861 761.5,567.5C 759.896,571.9 759.229,576.566 759.5,581.5C 759.5,582.167 759.5,582.833 759.5,583.5C 758.833,582.5 758.167,581.5 757.5,580.5C 757.564,567.078 754.064,554.745 747,543.5C 742.075,538.287 736.241,534.454 729.5,532C 718.348,529.121 707.015,527.455 695.5,527C 705.26,526.271 714.927,524.937 724.5,523C 736.533,520.607 745.366,514.107 751,503.5C 753.656,497.05 755.489,490.383 756.5,483.5C 757.268,482.737 757.768,481.737 758,480.5C 758.686,483.797 759.853,486.797 761.5,489.5 Z"/></g> <g><path style={{opacity:1}} fill="#dde9ed" d="M 603.5,505.5 C 602.339,517.018 602.339,528.518 603.5,540C 602.281,543.345 600.114,544.179 597,542.5C 597.015,530.866 596.515,519.199 595.5,507.5C 597.245,517.953 598.411,528.62 599,539.5C 599.934,527.974 601.434,516.64 603.5,505.5 Z"/></g> <g><path style={{opacity:1}} fill="#b2c3c9" d="M 761.5,567.5 C 761.638,572.414 760.972,577.081 759.5,581.5C 759.229,576.566 759.896,571.9 761.5,567.5 Z"/></g> <g><path style={{opacity:1}} fill="#6f898f" d="M 757.5,580.5 C 758.167,581.5 758.833,582.5 759.5,583.5C 759.662,585.527 759.495,587.527 759,589.5C 757.608,586.722 757.108,583.722 757.5,580.5 Z"/></g> <g><path style={{opacity:1}} fill="#f1f2f2" d="M 854.5,703.5 C 856.705,700.423 858.372,697.09 859.5,693.5C 858.325,693.281 857.325,693.614 856.5,694.5C 853.276,699.668 849.61,704.335 845.5,708.5C 845.167,708.5 844.833,708.5 844.5,708.5C 840.906,710.297 837.24,712.13 833.5,714C 831.612,716.707 829.612,719.207 827.5,721.5C 825.199,720.94 822.866,720.44 820.5,720C 823.122,716.043 826.122,712.376 829.5,709C 835.936,707.516 841.603,704.516 846.5,700C 847.264,697.931 847.764,695.764 848,693.5C 851.195,691.665 854.028,689.998 856.5,688.5C 857.593,690.77 859.093,691.103 861,689.5C 862.28,689.613 863.113,690.28 863.5,691.5C 872.482,692.332 881.482,692.832 890.5,693C 891.5,694.667 892.5,696.333 893.5,698C 890.331,699.459 886.998,700.292 883.5,700.5C 877.254,699.949 871.087,698.949 865,697.5C 863.354,699.141 862.354,698.807 862,696.5C 860.456,698.468 859.289,700.635 858.5,703C 857.207,703.49 855.873,703.657 854.5,703.5 Z"/></g> <g><path style={{opacity:1}} fill="#98a0a2" d="M 854.5,703.5 C 853.833,704.167 853.167,704.833 852.5,705.5C 852.44,704.957 852.107,704.624 851.5,704.5C 849.754,706.252 847.754,707.585 845.5,708.5C 849.61,704.335 853.276,699.668 856.5,694.5C 857.325,693.614 858.325,693.281 859.5,693.5C 858.372,697.09 856.705,700.423 854.5,703.5 Z"/></g> <g><path style={{opacity:1}} fill="#636c6e" d="M 852.5,705.5 C 848.521,708.484 845.188,712.15 842.5,716.5C 841.17,717.832 839.503,718.665 837.5,719C 836.748,719.671 836.414,720.504 836.5,721.5C 835.833,721.833 835.167,722.167 834.5,722.5C 834.158,721.662 833.492,721.328 832.5,721.5C 836.84,717.493 840.84,713.16 844.5,708.5C 844.833,708.5 845.167,708.5 845.5,708.5C 847.754,707.585 849.754,706.252 851.5,704.5C 852.107,704.624 852.44,704.957 852.5,705.5 Z"/></g> <g><path style={{opacity:1}} fill="#b5babb" d="M 844.5,708.5 C 840.84,713.16 836.84,717.493 832.5,721.5C 831.391,721.557 830.391,721.89 829.5,722.5C 829.158,721.662 828.492,721.328 827.5,721.5C 829.612,719.207 831.612,716.707 833.5,714C 837.24,712.13 840.906,710.297 844.5,708.5 Z"/></g> <g><path style={{opacity:1}} fill="#a5abab" d="M 842.5,716.5 C 842.512,720.446 840.512,722.113 836.5,721.5C 836.414,720.504 836.748,719.671 837.5,719C 839.503,718.665 841.17,717.832 842.5,716.5 Z"/></g> <g><path style={{opacity:1}} fill="#e5f0f4" d="M 217.5,714.5 C 224.47,723.651 231.303,732.984 238,742.5C 241.066,745.396 243.899,748.396 246.5,751.5C 251.5,757.5 256.5,763.5 261.5,769.5C 260.883,769.611 260.383,769.944 260,770.5C 257.782,768.908 256.115,766.908 255,764.5C 254.282,765.451 253.449,765.617 252.5,765C 250.743,762.154 248.743,759.488 246.5,757C 245.552,756.517 244.552,756.351 243.5,756.5C 242.805,752.447 241.139,748.781 238.5,745.5C 237.167,745.167 235.833,744.833 234.5,744.5C 232.432,741.843 231.099,738.843 230.5,735.5C 226.499,732.354 223.999,728.354 223,723.5C 222.667,724.167 222.333,724.833 222,725.5C 221.19,723.694 220.024,722.194 218.5,721C 218.645,720.228 218.978,719.561 219.5,719C 218.418,717.67 217.751,716.17 217.5,714.5 Z"/></g> <g><path style={{opacity:1}} fill="#143146" d="M 246.5,751.5 C 249.765,751.299 252.431,752.466 254.5,755C 253.167,756.84 253.334,757.34 255,756.5C 257.656,759.322 260.489,761.988 263.5,764.5C 264.409,767.363 266.076,769.697 268.5,771.5C 268.291,772.086 267.957,772.586 267.5,773C 270.133,774.899 272.966,776.399 276,777.5C 277.829,779.733 278.329,782.067 277.5,784.5C 272.167,779.5 266.833,774.5 261.5,769.5C 256.5,763.5 251.5,757.5 246.5,751.5 Z"/></g> <g><path style={{opacity:1}} fill="#b2c4cd" d="M 595.5,781.5 C 602.422,781.656 609.089,782.656 615.5,784.5C 608.578,784.344 601.911,783.344 595.5,781.5 Z"/></g> </svg> );
    const WeightlifterIcon = ({ className, ...props }) => ( <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" className={className} {...props} fill="currentColor"> <path fillRule="evenodd" d="M 71.5,-0.5 C 72.8333,-0.5 74.1667,-0.5 75.5,-0.5C 79.8872,24.1028 83.8872,48.7695 87.5,73.5C 103.456,71.4122 119.456,69.5789 135.5,68C 139.35,64.7414 143.85,63.2414 149,63.5C 153.256,63.474 157.256,64.474 161,66.5C 192.435,64.0945 223.935,63.0945 255.5,63.5C 287.065,63.0945 318.565,64.0945 350,66.5C 358.901,62.0634 367.401,62.5634 375.5,68C 390.903,69.4334 406.236,71.2668 421.5,73.5C 426.48,48.9549 430.813,24.2883 434.5,-0.5C 438.833,-0.5 443.167,-0.5 447.5,-0.5C 468.599,3.795 489.933,7.46167 511.5,10.5C 511.5,12.1667 511.5,13.8333 511.5,15.5C 501.196,72.9871 491.196,130.654 481.5,188.5C 455.654,184.582 429.987,179.915 404.5,174.5C 409.167,148.5 413.833,122.5 418.5,96.5C 417.624,95.7492 416.624,95.2492 415.5,95C 404.846,93.6496 394.18,92.4829 383.5,91.5C 383.667,126.835 383.5,162.168 383,197.5C 382.08,200.101 381.413,202.768 381,205.5C 364.58,230.007 347.914,254.34 331,278.5C 326.523,292.095 322.357,305.761 318.5,319.5C 342.193,326.174 365.859,333.007 389.5,340C 392.58,342.29 395.747,344.457 399,346.5C 403.788,352.317 405.788,358.984 405,366.5C 398,408.5 391,450.5 384,492.5C 381.874,501.447 376.707,507.78 368.5,511.5C 364.5,511.5 360.5,511.5 356.5,511.5C 346.437,507.927 341.103,500.76 340.5,490C 346.015,453.741 352.015,417.575 358.5,381.5C 327.168,380.612 295.835,380.779 264.5,382C 235.116,402.695 206.449,424.361 178.5,447C 142.237,468.794 105.904,490.294 69.5,511.5C 65.5,511.5 61.5,511.5 57.5,511.5C 44.7211,505.943 39.8878,496.276 43,482.5C 44.0804,480.004 45.4138,477.67 47,475.5C 79.9034,454.936 113.07,434.77 146.5,415C 167.667,391.167 188.833,367.333 210,343.5C 210.781,342.271 211.281,340.938 211.5,339.5C 204.767,318.802 197.934,298.135 191,277.5C 169.954,252.122 149.287,226.456 129,200.5C 127.519,164.228 127.019,127.895 127.5,91.5C 115.43,92.4522 103.43,93.9522 91.5,96C 96.6478,123.053 101.314,150.219 105.5,177.5C 79.8456,181.609 54.1789,185.609 28.5,189.5C 19.3533,132.949 9.68663,76.6161 -0.5,20.5C -0.5,17.8333 -0.5,15.1667 -0.5,12.5C 23.6544,8.36475 47.6544,4.03142 71.5,-0.5ZM255.5,213.5C287.721,209.061 301.555,190.728 297,158.5C288.407,135.106 271.573,124.772 246.5,127.5C 227.963,132.54 216.796,144.54 213,163.5C211.836,193.171 226.003,209.838 255.5,213.5Z M 216.5,85.5 C 257.851,85.2267 299.185,85.8934 340.5,87.5C 340.833,119.174 340.5,150.84 339.5,182.5C 318.978,199.523 298.312,216.356 277.5,233C 262.833,233.667 248.167,233.667 233.5,233C 212.667,216.167 191.833,199.333 171,182.5C 170.5,150.835 170.333,119.168 170.5,87.5C 186.01,87.2969 201.343,86.6303 216.5,85.5 Z" /> </svg> );
const AnaerobicIcon = ({ className, ...props }) => (
  <svg
    version="1.0"
    xmlns="http://www.w3.org/2000/svg"
    viewBox="0 0 512 512"
    preserveAspectRatio="xMidYMid meet"
    className={className}
{...props}
fill="currentColor"
  >
    <g
      transform="translate(0.000000,512.000000) scale(0.100000,-0.100000)"
      fill="currentColor" 
      stroke="none"
    >
      <path d="M2545 4783 c-147 -53 -252 -164 -289 -308 -55 -207 40 -417 229 -511 254 -125 559 11 629 281 55 208 -41 418 -232 513 -71 34 -82 37 -181 40 -82 2 -117 -2 -156 -15z"/>
      <path d="M2030 3831 c-86 -23 -765 -326 -809 -360 -19 -15 -43 -44 -54 -65 -36 -70 -33 -112 28 -381 31 -137 61 -257 66 -266 16 -30 69 -68 104 -75 52 -10 101 4 140 37 56 50 60 80 36 271 -12 90 -21 174 -21 184 0 18 17 23 180 47 99 15 185 25 190 22 6 -3 10 -13 10 -21 0 -8 -36 -135 -81 -282 -47 -156 -82 -294 -86 -332 -7 -78 15 -172 55 -242 41 -72 1377 -1525 1423 -1549 75 -38 185 -22 247 35 60 54 82 178 45 249 -9 18 -233 320 -497 672 -265 352 -485 645 -489 652 -4 7 35 198 88 426 102 443 108 487 80 606 -44 187 -203 341 -393 380 -76 16 -187 13 -262 -8z"/>
      <path d="M3260 3468 c-19 -5 -97 -37 -173 -70 l-138 -59 -46 40 c-25 23 -49 41 -52 41 -3 0 -6 -33 -7 -73 0 -42 -14 -128 -32 -208 -18 -75 -32 -143 -32 -152 0 -31 106 -54 171 -37 48 13 423 218 469 257 37 31 64 102 56 145 -19 103 -104 148 -216 116z"/>
      <path d="M4544 3399 c-253 -133 -433 -316 -520 -530 -66 -162 -94 -337 -76 -487 6 -49 74 -411 151 -805 78 -393 141 -735 141 -759 0 -57 -27 -106 -79 -143 l-43 -30 -1683 -5 c-1681 -5 -1684 -5 -1711 -26 -44 -32 -66 -68 -71 -117 -7 -61 25 -128 75 -159 l37 -23 1645 -3 c1192 -2 1668 0 1727 9 196 27 356 161 413 347 39 126 35 157 -136 1025 -166 842 -173 887 -141 995 44 146 131 244 313 352 209 123 226 141 226 230 0 79 -44 139 -117 159 -59 16 -67 15 -151 -30z"/>
      <path d="M805 2362 c-48 -23 -69 -45 -90 -95 -28 -68 -13 -146 38 -196 37 -36 760 -494 827 -524 68 -30 163 -27 234 7 30 15 67 41 81 58 30 35 135 240 135 262 0 8 -73 94 -162 191 -90 98 -178 198 -195 223 -18 25 -34 47 -37 49 -2 2 -23 -52 -46 -122 -35 -106 -45 -125 -59 -120 -10 3 -146 66 -302 141 -314 150 -351 161 -424 126z"/>
    </g>
  </svg>
);
    const InjectionIcon = ({ className = "w-6 h-6", ...props }) => {
      return (
        <svg 
          id="Icons" 
          viewBox="0 0 60 60" 
          xmlns="http://www.w3.org/2000/svg" 
          className={className} 
          {...props}
          style={{
            '--needle-color': '#262626',
            '--needle-color-dark': '#e5e7eb'
          }}
        >
          <style>
            {`
              .needle-path {
                fill: var(--needle-color);
              }
              /* Se corrige el selector para que coincida con el sistema de temas de la app (.dark) */
              .dark .needle-path {
                fill: var(--needle-color-dark);
              }
            `}
          </style>
          <path fill="#d6dbe3" d="M16.622,48.248a.5.5,0,0,1-.38-.824l1.391-1.63-2.654,1.531a.5.5,0,0,1-.6-.787l1.376-1.371-1.858,1.072a.5.5,0,0,1-.626-.761l1.809-2.068-2.353,1.359a.5.5,0,0,1-.587-.8l.7-.639-.377.217a.5.5,0,0,1-.627-.105.5.5,0,0,1-.018-.635l2.141-2.742a.39.39,0,0,1-.036-.054.5.5,0,0,1,.183-.683l.866-.5a.5.5,0,0,1,.644.74L14.184,41.4l2.132-1.231a.5.5,0,0,1,.587.8l-.7.636.984-.569a.5.5,0,0,1,.626.762l-1.809,2.068,2.551-1.472a.5.5,0,0,1,.6.787l-1.375,1.37,1.861-1.074a.5.5,0,0,1,.63.756l-1.391,1.631,1.076-.62a.5.5,0,0,1,.5.865l-3.592,2.074A.489.489,0,0,1,16.622,48.248Z"/>
          <path fill="#d6dbe3" d="M41.43,31.943a.5.5,0,0,1-.336-.87l1.285-1.168L39.69,31.457a.5.5,0,0,1-.548-.834L41.183,29.1,37.8,31.058a.5.5,0,0,1-.564-.823l4.381-3.517-6.528,3.768a.5.5,0,0,1-.533-.844l.753-.517-1.787,1.031a.5.5,0,0,1-.534-.844l1.819-1.253-3,1.734a.5.5,0,0,1-.548-.834L36.8,24.842l-7.619,4.4a.5.5,0,0,1-.541-.839L34.2,24.423l-7.455,4.3a.5.5,0,0,1-.525-.85l1.688-1.116-2.691,1.553a.5.5,0,0,1-.535-.842l6.091-4.236-6.383,3.685a.5.5,0,0,1-.526-.85l2.143-1.418L23.8,25.927a.5.5,0,0,1-.543-.838L30.431,19.9l-6.934,4a.5.5,0,0,1-.533-.844l4.1-2.822a.491.491,0,0,1-.516-.21.5.5,0,0,1,.109-.674l4.508-3.483a.487.487,0,0,1-.254-.181.5.5,0,0,1,.066-.664l3.171-2.9a.505.505,0,0,1,.246-.5l.866-.5a.5.5,0,0,1,.587.8l-.8.729,1.107-.638a.5.5,0,0,1,.556.828l-3.551,2.743,4.165-2.4a.5.5,0,0,1,.533.844l-3.841,2.64L38.33,14.18a.5.5,0,0,1,.543.838l-7.177,5.2,8.034-4.638a.5.5,0,0,1,.526.85l-2.137,1.414,2.458-1.419a.5.5,0,0,1,.535.843L35.021,21.5,41.767,17.6a.5.5,0,0,1,.525.85L40.6,19.574l1.991-1.149a.5.5,0,0,1,.541.839l-5.559,3.975,6.237-3.6a.5.5,0,0,1,.547.834L38.812,24.59l6.309-3.642a.5.5,0,0,1,.534.845l-1.818,1.253,2.145-1.238a.5.5,0,0,1,.534.844l-.757.52,1.008-.582a.5.5,0,0,1,.563.822L42.949,26.93l5.175-2.988a.5.5,0,0,1,.549.834l-2.511,1.869a.5.5,0,0,1,.334.87l-3.534,3.212a.5.5,0,0,1-.237.545l-1.045.6A.489.489,0,0,1,41.43,31.943Z"/>
          <path fill="#8991a0" d="M44.773,21.233a.5.5,0,0,1-.337-.868l1.608-1.476-2.1,1.209a.5.5,0,0,1-.552-.831l4.12-3.123L42.741,18.9a.5.5,0,0,1-.53-.846l2.567-1.735-2.931,1.693a.5.5,0,0,1-.529-.848l2.06-1.383-2.389,1.379a.5.5,0,0,1-.537-.842l4.87-3.421-5.455,3.15a.5.5,0,0,1-.524-.851l.481-.316a.5.5,0,0,1-.386-.9l3.54-2.413a.494.494,0,0,1-.359-.226.5.5,0,0,1,.132-.678l2.9-2.046a.473.473,0,0,1-.133-.124.5.5,0,0,1,.061-.663l4.291-3.995a.5.5,0,0,1,.243-.515l.868-.5a.5.5,0,0,1,.59.8L49.478,5.56l2.694-1.555a.5.5,0,0,1,.539.841l-.485.342.719-.415a.5.5,0,0,1,.532.846l-2.4,1.634,2.76-1.593a.5.5,0,0,1,.524.851l-.137.091.355-.206a.5.5,0,0,1,.537.842L50.246,10.66,55.7,7.511a.5.5,0,0,1,.528.847L54.166,9.744l2.4-1.382a.5.5,0,0,1,.53.847l-2.985,2.016a.511.511,0,0,1,.489.218.5.5,0,0,1-.116.675l-4.7,3.568a.5.5,0,0,1,.293.866l-3.81,3.5a.5.5,0,0,1-.238.541l-1,.574A.491.491,0,0,1,44.773,21.233Z"/>
          <path fill="#b9bfcc" d="M50.289,29.565a.5.5,0,0,1-.425-.763l1.188-1.908-1.979,1.141a.5.5,0,0,1-.666-.709l1.155-1.738L47.7,26.662a.5.5,0,0,1-.632-.756l.825-.972-1.219.7a.5.5,0,0,1-.618-.771l.591-.644-.879.507a.5.5,0,0,1-.665-.712l1.143-1.69L44.42,23.382a.5.5,0,0,1-.648-.736l1.017-1.332-1.545.892a.5.5,0,0,1-.61-.779L43.046,21l-.64.369a.5.5,0,0,1-.666-.709L42.9,18.921,41.034,20a.5.5,0,0,1-.654-.727L41.454,17.8l-1.662.959a.5.5,0,0,1-.6-.788l.179-.177-.344.2a.5.5,0,0,1-.66-.718l1.117-1.6-1.758,1.015a.5.5,0,0,1-.607-.784l.313-.317-.512.295a.5.5,0,0,1-.606-.784l.3-.307-.5.288a.5.5,0,0,1-.622-.766l.662-.737-.978.565a.5.5,0,0,1-.628-.106.5.5,0,0,1-.015-.637l.968-1.228-1.455.84a.5.5,0,0,1-.643-.742l.966-1.226-1.453.839a.5.5,0,0,1-.671-.7l1.175-1.828L31.5,10.458a.5.5,0,0,1-.674-.7l1.13-1.812a.5.5,0,0,1-.391-.912l1.61-.93a.5.5,0,0,1,.674.7L32.73,8.591,34.7,7.452a.5.5,0,0,1,.671.7L34.2,9.983l1.923-1.11a.5.5,0,0,1,.643.742L35.8,10.841,37.254,10a.5.5,0,0,1,.642.742l-.967,1.23,1.456-.841a.5.5,0,0,1,.622.766l-.662.737.978-.565a.5.5,0,0,1,.606.784l-.3.307.5-.288a.5.5,0,0,1,.606.783l-.312.318.512-.295a.5.5,0,0,1,.66.718L40.475,16l1.758-1.015a.5.5,0,0,1,.6.789l-.179.176.344-.2a.5.5,0,0,1,.654.728L42.58,17.948l1.661-.959a.5.5,0,0,1,.666.709l-1.154,1.739,1.861-1.075a.5.5,0,0,1,.611.78l-.413.427.64-.369a.5.5,0,0,1,.648.737l-1.017,1.331,1.545-.892a.5.5,0,0,1,.664.713l-1.143,1.688,1.827-1.053a.5.5,0,0,1,.618.77L49,23.14l.882-.509a.5.5,0,0,1,.632.756l-.824.971,1.217-.7a.5.5,0,0,1,.666.709L50.42,26.1l1.861-1.075a.5.5,0,0,1,.675.7l-1.187,1.908,1.3-.749a.5.5,0,1,1,.5.865L50.539,29.5A.489.489,0,0,1,50.289,29.565Z"/>
          <path fill="#31b5a5" d="M22.807,48.152a.5.5,0,0,1-.288-.909l.47-.331-1.3.748a.5.5,0,0,1-.541-.839l8.16-5.854-9.355,5.4a.5.5,0,0,1-.521-.852l5.458-3.537L18.98,45.391a.5.5,0,0,1-.518-.855l2.922-1.863-3.247,1.874a.5.5,0,0,1-.525-.851l7.413-4.878-8,4.619a.5.5,0,0,1-.516-.856L16.8,42.4l-.518.3a.5.5,0,0,1-.517-.855l1.082-.684-1.334.77a.5.5,0,0,1-.525-.851l6.7-4.4-7.246,4.183A.5.5,0,0,1,13.928,40l2.406-1.541-2.641,1.524a.5.5,0,0,1-.542-.839l7.953-5.71-8.32,4.8a.5.5,0,0,1-.545-.836l6.706-4.9L12.6,36.167a.5.5,0,0,1-.537-.842l3.637-2.55-2.159,1.246a.5.5,0,0,1-.554-.83l4.738-3.622a.5.5,0,0,1-.44-.856l4.2-3.9a.5.5,0,0,1,.244-.518l.877-.506a.5.5,0,0,1,.59.8l-1.985,1.844,2.554-1.474a.5.5,0,0,1,.553.83l-4.578,3.5,5.328-3.075a.5.5,0,0,1,.537.842l-3.636,2.548L26.482,27a.5.5,0,0,1,.545.836l-6.708,4.9,9.01-5.2a.5.5,0,0,1,.542.839l-7.953,5.711L34.708,26.7a.5.5,0,0,1,.52.854l-2.4,1.534L36.286,27.1a.5.5,0,0,1,.525.85l-6.706,4.4,7.719-4.456a.5.5,0,0,1,.518.855l-1.077.681,1.394-.8a.5.5,0,0,1,.517.856l-.3.188.483-.279a.5.5,0,0,1,.525.85l-7.411,4.877,8.006-4.623a.5.5,0,0,1,.519.855l-2.932,1.87L41.215,31.4a.5.5,0,0,1,.521.853l-5.448,3.531,1.284-.741a.5.5,0,0,1,.541.839l-8.158,5.853,2.187-1.261a.5.5,0,0,1,.538.841L29.788,43.35a.5.5,0,0,1-.015.857l-6.716,3.878A.491.491,0,0,1,22.807,48.152Z"/>
          <path className="needle-path" d="M12.869,32.95a5.509,5.509,0,0,0-.048,7.116c.066.077.14.148.207.225a4.265,4.265,0,0,0-1.577,2.738,3.306,3.306,0,0,0,.735,2.308,11.26,11.26,0,0,0,.828.851L2.005,57.2.4,58.8a.393.393,0,0,0,.179.667A1.04,1.04,0,0,0,1.6,59.2l11.29-11.291.921-.92.26.26a3.885,3.885,0,0,0,4.132.744,4.568,4.568,0,0,0,1.521-1.044,6,6,0,0,0,8.137-.61c1.275-1.261,2.536-2.536,3.8-3.8L44.519,29.677l2.7-2.7q1.18,1.18,2.362,2.362c1.257.96,2.561-.1,3.453-.991.733-.733,1.7-1.478.83-2.529-.956-1.152-2.163-2.164-3.22-3.221l-3.229-3.229,8.123-8.125a3.339,3.339,0,0,0,3.293-.589.994.994,0,0,0,.212-.165,2.3,2.3,0,0,0-.066-3.29c-.532-.539-1.071-1.071-1.607-1.607C55.994,4.216,54.626,2.83,53.24,1.462a3.111,3.111,0,0,0-3.787-.311,2.347,2.347,0,0,0-.83,3.437L40.63,12.582Q39.287,11.241,37.947,9.9C36.852,8.8,35.8,7.54,34.6,6.556a2.226,2.226,0,0,0-2.845.3c-.715.644-2.333,1.828-1.686,2.925a5.235,5.235,0,0,0,.861.912l1.977,1.977.111.11L20.936,24.864,14.1,31.7C13.688,32.112,13.248,32.509,12.869,32.95Zm5.039,14.208a1.768,1.768,0,0,1-1.153.186,2.52,2.52,0,0,1-1.345-.7l-1.1-1.1A5.151,5.151,0,0,1,13.174,44.2a2.748,2.748,0,0,1,.189-2.691,3.336,3.336,0,0,1,.372-.448c1.663,1.789,3.485,3.465,5.225,5.175A4.441,4.441,0,0,1,17.908,47.158ZM41.685,30.807c-1.256-.93-2.059-2.351-3.442-3.149a7.575,7.575,0,0,0-5.621-.727,20.494,20.494,0,0,1-2.405.673,6.064,6.064,0,0,1-3.611-.807,7.69,7.69,0,0,1-1.925-1.722,7.024,7.024,0,0,0-1.091-1.16l2.873-2.873,1.952,1.951.369.37c.069.068.3.049.369.043a2.1,2.1,0,0,0,.564-.127c.113-.043.613-.229.433-.408l-2.6-2.6-.162-.161L29.808,17.7l.362-.362,1.952,1.952.37.37c.068.068.3.05.368.044a2.067,2.067,0,0,0,.565-.127c.113-.043.613-.229.432-.41l-2.6-2.6-.162-.162,2.748-2.748L46.341,26.151ZM49.418,5.5,54.5,10.58l-7.907,7.907L44.4,16.294l4.93-4.931.739-.738c.207-.207.172-.437-.134-.5a1.267,1.267,0,0,0-1.024.274l-5.193,5.193-.01.01L41.511,13.41Q45.465,9.456,49.418,5.5ZM49.843,2a1.108,1.108,0,0,1,.824-.652,1.7,1.7,0,0,1,1.11.534c.086.081.167.168.251.251l3.723,3.724L57.5,7.6a2.008,2.008,0,0,1,.219,2.929c-.557.515-1.158.12-1.644-.325a.67.67,0,0,0-.1-.132L50.079,4.182A1.931,1.931,0,0,1,49.843,2Zm-17.2,8.529a13.3,13.3,0,0,1-.979-.979c-.79-.981.406-1.762,1.059-2.415.036-.037.225-.277.284-.284l.007,0a1.407,1.407,0,0,0,.184.176c.016.013.029.029.043.042.109.106.215.216.322.323l1.421,1.421,4.923,4.923a.642.642,0,0,0,.126.18l5.931,5.932a.489.489,0,0,0,.137.082l.025.025,5.33,5.331a12.19,12.19,0,0,1,1.054,1.054c.447.573.245.993-.163,1.446-.247.275-.527.526-.789.788a1.867,1.867,0,0,1-.274.274A.478.478,0,0,0,51.1,29a.423.423,0,0,0-.158-.173l-3-3a.671.671,0,0,0-.125-.179L34.469,12.3c-.03-.03-.071-.033-.106-.053Q33.5,11.389,32.646,10.53ZM15.325,32.18l0,0L17.3,34.15l.369.37c.224.224.7.12.958.007.161-.072.622-.337.389-.569l-2.6-2.6-.14-.139,2.751-2.751,1.977,1.977.37.369c.229.23.7.141.961.021.168-.077.621-.355.383-.593q-1.3-1.3-2.6-2.6l-.137-.136,2.653-2.653c.093.093.187.184.276.281.275.3.531.613.8.913A6.479,6.479,0,0,0,25.8,27.606a7.771,7.771,0,0,0,5.65.287,7.723,7.723,0,0,1,2.49-.536A6.335,6.335,0,0,1,37.381,28.5c1.306.944,2.089,2.3,3.463,3.147L27.658,44.834c-.382.383-.753.782-1.15,1.15a4.241,4.241,0,0,1-5.954-.147c-2.02-2.019-4.069-4.012-6.06-6.06a4.655,4.655,0,0,1-.156-6.61C14.657,32.829,15,32.509,15.325,32.18Z"/>
        </svg>
      );
    };
    const MedicalVisitIcon = ({ className, ...props }) => ( <svg version="1.0" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" className={className} {...props} fill="currentColor"> <g transform="scale(0.1, -0.1) translate(0, -5120)"> <path d="M1665 4643 c-27 -2 -90 -13 -139 -25 -81 -20 -110 -38 -92 -56 4 -3 82 -13 174 -22 l167 -15 0 -90 0 -90 -185 0 -184 0 -14 88 c-14 87 -14 89 8 119 22 30 22 32 5 45 -25 17 -34 17 -73 -7 -39 -24 -57 -63 -67 -146 -6 -59 -8 -61 -43 -74 -102 -36 -194 -126 -247 -242 -97 -211 -60 -531 81 -704 l33 -41 -30 -28 c-93 -90 -89 -200 12 -306 24 -26 174 -168 334 -315 381 -354 557 -523 574 -554 8 -15 17 -69 21 -131 8 -150 31 -179 141 -179 l49 0 -6 -152 c-4 -84 -7 -154 -8 -155 -1 -1 -179 -5 -396 -9 -262 -4 -420 -11 -468 -20 -258 -47 -442 -265 -442 -521 0 -201 116 -383 300 -472 150 -73 270 -87 590 -68 217 13 307 44 393 136 109 117 138 283 114 669 l-8 132 343 0 c390 0 816 15 898 31 175 35 309 185 318 357 4 71 5 72 32 72 43 0 135 36 195 76 73 48 120 103 162 191 124 258 -41 575 -309 591 -50 3 -71 0 -82 -10 -12 -13 -8 -17 38 -31 156 -50 264 -177 274 -323 7 -109 -17 -174 -89 -244 -31 -31 -83 -69 -115 -85 -51 -26 -70 -30 -139 -30 -67 0 -88 5 -131 27 -148 78 -223 276 -163 433 30 81 110 164 202 210 38 19 77 35 85 35 14 0 14 2 -1 18 -14 13 -35 17 -90 17 -59 0 -82 -5 -132 -29 -152 -75 -249 -251 -231 -418 26 -224 182 -396 391 -428 38 -6 71 -13 73 -14 1 -2 -7 -29 -18 -60 -46 -121 -124 -198 -239 -234 -61 -19 -190 -19 -933 -6 l-346 6 -6 32 c-3 17 -8 86 -12 154 l-7 122 58 0 c67 0 118 21 134 56 6 14 11 60 11 102 0 133 -5 125 258 382 231 225 597 602 669 688 27 32 37 54 41 91 4 43 1 52 -28 84 -18 20 -36 34 -41 31 -6 -3 -17 0 -26 8 -9 7 -3 -7 13 -32 57 -85 55 -96 -46 -185 -296 -262 -867 -796 -900 -843 -38 -51 -51 -97 -53 -186 l-2 -77 -93 3 -92 3 -4 92 c-5 150 -5 150 -378 509 -178 171 -389 373 -471 449 -85 81 -147 146 -147 157 0 24 67 97 96 104 28 7 24 11 544 -481 198 -188 351 -325 375 -336 52 -24 109 -24 164 1 32 15 154 132 463 442 l419 423 44 0 44 0 -20 20 c-13 14 -33 20 -63 20 -49 0 -60 -7 -316 -219 -161 -134 -277 -236 -487 -433 -86 -80 -150 -133 -163 -133 -21 0 -20 -1 -530 480 -177 168 -341 317 -364 332 -53 36 -111 44 -159 24 l-37 -15 -13 32 c-26 62 -57 194 -65 277 -20 194 30 347 159 491 l48 54 26 -32 c47 -59 90 -67 308 -59 214 8 247 16 281 75 21 36 33 170 22 245 -15 101 -88 139 -241 129z m507 -3460 c-1 -126 -7 -258 -12 -295 -24 -163 -103 -251 -256 -283 -54 -11 -120 -13 -304 -9 -323 8 -384 25 -489 140 -72 78 -95 144 -95 269 0 128 23 191 101 275 67 73 141 111 232 120 36 4 237 8 446 9 l380 1 -3 -227z"/> <path d="M2930 4640 c-106 -9 -208 -37 -220 -61 -13 -24 -7 -25 182 -40 93 -7 159 -17 161 -23 2 -6 1 -47 -2 -91 l-6 -80 -185 0 -185 0 -8 55 c-15 104 -13 136 8 160 19 21 19 22 0 36 -24 17 -29 17 -64 0 -42 -22 -60 -57 -71 -138 -19 -128 5 -208 72 -245 29 -16 57 -18 230 -16 222 1 257 8 306 62 l32 35 40 -39 c179 -175 217 -446 110 -776 -31 -94 -37 -139 -20 -139 25 0 91 42 113 72 34 46 50 80 83 178 26 76 29 99 29 210 0 134 -19 221 -70 320 -56 109 -145 195 -236 227 l-49 18 0 63 c0 94 -17 147 -57 182 -18 17 -41 30 -51 30 -9 0 -26 2 -37 4 -11 2 -58 0 -105 -4z"/> <path d="M3650 2452 c-120 -120 -37 -312 135 -312 169 0 259 194 138 300 -27 25 -42 30 -70 28 -55 -5 -64 -30 -25 -66 37 -35 43 -79 14 -105 -22 -20 -73 -22 -90 -5 -21 21 -14 84 13 116 30 36 31 44 7 65 -33 30 -80 21 -122 -21z"/> </g> </svg> );
    const AnalysisIcon = ({ className, ...props }) => ( <svg version="1.0" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" className={className} {...props} fill="currentColor"> <g transform="scale(0.1, -0.1) translate(0, -5120)"> <path d="M3231 4740 c-137 -28 -256 -169 -300 -355 l-12 -50 -173 3 c-217 4 -206 14 -206 -170 l0 -128 -282 0 c-156 -1 -302 -5 -325 -9 -50 -10 -143 -71 -185 -121 -60 -73 -99 -185 -118 -337 -8 -63 -7 -129 5 -272 8 -105 15 -215 15 -245 l0 -56 -77 -39 c-455 -229 -662 -775 -474 -1246 18 -44 42 -95 53 -113 l21 -34 -35 -28 c-45 -38 -68 -86 -68 -145 0 -40 -3 -48 -22 -53 -42 -10 -146 -69 -208 -117 -60 -46 -296 -263 -451 -415 -86 -84 -106 -127 -95 -214 15 -131 155 -237 290 -220 127 17 183 56 461 324 236 227 278 275 296 337 11 41 14 44 40 38 35 -8 93 10 134 40 l30 22 68 -26 68 -26 -7 -55 c-26 -203 -19 -322 25 -416 48 -103 129 -169 246 -200 40 -11 248 -14 1055 -14 1202 0 1678 16 1776 59 78 35 70 97 -15 108 -37 5 -41 8 -35 27 4 11 11 37 15 56 13 54 11 3197 -2 3243 -5 21 -24 54 -42 74 -57 65 -68 67 -400 71 l-298 4 2 130 c2 117 0 133 -16 145 -14 9 -55 13 -146 13 l-127 0 -12 48 c-57 229 -279 400 -469 362z m167 -131 c104 -52 180 -157 207 -288 20 -95 30 -101 174 -101 l117 0 -3 -147 c-4 -149 -18 -282 -31 -295 -27 -26 -663 -45 -995 -30 -114 5 -209 11 -211 13 -2 2 -7 109 -11 237 l-7 232 175 0 c201 0 201 0 211 82 18 141 82 252 175 300 71 37 120 37 199 -3z m-858 -788 c0 -60 3 -116 6 -125 15 -40 205 -56 664 -56 465 0 654 15 713 54 38 26 54 69 63 167 l7 69 294 0 295 0 29 -29 29 -29 0 -1612 0 -1612 -30 -30 -31 -30 -1002 6 c-551 3 -1148 9 -1326 12 -323 6 -324 7 -348 30 -22 23 -23 27 -23 211 l0 188 158 0 c186 1 272 19 421 91 260 124 444 332 535 605 122 367 35 713 -258 1027 -196 209 -494 329 -771 309 l-85 -6 0 408 c0 428 0 425 45 449 13 8 122 11 318 12 l297 0 0 -109z m-420 -862 c292 -36 543 -212 685 -482 66 -126 86 -201 92 -349 8 -173 -18 -300 -90 -443 -113 -227 -290 -377 -534 -452 -80 -24 -103 -27 -253 -27 -191 -1 -242 10 -387 79 -545 263 -667 991 -238 1420 140 140 320 229 520 255 88 11 112 11 205 -1z m-845 -1534 c20 -24 68 -69 106 -101 60 -49 67 -59 58 -75 -52 -98 -259 18 -259 145 0 40 22 76 46 76 7 0 29 -20 49 -45z m-106 -236 c46 -50 52 -62 47 -86 -8 -30 -368 -395 -528 -535 -102 -88 -134 -99 -201 -70 -55 25 -88 69 -89 122 -1 54 19 80 142 190 58 51 152 139 210 195 58 56 130 120 160 143 66 49 166 102 189 101 9 -1 40 -28 70 -60z"/> <path d="M3233 4500 c-61 -37 -62 -134 -2 -184 56 -47 145 -22 175 50 20 48 10 86 -32 124 -42 36 -93 40 -141 10z"/> <path d="M2932 4084 c-27 -18 -29 -55 -4 -77 16 -15 53 -17 314 -17 273 0 296 1 311 18 23 26 21 58 -5 76 -19 14 -66 16 -308 16 -242 0 -289 -2 -308 -16z"/> <path d="M2917 3092 c-26 -28 -21 -46 23 -85 112 -102 271 -133 525 -103 77 10 181 22 230 28 50 5 191 11 315 11 l225 2 9 28 c8 23 6 31 -12 50 -22 22 -27 22 -265 21 -172 0 -280 -5 -372 -18 -334 -45 -480 -30 -588 60 -34 29 -68 31 -90 6z"/> <path d="M4045 2333 c-11 -3 -72 -26 -135 -51 -111 -45 -118 -46 -215 -45 -76 0 -124 7 -200 28 -141 39 -153 40 -175 20 -44 -39 -18 -72 80 -103 107 -35 206 -52 303 -52 78 0 105 5 177 31 216 79 222 81 267 74 24 -3 56 -17 72 -31 47 -39 101 -28 101 21 0 59 -96 115 -195 114 -33 -1 -69 -3 -80 -6z"/> <path d="M3925 1514 c-11 -3 -78 -22 -150 -42 -122 -35 -139 -37 -265 -36 -86 0 -168 7 -225 18 -163 32 -180 32 -200 2 -16 -24 -16 -28 -2 -50 13 -20 34 -27 129 -45 258 -48 391 -47 580 8 206 59 269 63 366 21 55 -24 85 -18 97 20 10 30 -10 55 -62 81 -39 18 -68 23 -148 25 -55 2 -109 0 -120 -2z"/> <path d="M2178 2644 c-17 -36 -4 -52 73 -94 83 -45 204 -166 247 -247 62 -118 89 -301 62 -418 -11 -49 8 -85 45 -85 53 0 71 57 69 220 -1 118 -21 199 -79 317 -56 113 -162 228 -271 291 -84 50 -128 55 -146 16z"/> <path d="M2485 1720 c-25 -27 -10 -71 27 -84 53 -19 91 50 50 87 -25 23 -55 21 -77 -3z"/> </g> </svg> );
    const DrinkIcon = ({ className, ...props }) => ( <svg version="1.0" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" className={className} {...props} fill="currentColor"> <g transform="scale(0.1, -0.1) translate(0, -5120)"> <path d="M3080 5059 c-25 -11 -60 -35 -78 -52 -54 -51 -66 -80 -146 -347 l-26 -86 -82 12 c-170 26 -362 12 -539 -40 -197 -57 -362 -157 -515 -310 -159 -159 -258 -327 -308 -528 l-23 -90 -50 -28 c-56 -32 -109 -102 -119 -158 -4 -20 -4 -115 -1 -212 6 -204 13 -229 85 -299 l49 -47 7 -89 c27 -359 176 -1479 290 -2182 36 -225 49 -284 74 -338 38 -81 102 -144 190 -187 l67 -33 600 0 600 0 50 23 c28 13 68 35 89 50 51 35 120 129 140 190 39 118 273 1771 342 2409 15 137 20 164 35 168 25 8 89 81 106 123 10 25 16 91 20 223 5 166 4 194 -12 235 -23 60 -73 115 -125 139 -28 13 -42 26 -46 44 -49 229 -143 411 -301 581 l-76 81 37 99 c84 227 146 417 146 450 0 86 -51 168 -124 201 -62 28 -293 27 -356 -2z m215 -241 c-4 -13 -20 -63 -35 -113 -16 -49 -40 -129 -54 -176 l-26 -86 -54 28 c-30 15 -60 29 -67 31 -9 3 3 49 45 163 31 88 63 163 69 167 7 4 38 8 70 8 56 0 58 -1 52 -22z m-546 -484 c4 -5 -18 -103 -50 -219 -32 -115 -73 -270 -91 -342 l-32 -133 -181 -1 c-99 0 -353 -4 -565 -8 -212 -4 -387 -6 -389 -5 -2 2 13 34 34 71 182 333 505 570 870 638 88 16 389 16 404 -1z m324 -106 c32 -16 38 -23 32 -41 -3 -12 -36 -140 -73 -284 l-66 -263 -129 0 c-99 0 -128 3 -124 13 3 6 39 95 80 197 41 102 96 240 122 307 l47 121 36 -15 c21 -8 54 -24 75 -35z m341 -241 c45 -45 108 -116 138 -157 58 -78 123 -188 116 -195 -7 -7 -559 8 -556 15 2 4 43 105 92 223 80 193 92 215 108 206 10 -5 56 -47 102 -92z m-734 -592 l1035 -4 8 -156 c8 -137 7 -159 -7 -174 -14 -15 -42 -19 -189 -25 -211 -8 -553 -31 -790 -52 -162 -14 -198 -14 -395 0 -119 8 -272 18 -339 22 l-122 7 -22 121 c-26 144 -34 166 -54 166 -26 0 -26 -21 0 -149 14 -68 23 -126 20 -129 -2 -3 -97 -1 -211 4 -188 8 -207 11 -220 29 -12 17 -14 47 -8 175 4 88 11 161 18 169 9 11 33 12 126 6 63 -4 581 -9 1150 -10z m195 -489 c231 -20 685 -46 786 -46 44 0 79 -4 79 -9 0 -5 -18 -83 -39 -173 -90 -375 -270 -1207 -356 -1648 -14 -74 -28 -140 -30 -147 -2 -7 -83 22 -219 79 -229 97 -277 127 -320 201 -13 23 -66 173 -116 332 -51 160 -100 306 -111 326 -44 87 -114 143 -238 189 -103 38 -152 63 -194 99 -67 59 -81 103 -146 440 -34 173 -61 320 -61 327 0 8 32 14 108 19 59 4 184 13 277 20 189 15 313 13 580 -9z m-1011 -75 l9 -53 -190 -190 -190 -190 -15 58 -15 59 186 188 c102 103 190 186 196 184 5 -2 14 -27 19 -56z m-259 -101 c-82 -82 -152 -146 -156 -142 -3 4 -12 29 -18 56 l-12 49 83 85 c46 46 92 88 103 92 11 5 49 9 85 9 l65 1 -150 -150z m-135 85 c-30 -30 -57 -55 -61 -55 -6 0 -29 78 -29 99 0 7 28 11 72 11 l72 0 -54 -55z m254 -406 c-203 -203 -194 -199 -209 -110 l-7 44 188 189 189 189 14 -62 13 -62 -188 -188z m214 51 l10 -55 -181 -182 c-100 -101 -184 -183 -188 -183 -3 0 -12 27 -19 61 l-13 61 184 184 c101 101 186 180 190 176 3 -4 11 -32 17 -62z m37 -199 l7 -44 -178 -178 c-98 -99 -181 -179 -185 -179 -3 0 -11 25 -18 56 l-13 57 183 183 c198 198 189 193 204 105z m67 -142 l26 -36 -207 -207 -208 -208 -12 63 -13 62 188 188 c104 104 191 185 194 181 3 -4 18 -23 32 -43z m112 -97 l45 -29 -254 -253 -253 -253 -11 52 c-6 29 -11 57 -11 64 0 9 428 447 437 447 1 0 22 -13 47 -28z m166 -68 c22 -9 40 -19 40 -23 0 -3 -141 -147 -314 -320 l-314 -314 -11 52 c-6 29 -11 60 -11 69 0 22 530 552 552 552 10 0 36 -7 58 -16z m132 -81 c15 -15 28 -32 28 -37 0 -21 -709 -721 -714 -705 -3 7 -9 34 -14 59 l-9 45 331 333 c182 182 335 332 340 332 6 0 23 -12 38 -27z m81 -145 l17 -53 -373 -373 -372 -372 -13 62 -12 63 362 362 c200 200 365 363 369 363 3 0 13 -24 22 -52z m53 -163 l18 -56 -379 -379 c-240 -240 -382 -375 -386 -368 -4 7 -11 34 -14 61 l-7 50 373 373 c206 206 375 374 376 374 1 0 10 -25 19 -55z m58 -180 l16 -50 -387 -387 c-213 -214 -391 -388 -394 -388 -3 0 -11 28 -17 63 l-10 62 381 382 c210 211 384 379 388 375 3 -4 14 -29 23 -57z m-328 -614 c-292 -292 -399 -392 -405 -382 -5 7 -11 34 -15 59 l-6 47 392 392 393 393 19 -56 18 -56 -396 -397z m458 312 l35 -38 -377 -377 c-298 -299 -382 -378 -402 -378 -21 0 -52 14 -80 37 -3 3 780 793 787 793 2 0 18 -17 37 -37z m131 -94 l48 -21 -344 -344 -344 -344 -67 0 c-38 0 -68 3 -68 7 0 9 712 723 721 723 4 0 28 -9 54 -21z m165 -70 l44 -20 -310 -309 -310 -310 -72 0 c-40 0 -72 3 -72 7 0 15 645 653 660 653 8 0 35 -10 60 -21z m153 -63 l49 -19 -279 -279 -278 -278 -75 0 -75 0 300 300 c165 165 302 299 305 298 3 -2 27 -12 53 -22z m57 -157 l-17 -91 -164 -164 -164 -164 -75 0 -75 0 255 255 c140 140 255 255 256 255 0 0 -7 -41 -16 -91z m-51 -259 c-20 -102 -86 -160 -181 -160 l-43 0 115 115 c63 63 116 113 118 111 2 -2 -2 -32 -9 -66z"/> </g> </svg> );
const StarIcon = ({ className, ...props }) => {
      // Genera un ID único para el degradado para evitar conflictos
      const gradientId = React.useId();
      return (
        <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg" className={className} {...props}>
          <defs>
            <linearGradient id={gradientId} x1="0%" y1="0%" x2="100%" y2="100%">
              <stop offset="0%" style={{stopColor: '#FAE388', stopOpacity: 1}} />
              <stop offset="50%" style={{stopColor: '#E8CD75', stopOpacity: 1}} />
              <stop offset="100%" style={{stopColor: '#4E7A9F', stopOpacity: 1}} />
            </linearGradient>
          </defs>
          <path d="M50 10 L58 32 C58.5 33.5 59.5 34 61 34 L82 34 C84 34 85 35 84.5 36.5 C84 38 82.5 39 81 40 L65 52 C63.5 53 63 54.5 63.5 56 L68 77 C68.5 79 67.5 80.5 66 80 C64.5 79.5 63 78 61.5 76.5 L50 65 C48.5 63.5 46.5 63.5 45 65 L33.5 76.5 C32 78 30.5 79.5 29 80 C27.5 80.5 26.5 79 27 77 L31.5 56 C32 54.5 31.5 53 30 52 L14 40 C12.5 39 11 38 10.5 36.5 C10 35 11 34 13 34 L34 34 C35.5 34 36.5 33.5 37 32 L42 11 C43 9 44 8 45 8 C46.5 8 48.5 8 50 10 Z"
            fill={`url(#${gradientId})`} stroke="#a1882b" strokeWidth="2" strokeLinejoin="round" strokeLinecap="round"/>
          <ellipse cx="48" cy="45" rx="12" ry="8" fill="#FDFDFD" opacity="0.7" transform="rotate(-15 48 45)"/>
          <circle cx="50" cy="50" r="4" fill="#FAE388" opacity="0.9"/>
        </svg>
      );
    };
    const PillIcon = ({ className, ...props }) => {
      // Genera IDs únicos para el degradado y el filtro de sombra
      const gradientId = React.useId();
      const shadowId = React.useId();
      return (
        <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg" className={className} {...props}>
          <defs>
            <linearGradient id={gradientId} x1="0%" y1="0%" x2="100%" y2="100%">
              <stop offset="0%" style={{stopColor: '#A7E991', stopOpacity: 1}} />
              <stop offset="30%" style={{stopColor: '#73CB5D', stopOpacity: 1}} />
              <stop offset="70%" style={{stopColor: '#FB91C2', stopOpacity: 1}} />
              <stop offset="100%" style={{stopColor: '#FB5595', stopOpacity: 1}} />
            </linearGradient>
            <filter id={shadowId}>
              <feGaussianBlur in="SourceAlpha" stdDeviation="2"/>
              <feOffset dx="1" dy="3" result="offset"/>
              <feFlood floodColor="#000000" floodOpacity="0.15"/>
              <feComposite in2="offset" operator="in"/>
              <feMerge>
                <feMergeNode/>
                <feMergeNode in="SourceGraphic"/>
              </feMerge>
            </filter>
          </defs>
          <rect x="25" y="40" width="50" height="20" rx="10" ry="10"
            fill={`url(#${gradientId})`} stroke="rgba(0,0,0,0.2)" strokeWidth="1"
            strokeLinejoin="round" strokeLinecap="round" filter={`url(#${shadowId})`}
            transform="rotate(-35 50 50)"/>
          <line x1="50" y1="42" x2="50" y2="58"
            stroke="rgba(255,255,255,0.4)" strokeWidth="1" opacity="0.8"
            transform="rotate(-35 50 50)"/>
          <ellipse cx="35" cy="45" rx="4" ry="2" fill="#FDFDFD" opacity="0.8" transform="rotate(-35 50 50)"/>
          <circle cx="62" cy="52" r="1.5" fill="#FDFDFD" opacity="0.6" transform="rotate(-35 50 50)"/>
        </svg>
      );
    };
const WalkIcon = ({ className, ...props }) => ( <svg version="1.0" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" preserveAspectRatio="xMidYMid meet" className={className} {...props} fill="currentColor"> <g transform="translate(0.000000,512.000000) scale(0.100000,-0.100000)"> <path d="M2418 5101 c-155 -50 -281 -184 -324 -345 -16 -60 -18 -212 -3 -276 43 -189 217 -360 407 -399 261 -54 522 112 581 369 15 67 13 208 -4 275 -45 170 -175 312 -340 370 -89 31 -229 34 -317 6z"/> <path d="M2322 4001 c-30 -10 -66 -27 -80 -38 -15 -11 -220 -151 -457 -313 -236 -161 -443 -305 -458 -319 -16 -14 -35 -38 -43 -53 -18 -35 -324 -911 -336 -960 -18 -83 27 -180 102 -218 74 -38 191 -20 242 37 24 26 62 113 227 518 l143 350 195 100 c147 75 213 116 270 164 85 73 82 58 -11 -58 l-63 -78 -6 -209 c-4 -115 -16 -276 -27 -359 -11 -82 -27 -211 -35 -285 -9 -74 -41 -326 -72 -560 l-56 -425 -254 -495 c-139 -272 -258 -512 -264 -533 -22 -82 15 -180 89 -232 40 -28 50 -30 126 -30 72 0 87 3 122 26 30 20 116 138 374 514 184 269 342 502 351 519 18 33 150 577 179 736 l17 95 7 -56 c5 -30 6 -87 4 -125 l-4 -69 150 -200 151 -200 161 -556 c88 -306 170 -572 180 -590 55 -93 183 -126 289 -74 73 35 115 102 115 185 0 94 -187 1238 -211 1290 -12 25 -137 232 -280 461 l-258 415 10 155 c6 85 8 251 5 369 -5 191 -4 211 8 179 8 -20 22 -71 31 -112 15 -69 21 -80 66 -122 89 -83 80 -81 551 -95 230 -7 432 -10 450 -6 48 9 101 51 128 98 28 50 32 137 7 184 -23 45 -77 93 -117 104 -29 9 -316 38 -643 66 l-78 7 -306 369 c-168 203 -320 380 -337 393 -53 40 -110 55 -210 55 -62 -1 -108 -7 -144 -19z"/> </g> </svg> );
const MeditationIcon = ({ className, ...props }) => (
      <svg version="1.0" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 514 514" preserveAspectRatio="xMidYMid meet" className={className} {...props}>
        <style>
            {`
              .meditation-main {
                fill: #000000; /* Negro para modo claro */
              }
              .dark .meditation-main {
                fill: #e5e7eb; /* Gris claro para modo oscuro */
              }
              .meditation-aura {
                fill: #F0BC5E; /* Dorado para modo claro */
              }
              .dark .meditation-aura {
                fill: #fde047; /* Amarillo más brillante para modo oscuro */
              }
            `}
        </style>
        <g className="meditation-main" stroke="none">
          <path d="M 248.951 10.035 C 232.653 12.510 218.041 22.318 209.521 36.500 C 202.651 47.935 201.498 53.773 201.519 77.000 C 201.542 102.816 203.301 109.733 213.114 122.592 L 217.000 127.685 216.992 137.592 L 216.983 147.500 188.742 155.878 C 173.209 160.486 158.035 165.404 155.022 166.808 C 148.285 169.948 141.024 177.045 137.564 183.874 C 135.656 187.640 132.988 198.813 127.564 225.754 C 123.495 245.964 120.241 262.546 120.333 262.603 C 120.425 262.659 127.700 264.489 136.500 266.668 L 152.500 270.631 152.430 279.565 C 152.348 289.900 149.764 298.716 142.482 313.500 C 137.242 324.139 133.347 328.415 116.587 341.930 L 104.145 351.963 97.615 348.907 C 82.650 341.904 67.173 346.771 60.404 360.607 C 54.920 371.815 57.859 386.760 66.965 393.972 C 71.287 397.395 76.906 400.000 79.968 400.000 C 83.323 400.000 82.310 401.349 76.250 404.949 C 59.938 414.642 49.706 432.585 49.706 451.500 C 49.706 464.177 53.419 474.463 61.709 484.750 L 65.134 489.000 53.067 489.000 L 41.000 489.000 41.000 497.000 L 41.000 505.000 257.000 505.000 L 473.000 505.000 473.000 497.000 L 473.000 489.000 460.933 489.000 L 448.866 489.000 452.291 484.750 C 460.581 474.463 464.294 464.177 464.294 451.500 C 464.294 432.585 454.062 414.642 437.750 404.949 C 431.690 401.349 430.677 400.000 434.032 400.000 C 437.094 400.000 442.713 397.395 447.035 393.972 C 456.141 386.760 459.080 371.815 453.596 360.607 C 446.827 346.771 431.350 341.904 416.385 348.907 L 409.855 351.963 397.413 341.930 C 380.385 328.199 376.643 324.097 371.484 313.500 C 364.183 298.504 361.651 289.838 361.570 279.565 L 361.500 270.631 377.500 266.668 C 386.300 264.489 393.575 262.659 393.667 262.603 C 393.759 262.546 390.505 245.964 386.436 225.754 C 381.012 198.813 378.344 187.640 376.436 183.874 C 372.976 177.045 365.715 169.948 358.978 166.808 C 355.965 165.404 340.791 160.486 325.258 155.878 L 297.017 147.500 297.008 137.592 L 297.000 127.685 300.886 122.592 C 310.732 109.690 312.496 102.764 312.498 77.000 C 312.500 53.752 311.364 48.049 304.393 36.325 C 293.283 17.641 270.380 6.781 248.951 10.035 M 226.683 164.387 C 232.047 168.900 242.784 174.063 249.889 175.544 C 256.173 176.854 257.827 176.854 264.111 175.544 C 271.216 174.063 281.953 168.900 287.317 164.387 C 288.877 163.074 290.648 162.000 291.253 162.000 C 293.580 162.000 349.480 179.204 353.018 181.009 C 357.336 183.212 361.693 188.043 363.716 192.872 C 365.745 197.715 376.146 250.256 375.250 251.136 C 374.632 251.743 331.254 263.000 329.533 263.000 C 329.240 263.000 329.000 257.375 329.000 250.500 L 329.000 238.000 320.853 238.000 L 312.705 238.000 313.298 268.250 C 313.624 284.888 314.374 301.425 314.964 305.000 C 316.559 314.649 319.687 327.778 321.978 334.435 C 323.090 337.668 324.000 340.721 324.000 341.220 C 324.000 341.719 319.838 344.084 314.750 346.476 C 273.580 365.836 240.420 365.836 199.250 346.476 C 194.163 344.084 190.000 341.727 190.000 341.239 C 190.000 340.750 191.097 337.124 192.439 333.180 C 199.086 313.636 200.928 295.410 200.971 248.750 L 201.000 217.000 193.000 217.000 L 185.000 217.000 185.000 240.000 C 185.000 252.650 184.760 263.000 184.467 263.000 C 182.746 263.000 139.368 251.743 138.750 251.136 C 137.854 250.256 148.255 197.715 150.284 192.872 C 152.191 188.321 156.561 183.289 160.369 181.259 C 163.704 179.482 219.351 162.212 222.173 162.079 C 223.094 162.036 225.123 163.074 226.683 164.387 M 437.804 424.310 C 447.326 433.581 451.380 449.208 447.582 462.000 C 444.159 473.529 433.662 484.125 422.346 487.474 C 414.489 489.800 282.533 489.745 271.208 487.412 C 254.505 483.970 240.358 476.442 226.500 463.622 L 219.500 457.146 238.490 438.073 C 248.935 427.583 257.790 419.000 258.169 419.000 C 258.548 419.000 275.347 428.900 295.500 441.000 C 315.653 453.100 332.303 463.000 332.499 463.000 C 332.980 463.000 340.000 451.404 340.000 450.610 C 340.000 450.264 337.750 448.597 335.000 446.905 C 332.250 445.213 330.000 443.542 330.000 443.193 C 330.000 442.843 339.858 432.644 351.908 420.529 C 371.049 401.282 373.968 397.932 375.022 394.000 C 375.685 391.525 376.380 388.957 376.566 388.293 C 377.057 386.540 432.508 419.153 437.804 424.310 M 138.022 390.309 C 138.081 396.179 142.497 401.206 182.643 441.100 C 205.114 463.431 225.688 483.231 228.362 485.100 L 233.225 488.500 165.040 488.757 C 88.957 489.044 91.206 489.220 81.058 482.166 C 66.000 471.698 60.687 451.213 68.777 434.815 C 70.491 431.342 73.829 426.614 76.196 424.309 C 80.538 420.080 135.814 386.952 137.250 387.718 C 137.663 387.938 138.010 389.104 138.022 390.309 M 268.416 26.513 C 281.429 30.461 291.539 40.571 295.487 53.584 C 297.590 60.515 297.590 93.485 295.487 100.416 C 290.273 117.603 274.946 128.978 257.000 128.978 C 239.054 128.978 223.727 117.603 218.513 100.416 C 216.410 93.485 216.410 60.515 218.513 53.584 C 222.332 40.994 231.831 31.163 244.274 26.922 C 250.753 24.713 261.863 24.525 268.416 26.513 M 206.987 366.531 C 245.692 381.399 284.245 378.989 323.515 359.244 L 331.504 355.227 336.066 359.364 L 340.629 363.500 329.402 374.144 C 318.718 384.273 317.916 384.823 312.837 385.505 C 305.742 386.458 301.205 388.426 297.165 392.301 C 292.609 396.671 291.030 400.025 289.650 408.267 C 288.961 412.381 287.845 415.695 286.960 416.253 C 285.831 416.966 281.830 415.027 271.172 408.604 C 263.320 403.872 256.589 400.000 256.214 400.000 C 255.838 400.000 250.469 405.048 244.281 411.218 L 233.031 422.436 229.118 418.615 C 225.792 415.367 225.100 413.947 224.505 409.147 C 222.765 395.109 215.089 387.331 201.163 385.493 C 196.078 384.822 195.296 384.286 184.598 374.144 L 173.371 363.500 177.934 359.364 L 182.496 355.227 190.485 359.244 C 194.879 361.453 202.304 364.732 206.987 366.531 M 177.500 276.834 L 184.500 278.622 184.794 286.445 C 185.303 299.952 181.420 320.113 175.009 337.246 C 171.469 346.708 167.608 349.628 134.113 368.174 L 103.725 385.000 91.763 385.000 L 79.800 385.000 76.400 381.600 C 73.405 378.605 73.000 377.580 73.000 373.000 C 73.000 368.420 73.405 367.395 76.400 364.400 C 81.296 359.504 85.517 359.733 97.034 365.517 L 106.029 370.035 123.324 356.142 C 148.392 336.004 152.596 330.690 161.800 307.500 C 165.803 297.413 167.341 291.281 168.507 280.750 C 168.857 277.588 169.449 275.010 169.822 275.023 C 170.195 275.035 173.650 275.850 177.500 276.834 M 345.493 280.750 C 346.659 291.281 348.197 297.413 352.200 307.500 C 361.404 330.690 365.608 336.004 390.676 356.142 L 407.971 370.035 416.966 365.517 C 428.483 359.733 432.704 359.504 437.600 364.400 C 440.595 367.395 441.000 368.420 441.000 373.000 C 441.000 377.580 440.595 378.605 437.600 381.600 L 434.200 385.000 422.237 385.000 L 410.275 385.000 379.887 368.174 C 346.392 349.628 342.531 346.708 338.991 337.246 C 332.815 320.739 329.000 301.571 329.000 287.045 L 329.000 279.077 332.750 278.100 C 334.813 277.562 338.075 276.685 340.000 276.151 C 341.925 275.617 343.805 275.140 344.178 275.090 C 344.551 275.041 345.143 277.588 345.493 280.750 M 176.376 386.973 C 187.170 397.475 190.258 399.343 198.701 400.476 C 206.583 401.534 209.000 404.440 209.000 412.861 L 209.000 419.450 215.732 426.234 L 222.464 433.018 215.712 439.759 L 208.960 446.500 180.980 418.430 C 153.581 390.943 153.000 390.276 153.000 386.316 C 153.000 380.760 156.713 377.000 162.199 377.000 C 165.820 377.000 166.923 377.776 176.376 386.973 M 358.364 379.636 C 360.338 381.611 361.000 383.283 361.000 386.294 C 361.000 390.198 360.349 390.970 338.799 412.658 C 326.588 424.946 316.254 435.000 315.834 435.000 C 314.552 435.000 300.000 425.902 300.000 425.099 C 300.000 424.686 301.125 423.292 302.500 422.000 C 304.683 419.949 305.000 418.804 305.000 412.962 C 305.000 404.431 307.386 401.538 315.299 400.476 C 323.742 399.343 326.830 397.475 337.624 386.973 C 347.077 377.776 348.180 377.000 351.801 377.000 C 354.710 377.000 356.410 377.683 358.364 379.636 M 257.000 144.217 C 264.408 144.217 268.096 143.681 273.750 141.785 L 281.000 139.353 281.000 144.670 C 281.000 149.768 280.825 150.117 276.750 153.118 C 270.149 157.981 262.585 161.000 257.000 161.000 C 251.415 161.000 243.851 157.981 237.250 153.118 C 233.175 150.117 233.000 149.768 233.000 144.670 L 233.000 139.353 240.250 141.785 C 245.904 143.681 249.592 144.217 257.000 144.217 "/>
        </g>
        <g className="meditation-aura" stroke="none">
          <path d="M 306.495 171.205 C 300.717 179.974 287.974 194.798 277.874 204.500 C 256.566 224.968 235.288 239.132 207.250 251.513 L 201.000 254.273 200.838 269.387 C 200.660 285.882 200.527 289.074 199.585 299.416 C 198.814 307.885 195.385 325.207 193.509 330.111 L 192.127 333.722 202.314 329.951 C 232.606 318.735 251.737 307.952 274.563 289.228 C 286.928 279.085 297.762 268.156 306.825 256.684 C 312.675 249.280 313.000 248.583 313.000 243.434 L 313.000 238.000 316.829 238.000 C 320.651 238.000 320.671 237.979 326.784 227.250 C 336.094 210.912 349.040 180.600 347.381 179.027 C 346.897 178.567 338.664 175.855 329.086 173.001 C 319.508 170.147 311.144 167.609 310.499 167.361 C 309.853 167.113 308.051 168.843 306.495 171.205 "/>
        </g>
        <g className="meditation-main" stroke="none">
          <path d="M 489.000 497.000 L 489.000 505.000 497.000 505.000 L 505.000 505.000 505.000 497.000 L 505.000 489.000 497.000 489.000 L 489.000 489.000 489.000 497.000 "/>
        </g>
        <g className="meditation-main" stroke="none">
          <path d="M 9.000 497.000 L 9.000 505.000 17.000 505.000 L 25.000 505.000 25.000 497.000 L 25.000 489.000 17.000 489.000 L 9.000 489.000 9.000 497.000 "/>
        </g>
      </svg>
    );
    const AerobicIcon = ({ className, ...props }) => (
  <svg
    version="1.0"
    xmlns="http://www.w3.org/2000/svg"
    viewBox="0 0 512 512"
    preserveAspectRatio="xMidYMid meet"
   className={className}
{...props}
fill="currentColor"
  >
    <g
      transform="translate(0.000000,512.000000) scale(0.100000,-0.100000)"
      stroke="none"
    >
      <path d="M2545 4783 c-147 -53 -252 -164 -289 -308 -55 -207 40 -417 229 -511 254 -125 559 11 629 281 55 208 -41 418 -232 513 -71 34 -82 37 -181 40 -82 2 -117 -2 -156 -15z"/>
      <path d="M2030 3831 c-86 -23 -765 -326 -809 -360 -19 -15 -43 -44 -54 -65 -36 -70 -33 -112 28 -381 31 -137 61 -257 66 -266 16 -30 69 -68 104 -75 52 -10 101 4 140 37 56 50 60 80 36 271 -12 90 -21 174 -21 184 0 18 17 23 180 47 99 15 185 25 190 22 6 -3 10 -13 10 -21 0 -8 -36 -135 -81 -282 -47 -156 -82 -294 -86 -332 -7 -78 15 -172 55 -242 41 -72 1377 -1525 1423 -1549 75 -38 185 -22 247 35 60 54 82 178 45 249 -9 18 -233 320 -497 672 -265 352 -485 645 -489 652 -4 7 35 198 88 426 102 443 108 487 80 606 -44 187 -203 341 -393 380 -76 16 -187 13 -262 -8z"/>
      <path d="M3260 3468 c-19 -5 -97 -37 -173 -70 l-138 -59 -46 40 c-25 23 -49 41 -52 41 -3 0 -6 -33 -7 -73 0 -42 -14 -128 -32 -208 -18 -75 -32 -143 -32 -152 0 -31 106 -54 171 -37 48 13 423 218 469 257 37 31 64 102 56 145 -19 103 -104 148 -216 116z"/>
      <path d="M4544 3399 c-253 -133 -433 -316 -520 -530 -66 -162 -94 -337 -76 -487 6 -49 74 -411 151 -805 78 -393 141 -735 141 -759 0 -57 -27 -106 -79 -143 l-43 -30 -1683 -5 c-1681 -5 -1684 -5 -1711 -26 -44 -32 -66 -68 -71 -117 -7 -61 25 -128 75 -159 l37 -23 1645 -3 c1192 -2 1668 0 1727 9 196 27 356 161 413 347 39 126 35 157 -136 1025 -166 842 -173 887 -141 995 44 146 131 244 313 352 209 123 226 141 226 230 0 79 -44 139 -117 159 -59 16 -67 15 -151 -30z"/>
      <path d="M805 2362 c-48 -23 -69 -45 -90 -95 -28 -68 -13 -146 38 -196 37 -36 760 -494 827 -524 68 -30 163 -27 234 7 30 15 67 41 81 58 30 35 135 240 135 262 0 8 -73 94 -162 191 -90 98 -178 198 -195 223 -18 25 -34 47 -37 49 -2 2 -23 -52 -46 -122 -35 -106 -45 -125 -59 -120 -10 3 -146 66 -302 141 -314 150 -351 161 -424 126z"/>
    </g>
  </svg>
);
const CameraIcon = ({ className, ...props }) => (
  <svg
    version="1.0"
    xmlns="http://www.w3.org/2000/svg"
    viewBox="0 0 512.000000 512.000000"
    preserveAspectRatio="xMidYMid meet"
    className={className}
    {...props}
  >
    <g
      transform="translate(0.000000,512.000000) scale(0.100000,-0.100000)"
      fill="currentColor"
    >
      <path d="M2491 4794 l-31 -26 0 -197 c0 -219 3 -231 65 -251 26 -9 44 -9 70 0 62 20 65 32 65 251 l0 197 -31 26 c-21 18 -42 26 -69 26 -27 0 -48 -8 -69 -26z"/>
      <path d="M1787 4596 c-35 -32 -44 -84 -21 -127 23 -46 191 -298 217 -326 41 -45 128 -38 162 13 35 53 23 87 -97 267 -62 93 -121 175 -132 183 -33 23 -99 18 -129 -10z"/>
      <path d="M3204 4606 c-11 -8 -70 -90 -132 -183 -96 -145 -112 -174 -112 -208 1 -82 77 -128 151 -90 27 14 197 254 243 344 37 71 -10 151 -88 151 -23 0 -51 -6 -62 -14z"/>
      <path d="M1736 3900 c-70 -22 -150 -75 -189 -125 -16 -20 -42 -66 -59 -103 -17 -37 -43 -95 -58 -129 -21 -46 -39 -69 -71 -90 -38 -25 -52 -28 -144 -31 l-102 -4 -5 89 c-8 138 -64 230 -174 284 -46 23 -59 24 -229 24 -177 0 -181 0 -237 -28 -69 -34 -131 -101 -152 -164 -10 -29 -16 -81 -16 -135 0 -74 -3 -88 -16 -88 -32 0 -135 -64 -180 -112 -25 -27 -57 -74 -72 -106 l-27 -57 0 -1270 0 -1270 28 -58 c40 -80 112 -151 194 -190 l68 -32 446 -3 447 -3 31 27 c26 22 31 33 31 70 0 57 -22 91 -69 104 -21 6 -195 10 -432 10 -395 0 -396 0 -440 23 -29 16 -54 40 -74 72 l-30 48 -3 549 -3 548 604 0 604 0 6 -57 c39 -361 310 -726 659 -888 290 -134 642 -140 939 -16 273 114 506 348 620 624 34 81 79 255 79 305 l0 32 605 0 606 0 -3 -548 -3 -549 -30 -48 c-20 -32 -45 -56 -74 -72 l-44 -23 -1606 0 c-1074 0 -1618 -4 -1643 -10 -48 -14 -68 -43 -68 -101 0 -40 4 -51 31 -73 l31 -26 1656 2 1657 3 68 32 c82 39 152 108 193 189 l29 59 0 1270 0 1270 -27 57 c-46 98 -131 174 -241 217 -36 13 -117 17 -543 21 l-501 5 -42 28 c-44 29 -42 26 -134 231 -47 105 -134 182 -245 216 -62 19 -95 20 -826 19 -717 0 -764 -1 -820 -19z m1599 -209 c61 -28 90 -66 138 -184 64 -153 112 -208 234 -265 l58 -27 507 -5 506 -5 44 -30 c23 -17 54 -51 68 -75 l25 -45 3 -547 3 -548 -606 0 -605 0 0 33 c-1 146 -127 455 -231 568 -32 34 -41 39 -82 39 -60 0 -96 -30 -103 -85 -5 -36 2 -51 60 -143 109 -174 150 -315 150 -517 0 -158 -23 -264 -88 -399 -119 -250 -329 -429 -603 -513 -80 -24 -102 -27 -253 -27 -151 0 -173 3 -253 27 -337 103 -586 361 -669 693 -28 114 -31 322 -5 428 99 401 421 687 830 736 172 20 340 -11 519 -96 111 -54 155 -55 196 -9 27 32 30 100 4 131 -37 46 -195 118 -334 153 -536 134 -1089 -121 -1328 -613 -56 -114 -96 -246 -106 -341 l-7 -65 -604 0 -604 0 3 548 c3 512 4 549 22 582 24 46 54 78 91 98 26 15 90 18 535 22 l505 5 65 31 c118 56 167 113 231 272 43 106 74 145 134 173 38 18 81 19 775 19 694 0 737 -1 775 -19z m-2469 -115 c31 -31 34 -39 34 -95 l0 -61 -195 0 -195 0 0 63 c0 67 16 102 54 117 11 5 77 9 145 9 l123 1 34 -34z"/>
      <path d="M1963 3510 c-13 -5 -32 -24 -43 -42 -28 -45 -21 -94 20 -130 l30 -28 590 0 590 0 30 28 c57 50 42 146 -26 172 -32 13 -1160 12 -1191 0z"/>
      <path d="M687 3010 c-105 -18 -195 -84 -247 -182 -29 -54 -35 -75 -38 -148 -5 -101 17 -172 77 -248 125 -158 393 -166 531 -16 68 74 95 143 94 244 0 72 -4 94 -28 147 -49 106 -144 181 -261 202 -64 12 -60 12 -128 1z m153 -240 c70 -55 77 -145 16 -206 -60 -60 -144 -63 -201 -6 -82 82 -49 208 63 242 40 12 82 2 122 -30z"/>
      <path d="M3870 3002 c-59 -29 -60 -37 -58 -355 l3 -289 27 -23 c15 -13 47 -27 70 -30 24 -3 202 -5 396 -3 l354 3 29 33 29 32 0 294 0 293 -25 25 c-14 14 -39 28 -56 32 -18 3 -190 6 -383 6 -314 0 -355 -2 -386 -18z m640 -342 l0 -150 -245 0 -245 0 0 150 0 150 245 0 245 0 0 -150z"/>
      <path d="M2370 2590 c-379 -98 -623 -474 -556 -859 62 -353 346 -608 701 -628 591 -33 988 582 714 1108 -98 187 -275 327 -483 379 -106 27 -272 26 -376 0z m331 -206 c147 -43 284 -156 348 -286 155 -315 -25 -691 -370 -773 -87 -20 -161 -19 -253 5 -181 46 -315 171 -382 355 -103 284 63 599 366 696 72 23 217 25 291 3z"/>
    </g>
  </svg>
);
const CalendarIcon = ({ className, ...props }) => (
  <svg
    version="1.0"
    xmlns="http://www.w3.org/2000/svg"
    viewBox="0 0 512.000000 512.000000"
    preserveAspectRatio="xMidYMid meet"
    className={className}
    {...props}
  >
    <g
      transform="translate(0.000000,512.000000) scale(0.100000,-0.100000)"
      fill="currentColor"
      stroke="none"
    >
      <path d="M1225 5105 c-135 -36 -236 -93 -333 -188 -143 -141 -222 -327 -222 -528 l0 -69 -222 0 c-213 0 -225 -1 -273 -24 -73 -34 -110 -69 -144 -138 l-31 -61 0 -1937 0 -1937 31 -61 c34 -69 71 -104 144 -138 l50 -24 2335 0 2335 0 50 24 c73 34 110 69 144 138 l31 61 0 1936 0 1936 -24 50 c-34 73 -69 110 -138 144 l-61 31 -224 0 -223 0 0 75 c0 215 -102 434 -264 566 -74 61 -198 123 -286 143 -97 23 -268 21 -359 -4 -135 -38 -243 -103 -338 -203 -127 -134 -188 -279 -200 -474 l-6 -103 -437 0 -437 0 -6 108 c-9 163 -55 290 -151 418 -89 119 -248 222 -397 258 -80 20 -273 20 -344 1z m343 -223 c74 -28 130 -64 181 -114 101 -100 149 -207 158 -355 l6 -93 -95 0 -95 0 -5 83 c-9 141 -72 237 -192 293 -77 36 -190 34 -271 -4 -68 -33 -127 -92 -159 -161 -20 -43 -21 -61 -21 -311 l0 -265 28 -56 c16 -33 47 -73 73 -95 115 -99 117 -102 111 -141 -7 -42 -28 -68 -67 -82 -68 -23 -223 103 -284 232 -19 40 -39 96 -45 125 -17 82 -14 493 4 570 50 213 233 378 445 401 72 8 164 -3 228 -27z m2330 0 c80 -31 133 -65 194 -127 95 -96 148 -229 148 -370 l0 -65 -94 0 -93 0 -5 83 c-8 138 -68 234 -183 289 -51 24 -73 28 -141 28 -70 0 -89 -4 -142 -30 -69 -35 -125 -92 -156 -159 -20 -43 -21 -61 -21 -311 l0 -265 28 -57 c17 -36 46 -72 74 -95 93 -77 113 -100 113 -131 0 -37 -31 -77 -69 -90 -82 -29 -253 132 -313 293 -20 54 -22 83 -26 299 -4 274 4 338 53 442 116 241 393 357 633 266z m-2441 -389 c33 -22 53 -70 53 -128 l0 -45 -115 0 -115 0 0 50 c0 88 42 140 113 140 21 0 49 -8 64 -17z m2331 1 c33 -23 52 -67 52 -124 l0 -50 -115 0 -115 0 0 50 c0 89 42 140 115 140 22 0 51 -7 63 -16z m-3118 -449 c0 -262 141 -507 367 -636 47 -27 70 -33 134 -37 99 -6 162 14 227 73 148 133 129 361 -39 481 -61 44 -79 77 -79 144 l0 50 859 0 858 0 6 -107 c9 -165 54 -291 152 -421 52 -69 158 -157 232 -193 75 -39 172 -38 241 -15 64 22 136 84 170 150 23 44 27 63 27 136 0 70 -4 93 -24 130 -27 53 -84 116 -124 136 -42 23 -67 71 -67 132 l0 52 598 0 c384 0 610 -4 635 -11 74 -20 72 2 75 -596 l3 -533 -2361 0 -2361 0 3 533 c3 593 1 576 71 596 17 5 114 10 215 10 l182 1 0 -75z m4250 -2080 l0 -815 -407 0 -406 0 -43 -25 c-26 -15 -54 -43 -69 -69 l-25 -43 0 -406 0 -407 -1827 0 c-1239 0 -1840 3 -1866 11 -78 21 -72 -88 -75 1316 l-2 1253 2360 0 2360 0 0 -815z m-5 -1662 c-7 -49 -42 -88 -86 -97 -18 -3 -194 -6 -393 -6 l-361 0 420 420 420 420 3 -347 c2 -192 0 -367 -3 -390z"/>
      <path d="M2382 2165 c-36 -30 -47 -75 -28 -120 20 -47 60 -65 146 -65 l70 0 0 -486 c0 -314 4 -492 10 -505 13 -23 61 -49 92 -49 40 0 86 36 98 77 8 26 10 202 8 576 l-3 539 -33 29 -32 29 -149 0 c-145 0 -150 -1 -179 -25z"/>
    </g>
  </svg>
);
    const AerobicsClassIcon = ({ className, ...props }) => ( <svg version="1.0" xmlns="http://www.w3.org/2000/svg" width="512pt" height="512pt" viewBox="0 0 512 512" preserveAspectRatio="xMidYMid meet" className={className} {...props} fill="currentColor"><g transform="translate(0,512) scale(0.1,-0.1)" stroke="none"><path d="M3990 5099 c-572 -85 -1049 -338 -1393 -739 -85 -99 -220 -289 -372 -523 -208 -322 -544 -978 -695 -1357 -22 -55 -72 -163 -110 -241 -220 -438 -433 -951 -653 -1569 -84 -239 -90 -260 -90 -335 -1 -98 24 -156 95 -228 71 -71 143 -101 243 -102 92 0 141 20 193 80 43 48 51 66 117 255 135 390 291 793 433 1120 41 96 78 178 81 182 3 4 66 -127 140 -290 315 -695 537 -1155 583 -1208 132 -150 401 -91 497 109 39 82 46 132 27 204 -8 32 -79 193 -159 358 -255 531 -556 1195 -549 1213 3 8 25 12 66 12 83 0 1078 186 1134 212 45 21 90 77 110 137 41 119 -30 387 -158 596 -70 115 -148 213 -271 340 -80 83 -124 138 -143 178 -30 62 -147 193 -239 266 l-55 44 26 41 c79 122 206 265 316 355 283 231 594 352 1060 411 102 13 131 25 174 74 108 123 29 355 -138 409 -65 21 -111 20 -270 -4z m-1038 -2187 c46 -51 108 -136 142 -194 l27 -46 -53 -11 c-158 -31 -431 -81 -434 -78 -9 9 261 367 277 367 4 0 22 -17 41 -38z"/><path d="M3488 4241 c-188 -60 -308 -222 -308 -416 0 -122 40 -217 129 -305 67 -67 144 -107 236 -122 290 -48 544 209 495 501 -43 256 -308 420 -552 342z"/></g></svg> );
    const DanceIcon = ({ className, ...props }) => ( <svg version="1.0" xmlns="http://www.w3.org/2000/svg" width="512pt" height="512pt" viewBox="0 0 512 512" preserveAspectRatio="xMidYMid meet" className={className} {...props} fill="currentColor"><g transform="translate(0,512) scale(0.1,-0.1)" stroke="none"><path d="M1976 5111 c-7 -11 31 -31 58 -31 27 0 25 -14 -5 -27 -25 -10 -30 -18 -27 -40 2 -21 10 -29 38 -36 l35 -9 -28 -14 c-44 -24 -31 -31 35 -21 61 9 204 -4 219 -21 4 -4 14 -74 23 -157 19 -169 41 -271 85 -397 17 -47 31 -89 31 -92 0 -3 -65 59 -145 139 -80 80 -152 145 -161 145 -14 0 -14 -13 3 -74 4 -15 2 -18 -13 -12 -10 4 -39 10 -64 13 -40 6 -44 5 -32 -10 7 -8 44 -34 83 -57 53 -31 74 -51 90 -83 12 -23 35 -56 52 -74 l30 -32 -24 -5 c-106 -25 -155 -36 -162 -36 -4 0 -7 32 -5 70 2 61 -1 73 -20 92 -13 14 -25 19 -30 13 -5 -6 -17 -50 -26 -100 -9 -49 -23 -99 -31 -111 -9 -14 -43 -29 -112 -49 -54 -15 -115 -34 -135 -42 -37 -15 -37 -15 -85 25 -58 47 -156 107 -200 123 -18 6 -33 15 -33 19 0 4 13 39 29 77 28 64 32 68 59 65 l29 -3 6 83 c6 95 41 192 88 246 16 18 29 42 29 53 0 37 -53 124 -109 179 -86 84 -191 110 -305 76 -67 -20 -111 -53 -153 -113 -34 -49 -37 -62 -57 -204 l-21 -151 -52 -63 c-47 -57 -57 -64 -99 -71 -26 -4 -89 -4 -140 -1 -87 5 -96 4 -151 -23 -74 -35 -165 -119 -243 -222 -72 -95 -97 -142 -106 -195 -5 -33 -2 -44 22 -72 35 -42 81 -70 169 -105 67 -26 80 -37 348 -304 229 -228 279 -284 288 -316 20 -73 2 -120 -113 -299 -101 -158 -118 -197 -118 -285 0 -40 5 -105 12 -144 9 -56 9 -100 -1 -202 -15 -156 -54 -396 -73 -451 -8 -22 -78 -134 -156 -250 -159 -236 -193 -310 -266 -567 -32 -118 -44 -147 -56 -142 -40 15 -119 26 -144 20 -15 -4 -39 -18 -52 -31 -23 -23 -24 -31 -24 -142 0 -68 -9 -186 -22 -279 -25 -188 -21 -218 40 -286 40 -44 140 -98 183 -98 57 0 79 67 61 183 l-11 66 54 123 c59 138 79 201 94 303 11 76 7 68 195 330 80 111 102 135 104 118 3 -17 10 -23 28 -23 36 0 102 106 308 490 31 58 54 94 51 80 -3 -14 -30 -135 -60 -269 -57 -259 -57 -273 -11 -291 21 -8 24 -18 34 -122 21 -210 34 -453 27 -523 -7 -80 -27 -165 -56 -246 -14 -39 -19 -74 -17 -120 l3 -64 124 -3 c102 -2 127 0 142 13 16 15 19 15 43 0 21 -14 51 -16 218 -13 167 3 198 6 222 21 62 41 46 62 -78 103 -364 120 -399 198 -330 738 11 90 19 122 34 135 27 24 117 306 145 456 82 446 97 630 104 1315 l6 585 100 20 100 20 -1 65 c0 36 -2 101 -5 144 l-4 80 110 38 c119 42 145 62 145 113 0 32 7 39 128 121 70 48 135 97 145 110 17 22 20 23 42 8 26 -17 96 -104 119 -148 22 -43 8 -68 -103 -181 -55 -55 -104 -110 -110 -122 -46 -91 43 -203 187 -233 l48 -11 -4 -58 c-5 -75 18 -189 68 -336 l40 -116 -26 -44 -26 -45 22 -258 c62 -752 100 -1116 156 -1502 77 -536 139 -816 195 -876 22 -24 26 -23 221 30 129 35 187 46 194 35 3 -5 -18 -47 -46 -94 -79 -130 -63 -161 67 -131 91 21 106 32 143 106 27 54 56 84 168 178 46 38 52 47 52 82 0 22 -5 50 -11 63 -16 36 2 61 58 82 100 38 239 99 265 117 37 25 29 40 -54 98 l-70 49 42 17 c32 13 46 26 57 53 22 53 134 164 261 258 62 46 116 91 119 99 3 8 0 28 -7 44 -17 41 -8 67 50 139 112 140 169 298 233 646 15 80 34 150 50 182 15 28 77 113 138 189 138 172 153 203 146 299 -6 86 -29 136 -119 266 -36 52 -89 132 -118 178 l-52 84 107 107 c68 69 106 113 102 123 -8 21 -67 46 -130 53 -65 8 -123 -5 -214 -48 l-63 -29 -33 25 c-18 14 -66 41 -107 60 -60 29 -95 38 -177 47 -108 11 -306 9 -319 -3 -4 -5 -13 -72 -20 -150 -7 -79 -13 -144 -13 -145 -1 -2 -10 -3 -21 -3 -11 0 -36 -7 -55 -14 -31 -13 -35 -19 -35 -53 1 -21 7 -67 15 -103 19 -87 19 -100 -4 -100 -30 0 -209 48 -286 77 -116 43 -172 79 -185 119 -24 71 11 226 100 451 27 68 54 152 61 186 19 105 1 236 -66 466 -43 151 -100 262 -170 336 -65 67 -121 95 -195 95 -178 0 -240 -87 -285 -400 -8 -58 -15 -124 -15 -147 0 -24 -4 -43 -9 -43 -9 0 -164 183 -194 230 -9 15 -26 75 -36 133 -13 74 -32 134 -60 195 -23 49 -41 97 -41 108 0 25 -25 105 -43 140 -21 40 -65 80 -107 98 -98 41 -321 79 -334 57z m2552 -1840 c44 -23 154 -131 217 -216 74 -98 137 -290 136 -411 0 -71 -43 -215 -124 -414 -36 -92 -84 -180 -178 -330 -70 -113 -141 -221 -158 -240 l-31 -35 -28 34 c-27 31 -31 33 -49 20 -11 -8 -62 -63 -113 -124 -148 -174 -279 -312 -331 -351 -27 -20 -49 -42 -49 -49 0 -8 16 -27 36 -44 23 -18 35 -35 31 -44 -6 -16 -231 -143 -339 -191 l-68 -30 26 -27 c16 -17 24 -34 20 -44 -7 -18 -147 -85 -254 -121 -88 -30 -243 -64 -293 -64 l-36 0 -32 162 c-18 90 -35 172 -37 184 -5 19 2 22 103 38 163 27 263 52 292 74 23 18 26 26 24 74 l-3 55 183 90 c166 83 271 152 256 167 -3 4 -32 10 -64 14 -32 4 -60 12 -62 19 -5 15 83 117 238 274 129 132 220 209 246 209 8 0 22 -18 30 -40 10 -25 23 -40 33 -40 38 0 202 195 287 343 l45 78 23 -21 c26 -25 27 -24 49 50 24 80 31 212 16 298 -14 82 -73 213 -115 252 l-25 23 0 -36 c0 -20 -2 -37 -5 -37 -2 0 -33 15 -67 34 -71 39 -197 78 -329 102 -63 12 -90 21 -93 33 -22 72 -55 236 -49 242 5 4 60 12 124 18 124 12 243 4 354 -23 71 -17 95 -9 95 34 0 36 15 38 68 11z"/></g></svg> );
    const MartialArtsIcon = ({ className, ...props }) => ( <svg version="1.0" xmlns="http://www.w3.org/2000/svg" width="512pt" height="512pt" viewBox="0 0 512 512" preserveAspectRatio="xMidYMid meet" className={className} {...props} fill="currentColor"><g transform="translate(0,512) scale(0.1,-0.1)" stroke="none"><path d="M2651 4810 c-103 -27 -194 -81 -277 -164 -132 -133 -189 -279 -182 -465 5 -119 30 -207 84 -296 l32 -54 -52 -5 c-28 -3 -388 -17 -801 -32 -512 -17 -763 -30 -793 -38 l-42 -13 -183 188 c-156 160 -188 188 -220 194 -90 17 -165 -17 -198 -89 -22 -49 -24 -85 -5 -130 23 -54 304 -491 340 -528 44 -45 107 -74 181 -83 35 -5 71 -17 88 -29 34 -25 -17 -22 834 -45 364 -9 665 -19 668 -22 3 -3 15 -54 27 -114 25 -125 46 -158 98 -158 39 0 70 32 70 72 0 51 -60 296 -79 321 -24 32 -42 34 -743 50 l-548 14 0 121 0 121 754 28 754 28 74 -36 c83 -42 165 -66 223 -66 22 0 45 -4 51 -8 6 -4 21 -39 33 -79 12 -40 24 -79 27 -87 4 -10 -6 -16 -35 -21 -61 -10 -91 -38 -91 -85 0 -64 45 -82 151 -58 8 2 18 -26 30 -82 10 -47 18 -88 19 -92 0 -3 -24 -9 -52 -13 -88 -12 -125 -70 -79 -126 17 -21 27 -24 84 -22 l65 3 7 -85 c4 -46 5 -91 1 -100 -4 -10 -19 -15 -51 -15 -84 0 -123 -72 -70 -126 22 -22 33 -25 77 -22 l50 3 -6 -77 c-11 -138 -10 -136 -72 -144 -30 -3 -65 -15 -79 -26 -55 -43 -13 -128 63 -128 l40 0 -18 -57 c-10 -32 -30 -88 -45 -125 l-27 -66 -46 16 c-76 27 -244 116 -334 176 -132 89 -130 85 -118 126 21 73 31 168 31 304 0 122 -2 143 -19 165 -28 38 -83 41 -111 6 -18 -24 -20 -40 -20 -168 0 -130 -15 -254 -39 -316 -8 -20 -153 -153 -377 -346 -228 -197 -479 -394 -674 -530 -139 -97 -175 -142 -196 -245 l-11 -54 -120 -88 c-96 -71 -130 -90 -174 -99 -115 -23 -229 -86 -324 -177 -57 -56 -106 -137 -106 -177 0 -80 64 -164 140 -185 64 -17 514 49 575 84 52 31 88 94 89 158 l1 48 79 56 c78 57 79 57 145 55 54 -2 94 6 216 43 152 46 344 116 442 161 83 38 94 104 23 143 -23 13 -36 10 -165 -41 -194 -76 -453 -157 -504 -157 -124 0 -203 134 -143 245 16 30 45 54 205 169 228 163 576 448 866 710 40 36 78 66 83 66 6 0 27 -13 47 -29 97 -76 298 -188 436 -241 33 -13 63 -26 67 -29 11 -9 -101 -134 -197 -221 -106 -97 -220 -180 -362 -266 -65 -39 -124 -83 -132 -96 -31 -54 32 -122 91 -99 49 18 240 141 356 228 64 48 168 138 230 201 l112 112 118 -20 c509 -87 856 -180 1030 -277 126 -71 193 -138 271 -275 18 -32 50 -74 72 -95 l39 -37 0 -103 c0 -102 0 -103 -35 -148 -38 -51 -75 -156 -75 -217 0 -64 43 -132 105 -166 25 -14 72 -18 298 -20 l268 -3 44 25 c79 47 112 137 81 221 -23 59 -113 141 -210 191 l-77 39 4 155 c3 144 5 160 30 218 56 125 59 338 8 502 -35 111 -139 248 -250 328 -53 39 -84 40 -118 6 -42 -42 -28 -74 75 -170 111 -103 147 -169 170 -309 13 -80 14 -113 5 -186 -18 -137 -67 -214 -153 -240 -32 -10 -44 -9 -76 7 -21 11 -48 33 -59 51 -11 17 -38 60 -60 95 -161 258 -457 388 -1188 524 -105 19 -198 37 -204 39 -26 9 1 34 65 61 173 72 347 183 465 293 l67 64 84 -17 c122 -24 311 -80 434 -127 142 -56 173 -59 201 -24 27 36 27 71 -2 97 -46 41 -378 156 -545 188 l-62 13 0 36 c0 55 -19 323 -25 347 -4 20 0 22 81 28 102 9 195 35 287 83 80 42 167 120 167 150 0 12 14 30 35 44 49 34 92 97 109 161 13 49 12 85 -10 349 -17 208 -29 305 -41 332 -47 107 -195 130 -272 42 -40 -45 -45 -68 -77 -346 l-28 -235 -80 -33 c-94 -39 -182 -49 -241 -29 -32 11 -42 20 -54 53 -65 183 -129 315 -203 423 l-51 72 25 38 c75 112 108 219 109 347 0 118 -14 182 -63 285 -33 69 -56 100 -122 165 -49 49 -105 93 -143 113 -135 71 -313 91 -462 52z m290 -146 c165 -49 284 -167 335 -333 19 -62 18 -193 -2 -261 -43 -146 -164 -270 -313 -321 -71 -25 -204 -26 -281 -3 -289 85 -423 411 -284 687 30 59 129 159 186 188 113 58 251 75 359 43z m-2568 -882 l187 -194 0 -74 c0 -44 -4 -74 -10 -74 -22 0 -76 29 -96 51 -30 33 -304 466 -304 479 0 32 52 -12 223 -188z m3807 16 c1 -7 11 -132 24 -278 13 -149 19 -280 15 -298 -4 -19 -18 -45 -30 -59 l-24 -24 -28 33 c-64 75 -62 49 -27 345 17 147 33 274 35 281 3 6 11 12 20 12 8 0 15 -6 15 -12z m-923 -180 c160 -255 265 -647 292 -1093 8 -127 7 -142 -9 -166 -37 -51 -174 -172 -255 -225 -94 -61 -244 -144 -262 -144 -8 0 -7 15 6 53 10 28 24 76 31 105 13 58 13 58 82 67 61 8 91 32 91 74 0 45 -32 75 -83 75 -22 1 -40 4 -41 9 0 4 3 52 6 106 l7 99 51 5 c39 3 56 11 74 31 28 33 29 56 2 90 -18 22 -28 26 -75 26 l-54 0 0 34 c0 18 -3 60 -6 94 -7 68 -15 59 72 77 28 6 55 55 46 87 -2 10 -16 28 -31 39 -20 17 -35 20 -68 15 l-42 -6 -7 38 c-3 20 -12 66 -19 102 -15 70 -11 80 33 80 13 0 37 14 54 30 24 25 29 36 24 58 -12 48 -43 65 -107 58 l-56 -7 -21 75 c-12 41 -22 79 -22 84 0 5 14 12 31 16 36 7 147 61 169 82 8 8 19 14 25 14 6 0 34 -37 62 -82z m-2457 -113 l0 -115 -45 0 -45 0 0 115 0 115 45 0 45 0 0 -115z m3219 -424 l52 -63 -33 -24 c-18 -13 -35 -23 -39 -22 -8 3 -109 155 -109 163 0 2 12 11 28 19 31 17 24 21 101 -73z m-228 -73 c36 -55 56 -95 51 -100 -10 -10 -166 -17 -176 -7 -3 3 -12 39 -21 80 -8 41 -17 84 -20 97 -5 21 -2 22 50 22 l55 0 61 -92z m879 -2143 l0 -65 -50 0 -50 0 0 54 c0 54 0 54 38 64 63 17 62 18 62 -53z m-3687 6 l26 -39 -40 -27 c-23 -14 -42 -25 -42 -23 -1 2 -15 18 -32 36 l-30 33 35 29 c19 16 40 30 46 30 6 0 23 -18 37 -39z m-229 -135 c35 -15 78 -76 91 -128 5 -21 2 -29 -17 -41 -35 -22 -456 -81 -474 -66 -22 18 -17 36 27 84 55 60 140 115 219 142 76 26 108 28 154 9z m3980 -106 c126 -39 245 -126 231 -169 -6 -21 -12 -21 -236 -21 -148 0 -238 4 -251 11 -17 9 -19 17 -14 52 22 136 108 177 270 127z"/></g></svg> );
    const YogaIcon = ({ className, ...props }) => ( <svg version="1.0" xmlns="http://www.w3.org/2000/svg" width="512pt" height="512pt" viewBox="0 0 512 512" preserveAspectRatio="xMidYMid meet" className={className} {...props} fill="currentColor"><g transform="translate(0,512) scale(0.1,-0.1)" stroke="none"><path d="M2397 4463 c-58 -20 -140 -90 -170 -147 -18 -34 -22 -57 -22 -136 0 -60 5 -103 13 -118 l13 -23 28 38 c98 135 318 263 453 263 37 0 35 9 -9 52 -82 79 -204 107 -306 71z"/><path d="M2673 4165 c-230 -65 -373 -250 -373 -484 0 -147 44 -252 147 -355 270 -268 721 -143 828 228 23 80 16 228 -14 307 -50 127 -166 240 -299 289 -75 28 -217 36 -289 15z"/><path d="M1901 3240 c-24 -5 -65 -22 -91 -37 -68 -40 -1311 -1137 -1297 -1144 24 -13 326 -69 477 -88 291 -38 720 -56 735 -31 4 6 60 51 124 100 169 127 308 261 371 359 l16 23 97 -48 c62 -31 100 -45 106 -39 5 6 71 122 146 259 106 192 134 251 123 257 -82 55 -587 354 -620 368 -54 24 -130 32 -187 21z"/><path d="M2764 2573 c-53 -98 -115 -209 -136 -247 -21 -38 -35 -73 -31 -77 4 -4 271 -138 593 -296 l585 -288 76 0 c66 0 81 3 118 28 78 52 121 148 106 237 -13 75 -59 126 -185 205 -250 156 -1011 615 -1019 615 -5 0 -53 -80 -107 -177z"/><path d="M257 1846 c-119 -116 -181 -215 -227 -361 -113 -364 119 -755 492 -830 65 -13 189 -15 778 -15 l700 0 0 439 c0 410 -1 440 -17 445 -10 2 -106 19 -213 36 -253 40 -250 39 -250 56 0 8 13 43 29 77 l28 64 -206 11 c-325 19 -643 65 -934 136 l-97 23 -83 -81z"/><path d="M2170 1065 l0 -425 1173 2 1172 3 66 26 c97 37 157 76 219 138 76 77 320 446 320 483 0 37 -40 78 -77 78 -16 0 -132 -52 -279 -127 l-251 -127 -289 47 c-1273 206 -2025 327 -2038 327 -14 0 -16 -42 -16 -425z"/></g></svg> );
    const HandballIcon = ({ className, ...props }) => ( <svg version="1.0" xmlns="http://www.w3.org/2000/svg" width="512pt" height="512pt" viewBox="0 0 512 512" preserveAspectRatio="xMidYMid meet" className={className} {...props} fill="currentColor"><g transform="translate(0,512) scale(0.1,-0.1)" stroke="none"><path d="M2804 4896 c-93 -23 -175 -92 -216 -181 -35 -76 -33 -191 5 -267 30 -62 83 -115 149 -150 36 -19 58 -23 138 -23 80 0 102 4 138 23 66 35 119 88 149 150 38 77 39 190 4 270 -60 134 -225 214 -367 178z"/><path d="M2075 4781 c-89 -41 -132 -126 -182 -361 -26 -121 -25 -440 1 -560 56 -259 169 -499 315 -670 26 -30 51 -61 55 -68 5 -8 -180 -337 -490 -873 -273 -473 -503 -878 -511 -901 -27 -80 8 -178 85 -232 57 -40 149 -48 208 -18 60 31 84 63 199 262 59 102 108 187 110 189 6 5 364 -203 365 -212 0 -4 -117 -209 -259 -456 -142 -246 -267 -463 -277 -482 -37 -72 -14 -189 48 -245 47 -43 87 -56 158 -52 77 4 125 30 163 88 13 19 295 505 627 1080 332 575 607 1050 612 1055 13 14 40 -24 98 -140 123 -248 149 -526 72 -773 -19 -60 -27 -109 -27 -158 0 -62 4 -76 29 -112 36 -52 112 -92 176 -92 69 0 144 41 176 96 93 159 140 532 99 794 -51 336 -209 637 -457 875 -87 84 -115 102 -383 255 -159 91 -323 190 -364 221 -351 258 -509 733 -384 1147 34 112 40 189 18 236 -50 106 -178 154 -280 107z"/><path d="M3306 4039 c-63 -15 -153 -68 -202 -121 -103 -110 -140 -269 -95 -416 62 -206 277 -335 483 -293 227 48 380 266 339 486 -21 118 -79 211 -170 276 -96 69 -236 96 -355 68z"/></g></svg> );
    const SoccerIcon = ({ className, ...props }) => ( <svg version="1.0" xmlns="http://www.w3.org/2000/svg" width="512pt" height="512pt" viewBox="0 0 512 512" preserveAspectRatio="xMidYMid meet" className={className} {...props} fill="currentColor"><g transform="translate(0,512) scale(0.1,-0.1)" stroke="none"><path d="M3178 4861 c-77 -25 -118 -52 -177 -116 -69 -76 -95 -146 -94 -255 0 -122 27 -185 112 -271 88 -87 150 -113 276 -114 80 0 97 4 157 32 85 40 151 106 191 191 29 61 32 76 32 162 0 86 -3 101 -32 162 -63 134 -185 216 -331 224 -57 3 -91 -1 -134 -15z"/><path d="M2323 4095 c-241 -68 -522 -385 -759 -857 -76 -151 -104 -229 -104 -287 0 -84 57 -127 135 -101 45 15 96 80 278 356 104 158 168 244 224 301 91 94 163 144 163 113 0 -6 -41 -110 -91 -232 -146 -354 -197 -606 -170 -848 27 -255 116 -416 294 -534 82 -54 255 -141 332 -166 114 -37 178 -89 201 -165 39 -133 29 -294 -42 -658 -24 -125 -49 -273 -55 -329 -11 -104 -8 -339 5 -370 10 -22 50 -34 151 -47 192 -25 589 -40 664 -25 34 7 52 44 34 73 -5 9 -69 48 -142 86 -164 87 -256 155 -295 218 -28 46 -30 55 -29 145 1 101 24 205 108 487 48 160 68 292 55 368 -20 127 -84 224 -284 436 -239 253 -255 336 -117 616 86 174 234 392 389 574 l28 33 0 -79 c-1 -70 3 -86 32 -146 60 -122 203 -239 428 -351 257 -127 393 -147 445 -62 57 93 -1 163 -319 381 -236 162 -276 221 -308 455 -19 141 -37 184 -111 261 -136 143 -417 277 -708 339 -132 28 -358 36 -432 15z"/><path d="M900 2317 c-104 -29 -193 -123 -281 -299 -88 -176 -169 -398 -169 -464 0 -38 25 -55 65 -46 11 2 90 76 175 163 174 177 207 199 305 199 78 0 143 -27 276 -115 119 -78 189 -111 324 -154 275 -89 503 -55 654 96 32 32 63 68 70 80 10 21 8 24 -31 44 -143 73 -258 181 -335 316 l-29 52 -27 -34 c-39 -48 -147 -123 -211 -146 -116 -40 -217 -15 -341 87 -245 199 -274 218 -355 228 -25 3 -65 0 -90 -7z"/><path d="M4165 1017 c-146 -49 -248 -167 -276 -320 -47 -253 192 -493 447 -450 132 23 240 102 299 219 28 55 30 67 30 169 0 98 -3 116 -26 165 -39 82 -109 154 -187 192 -58 27 -80 32 -157 35 -56 2 -105 -2 -130 -10z"/></g></svg> );
    const BasketballIcon = ({ className, ...props }) => ( <svg version="1.0" xmlns="http://www.w3.org/2000/svg" width="512pt" height="512pt" viewBox="0 0 512 512" preserveAspectRatio="xMidYMid meet" className={className} {...props} fill="currentColor"><g transform="translate(0,512) scale(0.1,-0.1)" stroke="none"><path d="M530 4956 c-72 -19 -115 -44 -166 -94 -56 -56 -92 -128 -105 -214 -6 -39 -9 -657 -7 -1638 l3 -1575 24 -60 c33 -82 124 -173 206 -206 l60 -24 518 -3 c374 -2 517 0 517 8 0 46 -70 275 -113 373 l-26 57 -355 0 c-353 0 -355 0 -376 22 -20 22 -20 26 -20 1451 0 912 4 1435 10 1447 5 10 24 23 41 29 45 16 3593 16 3638 0 17 -6 36 -19 41 -29 6 -12 10 -535 10 -1447 0 -1425 0 -1429 -20 -1451 -21 -22 -23 -22 -381 -22 l-360 0 -33 -72 c-37 -81 -67 -170 -91 -268 -9 -36 -18 -73 -21 -82 -5 -17 23 -18 498 -18 543 0 575 3 661 53 62 37 132 117 159 185 l23 57 0 1620 0 1620 -26 61 c-33 78 -72 127 -135 169 -104 69 43 65 -2149 64 -1542 0 -1990 -3 -2025 -13z"/><path d="M2625 3662 c18 -75 48 -152 87 -222 32 -56 99 -149 109 -150 3 0 58 59 123 130 95 106 115 134 106 145 -28 33 -217 116 -311 135 -137 29 -130 31 -114 -38z"/><path d="M2385 3703 c-55 -12 -156 -49 -205 -73 -71 -36 -182 -118 -178 -132 2 -5 127 -122 278 -259 l275 -248 53 57 c29 31 64 71 78 89 l25 32 -50 64 c-91 116 -149 234 -186 381 -24 97 -31 103 -90 89z"/><path d="M3056 3309 c-137 -150 -137 -131 9 -204 83 -42 193 -75 289 -89 l38 -5 -6 37 c-11 62 -37 133 -76 212 -37 73 -113 180 -128 180 -4 0 -60 -59 -126 -131z"/><path d="M1835 3303 c-48 -82 -87 -191 -104 -287 -19 -106 -21 -102 62 -109 142 -12 315 -75 441 -161 l63 -44 71 82 c40 44 73 84 74 87 3 6 -548 509 -557 509 -3 0 -25 -35 -50 -77z"/><path d="M2756 2976 c-42 -46 -76 -88 -75 -92 0 -8 461 -428 529 -482 l29 -24 36 56 c68 107 131 305 123 388 l-3 33 -70 8 c-139 14 -346 90 -440 161 -16 12 -35 25 -41 29 -7 4 -44 -28 -88 -77z"/><path d="M1736 2717 c24 -144 152 -387 204 -387 11 0 66 52 134 128 l115 127 -22 17 c-78 62 -254 130 -375 146 l-63 9 7 -40z"/><path d="M2488 2678 l-75 -82 52 -67 c28 -37 67 -96 86 -133 l34 -66 228 0 c153 0 226 3 222 10 -10 16 -459 420 -466 420 -4 0 -40 -37 -81 -82z"/><path d="M2251 2418 c-85 -94 -89 -88 43 -88 l116 0 -30 48 c-37 58 -66 92 -77 91 -4 -1 -28 -23 -52 -51z"/><path d="M1262 2146 c7 -56 46 -142 87 -188 18 -20 55 -48 83 -62 l52 -26 1069 0 c808 0 1080 3 1111 12 88 26 178 147 200 271 l7 37 -1307 0 -1307 0 5 -44z"/><path d="M1540 1715 c0 -2 18 -39 39 -82 75 -149 141 -374 176 -603 23 -149 31 -501 15 -678 -13 -141 -13 -143 8 -164 38 -39 103 -23 123 29 8 22 12 23 151 23 l143 0 17 -30 c34 -59 109 -59 131 0 l11 30 208 0 208 0 0 -24 c0 -29 43 -66 76 -66 29 0 61 30 70 65 l6 25 142 0 142 0 9 -32 c19 -63 96 -76 132 -22 14 22 15 33 5 87 -7 34 -18 131 -24 214 -32 408 67 932 223 1186 l29 47 -91 0 -90 0 -34 -72 c-18 -40 -46 -110 -62 -155 l-28 -83 -162 0 c-154 0 -163 1 -163 19 0 22 38 248 46 274 5 15 -3 17 -74 17 l-79 0 -21 -127 c-12 -71 -23 -139 -24 -153 l-3 -25 -237 -3 -237 -2 -6 57 c-4 32 -15 101 -24 153 l-16 95 -79 3 c-77 3 -78 3 -73 -20 6 -22 28 -150 42 -245 l7 -43 -174 0 -173 1 -26 82 c-15 45 -41 115 -59 155 l-33 72 -83 0 c-46 0 -84 -2 -84 -5z m653 -557 c4 -57 10 -151 13 -210 l7 -108 -141 0 c-162 0 -146 -12 -157 115 -4 39 -15 117 -26 175 -10 58 -19 111 -19 118 0 9 38 12 159 12 l158 0 6 -102z m581 50 c-3 -29 -9 -123 -12 -208 l-7 -155 -196 -3 -196 -2 -7 132 c-3 73 -9 168 -13 211 l-6 77 222 0 221 0 -6 -52z m456 38 c0 -8 -9 -65 -19 -128 -11 -62 -23 -150 -27 -195 l-7 -83 -135 0 -135 0 6 163 c4 89 10 183 13 210 l7 -47 148 0 c121 0 149 -3 149 -14z m-1020 -706 l0 -150 -140 0 -141 0 2 143 c1 78 3 145 6 150 2 4 65 7 139 7 l134 0 0 -150z m542 8 c3 -79 3 -146 1 -150 -2 -5 -92 -8 -199 -8 l-194 0 0 143 c0 79 3 147 7 150 3 4 91 7 193 7 l187 0 5 -142z m418 75 c0 -38 3 -105 7 -150 l6 -83 -135 0 -135 0 -7 77 c-8 99 -8 208 1 216 3 4 64 7 135 7 l128 0 0 -67z"/></g></svg> );
    const SwimIcon = ({ className, ...props }) => ( <svg version="1.0" xmlns="http://www.w3.org/2000/svg" width="512pt" height="512pt" viewBox="0 0 512 512" preserveAspectRatio="xMidYMid meet" className={className} {...props} fill="currentColor"><g transform="translate(0,512) scale(0.1,-0.1)" stroke="none"><path d="M4152 4564 c-29 -11 -190 -143 -536 -439 -271 -232 -505 -439 -520 -458 -18 -23 -106 -251 -246 -632 -120 -328 -220 -598 -222 -600 -1 -1 -337 -184 -745 -406 -409 -221 -742 -404 -740 -405 1 -1 22 2 47 6 74 15 235 11 313 -6 91 -21 170 -57 271 -122 137 -90 202 -92 326 -12 173 112 289 150 460 150 171 0 281 -35 443 -139 142 -92 202 -92 341 -1 111 73 130 81 273 125 7 2 -72 157 -193 381 -112 208 -204 380 -204 383 0 3 77 218 171 476 l172 470 457 391 c519 445 510 435 510 568 -1 113 -57 208 -155 258 -53 28 -164 34 -223 12z"/><path d="M3910 3044 c-99 -26 -179 -72 -257 -149 -312 -307 -175 -827 250 -950 77 -22 217 -22 293 0 350 101 519 474 363 802 -65 137 -217 258 -374 298 -74 19 -202 18 -275 -1z"/><path d="M72 1478 c-36 -10 -72 -57 -72 -96 0 -31 26 -79 49 -91 10 -6 51 -14 92 -19 87 -11 128 -27 206 -80 138 -93 229 -123 373 -123 145 0 235 30 374 124 89 60 142 77 240 77 103 0 141 -13 249 -84 142 -93 219 -118 367 -117 142 0 226 27 350 111 118 80 133 85 260 85 129 0 132 -1 275 -95 95 -61 166 -88 260 -98 159 -17 284 12 420 100 143 92 146 93 275 93 l115 0 65 -38 c36 -21 94 -56 130 -78 97 -59 175 -80 298 -80 146 -1 236 29 375 123 78 53 119 69 206 80 88 11 106 19 126 58 20 39 19 69 -5 107 -24 40 -65 52 -150 43 -92 -10 -166 -34 -232 -75 -32 -19 -84 -51 -115 -70 -77 -48 -122 -58 -228 -53 -100 5 -121 13 -250 98 -42 27 -101 58 -131 69 -113 43 -289 44 -405 3 -30 -10 -99 -47 -153 -81 -123 -79 -158 -91 -262 -91 -98 0 -151 17 -240 77 -138 94 -232 125 -374 125 -142 0 -236 -31 -374 -125 -89 -60 -142 -77 -240 -77 -104 0 -141 13 -260 90 -148 96 -264 126 -426 109 -95 -9 -169 -37 -265 -99 -143 -94 -146 -95 -275 -95 -127 0 -142 5 -260 85 -78 53 -127 76 -196 93 -78 20 -151 25 -192 15z"/><path d="M35 927 c-39 -39 -45 -78 -20 -126 16 -33 48 -47 124 -56 75 -9 132 -32 236 -98 142 -91 176 -101 335 -102 166 0 222 16 367 109 119 77 156 90 253 90 98 0 142 -14 234 -74 169 -110 247 -134 411 -127 134 5 188 24 330 113 119 75 198 100 287 90 83 -10 124 -26 230 -94 134 -85 190 -104 323 -109 160 -7 253 21 398 119 101 68 141 82 242 82 104 0 136 -12 274 -99 122 -78 182 -97 316 -103 159 -6 242 18 378 110 83 56 153 86 222 93 81 9 113 22 130 56 25 48 19 87 -19 125 -31 31 -39 34 -93 34 -115 0 -222 -38 -346 -122 -103 -70 -140 -83 -247 -83 -107 0 -144 13 -247 83 -130 88 -230 122 -365 122 -134 0 -231 -30 -348 -110 -191 -130 -328 -132 -519 -8 -52 34 -126 73 -165 87 -63 23 -85 26 -201 26 -117 -1 -137 -4 -198 -28 -37 -14 -109 -53 -160 -86 -112 -72 -190 -96 -285 -87 -74 6 -137 33 -244 103 -104 68 -180 94 -298 100 -160 9 -241 -16 -409 -122 -105 -66 -187 -90 -279 -81 -72 6 -125 29 -256 111 -106 65 -162 85 -273 92 l-82 6 -36 -36z"/></g></svg> );
    const BicycleIcon = ({ className, ...props }) => ( <svg version="1.0" xmlns="http://www.w3.org/2000/svg" width="512pt" height="512pt" viewBox="0 0 512 512" preserveAspectRatio="xMidYMid meet" className={className} {...props} fill="currentColor"><g transform="translate(0,512) scale(0.1,-0.1)" stroke="none"><path d="M2585 5008 c-206 -27 -356 -233 -324 -443 49 -314 434 -439 659 -215 153 154 153 396 0 550 -88 87 -205 125 -335 108z"/><path d="M1964 4166 c-95 -44 -104 -62 -292 -555 -94 -246 -176 -468 -181 -492 -21 -91 -8 -208 32 -286 10 -18 17 -34 17 -36 0 -3 -51 -7 -112 -9 -124 -5 -158 -16 -201 -68 -53 -62 -48 -152 12 -211 49 -49 91 -59 254 -59 l138 0 14 -32 c13 -32 12 -33 -83 -174 l-97 -141 -80 28 c-305 106 -650 62 -923 -118 -83 -55 -213 -183 -272 -269 -304 -440 -230 -1041 173 -1384 566 -482 1424 -247 1668 457 16 46 29 92 29 104 0 18 4 20 44 14 41 -6 70 3 349 114 296 118 329 136 356 188 23 45 10 115 -30 151 l-21 21 288 283 c486 476 524 512 527 507 5 -6 37 -101 37 -110 0 -4 -28 -24 -62 -45 -134 -80 -233 -172 -320 -294 -297 -419 -248 -981 118 -1343 548 -543 1472 -318 1723 420 124 366 14 796 -272 1070 -136 130 -281 212 -462 259 -83 22 -123 27 -235 28 -74 1 -155 -1 -179 -4 l-43 -5 -103 303 c-56 166 -99 302 -95 302 5 0 47 -19 94 -41 101 -49 136 -48 193 5 30 27 36 41 40 83 9 92 -6 107 -247 228 l-209 105 20 -45 c73 -165 23 -351 -120 -448 l-25 -17 17 -53 c9 -30 17 -57 17 -60 0 -4 -49 -7 -108 -7 -60 0 -157 -3 -215 -7 l-107 -6 0 -31 c0 -33 -19 -118 -44 -199 l-15 -48 122 7 122 6 -172 -173 -172 -174 -72 -240 -71 -240 -46 -1 c-26 -1 -68 -11 -94 -22 -27 -12 -48 -19 -48 -15 0 3 69 238 154 522 85 284 157 531 161 549 10 50 -12 125 -51 171 -29 34 -54 47 -162 89 -70 27 -154 55 -187 62 -33 7 -76 21 -96 30 -51 26 -103 89 -117 140 -12 43 -84 701 -78 707 2 2 36 -83 76 -189 163 -431 169 -445 206 -477 19 -17 58 -37 87 -45 123 -35 686 -159 723 -159 80 -1 155 61 170 139 13 71 -22 151 -81 186 -17 9 -170 49 -340 88 -169 38 -309 71 -310 73 -6 6 -195 510 -193 513 2 1 48 -61 103 -137 l99 -140 34 88 c56 147 53 243 -13 329 -38 50 -86 74 -347 173 -208 80 -246 91 -300 91 -45 0 -78 -7 -114 -24z m298 -1758 c65 -24 118 -48 118 -53 0 -6 -56 -199 -125 -429 -69 -231 -128 -436 -131 -456 -9 -55 12 -117 58 -166 23 -24 39 -46 37 -48 -2 -2 -39 -18 -83 -36 l-79 -31 -22 21 c-13 12 -36 49 -51 83 -24 52 -28 75 -28 147 0 76 6 107 63 293 l63 208 -55 133 -55 133 61 7 c33 3 77 6 97 6 29 0 39 5 43 19 3 12 -1 22 -12 26 -9 4 -110 43 -226 87 -115 44 -219 84 -230 89 -11 4 81 8 210 9 l230 0 117 -42z m-378 -566 c46 -112 83 -202 81 -200 -2 2 -26 38 -54 81 -28 43 -86 113 -129 157 l-79 80 41 61 c34 52 41 58 48 43 4 -11 46 -111 92 -222z m-676 53 c37 -9 73 -19 80 -24 9 -5 -47 -96 -209 -332 -122 -178 -226 -336 -231 -352 -19 -54 11 -129 65 -160 16 -9 136 -13 453 -17 l431 -5 -13 -55 c-8 -30 -35 -98 -61 -150 -40 -82 -60 -108 -142 -190 -109 -108 -201 -163 -336 -201 -114 -33 -288 -33 -399 -1 -328 94 -549 368 -564 698 -7 152 13 248 80 384 45 91 64 117 142 195 69 69 110 101 171 132 75 39 179 77 235 86 64 11 236 6 298 -8z m3092 -15 c132 -45 219 -98 316 -195 78 -78 97 -104 142 -195 67 -136 87 -232 80 -384 -15 -330 -236 -604 -564 -698 -63 -18 -103 -23 -199 -22 -143 0 -237 23 -360 87 -112 59 -253 200 -312 312 -158 302 -107 656 129 896 59 61 149 129 169 129 4 0 62 -164 128 -363 126 -376 133 -393 198 -426 51 -26 131 -1 163 51 35 58 28 94 -100 470 -66 194 -120 357 -120 362 0 5 57 6 133 3 99 -4 148 -10 197 -27z m-2697 -210 c88 -98 141 -193 177 -317 l19 -63 -276 0 c-151 0 -273 4 -271 8 12 31 285 421 295 422 6 0 31 -23 56 -50z"/></g></svg> );
const BotiquinIcon = ({ className, ...props }) => (
  <svg xmlns="http://www.w3.org/2000/svg" width="512" height="512" viewBox="0 0 512 512" className={className} {...props}>
    <defs>
      <radialGradient id="bgGradient" cx="30%" cy="30%">
        <stop offset="0%" stopColor="#F8F9FF"/>
        <stop offset="100%" stopColor="#E8EAFC"/>
      </radialGradient>
    </defs>
    <rect x="20" y="140" width="472" height="352" rx="24" ry="24" fill="url(#bgGradient)" className="themed-stroke" strokeWidth="12"/>
    <rect x="180" y="30" width="152" height="40" rx="20" ry="20" fill="#888" className="themed-stroke" strokeWidth="8"/>
    <rect x="200" y="70" width="20" height="70" fill="#888" className="themed-stroke" strokeWidth="6"/>
    <rect x="292" y="70" width="20" height="70" fill="#888" className="themed-stroke" strokeWidth="6"/>
    <rect x="80" y="130" width="30" height="25" rx="6" ry="6" fill="#BBB" className="themed-stroke" strokeWidth="4"/>
    <rect x="140" y="130" width="20" height="25" rx="4" ry="4" fill="#BBB" className="themed-stroke" strokeWidth="4"/>
    <rect x="352" y="130" width="20" height="25" rx="4" ry="4" fill="#BBB" className="themed-stroke" strokeWidth="4"/>
    <rect x="402" y="130" width="30" height="25" rx="6" ry="6" fill="#BBB" className="themed-stroke" strokeWidth="4"/>
    <circle cx="256" cy="316" r="90" fill="#C44534" className="themed-stroke" strokeWidth="12"/>
    <rect x="236" y="256" width="40" height="120" rx="12" ry="12" fill="#FFF" className="themed-stroke" strokeWidth="8"/>
    <rect x="196" y="296" width="120" height="40" rx="12" ry="12" fill="#FFF" className="themed-stroke" strokeWidth="8"/>
    <rect x="236" y="296" width="40" height="40" fill="#FFF"/>
  </svg>
);

const HistorialMedicoIcon = ({ className, ...props }) => (
  <svg xmlns="http://www.w3.org/2000/svg" width="512" height="512" viewBox="0 0 512 512" className={className} {...props}>
    <defs>
      <linearGradient id="topPageGradient" x1="0%" y1="0%" x2="100%" y2="0%">
        <stop offset="0%" stopColor="#F8FAFC"/>
        <stop offset="50%" stopColor="#F1F5F9"/>
        <stop offset="100%" stopColor="#E2E8F0"/>
      </linearGradient>
      <linearGradient id="backPageGradient" x1="0%" y1="0%" x2="100%" y2="0%">
        <stop offset="0%" stopColor="#CBD5E1"/>
        <stop offset="100%" stopColor="#94A3B8"/>
      </linearGradient>
    </defs>
    <rect x="10" y="120" width="200" height="320" rx="8" ry="8" fill="url(#backPageGradient)" className="themed-stroke" strokeWidth="8"/>
    <rect x="302" y="120" width="200" height="320" rx="8" ry="8" fill="url(#backPageGradient)" className="themed-stroke" strokeWidth="8"/>
    <path d="M30 110 L200 110 Q210 115 210 125 L210 420 Q210 430 200 430 L40 430 Q30 425 30 415 Z" fill="url(#topPageGradient)" className="themed-stroke" strokeWidth="8"/>
    <path d="M302 125 Q302 115 312 110 L482 110 Q492 115 492 125 L492 415 Q492 425 482 430 L312 430 Q302 425 302 415 Z" fill="url(#topPageGradient)" className="themed-stroke" strokeWidth="8"/>
    <rect x="210" y="110" width="92" height="320" fill="#374151" className="themed-stroke" strokeWidth="8"/>
    <line x1="256" y1="110" x2="256" y2="430" className="themed-stroke" strokeWidth="6"/>
    <circle cx="256" cy="140" r="65" fill="#EF4444" className="themed-stroke" strokeWidth="12"/>
    <path d="M241 105 L271 105 Q276 105 276 110 L276 125 L291 125 Q296 125 296 130 L296 150 Q296 155 291 155 L276 155 L276 170 Q276 175 271 175 L241 175 Q236 175 236 170 L236 155 L221 155 Q216 155 216 150 L216 130 Q216 125 221 125 L236 125 L236 110 Q236 105 241 105 Z" fill="#FFF" className="themed-stroke" strokeWidth="8"/>
    <path d="M50 180 Q120 175 170 180" className="themed-stroke" strokeWidth="8" fill="none" strokeLinecap="round"/>
    <path d="M50 200 Q110 195 160 200" className="themed-stroke" strokeWidth="8" fill="none" strokeLinecap="round"/>
    <path d="M50 220 Q115 215 165 220" className="themed-stroke" strokeWidth="8" fill="none" strokeLinecap="round"/>
    <path d="M50 260 Q125 255 175 260" className="themed-stroke" strokeWidth="8" fill="none" strokeLinecap="round"/>
    <path d="M50 280 Q105 275 155 280" className="themed-stroke" strokeWidth="8" fill="none" strokeLinecap="round"/>
    <path d="M50 300 Q120 295 170 300" className="themed-stroke" strokeWidth="8" fill="none" strokeLinecap="round"/>
    <path d="M50 320 Q110 315 160 320" className="themed-stroke" strokeWidth="8" fill="none" strokeLinecap="round"/>
    <path d="M50 340 Q115 335 165 340" className="themed-stroke" strokeWidth="8" fill="none" strokeLinecap="round"/>
    <path d="M50 360 Q100 355 150 360" className="themed-stroke" strokeWidth="8" fill="none" strokeLinecap="round"/>
    <path d="M50 380 Q130 375 180 380" className="themed-stroke" strokeWidth="8" fill="none" strokeLinecap="round"/>
    <path d="M50 400 Q115 395 165 400" className="themed-stroke" strokeWidth="8" fill="none" strokeLinecap="round"/>
    <path d="M342 180 Q392 175 442 180" className="themed-stroke" strokeWidth="8" fill="none" strokeLinecap="round"/>
    <path d="M342 200 Q382 195 432 200" className="themed-stroke" strokeWidth="8" fill="none" strokeLinecap="round"/>
    <path d="M342 220 Q397 215 447 220" className="themed-stroke" strokeWidth="8" fill="none" strokeLinecap="round"/>
    <path d="M342 260 Q387 255 437 260" className="themed-stroke" strokeWidth="8" fill="none" strokeLinecap="round"/>
    <path d="M342 280 Q402 275 452 280" className="themed-stroke" strokeWidth="8" fill="none" strokeLinecap="round"/>
    <path d="M342 300 Q392 295 442 300" className="themed-stroke" strokeWidth="8" fill="none" strokeLinecap="round"/>
    <path d="M342 320 Q407 315 457 320" className="themed-stroke" strokeWidth="8" fill="none" strokeLinecap="round"/>
    <path d="M342 340 Q387 335 437 340" className="themed-stroke" strokeWidth="8" fill="none" strokeLinecap="round"/>
    <path d="M342 360 Q397 355 447 360" className="themed-stroke" strokeWidth="8" fill="none" strokeLinecap="round"/>
    <path d="M342 380 Q382 375 432 380" className="themed-stroke" strokeWidth="8" fill="none" strokeLinecap="round"/>
    <path d="M342 400 Q387 395 437 400" className="themed-stroke" strokeWidth="8" fill="none" strokeLinecap="round"/>
    <rect x="240" y="420" width="32" height="20" rx="4" ry="4" fill="#374151" className="themed-stroke" strokeWidth="4"/>
  </svg>
);

const GenericoIcon = ({ className, ...props }) => (
  <svg xmlns="http://www.w3.org/2000/svg" width="512" height="512" viewBox="0 0 512 512" className={className} {...props}>
    <rect x="30" y="160" width="220" height="300" rx="40" ry="40" fill="#B8C5E8" className="themed-stroke" strokeWidth="10"/>
    <rect x="90" y="100" width="100" height="70" fill="#B8C5E8" className="themed-stroke" strokeWidth="8"/>
    <rect x="60" y="30" width="160" height="50" rx="25" ry="25" fill="#4A5568" className="themed-stroke" strokeWidth="8"/>
    <rect x="80" y="80" width="120" height="25" rx="12" ry="12" fill="#718096" className="themed-stroke" strokeWidth="6"/>
    <rect x="40" y="220" width="200" height="120" rx="8" ry="8" fill="#F56565" className="themed-stroke" strokeWidth="6"/>
    <rect x="125" y="240" width="30" height="80" rx="6" ry="6" fill="#FFF" className="themed-stroke" strokeWidth="5"/>
    <rect x="100" y="265" width="80" height="30" rx="6" ry="6" fill="#FFF" className="themed-stroke" strokeWidth="5"/>
    <rect x="125" y="265" width="30" height="30" fill="#FFF"/>
    <rect x="40" y="340" width="200" height="120" rx="8" ry="8" fill="#A0B0D8" className="themed-stroke" strokeWidth="6"/>
    <ellipse cx="350" cy="280" rx="50" ry="30" fill="#F6E05E" className="themed-stroke" strokeWidth="8"/>
    <line x1="300" y1="280" x2="400" y2="280" className="themed-stroke" strokeWidth="6"/>
    <circle cx="300" cy="400" r="35" fill="#FFF" className="themed-stroke" strokeWidth="8"/>
    <line x1="275" y1="400" x2="325" y2="400" className="themed-stroke" strokeWidth="4"/>
    <ellipse cx="420" cy="380" rx="45" ry="28" fill="#F687B3" className="themed-stroke" strokeWidth="8"/>
    <line x1="375" y1="380" x2="465" y2="380" className="themed-stroke" strokeWidth="6"/>
  </svg>
);

const PastillasIcon = ({ className, ...props }) => (
  <svg xmlns="http://www.w3.org/2000/svg" width="512" height="512" viewBox="0 0 512 512" className={className} {...props}>
    <defs>
      <radialGradient id="blueGradient" cx="30%" cy="30%">
        <stop offset="0%" stopColor="#B8C5F2"/>
        <stop offset="70%" stopColor="#7B9AF7"/>
        <stop offset="100%" stopColor="#5A7BF0"/>
      </radialGradient>
      <radialGradient id="redGradient" cx="40%" cy="30%">
        <stop offset="0%" stopColor="#FF7A7A"/>
        <stop offset="100%" stopColor="#F44444"/>
      </radialGradient>
    </defs>
    <circle cx="320" cy="200" r="120" fill="url(#redGradient)" stroke="#2C3E50" className="themed-stroke" strokeWidth="12"/>
    <path d="M220 140 L380 280" stroke="#2C3E50" className="themed-stroke" strokeWidth="8" strokeLinecap="round"/>
    <path d="M240 120 L400 260" stroke="#2C3E50" className="themed-stroke" strokeWidth="6" strokeLinecap="round"/>
    <circle cx="200" cy="280" r="120" fill="url(#blueGradient)" stroke="#2C3E50" className="themed-stroke" strokeWidth="12"/>
    <line x1="90" y1="280" x2="310" y2="280" stroke="#2C3E50" className="themed-stroke" strokeWidth="10" strokeLinecap="round"/>
    <ellipse cx="150" cy="220" rx="35" ry="20" fill="#FFFFFF" opacity="0.6" transform="rotate(-30 150 220)"/>
    <circle cx="170" cy="200" r="8" fill="#FFFFFF" opacity="0.8"/>
  </svg>
);

const AjustesIcon = ({ className, ...props }) => (
  <svg xmlns="http://www.w3.org/2000/svg"
  viewBox="0 0 512 512"
  preserveAspectRatio="xMidYMid meet"
  className={className} {...props}>
    <g transform="translate(0.000000,512.000000) scale(0.100000,-0.100000)"
    className="themed-fill" stroke="none">
    <path d="M2172 5100 c-67 -41 -72 -60 -72 -300 0 -118 -5 -232 -9 -254 -15
    -62 -51 -90 -170 -131 -58 -20 -158 -61 -222 -91 -63 -30 -125 -54 -138 -54
    -43 0 -88 34 -246 191 -99 97 -171 160 -188 164 -16 4 -51 5 -79 3 l-50 -5
    -240 -239 c-132 -132 -246 -251 -254 -266 -17 -32 -18 -111 -3 -141 6 -12 83
    -94 170 -183 152 -154 179 -190 179 -236 0 -12 -26 -78 -59 -147 -32 -69 -72
    -169 -90 -222 -36 -108 -65 -145 -127 -160 -22 -4 -136 -9 -254 -9 -240 0
    -259 -5 -300 -72 -19 -31 -20 -51 -20 -388 0 -337 1 -357 20 -388 41 -67 60
    -72 300 -72 118 0 232 -5 254 -9 62 -15 91 -52 127 -160 18 -53 58 -153 90
    -222 33 -69 59 -135 59 -147 0 -46 -27 -82 -179 -236 -87 -89 -164 -171 -170
    -183 -14 -28 -14 -108 0 -136 16 -31 469 -485 501 -503 32 -17 111 -18 141 -3
    12 6 92 80 177 164 153 151 198 185 241 185 13 0 75 -24 138 -54 64 -30 164
    -71 222 -91 119 -41 155 -69 170 -131 4 -22 9 -136 9 -254 0 -240 5 -259 72
    -300 31 -19 51 -20 388 -20 337 0 357 1 388 20 67 41 72 60 72 300 0 118 5
    232 9 254 15 62 52 91 160 127 53 17 153 58 222 90 69 33 135 59 148 59 43 0
    88 -34 241 -185 85 -84 165 -158 177 -164 30 -15 109 -14 141 3 32 18 485 472
    501 503 14 28 14 108 0 136 -6 12 -80 92 -164 177 -151 153 -185 198 -185 241
    0 13 26 79 59 148 32 69 72 169 90 222 36 108 65 145 127 160 22 4 136 9 254
    9 240 0 259 5 300 72 19 31 20 51 20 388 0 337 -1 357 -20 388 -41 67 -60 72
    -300 72 -118 0 -232 5 -254 9 -62 15 -91 52 -127 160 -17 53 -58 153 -90 222
    -33 69 -59 135 -59 148 0 43 35 88 191 246 97 99 160 171 164 188 4 16 5 51 3
    79 l-5 50 -239 240 c-132 132 -252 246 -268 255 -20 10 -47 14 -88 11 l-59 -4
    -162 -161 c-160 -158 -204 -193 -248 -193 -13 0 -79 26 -148 59 -69 32 -169
    73 -222 90 -108 36 -145 65 -160 127 -4 22 -9 136 -9 254 0 240 -5 259 -72
    300 -31 19 -51 20 -388 20 -337 0 -357 -1 -388 -20z m613 -1226 c545 -90 994
    -537 1090 -1088 20 -115 20 -337 0 -452 -96 -551 -538 -992 -1090 -1089 -117
    -20 -333 -20 -450 0 -484 85 -884 430 -1040 898 -47 142 -65 255 -65 417 0
    162 18 275 65 417 210 629 835 1005 1490 897z"/>
    <path d="M2930 2994 c-14 -9 -136 -127 -272 -263 l-248 -246 -97 96 c-125 123
    -135 129 -203 129 -62 0 -100 -20 -131 -66 -24 -37 -26 -129 -3 -164 25 -37
    293 -307 338 -341 32 -24 49 -29 96 -29 47 0 64 5 96 29 46 34 614 605 638
    641 10 15 16 45 16 80 0 62 -20 100 -66 131 -37 24 -129 26 -164 3z"/>
    </g>
  </svg>
);

    // ====================== Gestión de Datos de Usuario ======================
  function useUsers(){ 
        const [users,setUsers]=useLocalStorage(USERS_KEY,[]); 
        const [current,setCurrent]=useLocalStorage(CURRENT_KEY,null); 
        const saveUser=(data, autoLogin=true, isImport=false)=>{
            // AÑADIMOS UN ID ÚNICO A CADA PERFIL SI NO LO TIENE
            // Esto asegura que tanto los nuevos usuarios como los importados tengan un identificador.
            if (!data.profile.id) {
                data.profile.id = `user_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            }
            const safeData = {
                ...data,
                profile: {
                    ...data.profile,
                    medication: { name: '', dose: '', startDate: null, frequency: null, ...data.profile.medication },
                    medication2: { name: '', dose: '', startDate: null, frequency: null, ...data.profile.medication2 }
                },
                events: data.events || []
            };
            if (isImport) {
                const next = [...users, safeData];
                setUsers(next);
                if(autoLogin) setCurrent(safeData);
                return;
            }
            // La lógica de actualización ahora buscará por ID si existe, si no, por nombre (para perfiles antiguos)
            const idx = users.findIndex(u => (safeData.profile.id && u.profile.id === safeData.profile.id) || (!safeData.profile.id && u.profile.name === safeData.profile.name)); 
            const next = [...users]; 
            if(idx>=0) next[idx]=safeData; else next.push(safeData); 
            setUsers(next); 
            if(autoLogin) setCurrent(safeData); 
        }; 
        // MODIFICAMOS removeUser PARA QUE ACEPTE UN ID
        const removeUser=(userId)=>{ 
            const next = users.filter(u=>u.profile.id !== userId); 
            setUsers(next); 
            if(current?.profile.id === userId) setCurrent(null) 
        }; 
        return {users,current, setCurrent, saveUser, removeUser}; 
    }
    // ====================== Componentes de Login y PIN ======================
    const LoginHeader = () => (<div className="p-3 bg-white dark:bg-gray-700 rounded-t-2xl border-b-2 border-gray-300 dark:border-gray-600 relative overflow-hidden"><div className="absolute inset-0 bg-gradient-to-l from-blue-300 dark:from-blue-900 from-30% to-transparent pointer-events-none"></div><h2 className="text-2xl font-bold text-center text-gray-800 dark:text-white relative z-10">ControlaTuPeso+</h2></div>);
        const PinPrompt = ({ open, title, message, onCancel, onValidate, onForgotPassword }) => {
        const [pin, setPin] = React.useState('');
        if (!open) return null;
        return (
            <Modal open={open} onClose={onCancel} customHeader={<LoginHeader/>}>
                <div className="p-6 text-center">
                    <h3 className="text-lg font-semibold text-gray-800 dark:text-white">{title}</h3>
                    <p className="text-white dark:text-gray-300 mt-1">{message}</p>
                    <input type="password" value={pin} onChange={(e) => setPin(e.target.value.replace(/[^0-9]/g, '').slice(0, 4))} maxLength="4" className="mt-4 w-32 text-center text-2xl tracking-[.5em] p-2 rounded-lg border-2 border-gray-400 focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-800 dark:text-white dark:border-gray-500" autoFocus />
                    <div className="mt-6 flex justify-between items-center">
                        <Button variant="secondary" onClick={onCancel}>Cancelar</Button>
                        <a href="#" onClick={(e)=>{e.preventDefault(); onForgotPassword();}} className="text-sm text-black hover:underline dark:text-blue-400">¿Olvidaste tu PIN?</a>
                        <Button onClick={() => onValidate(pin)} disabled={pin.length !== 4}>Confirmar</Button>
                    </div>
                </div>
            </Modal>
        );
    };
    const PinRecoveryModal = ({ open, user, onClose, onRecovered }) => {
        const [formData, setFormData] = React.useState({ initial: '', target: '' });
        const handleChange = (key, value) => {
            setFormData(s => ({ ...s, [key]: value }));
        };
        const recoverPin = () => {
            const initialMatch = parseFloat(formData.initial) === user.profile.startWeight;
            const targetMatch = parseFloat(formData.target) === user.profile.targetWeight;
            if (initialMatch && targetMatch) {
                alert(`¡Datos correctos!
El PIN para ${user.profile.name} es: ${user.profile.pin}`);
                onRecovered();
            } else {
                alert('Los datos introducidos no coinciden con los del perfil. Inténtalo de nuevo.');
            }
        };
        if (!open) return null;
        return (
            <Modal open={open} onClose={onClose} customHeader={<LoginHeader/>}>
                <div className="p-6 space-y-4">
                    <h3 className="text-lg font-semibold text-gray-800 dark:text-white text-center">Recuperación de PIN</h3>
                    <p className="text-gray-600 dark:text-gray-300 mt-1 text-center">Para verificar tu identidad, responde a las siguientes preguntas.</p>
                    <Input label="¿Qué peso inicial (kg) registraste?" type="number" step="0.1" value={formData.initial} onChange={(e) => handleChange('initial', e.target.value)} autoFocus />
                    <Input label="¿Cuál es tu peso objetivo (kg)?" type="number" step="0.1" value={formData.target} onChange={(e) => handleChange('target', e.target.value)} />
                    <div className="mt-6 flex justify-end gap-2">
                        <Button variant="secondary" onClick={onClose}>Cancelar</Button>
                        <Button onClick={recoverPin} disabled={!formData.initial || !formData.target}>Verificar y Recuperar</Button>
                    </div>
                </div>
            </Modal>
        );
    };
    // ====================== Componentes de Onboarding y Selección de Usuario ======================
    const ImportUserModal = ({open,onClose,onImport})=>{ const input=React.useRef(null); const handle=(file)=>{ if(!file) return; const reader = new FileReader(); reader.onload=(e)=>{ try{ const data=JSON.parse(e.target.result); if(!data.profile?.name || !data.profile.pin) throw new Error(); data.entries = Array.isArray(data.entries)?data.entries:[]; data.events = Array.isArray(data.events)?data.events:[]; if(!data.profile.createdAt) data.profile.createdAt=new Date().toISOString(); onImport(data); }catch{ alert('Archivo JSON inválido.'); } }; reader.readAsText(file); }; return (<Modal open={open} onClose={onClose} customHeader={<LoginHeader/>}><div className="p-4"><h3 className="text-lg font-semibold text-gray-800 dark:text-white text-center mb-4">Importar usuario desde JSON</h3><div className="rounded-lg border-2 border-dashed border-gray-400 p-8 text-center space-y-3"><p className="text-lg text-gray-800 dark:text-white">Arrastra tu archivo aquí</p><p className="text-sm text-gray-500 dark:text-gray-300">o selecciona desde el explorador</p><Button variant="outline" onClick={()=>input.current.click()}>Seleccionar archivo</Button><input ref={input} type="file" accept=".json,application/json" className="hidden" onChange={(e)=>handle(e.target.files[0])}/></div><div className="mt-4 flex justify-end"><Button variant="secondary" onClick={onClose}>Cancelar</Button></div></div></Modal>); };
const UserSelect = ({users,onChoose,onCreate,onImport, onDelete})=>{ return (<div className="min-h-screen flex flex-col items-center justify-center p-4"><Modal open={true} onClose={()=>{}} size="lg" customHeader={<LoginHeader/>}><div className="p-4"><h3 className="text-lg font-semibold text-gray-800 dark:text-white text-center mb-4">Seleccionar usuario</h3><div className="grid grid-cols-1 md:grid-cols-2 gap-4">{users.map((u)=>(<Card key={u.profile.id || u.profile.name} className="cursor-pointer hover:shadow-lg transition" onClick={()=>onChoose(u)}><div className="flex items-start justify-between"><h4 className="text-lg font-semibold text-gray-800 dark:text-white">{u.profile.name}</h4><button className="text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300 text-3xl leading-none" onClick={(e)=>{e.stopPropagation(); onDelete(u.profile.id)}} title="Eliminar">🗑</button></div><p className="text-sm !text-gray-600 dark:!text-gray-300 mt-1">Registros: {u.entries?.length||0}</p></Card>))}</div><div className="mt-4 flex flex-wrap gap-3 justify-end"><Button onClick={onCreate}>Crear nuevo usuario</Button><Button variant="outline" onClick={onImport}>Importar desde JSON</Button></div></div></Modal></div>);};
// ====================== INICIO DEL CÓDIGO ACTUALIZADO PARA ONBOARDING ======================
const Onboarding = ({onDone,onCancel})=>{
    const [form,setForm]=React.useState({name:'', age:'', biology: 'hombre', height:'', startWeight:'', targetWeight:'', pin:'', pin2:'', med1_name:'', med1_dose:'', med1_start:'', med1_freq: '', med2_name:'', med2_dose:'', med2_start:'', med2_freq:'' });
    const change = (k,v)=>setForm(s=>({...s,[k]:v}));
const handlePhotoChange = (e) => {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onloadend = () => {
            change('photo', reader.result); // Guardamos la imagen como un string base64
        };
        reader.readAsDataURL(file);
    }
};
    const submit=()=>{
        if(!form.name.trim() || !form.startWeight || !form.targetWeight || form.pin.length!==4 || form.pin!==form.pin2) return alert('Por favor, completa todos los campos requeridos y asegúrate de que los PIN coincidan.');
        const data = {
            profile:{
                name:form.name.trim(),
                age:parseInt(form.age||'0'),
                biology: form.biology,
                height:parseInt(form.height||'0'),
                startWeight:parseFloat(form.startWeight),
                targetWeight:parseFloat(form.targetWeight),
                pin:form.pin,
                createdAt:new Date().toISOString(),
                processStartDate:new Date().toISOString(),
                medication:{name:form.med1_name||'', dose:form.med1_dose||'', startDate:form.med1_start||null, frequency: parseInt(form.med1_freq) || null},
                medication2:{name:form.med2_name||'', dose:form.med2_dose||'', startDate:form.med2_start||null, frequency: parseInt(form.med2_freq) || null}
            },
            entries:[],
            events: [],
            measurements: []
        };
        onDone(data);
    };
    return (
    <div className="min-h-screen flex flex-col items-center justify-center p-4">
            <Modal open={true} onClose={onCancel} size="lg" customHeader={<LoginHeader/>}>
                <div className="p-4 space-y-4">
                    <div>
                        <h4 className="font-semibold mb-2 text-gray-800 dark:text-white">Datos Personales y de Acceso</h4>
                        <div className="grid grid-cols-2 md:grid-cols-3 gap-3 border-t-2 pt-3 dark:border-gray-600">
                            <Input containerClassName="col-span-2 md:col-span-1" label="Nombre" value={form.name} onChange={(e)=>change('name',e.target.value)}/>
                            <Input containerClassName="col-span-1" label="Edad" type="number" value={form.age} onChange={(e)=>change('age',e.target.value)}/>
                            <Select containerClassName="col-span-1" label="Biología" options={[{value:'hombre', label:'Hombre'}, {value:'mujer', label:'Mujer'}]} value={form.biology} onChange={e=>change('biology', e.target.value)}/>
                            <Input containerClassName="col-span-1" label="Altura (cm)" type="number" value={form.height} onChange={(e)=>change('height',e.target.value)}/>
                            <Input containerClassName="col-span-1" label="Peso inicial (kg)" type="number" step="0.1" value={form.startWeight} onChange={(e)=>change('startWeight',e.target.value)}/>
                            <Input containerClassName="col-span-2 md:col-span-1" label="Peso objetivo (kg)" type="number" step="0.1" value={form.targetWeight} onChange={(e)=>change('targetWeight',e.target.value)}/>
                            <Input containerClassName="md:col-span-1" label="PIN (4 dígitos)" type="password" maxLength={4} value={form.pin} onChange={(e)=>change('pin',e.target.value.replace(/[^0-9]/g,''))}/>
                            <Input containerClassName="md:col-span-2" label="Confirmar PIN" type="password" maxLength={4} value={form.pin2} onChange={(e)=>change('pin2',e.target.value.replace(/[^0-9]/g,''))}/>
                        </div>
                    </div>
                    <div>
                        <h4 className="font-semibold mb-2 text-gray-800 dark:text-white">Medicación (Opcional)</h4>
                        <div className="space-y-3 border-t-2 pt-3 dark:border-gray-600">
                            <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                                <Input label="Medicación 1" value={form.med1_name} onChange={(e)=>change('med1_name',e.target.value)}/>
                                <Input label="Dosis 1" value={form.med1_dose} onChange={(e)=>change('med1_dose',e.target.value)}/>
                                <CustomDateInput label="Día de inicio" value={form.med1_start} onChange={(e)=>change('med1_start', e.target.value)}/>
                                <Input type="number" label="Cada ___ días" value={form.med1_freq} onChange={(e)=>change('med1_freq', e.target.value)}/>
                            </div>
                            <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                                <Input label="Medicación 2" value={form.med2_name} onChange={(e)=>change('med2_name',e.target.value)}/>
                                <Input label="Dosis 2" value={form.med2_dose} onChange={(e)=>change('med2_dose',e.target.value)}/>
                                <CustomDateInput label="Día de inicio" value={form.med2_start} onChange={(e)=>change('med2_start', e.target.value)}/>
                                <Input type="number" label="Cada ___ días" value={form.med2_freq} onChange={(e)=>change('med2_freq', e.target.value)}/>
                            </div>
                        </div>
                    </div>
                    <div className="mt-4 flex justify-between">
                        <Button variant="secondary" onClick={onCancel}>Cancelar</Button>
                        <Button onClick={submit}>Crear</Button>
                    </div>
                </div>
            </Modal>
        </div>
    );
};
// ====================== FIN DEL CÓDIGO ACTUALIZADO PARA ONBOARDING ======================
    // --- Componentes de la App Principal ---
// ====================== INICIO DEL CÓDIGO ACTUALIZADO PARA EVENTMODAL ======================
const EventModal = ({ open, onClose, date, onSave, onDelete, existingEvent, eventType }) => {
  const [type, setType] = React.useState(eventType || 'especial');
  const [frequency, setFrequency] = React.useState('unico');
  const [message, setMessage] = React.useState('');
  React.useEffect(() => {
    if (open) {
      if (existingEvent) {
        setType(existingEvent.type || 'especial');
        setFrequency(existingEvent.frequency || 'unico');
        setMessage((existingEvent && existingEvent.message && String(existingEvent.message).trim() !== '') ? existingEvent.message : '....');
      } else {
        setType(eventType || 'especial');
        setFrequency('unico');
        setMessage('');
      }
    }
  }, [existingEvent, open, eventType]);
  const handleSubmit = () => {
    const eventData = {
      id: existingEvent ? existingEvent.id : Date.now(),
      date: date,
      type: type,
      frequency: frequency,
      message: (message && message.trim() ? message : '....')
    };
    onSave(eventData);
    onClose();
  };
  const handleDelete = () => {
      onDelete(existingEvent.id);
      onClose();
  };
  const eventOptions = [
    { value: 'especial', label: 'Día especial', icon: <StarIcon className="w-6 h-6"/> },
    { value: 'medico', label: 'Visita Médica', icon: <MedicalVisitIcon className="w-6 h-6"/> },
    { value: 'analisis', label: 'Control/análisis', icon: <AnalysisIcon className="w-6 h-6"/> },
    { value: 'bebida', label: 'Batido/infusión', icon: <DrinkIcon className="w-6 h-6"/> }
  ];
  const placeholderText = React.useMemo(() => {
      switch(type) {
          case 'especial': return 'ej: cumpleaños, cena especial, viaje...';
          case 'medico': return 'ej: lugar y hora...';
          case 'analisis': return 'ej: medición corporal, lugar y hora....';
          default: return 'Añadir una nota (opcional)...';
      }
  }, [type]);
  return (
    <Modal open={open} onClose={onClose} size="md">
<AppModalHeader title={`${existingEvent ? 'Editar Evento' : 'Añadir Evento'} del ${new Date(date + 'T00:00:00').toLocaleDateString('es-ES', { day: '2-digit', month: 'long' })}`} onClose={onClose} />
      <div className="p-4 space-y-4">
        <div>
          <label className="text-sm font-medium text-gray-700 dark:text-gray-300">Tipo de Evento</label>
<div className="grid grid-cols-2 gap-2 mt-1">
  {eventOptions.map(opt => (
    <button key={opt.value} onClick={() => setType(opt.value)} className={`flex items-center gap-3 p-3 rounded-lg border-2 transition ${type === opt.value ? 'bg-blue-100 dark:bg-blue-900 border-blue-500' : 'bg-gray-50 dark:bg-gray-800 border-gray-400 dark:border-gray-600'}`}>
      <span className="text-gray-800 dark:text-gray-100">
        {opt.icon}
      </span>
      <span className="font-semibold text-gray-800 dark:text-gray-100">{opt.label}</span>
    </button>
  ))}
</div>
        </div>
        <Select label="Frecuencia del Evento" value={frequency} onChange={e => setFrequency(e.target.value)}
          options={[
            { value: 'unico', label: 'Evento único' },
            { value: 'diario', label: 'Diario' },
            { value: 'semanal', label: 'Semanal' },
            { value: 'quincenal', label: 'Quincenal' },
            { value: 'mensual', label: 'Mensual' },
          ]}
        />
        <div>
            <label className="text-sm font-medium text-gray-700 dark:text-gray-300">Mensaje de Evento</label>
            <textarea
                value={message}
                onChange={(e) => setMessage(e.target.value)}
                placeholder={placeholderText}
                rows="3"
                className="mt-1 w-full px-3 py-2 rounded-lg border-2 border-gray-400 focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-800 dark:text-white dark:border-gray-500"
            />
            <p className="text-xs text-gray-500 dark:text-gray-400 mt-2">
              Si deseas eliminar o modificar un evento ya registrado, selecciona el evento en el calendario con doble click.
            </p>

        </div>
        <div className="flex justify-between items-center gap-2 pt-2">
          {existingEvent ? <Button variant="danger" onClick={handleDelete} type="button">Eliminar</Button> : <div/>}
          <div className="flex gap-2">
            <Button variant="secondary" onClick={onClose}>Cancelar</Button>
            <Button onClick={handleSubmit}>Guardar</Button>
          </div>
        </div>
      </div>
    </Modal>
  );
};
// ====================== FIN DEL CÓDIGO ACTUALIZADO PARA EVENTMODAL ======================
// CÓDIGO CORREGIDO
const IconSelectionModal = ({ open, onClose, onSelect, title, exerciseType }) => {
  if (!open) return null;
    // NUEVO: Ahora cada icono sabe si es aeróbico o no
    const icons = [
    { name: 'anaerobico', Comp: AnaerobicIcon, isAerobic: false }, 
    { name: 'aerobico_class', Comp: AerobicsClassIcon, isAerobic: true },
    { name: 'bicycle', Comp: BicycleIcon, isAerobic: true }, 
    { name: 'swimming', Comp: SwimIcon, isAerobic: true },
    { name: 'basketball', Comp: BasketballIcon, isAerobic: true }, 
    { name: 'soccer', Comp: SoccerIcon, isAerobic: true },
    { name: 'handball', Comp: HandballIcon, isAerobic: true }, 
    { name: 'yoga', Comp: YogaIcon, isAerobic: true }, // Marcado como aeróbico para el color
    { name: 'martial_arts', Comp: MartialArtsIcon, isAerobic: false } // Marcado como anaeróbico para el color
  ];
  return (
    <Modal open={open} onClose={onClose} size="md">
      {/* NUEVO: Contenedor relativo para el botón de cierre */}
      <div className="relative p-4 border-b-2 dark:border-gray-600">
        <h3 className="text-lg font-semibold text-center text-gray-800 dark:text-white">{title}</h3>
        {/* NUEVO: El botón de cierre (X) */}
        <button 
          onClick={onClose} 
          className="absolute top-2 right-2 p-1 text-white hover:text-gray-300 transition-colors"
          aria-label="Cerrar modal"
        >
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        </button>
      </div>
      <div className="p-4 grid grid-cols-3 gap-4">
        {icons.map((icon) => (
          <button key={icon.name} onClick={() => onSelect(icon.name)} className="flex items-center justify-center p-4 rounded-lg border-2 border-gray-400 dark:border-gray-600 hover:bg-blue-100 dark:hover:bg-blue-900 hover:border-blue-500 transition">
            {/* NUEVO: Se aplica la clase correcta según 'isAerobic' */}
            <icon.Comp className={`w-12 h-12 ${exerciseType === 'aerobico' ? 'aerobic-icon-themed' : 'anaerobic-icon-themed'}`} />
          </button>
        ))}
      </div>
    </Modal>
  );
};

const ExerciseTypeModal = ({ open, onClose, onSelect, currentValue }) => {
  if (!open) return null;

  return (
    <Modal open={open} onClose={onClose} size="md">
      {/* SECCIÓN MODIFICADA */}
{/* CAMBIO: El div contenedor ahora centra su contenido con flexbox */}
<div className="relative p-4 border-b-2 dark:border-gray-600 flex items-center justify-center">
  {/* El degradado sigue igual */}
  <div className="absolute inset-0 bg-gradient-to-l from-blue-200/50 dark:from-blue-800/50 to-transparent pointer-events-none z-0"></div>
  
  {/* El título se centra gracias al contenedor flex */}
  <h3 className="relative z-10 text-lg font-semibold text-center text-gray-800 dark:text-white">Selecciona el Tipo de Ejercicio</h3>
  
  {/* CAMBIO CLAVE: El botón ahora se posiciona absolutamente en la esquina, centrado verticalmente */}
  <button 
    onClick={onClose} 
    className="absolute top-1/2 right-4 -translate-y-1/2 p-1 text-white hover:text-gray-300 transition-colors z-20"
    aria-label="Cerrar modal"
  >
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
  </button>
</div>
      {/* FIN DE LA SECCIÓN MODIFICADA */}

      <div className="p-4 space-y-2">
        {EXERCISE_TYPE.map(opt => (
          <button 
            key={opt.value} 
            onClick={() => onSelect(opt.value)}
            className={`w-full flex flex-col items-center p-3 rounded-lg border-2 transition ${currentValue === opt.value ? 'bg-blue-100 dark:bg-blue-900 border-blue-500' : 'bg-gray-50 dark:bg-gray-800 border-gray-400 dark:border-gray-600 hover:border-gray-500 dark:hover:border-gray-400'}`}
          >
            <p className="font-semibold text-gray-800 dark:text-gray-100 text-center">{opt.label}</p>
            {opt.description && (
              <p className="text-sm text-gray-600 dark:text-gray-300 mt-1 text-center">{opt.description}</p>
            )}
          </button>
        ))}
      </div>
    </Modal>
  );
};

    const getExerciseComponent = (entryData, className) => {
    const iconMap = {
        // Iconos específicos seleccionables
        anaerobico: AnaerobicIcon, 
        aerobico_class: AerobicsClassIcon, 
        bicycle: BicycleIcon, 
        swimming: SwimIcon, 
        basketball: BasketballIcon, 
        soccer: SoccerIcon, 
        handball: HandballIcon, 
        yoga: YogaIcon, 
        martial_arts: MartialArtsIcon,
        // Iconos genéricos por tipo de ejercicio
        fuerza: WeightlifterIcon,
        aerobico: AerobicIcon, // El corredor genérico
        paseo: WalkIcon,
        baile: DanceIcon
    };

    // 1. Elegimos el componente de icono a mostrar
    const IconComp = iconMap[entryData.exerciseIcon] || iconMap[entryData.exerciseType] || WeightlifterIcon;

    // 2. Lógica de color DEFINITIVA:
    //    Solo si el TIPO de ejercicio es 'aerobico', usamos el color especial.
    //    Para CUALQUIER otro tipo, usamos el color normal (negro/blanco).
    const themeClass = entryData.exerciseType === 'aerobico'
        ? 'aerobic-icon-themed'
        : 'anaerobic-icon-themed';

    // 3. Devolvemos el icono con sus clases correctas.
    return IconComp ? <IconComp className={`${className} ${themeClass}`} /> : null;
};

const DayModal = ({open, onClose, date, data, onSave, onDelete, onOpenEventModal})=>{
  // Estilo estándar para todos los campos del modal.
  const fieldStyles = "bg-gray-50 dark:bg-gray-700 text-black dark:text-white border border-black dark:border-white";
  
  const [form,setForm]=React.useState({weight:'', glucose:'', exercises: [], sleep:'7h', fasting:'0h', diet:'correcta', water:'1.5L', meditationTime: '0min', dailySteps: ''});
  const [isExerciseWizardOpen, setIsExerciseWizardOpen] = React.useState(false);
  const [detailModal, setDetailModal] = React.useState({ open: false, exercise: null, index: -1 });
  const [editingExerciseIndex, setEditingExerciseIndex] = React.useState(null);

  const [showConverter, setShowConverter] = React.useState(false);
  const [mmolValue, setMmolValue] = React.useState('');
  const isExistingEntry = React.useMemo(() => data.entries.some(e => e.date === date), [open, date, data.entries]);
  const modalRef = React.useRef(null);

   React.useEffect(() => {
    if (showConverter) {
        const timer = setTimeout(() => {
            setShowConverter(false);
        }, 8000);
        return () => clearTimeout(timer);
    }
  }, [showConverter]);

  React.useEffect(()=>{
    if(!open || !date) return;
    setShowConverter(false);
    setMmolValue('');
    const sameDay = data.entries.find(e=>e.date===date);
    
    const getValidExercises = (entry) => {
        if (entry && Array.isArray(entry.exercises)) {
            return entry.exercises;
        }
        if (entry && entry.exerciseTime && entry.exerciseTime !== '0min') {
            return [{
                exerciseTime: entry.exerciseTime,
                exerciseType: entry.exerciseType || 'fuerza',
                exerciseIntensity: entry.exerciseIntensity || 'normal',
                exerciseIcon: entry.exerciseIcon || ''
            }];
        }
        return [];
    };

    if (sameDay) {
        setForm({
            weight: sameDay.weight ?? '',
            glucose: sameDay.glucose ?? '',
            exercises: getValidExercises(sameDay),
            sleep: sameDay.sleep || '7h',
            fasting: sameDay.fasting || '0h',
            diet: sameDay.diet || 'correcta',
            water: sameDay.water || '1.5L',
            meditationTime: sameDay.meditationTime || '0min',
            dailySteps: sameDay.dailySteps ?? ''
        });
    } else {
        const yesterday = new Date(new Date(date + 'T00:00:00').setDate(new Date(date + 'T00:00:00').getDate() - 1));
        const prevDay = data.entries
            .filter(e => new Date(e.date + 'T00:00:00') <= yesterday)
            .sort((a, b) => new Date(b.date) - new Date(a.date))[0];
        
        setForm({
            weight: prevDay?.weight ?? '',
            glucose: prevDay?.glucose ?? '',
            exercises: getValidExercises(prevDay),
            sleep: prevDay?.sleep || '7h',
            fasting: prevDay?.fasting || '0h',
            diet: prevDay?.diet || 'correcta',
            water: prevDay?.water || '1.5L',
            meditationTime: prevDay?.meditationTime || '0min',
            dailySteps: prevDay?.dailySteps ?? ''
        });
    }
}, [open, date, data]);

  const change=(k,v)=>setForm(s=>({...s,[k]:v}));
  
  const submit=(e)=>{ 
    e.preventDefault(); 
    const { exerciseTime, exerciseType, exerciseIntensity, exerciseIcon, ...formDataToSave } = form;
    onSave(date,{ ...formDataToSave, weight: form.weight!=='' ? parseFloat(form.weight) : null, glucose: form.glucose!=='' ? parseFloat(form.glucose) : null, dailySteps: form.dailySteps !== '' ? parseInt(form.dailySteps) : null }); 
    onClose(); 
  };

  const handleDelete = () => { onDelete(date); onClose(); };

  const handleMmolChange = (e) => {
      const mmol = e.target.value;
      setMmolValue(mmol);
      if (mmol && !isNaN(mmol)) {
          const mgdl = Math.round(parseFloat(mmol) * 18.018 * 2) / 2;
          change('glucose', mgdl);
      } else {
          change('glucose', '');
      }
  };

  const handleAddExerciseClick = () => {
    if (form.exercises.length >= 2) {
      alert("No se pueden registrar más de dos tipos de ejercicios por día. Pero puedes modificar alguno de los ya registrados.");
    } else {
      setEditingExerciseIndex(null);
      setIsExerciseWizardOpen(true);
    }
  };

  const handleEditExercise = (index) => {
    setEditingExerciseIndex(index);
    setDetailModal({ open: false, exercise: null, index: -1 });
    setIsExerciseWizardOpen(true);
  };

  const handleDeleteExercise = (index) => {
    setForm(prev => ({
        ...prev,
        exercises: prev.exercises.filter((_, i) => i !== index)
    }));
    setDetailModal({ open: false, exercise: null, index: -1 });
  };
  
  const handleSaveExercise = (exerciseData) => {
    setForm(prev => {
        const newExercises = [...prev.exercises];
        if (editingExerciseIndex !== null) {
            newExercises[editingExerciseIndex] = exerciseData;
        } else {
            newExercises.push(exerciseData);
        }
        return { ...prev, exercises: newExercises };
    });
    setEditingExerciseIndex(null);
  };
  
  const eventOptions = [
    { value: 'especial', label: 'Día especial', icon: <StarIcon className="w-6 h-6"/> },
    { value: 'medico', label: 'Visita Médica', icon: <MedicalVisitIcon className="w-6 h-6"/> },
    { value: 'analisis', label: 'Control/análisis', icon: <AnalysisIcon className="w-6 h-6"/> },
    { value: 'bebida', label: 'Batido/Infusión', icon: <DrinkIcon className="w-6 h-6"/> }
  ];
  
  const ExerciseDisplay = ({ exercise, onClick }) => {
  const baseClasses = "w-full h-full px-2 py-1 rounded-lg border border-black dark:border-white flex items-center justify-center text-sm";
  if (!exercise || !exercise.exerciseTime || exercise.exerciseTime === '0min') {
      return (
          <div className={`${baseClasses} bg-gray-50 dark:bg-gray-700 border-dashed border-gray-400 dark:border-gray-500`}>
              <span className="text-gray-400 dark:text-gray-500">Sin registrar</span>
          </div>
      );
  }
  return (
      <button type="button" onClick={onClick} className={`${baseClasses} bg-gray-50 dark:bg-gray-700 gap-2 hover:bg-gray-100 dark:hover:bg-gray-600 transition`}>
          {getExerciseComponent(exercise, "w-8 h-8")} {/* Icono más grande */}
          <div className="flex flex-col items-start justify-center">
              <span className="text-black dark:text-gray-100 font-normal">
                {EXERCISE_TIME.find(o => o.value === exercise.exerciseTime)?.label || ''}
              </span>
              <span className="text-xs text-gray-600 dark:text-gray-400">
                {EXERCISE_INTENSITY.find(o => o.value === exercise.exerciseIntensity)?.label || ''}
              </span>
          </div>
      </button>
  );
};

  return (<>
    <Modal open={open} onClose={onClose} size="lg">
      <div ref={modalRef} onClick={() => {if(showConverter) setShowConverter(false)}}>
<AppModalHeader title={`Registro del ${new Date(date+'T00:00:00').toLocaleDateString('es-ES',{weekday:'long',day:'2-digit',month:'long'})}`} onClose={onClose} />
        <div className="p-4 day-modal">
            <form onSubmit={submit} className="space-y-4">
              <div className="grid grid-cols-2 gap-4">
                  <Input label="Peso (kg)" type="number" step="0.1" value={form.weight} onChange={(e)=>change('weight',e.target.value)} className={fieldStyles}/>
                  <div className="relative">
                    <div className="flex justify-between items-center mb-1">
                        <label className="text-sm font-medium text-black dark:text-gray-100">Glucosa</label>
                        <button type="button" onClick={(e) => {e.stopPropagation(); setShowConverter(s => !s)}} className="text-xs text-black dark:text-blue-400 hover:underline px-2 py-1 border border-black dark:border-white rounded-md">mmol/L ↔ mg/dL</button>
                    </div>
                    <div className={`relative flex items-center w-full px-3 py-2 rounded-lg ${fieldStyles.replace('text-black', '')}`}>
                        <input type="number" value={form.glucose} onChange={(e) => change('glucose', e.target.value)} className="w-full bg-transparent outline-none text-black dark:text-white" />
                        <span className="text-gray-500 dark:text-gray-400">mg/dl</span>
                    </div>
                    {showConverter && (
                      <div onClick={e => e.stopPropagation()} className="absolute top-0 left-0 w-full h-full bg-white/75 dark:bg-gray-800/80 backdrop-blur-sm p-3 rounded-lg shadow-xl z-10 border-2 border-blue-500 flex flex-col justify-start">
                        <div className="flex items-start gap-2">
                            <Input containerClassName="flex-grow" label="Glucosa (mmol/L)" type="number" step="0.1" value={mmolValue} onChange={handleMmolChange} autoFocus />
                            <Button variant="secondary" className="mt-auto border-2 border-blue-500" onClick={()=>setShowConverter(false)}>OK</Button>
                        </div>
                      </div>
                    )}
                  </div>
              </div>
              
              <div className="grid grid-cols-2 gap-4">
                  <div className="space-y-1">
                      <label className="text-base font-medium text-black dark:text-gray-200">Registro de Ejercicio</label>
                      <Button type="button" variant="outline" className={`w-full justify-center h-12 text-black dark:text-white font-normal ${fieldStyles}`} onClick={handleAddExerciseClick}>
                          Añadir Ejercicio
                      </Button>
                  </div>
                   <div className="space-y-1">
                      <label className="text-base font-medium text-black dark:text-gray-200">Tiempo - Intensidad</label>
                      <div className="grid grid-cols-2 gap-2 h-12">
                          <ExerciseDisplay 
                              exercise={form.exercises[0]} 
                              onClick={() => form.exercises[0] && setDetailModal({ open: true, exercise: form.exercises[0], index: 0 })}
                          />
                          <ExerciseDisplay 
                              exercise={form.exercises[1]}
                              onClick={() => form.exercises[1] && setDetailModal({ open: true, exercise: form.exercises[1], index: 1 })}
                          />
                      </div>
                  </div>
              </div>

              <div className="grid grid-cols-2 gap-4">
                <Select label="Consumo de agua" options={WATER} value={form.water} onChange={(e)=>change('water',e.target.value)} className={fieldStyles}/>
                <Select label="Horas de sueño" options={SLEEP} value={form.sleep} onChange={(e)=>change('sleep',e.target.value)} className={fieldStyles}/>
              </div>
              <div className="grid grid-cols-2 gap-4">
                  <Select label="Calidad de la dieta" options={DIET} value={form.diet} onChange={(e)=>change('diet',e.target.value)} className={fieldStyles}/>
                  <Select label="Tipo de ayuno" options={FASTING} value={form.fasting} onChange={(e)=>change('fasting',e.target.value)} className={fieldStyles}/>
              </div>
              <div className="grid grid-cols-2 gap-4">
                  <Select label="Meditación" options={MEDITATION_TIME} value={form.meditationTime} onChange={(e)=>change('meditationTime',e.target.value)} className={fieldStyles}/>
                  <Input label="Pasos diarios" type="number" value={form.dailySteps} onChange={(e)=>change('dailySteps',e.target.value.replace(/[^0-9]/g,''))} className={fieldStyles}/>
              </div>
              <div className="pt-4 border-t-2 dark:border-gray-600">
                <label className="text-sm font-medium text-black dark:text-gray-100 mb-2 block">Añadir o ver eventos</label>
                <div className="grid grid-cols-2 sm:grid-cols-4 gap-2">
                    {eventOptions.map(opt => (
                      <Button key={opt.value} variant="outline" type="button" onClick={() => onOpenEventModal(opt.value, null)} className={`flex-col h-20 text-black dark:text-white ${fieldStyles}`}>
                          {opt.icon}
                          <span className="text-xs text-center">{opt.label}</span>
                      </Button>
                    ))}
                </div>
              </div>
              <div className="flex justify-between items-center gap-2 pt-4">
                  {isExistingEntry ? <Button variant="danger" onClick={handleDelete} type="button" className="border border-black dark:border-white">Eliminar Registro</Button> : <div></div>}     
                  <div className="flex gap-2">
                      <Button variant="secondary" onClick={onClose} className="border border-black dark:border-white text-black dark:text-white">Cancelar</Button>
                      <Button type="submit" className="border border-black dark:border-white">Guardar</Button>
                  </div>
              </div>
            </form>
        </div>
      </div>
    </Modal>
    <ExerciseWizardModal
        open={isExerciseWizardOpen}
        onClose={() => setIsExerciseWizardOpen(false)}
        initialData={editingExerciseIndex !== null ? form.exercises[editingExerciseIndex] : { exerciseTime: '15min', exerciseType: 'fuerza', exerciseIcon: '', exerciseIntensity: 'normal' }}
        onSave={handleSaveExercise}
    />
    <ExerciseDetailModal
        open={detailModal.open}
        onClose={() => setDetailModal({ open: false, exercise: null, index: -1 })}
        exerciseData={detailModal.exercise}
        onEdit={() => handleEditExercise(detailModal.index)}
        onDelete={() => handleDeleteExercise(detailModal.index)}
    />
  </>
  );
};
const ExerciseWizardModal = ({ open, onClose, onSave, initialData }) => {
  if (!open) return null;

  // Estado para controlar el paso actual del asistente (1: Tipo, 2: Icono, 3: Tiempo/Intensidad)
  const [step, setStep] = React.useState(1);
  // Estado para almacenar los datos del ejercicio mientras el usuario los selecciona
  const [exerciseData, setExerciseData] = React.useState({
    exerciseTime: '0min',
    exerciseType: 'fuerza',
    exerciseIcon: '',
    exerciseIntensity: 'normal'
  });

  // Al abrir el modal, cargamos los datos existentes para poder editarlos
  React.useEffect(() => {
    if (open) {
      setStep(1); // Siempre empezamos por el primer paso
      setExerciseData(initialData);
    }
  }, [open, initialData]);

  const handleTypeSelect = (type) => {
    setExerciseData(prev => ({ ...prev, exerciseType: type, exerciseIcon: '' })); // Reseteamos el icono al cambiar de tipo
    if (type === 'aerobico' || type === 'anaerobico') {
      setStep(2); // Si el tipo requiere un icono, vamos al paso 2
    } else {
      setStep(3); // Si no, saltamos directamente al paso 3
    }
  };

  const handleIconSelect = (icon) => {
    setExerciseData(prev => ({ ...prev, exerciseIcon: icon }));
    setStep(3); // Después de seleccionar icono, vamos al paso 3
  };

  const handleTimeAndIntensitySave = () => {
    onSave(exerciseData); // Enviamos todos los datos guardados al DayModal
    onClose(); // Cerramos el asistente
  };

  // Renderiza el contenido del modal según el paso actual
  const renderStepContent = () => {
    switch (step) {
      case 1: // Selección de Tipo de Ejercicio
        return (
          <div className="p-4 space-y-2">
            {EXERCISE_TYPE.map(opt => (
              <button 
  key={opt.value} 
  onClick={() => handleTypeSelect(opt.value)} 
  className="w-full flex flex-col items-center justify-center p-3 rounded-lg border-2 bg-gray-50 dark:bg-gray-800 border-gray-400 dark:border-gray-600 hover:border-blue-500 dark:hover:border-blue-400 transition"
>
  <p className="font-semibold text-gray-800 dark:text-gray-100 text-center">{opt.label}</p>
  {opt.description && <p className="text-sm text-gray-600 dark:text-gray-300 mt-1 text-center">{opt.description}</p>}
</button>

            ))}
          </div>
        );
      case 2: // Selección de Icono
        const icons = [
          { name: 'anaerobico', Comp: AnaerobicIcon }, { name: 'aerobico_class', Comp: AerobicsClassIcon },
          { name: 'bicycle', Comp: BicycleIcon }, { name: 'swimming', Comp: SwimIcon },
          { name: 'basketball', Comp: BasketballIcon }, { name: 'soccer', Comp: SoccerIcon },
          { name: 'handball', Comp: HandballIcon }, { name: 'yoga', Comp: YogaIcon }, { name: 'martial_arts', Comp: MartialArtsIcon }
        ];
        return (
          <div className="p-4 grid grid-cols-3 gap-4">
            {icons.map(icon => (
              <button key={icon.name} onClick={() => handleIconSelect(icon.name)} className="flex items-center justify-center p-4 rounded-lg border-2 border-gray-400 dark:border-gray-600 hover:bg-blue-100 dark:hover:bg-blue-900 hover:border-blue-500 transition">
                <icon.Comp className={`w-12 h-12 ${exerciseData.exerciseType === 'aerobico' ? 'aerobic-icon-themed' : 'anaerobic-icon-themed'}`} />
              </button>
            ))}
          </div>
        );
      case 3: // Selección de Tiempo e Intensidad
        return (
          <div className="p-4 space-y-4">
            <Select label="Tiempo de Ejercicio" options={EXERCISE_TIME} value={exerciseData.exerciseTime} onChange={(e) => setExerciseData(prev => ({ ...prev, exerciseTime: e.target.value }))} />
            {exerciseData.exerciseTime !== '0min' && (
              <div className="space-y-2">
                <label className="text-sm font-medium text-white dark:text-gray-100">Intensidad del Ejercicio</label>
                <div className="flex gap-2">
                  {EXERCISE_INTENSITY.map(intensity => (
                    <Button key={intensity.value} type="button" variant={exerciseData.exerciseIntensity === intensity.value ? 'primary' : 'outline'} onClick={() => setExerciseData(prev => ({ ...prev, exerciseIntensity: intensity.value }))} className="flex-1">
                      {intensity.label}
                    </Button>
                  ))}
                </div>
              </div>
            )}
            <div className="flex justify-end pt-4">
                <Button onClick={handleTimeAndIntensitySave}>Guardar Ejercicio</Button>
            </div>
          </div>
        );
      default:
        return null;
    }
  };

  const getTitleForStep = () => {
    switch (step) {
      case 1: return "Selecciona el Tipo de Ejercicio";
      case 2: return `Selecciona un Icono para ${EXERCISE_TYPE.find(e => e.value === exerciseData.exerciseType)?.label}`;
      case 3: return "Define Tiempo e Intensidad";
      default: return "Registrar Ejercicio";
    }
  };

  return (
    <Modal open={open} onClose={onClose} size="md">
      {/* SECCIÓN MODIFICADA */}
{/* CAMBIO: El div contenedor ahora centra su contenido con flexbox */}
<div className="relative p-4 border-b-2 dark:border-gray-600 flex items-center justify-center">
<div className="absolute inset-0 bg-gradient-to-l from-blue-200/100 dark:from-blue-800/55 to-transparent pointer-events-none z-0"></div>
  {step > 1 && <button onClick={() => setStep(prev => prev - 1)} className="absolute top-1/2 left-4 -translate-y-1/2 text-white hover:text-gray-300 z-20">←</button>}
  <h3 className="relative z-10 text-lg font-semibold text-center text-gray-800 dark:text-white">{getTitleForStep()}</h3>
  <button onClick={onClose} className="absolute top-1/2 right-4 -translate-y-1/2 p-1 text-white hover:text-gray-300 transition-colors z-20" aria-label="Cerrar modal">
     <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
  </button>
</div>
      {/* FIN DE LA SECCIÓN MODIFICADA */}
      {renderStepContent()}
    </Modal>
  );
};

const ExerciseDetailModal = ({ open, onClose, onEdit, onDelete, exerciseData }) => {
    if (!open || !exerciseData) return null;

    const { exerciseTime, exerciseType, exerciseIntensity } = exerciseData;

    const typeLabel = EXERCISE_TYPE.find(opt => opt.value === exerciseType)?.label || 'Ejercicio';
    const timeLabel = EXERCISE_TIME.find(opt => opt.value === exerciseTime)?.label || '';
    const intensityLabel = EXERCISE_INTENSITY.find(opt => opt.value === exerciseIntensity)?.label || '';

    return (
        <Modal open={open} onClose={onClose} size="sm">
<AppModalHeader title="Detalle del Ejercicio" onClose={onClose} />
            <div className="p-4 space-y-4">
                <Card className="flex flex-col items-center justify-center p-4 text-center ExerciseDetailModal-text-fix">
                    {getExerciseComponent(exerciseData, "w-16 h-16 mb-2")}
                    {/* ESTAS SON LAS LÍNEAS CORREGIDAS PARA EL TEXTO */}
                    <p className="text-xl font-bold text-black dark:text-white !text-black">{typeLabel}</p>
                    <p className="text-lg text-gray-800 dark:text-gray-300 !text-gray-800">{timeLabel} - {intensityLabel}</p>
                </Card>
                <div className="flex justify-between items-center gap-2 pt-2">
                    <Button variant="danger" onClick={onDelete} className="text-white !important">Borrar</Button>
                    <div className="flex gap-2">
                        <Button variant="secondary" onClick={onClose}>Cancelar</Button>
                        <Button variant="primary" onClick={onEdit} className="text-white !important">Editar</Button>
                    </div>
                </div>
            </div>
        </Modal>
    );
};
// ====================== INICIO DE LOS NUEVOS COMPONENTES DE MEDIDAS ======================
const MeasurementChoiceModal = ({ open, onClose, onSelect }) => {
    if (!open) return null;
    return (
        <Modal open={open} onClose={onClose} size="sm">
<AppModalHeader title="Gestión de Medidas Corporales" onClose={onClose} />
            <div className="p-6 flex flex-col space-y-4">
                <Button onClick={() => onSelect('add')} variant="primary" className="w-full">Introducir Medidas Nuevas</Button>
                <Button onClick={() => onSelect('view')} variant="secondary" className="w-full">Ver Medidas Registradas</Button>
            </div>
        </Modal>
    );
};

// ====================== INICIO DEL CÓDIGO ACTUALIZADO PARA AddMeasurementModal ======================
const AddMeasurementModal = ({ open, onClose, onSave, existingMeasurement }) => {
    const [form, setForm] = React.useState({
        id: null, date: fmt(new Date()), type: 'circunferencia',
        cuello: '', muslos: '', cadera: '', cintura: '', pecho: '', brazo: '', photo: null
    });

    const change = (k, v) => setForm(s => ({ ...s, [k]: v }));

    // FUNCIÓN CLAVE MEJORADA: Ahora comprime la imagen
    const handleFileSelect = (file) => {
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
                // --- Lógica de compresión ---
                const canvas = document.createElement('canvas');
                const MAX_WIDTH = 1024; // Resolución máxima, más que suficiente
                const MAX_HEIGHT = 1024;
                let width = img.width;
                let height = img.height;

                if (width > height) {
                    if (width > MAX_WIDTH) {
                        height *= MAX_WIDTH / width;
                        width = MAX_WIDTH;
                    }
                } else {
                    if (height > MAX_HEIGHT) {
                        width *= MAX_HEIGHT / height;
                        height = MAX_HEIGHT;
                    }
                }
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);

                // Convertimos a JPEG con calidad del 80% para un tamaño mucho menor
                const compressedBase64 = canvas.toDataURL('image/jpeg', 0.8);
                change('photo', compressedBase64);
                // --- Fin de la lógica de compresión ---
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    };

    React.useEffect(() => {
        if (open) {
            if (existingMeasurement) {
                setForm({
                    id: existingMeasurement.id, date: existingMeasurement.date, type: existingMeasurement.type || 'circunferencia',
                    cuello: existingMeasurement.cuello ?? '', muslos: existingMeasurement.muslos ?? '',
                    cadera: existingMeasurement.cadera ?? '', cintura: existingMeasurement.cintura ?? '',
                    pecho: existingMeasurement.pecho ?? '', brazo: existingMeasurement.brazo ?? '',
                    photo: existingMeasurement.photo ?? null
                });
            } else {
                setForm({
                    id: Date.now(), date: fmt(new Date()), type: 'circunferencia',
                    cuello: '', muslos: '', cadera: '', cintura: '', pecho: '', brazo: '',
                    photo: null
                });
            }
        }
    }, [open, existingMeasurement]);
    
    const handleSubmit = (e) => {
        e.preventDefault();
        const numericData = {
            cuello: form.cuello !== '' ? parseFloat(form.cuello) : null,
            muslos: form.muslos !== '' ? parseFloat(form.muslos) : null,
            cadera: form.cadera !== '' ? parseFloat(form.cadera) : null,
            cintura: form.cintura !== '' ? parseFloat(form.cintura) : null,
            pecho: form.pecho !== '' ? parseFloat(form.pecho) : null,
            brazo: form.brazo !== '' ? parseFloat(form.brazo) : null,
        };
        onSave({ ...form, ...numericData });
        onClose();
    };

    return (
        <Modal open={open} onClose={onClose} size="lg">
<AppModalHeader title={existingMeasurement ? "Editar Medida" : "Introducir Medidas Corporales"} onClose={onClose} />
            <form onSubmit={handleSubmit} className="p-4 space-y-4">
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <CustomDateInput label="Fecha de la Medición" value={form.date} onChange={(e) => change('date', e.target.value)} />
                    <Select label="Tipo de Medición" options={[{value: 'circunferencia', label: 'Circunferencia Corporal (cm)'}, {value: 'pliegues', label: 'Pliegues Cutáneos (mm)'}]} value={form.type} onChange={(e) => change('type', e.target.value)} />
                </div>
                <div className="grid grid-cols-2 md:grid-cols-3 gap-4 border-t-2 dark:border-gray-600 pt-4">
                    <Input label="Cuello" type="number" step="0.1" value={form.cuello} onChange={(e) => change('cuello', e.target.value)} />
                    <Input label="Muslos" type="number" step="0.1" value={form.muslos} onChange={(e) => change('muslos', e.target.value)} />
                    <Input label="Cadera" type="number" step="0.1" value={form.cadera} onChange={(e) => change('cadera', e.target.value)} />
                    <Input label="Cintura" type="number" step="0.1" value={form.cintura} onChange={(e) => change('cintura', e.target.value)} />
                    <Input label="Pecho" type="number" step="0.1" value={form.pecho} onChange={(e) => change('pecho', e.target.value)} />
                    <Input label="Brazo" type="number" step="0.1" value={form.brazo} onChange={(e) => change('brazo', e.target.value)} />
                </div>
                <div className="space-y-4 pt-4 border-t-2 dark:border-gray-600">
                    <label className="text-sm font-medium text-gray-700 dark:text-gray-300">Foto del día (opcional)</label>
                    <div className="flex flex-wrap gap-3">
                        {/* Botón para abrir la cámara */}
                        <Button variant="outline" type="button" onClick={() => document.getElementById('camera-upload').click()}>
                            <div className="flex items-center gap-2"><CameraIcon className="w-6 h-6" /><span>Hacer Foto</span></div>
                        </Button>
                        {/* Botón para abrir la galería */}
                        <Button variant="outline" type="button" onClick={() => document.getElementById('gallery-upload').click()}>
                           <div className="flex items-center gap-2"><span>Elegir de Galería</span></div>
                        </Button>
                        
                        {/* Inputs ocultos que hacen la magia */}
                        <input id="camera-upload" type="file" accept="image/*" capture="environment" className="hidden" onChange={(e) => handleFileSelect(e.target.files[0])} />
                        <input id="gallery-upload" type="file" accept="image/*" className="hidden" onChange={(e) => handleFileSelect(e.target.files[0])} />
                    </div>

                    {form.photo && (
                        <div className="relative">
                            <img src={form.photo} alt="Foto del registro" className="w-full h-48 object-cover rounded-lg border-2 border-gray-300 dark:border-gray-600" />
                            <button
                                type="button"
                                onClick={() => change('photo', null)}
                                className="absolute top-1 right-1 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs hover:bg-red-600"
                                title="Eliminar foto"
                            >
                                ✕
                            </button>
                        </div>
                    )}
                </div>
                <div className="flex justify-end gap-2 pt-4">
                    <Button type="button" variant="secondary" onClick={onClose}>Cancelar</Button>
                    <Button type="submit">Guardar Medidas</Button>
                </div>
            </form>
        </Modal>
    );
};
// ====================== CÓDIGO FINAL Y COMPLETO PARA ViewMeasurementsModal ======================
const ViewMeasurementsModal = ({ open, onClose, measurements, onEdit, onDelete, user, onDownloadPDF }) => {
    const [showPhotoId, setShowPhotoId] = React.useState(null);
    const sortedMeasurements = React.useMemo(() => {
  return (measurements || []).slice().sort((a,b) => new Date(b.date) - new Date(a.date));
}, [measurements]);

    return (
        <Modal open={open} onClose={onClose} size="lg">
<AppModalHeader title="Medidas Registradas" onClose={onClose} />
            <div className="p-4 max-h-[70vh] overflow-y-auto">
                {sortedMeasurements.length === 0 ? (
                    <p className="text-center text-gray-600 dark:text-gray-300 py-8">No hay medidas registradas todavía.</p>
                ) : (
                    <div className="space-y-3">
                        {sortedMeasurements.map(m => {
                            // Se define la unidad ('cm' o 'mm') para esta entrada
                            const unit = m.type === 'circunferencia' ? 'cm' : 'mm';
                            return (
                            <Card key={m.id} className="p-3">
{/* INICIO DEL CÓDIGO CORREGIDO - v2 */}
<div className="flex justify-between items-center gap-x-2 min-w-0">
  <div className="min-w-0">
    <p className="hidden sm:block font-bold text-gray-800 dark:text-white truncate">
      {new Date(m.date + 'T00:00:00').toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' })}
    </p>
    <p className="sm:hidden font-bold text-gray-800 dark:text-white truncate">
      {new Date(m.date + 'T00:00:00').toLocaleDateString('es-ES', { day: '2-digit', month: 'short', year: '2-digit' }).replace(/\./g, '').replace(/ /g, '-')}
    </p>
  </div>

  <div className="flex items-center gap-2 flex-nowrap">
    <Button variant="outline" onClick={() => onEdit(m)} className="flex-shrink-0 px-2 py-1 text-xs">Editar</Button>
    <Button variant="danger" onClick={() => onDelete(m.id)} className="flex-shrink-0 px-2 py-1 text-xs">Borrar</Button>
    {m.photo && (
      <Button variant="outline" onClick={() => setShowPhotoId(m.id)} className="flex-shrink-0 px-2 py-1 text-xs">
        Ver Foto
      </Button>
    )}
  </div>
</div>
{/* FIN DEL CÓDIGO CORREGIDO - v2 */}

                                <div className="grid grid-cols-3 sm:grid-cols-6 gap-2 mt-2 text-center border-t dark:border-gray-600 pt-2">
                                    {/* Las unidades se añaden dinámicamente a cada valor */}
                                    <div><p className="text-xs text-gray-600 dark:text-gray-300">Cuello</p><p className="font-semibold text-gray-800 dark:text-white">{m.cuello ? `${m.cuello} ${unit}` : '—'}</p></div>
                                    <div><p className="text-xs text-gray-600 dark:text-gray-300">Muslos</p><p className="font-semibold text-gray-800 dark:text-white">{m.muslos ? `${m.muslos} ${unit}` : '—'}</p></div>
                                    <div><p className="text-xs text-gray-600 dark:text-gray-300">Cadera</p><p className="font-semibold text-gray-800 dark:text-white">{m.cadera ? `${m.cadera} ${unit}` : '—'}</p></div>
                                    <div><p className="text-xs text-gray-600 dark:text-gray-300">Cintura</p><p className="font-semibold text-gray-800 dark:text-white">{m.cintura ? `${m.cintura} ${unit}` : '—'}</p></div>
                                    <div><p className="text-xs text-gray-600 dark:text-gray-300">Pecho</p><p className="font-semibold text-gray-800 dark:text-white">{m.pecho ? `${m.pecho} ${unit}` : '—'}</p></div>
                                    <div><p className="text-xs text-gray-600 dark:text-gray-300">Brazo</p><p className="font-semibold text-gray-800 dark:text-white">{m.brazo ? `${m.brazo} ${unit}` : '—'}</p></div>
                                </div>

                                {showPhotoId === m.id && m.photo && (
                                    <div className="mt-4 p-3 border-t-2 dark:border-gray-600">
                                        <div className="relative">
                                            <img src={m.photo} alt="Foto del registro" className="w-full h-auto max-h-80 object-contain rounded-lg border-2 border-gray-300 dark:border-gray-600" />
                                            <div className="absolute top-2 right-2 flex flex-col gap-2">
                                                <button onClick={() => setShowPhotoId(null)} className="bg-gray-300 hover:bg-gray-400 btn-cerrar text-gray-800 text-xs py-1.5 px-3 rounded font-semibold transition" title="Cerrar vista de foto">Cerrar</button>
                                                <button onClick={() => { const link = document.createElement('a'); link.href = m.photo; link.download = `foto_medida_${m.id}.jpg`; link.click(); }} className="bg-blue-600 hover:bg-blue-700 btn-descargar text-white text-xs py-1.5 px-3 rounded font-semibold transition" title="Descargar foto">Descargar</button>
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </Card>
                            )
                        })}
                    </div>
                )}
            </div>
            <div className="flex justify-between p-4 border-t-2 dark:border-gray-600">
                <Button onClick={onDownloadPDF} variant="outline">
                    📄 Descargar Medidas (PDF)
                </Button>
                <Button onClick={onClose} variant="secondary">Cerrar</Button>
            </div>
        </Modal>
    );
};
// ====================== INICIO DEL CÓDIGO FINAL Y CORRECTO PARA CALENDARVIEW ======================
const CalendarView = ({user, setUser, date, calendarRef, isActive})=>{
  const [dayModalDate, setDayModalDate] = React.useState(null);
  const [eventModal, setEventModal] = React.useState({ open: false, date: null, type: null, existing: null });
  const [selectedDay, setSelectedDay] = React.useState(null);
  const [activeTooltip, setActiveTooltip] = React.useState(null);
  const [detailModal, setDetailModal] = React.useState({ open: false, exercise: null, index: -1 });
  const [isExerciseWizardOpen, setIsExerciseWizardOpen] = React.useState(false);
  const [exerciseWizardInitialData, setExerciseWizardInitialData] = React.useState(null);
  const [exerciseWizardTargetDate, setExerciseWizardTargetDate] = React.useState(null);
  const [editingExerciseIndexCalendar, setEditingExerciseIndexCalendar] = React.useState(null);


  // INICIO DE LA NUEVA LÓGICA DE SCROLL AUTOMÁTICO
  // 1. Usamos una referencia para "capturar" el nodo DOM del día de hoy cuando React lo renderice.
  const todayRef = React.useRef(null);

  React.useEffect(() => {
    // 2. Este efecto se ejecuta cuando la pestaña se activa o cuando el nodo de "hoy" se captura.
    if (isActive && todayRef.current) {
      // 3. Pequeño retardo para que el scroll no sea brusco al cambiar de pestaña.
      setTimeout(() => {
        todayRef.current.scrollIntoView({
          behavior: 'smooth',
          block: 'center'
        });
      }, 100);
    }
  // 4. La dependencia de todayRef.current asegura que esto solo se ejecute cuando el elemento exista.
  }, [isActive, todayRef.current]);
  // FIN DE LA NUEVA LÓGICA DE SCROLL AUTOMÁTICO


  // El resto de funciones no necesitan cambios
  const handleEditExercise = (index) => {
    setDetailModal({ open: false, exercise: null, index: -1 });
  };
  
  const handleDeleteExercise = (dayStr, index) => {
      const entryIndex = user.entries.findIndex(e => e.date === dayStr);
      if (entryIndex === -1) return;
      const updatedEntries = [...user.entries];
      const updatedExercises = updatedEntries[entryIndex].exercises.filter((_, i) => i !== index);
      updatedEntries[entryIndex].exercises = updatedExercises;
      setUser({ ...user, entries: updatedEntries });
      setDetailModal({ open: false, exercise: null, index: -1 });
  };

const handleDayClick = (dayString) => {
    if (selectedDay === dayString) {
        setDayModalDate(dayString);
    } else {
        setSelectedDay(dayString);
        setActiveTooltip(null);
    }
};

  const handleExerciseIconClick = (e, dayString, exerciseData, index) => {
      e.stopPropagation();
      const uniqueId = `ex-${dayString}-${index}`;
      if (activeTooltip === uniqueId) {
          setSelectedDay(dayString);
          setDetailModal({ open: true, exercise: exerciseData, index: index, date: dayString });
          setActiveTooltip(null);
      } else {
          setActiveTooltip(uniqueId);
      }
  };
  const handleIconClick = (e, eventData) => {
      e.stopPropagation();
      if (activeTooltip === eventData.id) {
          setEventModal({ open: true, date: eventData.date, type: eventData.type, existing: eventData });
          setActiveTooltip(null);
      } else {
          setActiveTooltip(eventData.id);
      }
  };
  
  const handleOpenEventModal = (dayStr, eventType = null, existingEvent = null) => {
    setDayModalDate(null);
    setEventModal({ open: true, date: dayStr, type: eventType, existing: existingEvent });
  };

  const saveEntry=(d,p)=>{ const e=[...user.entries]; const i=e.findIndex(x=>x.date===d); const nE={...(e[i]||{}),date:d,...p}; if(i>=0)e[i]=nE; else e.push(nE); e.sort((a,b)=>new Date(a.date)-new Date(b.date)); setUser({...user,entries:e}); };
  const removeEntry=(d)=>{ const updatedEntries = user.entries.filter(e => e.date !== d); setUser({...user, entries: updatedEntries}); };

const countIconsForDay = (dayStr, eventsList) => {
  const day = new Date(dayStr + 'T00:00:00');
  let count = 0;
  const entry = (user.entries || []).find(e => e.date === dayStr);
  if (isMedicationDay(day, user.profile?.medication)) count += 1;
  if (isMedicationDay(day, user.profile?.medication2)) count += 1;
  if (entry?.exercises) {
      count += entry.exercises.filter(ex => ex.exerciseTime && ex.exerciseTime !== '0min').length;
  } else if (entry?.exerciseTime && entry.exerciseTime !== '0min') {
      count += 1;
  }
  if (entry?.meditationTime && entry.meditationTime !== '0min') count += 1;
  const eventsOnDay = getEventsForDay(day, eventsList);
  count += eventsOnDay.length;
  return count;
};

const saveEvent = (eventData) => {
  const events = [...(user.events || [])];
  const index = events.findIndex(e => e.id === eventData.id);
  if (!eventData.message || String(eventData.message).trim() === '') {
      eventData.message = '....';
  }
  if (index > -1) {
    events[index] = eventData;
  } else {
    events.push(eventData);
  }
  const iconsCount = countIconsForDay(eventData.date, events);
  if (iconsCount > 8) {
    alert("Límite máximo de iconos en calendario superado. Si lo deseas, puedes borrar alguno ya existente.");
    return;
  }
  setUser({ ...user, events });
};

  const deleteEvent = (eventId) => {
    const events = (user.events || []).filter(e => e.id !== eventId);
    setUser({ ...user, events });
  };
  
  const isMedicationDay = (day, med) => {
      if (!med || !med.name || !med.frequency || !med.startDate) return false;
      const startDate = new Date(med.startDate + 'T00:00:00');
      const currentDay = new Date(day);
      currentDay.setHours(0,0,0,0);
      if (currentDay < startDate) return false;
      const diffTime = Math.abs(currentDay - startDate);
      const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
      return diffDays % med.frequency === 0;
  };
  
const getEventsForDay = (day, eventsList = user.events || []) => {
    const events = eventsList || [];
    const dayOfWeek = day.getDay();
    const dateOfMonth = day.getDate();
    const dayDate = new Date(day);
    dayDate.setHours(0,0,0,0);
    return events.filter(event => {
        const eventDate = new Date(event.date + 'T00:00:00');
        switch (event.frequency) {
            case 'unico': return event.date === fmt(day);
            case 'diario': return dayDate >= eventDate;
            case 'semanal': return dayDate >= eventDate && dayOfWeek === eventDate.getDay();
            case 'quincenal':
                if (dayDate < eventDate) return false;
                const diffTime = Math.abs(dayDate - eventDate);
                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                return diffDays % 14 === 0;
            case 'mensual': return dayDate >= eventDate && dateOfMonth === eventDate.getDate();
            default: return false;
        }
    });
  };

  const firstOfMonth = new Date(date.getFullYear(), date.getMonth(), 1);
  const lastOfMonth = new Date(date.getFullYear(), date.getMonth() + 1, 0);
  const firstDayOfWeek = (firstOfMonth.getDay() + 6) % 7;
  const calendarStart = new Date(firstOfMonth);
  calendarStart.setDate(firstOfMonth.getDate() - firstDayOfWeek);
  const lastDayOfWeek = (lastOfMonth.getDay() + 6) % 7;
  const calendarEnd = new Date(lastOfMonth);
  calendarEnd.setDate(lastOfMonth.getDate() + (6 - lastDayOfWeek));
  const days = [];
  for (let d = new Date(calendarStart); d <= calendarEnd; d.setDate(d.getDate() + 1)) {
      days.push(new Date(d));
  }
  
  const WeeklyLossAnnotation = ({ day, entries, profile, isMobile=false }) => {
    if (day.getDay() !== 0) return null;
    const allEntriesSorted = [...entries].sort((a, b) => new Date(a.date) - new Date(b.date));
    if (allEntriesSorted.length < 1) return null;
    const firstEntryDate = new Date(allEntriesSorted[0].date + 'T00:00:00');
    const thisSunday = new Date(day);
    thisSunday.setHours(23, 59, 59, 999);
    if (thisSunday < firstEntryDate) return null;
    const lastEntryThisWeek = allEntriesSorted.filter(e => e.weight != null && new Date(e.date + 'T00:00:00') <= thisSunday).pop();
    if (!lastEntryThisWeek) return null;
    const previousSunday = new Date(thisSunday);
    previousSunday.setDate(thisSunday.getDate() - 7);
    let weightToCompare;
    if (previousSunday < firstEntryDate) {
        weightToCompare = profile.startWeight;
    } else {
        const lastEntryPrevWeek = allEntriesSorted.filter(e => e.weight != null && new Date(e.date + 'T00:00:00') <= previousSunday).pop();
        weightToCompare = lastEntryPrevWeek ? lastEntryPrevWeek.weight : profile.startWeight;
    }
    const currentWeight = lastEntryThisWeek.weight;
    const totalChange = currentWeight - weightToCompare;
    if (Math.abs(totalChange) < 0.05) return null;
    const symbol = totalChange < 0 ? "-" : "+";
    const value = Math.abs(totalChange).toFixed(1).replace('.', ',');
    const sizeClasses = isMobile ? "w-12 h-12 text-2xl" : "w-12 h-12 text-xl";
    const positionClasses = isMobile ? "top-2 right-2" : "top-1 right-1";
    return (
        <div className={`absolute ${positionClasses} flex items-center justify-center rounded-full border-2 border-red-500 bg-white/50 dark:bg-black/50 pointer-events-none ${sizeClasses}`}>
             { !isMobile && <svg viewBox="0 0 100 100" className="absolute w-full h-full">
                <path d="M 50,5 A 45,45 0 1,1 49.9,5.01 Z" stroke="#dc2626" strokeWidth="4" fill="none" transform="rotate(-15 50 50)" />
            </svg> }
            <span className="font-handwriting text-black dark:text-white font-bold z-10">{symbol}{value}</span>
        </div>
    );
  };
  
const IconRenderer = ({ icon, isMobile }) => {
    const size = isMobile ? 'w-7 h-7' : 'w-6 h-6';
    const themedClass = `${size} text-gray-800 dark:text-white`;

    let IconComponent;
    let tooltipText = icon.event?.message || '';

    switch (icon.type) {
        case 'injection': IconComponent = <InjectionIcon className={size} />; break;
        case 'pill': IconComponent = <PillIcon className={size} />; break;
        case 'meditation':
            tooltipText = MEDITATION_TIME.find(opt => opt.value === icon.data.meditationTime)?.label || '';
            IconComponent = <MeditationIcon className={themedClass} />;
            break;
        case 'medico': IconComponent = <MedicalVisitIcon className={themedClass} />; break;
        case 'analisis': IconComponent = <AnalysisIcon className={themedClass} />; break;
        case 'bebida': IconComponent = <DrinkIcon className={themedClass} />; break;
        case 'exercise':
            if (!icon.data || icon.data.exerciseTime === '0min') return null;
            const timeLabel = EXERCISE_TIME.find(o => o.value === icon.data.exerciseTime)?.label || '';
            const intensityLabel = EXERCISE_INTENSITY.find(o => o.value === icon.data.exerciseIntensity)?.label || '';
            tooltipText = `${timeLabel} - ${intensityLabel}`;
            return (
                <div className="tooltip-wrap relative flex items-center" onClick={(e) => handleIconClick(e, icon)}>
                    {isMobile && <span className="text-xs font-semibold text-gray-800 dark:text-white mr-1">{timeLabel}</span>}
                    {getExerciseComponent(icon.data, size)}
                    <div className={`tooltip ${activeTooltip === icon.id ? 'block' : 'hidden'}`}>{tooltipText}</div>
                </div>
            );
        default: return null;
    }

    return (
        <div className="tooltip-wrap relative" onClick={(e) => handleIconClick(e, icon.event)}>
            {IconComponent}
            <div className={`tooltip ${activeTooltip === icon.event?.id ? 'block' : 'hidden'}`}>{tooltipText}</div>
        </div>
    );
};


  return(<div className="space-y-4" ref={calendarRef} onClick={() => activeTooltip && setActiveTooltip(null)}>
    <div className="hidden sm:block"> {/* Desktop Calendar */}
        <Card className="bg-transparent dark:bg-transparent backdrop-blur-sm p-2">
            <div className="grid grid-cols-7 gap-1 md:gap-2">
                {days.map((d,i)=>{ 
                    const isCurrentMonth = d.getMonth() === date.getMonth();
                    const dayString = fmt(d);
                    const entry = user.entries.find(e=>e.date===dayString); 
                    const prevEntry = user.entries.filter(e=>e.weight!=null&&e.date<dayString).pop(); 
                    const diff = entry?.weight!=null&&prevEntry?.weight!=null?entry.weight-prevEntry.weight:null; 
                    const eventsOnDay = getEventsForDay(d);
                    const specialEvent = eventsOnDay.find(e => e.type === 'especial');
                    const otherEvents = eventsOnDay.filter(e => e.type !== 'especial');
                    const weekdayAbbr = d.toLocaleString('es-ES', { weekday: 'short' }).replace('.', '');
                    
                    let allIcons = [];
                    if (isMedicationDay(d, user.profile.medication)) allIcons.push({ id: `med1-${dayString}`, type: 'injection', event: {id: `med1-${dayString}`, message: `${user.profile.medication.name} - ${user.profile.medication.dose}`} });
                    if (isMedicationDay(d, user.profile.medication2)) allIcons.push({ id: `med2-${dayString}`, type: 'pill', event: {id: `med2-${dayString}`, message: `${user.profile.medication2.name} - ${user.profile.medication2.dose}`} });
                    if (entry?.meditationTime && entry.meditationTime !== '0min') allIcons.push({ id: `meditation-${dayString}`, type: 'meditation', data: entry, event: {id: `meditation-${dayString}`, message: `Meditación: ${entry.meditationTime}`} });
                    otherEvents.forEach(e => allIcons.push({ id: e.id, type: e.type, event: e }));
                    
                    const isSelected = selectedDay === dayString;
                    return(
                       
<button key={i} data-date={dayString} onClick={() => handleDayClick(dayString)} className={`bg-white/75 dark:bg-[#2B3544]/80 backdrop-blur-sm relative rounded-lg calendar-cell p-2 text-left hover:shadow-lg transition-all duration-200 flex flex-col items-start justify-start min-h-[9rem] ${dayString===fmt(new Date())?'ring-2 ring-blue-500 border-blue-500':''} ${!isCurrentMonth ? 'opacity-60 hover:opacity-100' : ''} ${isSelected ? 'bg-blue-200 dark:bg-blue-800' : ''}`}>
                             <div className="flex items-center justify-between w-full gap-1">
                                <span className="text-sm font-medium text-gray-700 dark:text-gray-200">{weekdayAbbr} {d.getDate()}</span>
                                <div className={`flex items-center gap-1 ${d.getDay() === 0 && specialEvent ? 'mr-12' : ''}`}>
                                    {specialEvent && (
                                        <div className="tooltip-wrap relative" onClick={(e) => handleIconClick(e, specialEvent)}>
                                            <StarIcon className="w-6 h-6" />
                                            <div className={`tooltip ${activeTooltip === specialEvent.id ? 'block' : 'hidden'}`}>{specialEvent.message}</div>
                                        </div>
                                    )}
                                </div>
                            </div>
                            <div className="w-full flex-grow flex flex-col justify-center mt-1">
                                {entry?.weight!=null && (
                                    <>
                                        <div className="text-2xl font-bold text-gray-800 dark:text-white leading-5">{entry.weight.toFixed(1)} kg</div>
                                        {diff!=null && <div className={`text-sm font-semibold ${diff<0?'text-green-600':(diff>0?'text-red-600':'text-gray-500')}`}>{diff<0?'▼':(diff>0?'▲':'▬')} {Math.abs(diff).toFixed(1)} kg</div>}
                                    </>
                                )}
                            </div>
                            <div className="w-full mt-auto flex flex-row-reverse flex-wrap-reverse items-end justify-start gap-x-1 gap-y-0.5">
                                                            {/* Renderizado de ejercicios para PC (CORREGIDO) */}
                            {(entry?.exercises || []).map((ex, exIndex) => {
                                if (!ex || ex.exerciseTime === '0min') return null;
                                const timeLabel = EXERCISE_TIME.find(o => o.value === ex.exerciseTime)?.label || '';
                                return (
                                    <div key={`ex-pc-${dayString}-${exIndex}`} className="flex items-center gap-1 cursor-pointer" onClick={(e) => handleExerciseIconClick(e, dayString, ex, exIndex)}>
                                        <span className="text-xs font-semibold text-gray-800 dark:text-white">{timeLabel}</span>
                                        {getExerciseComponent(ex, "w-6 h-6")}
                                    </div>
                                );
                            })}
                            {/* Compatibilidad con datos de ejercicio antiguos en PC */}
                            {(!entry?.exercises || entry.exercises.length === 0) && entry?.exerciseTime && entry.exerciseTime !== '0min' && (
                                <div className="flex items-center gap-1 cursor-pointer" onClick={(e) => handleExerciseIconClick(e, dayString, entry, 0)}>
                                    <span className="text-xs font-semibold text-gray-800 dark:text-white">{EXERCISE_TIME.find(opt => opt.value === entry.exerciseTime)?.label || ''}</span>
                                    {getExerciseComponent(entry, "w-6 h-6")}
                                </div>
                            )}
                                {allIcons.map((icon) => <IconRenderer key={icon.id} icon={icon} isMobile={false} />)}
                            </div>
                            <WeeklyLossAnnotation day={d} entries={user.entries} profile={user.profile} isMobile={false} />
                        </button>
                    );
                })}
            </div>
        </Card>
    </div>
    <div className="sm:hidden space-y-2"> {/* Mobile Calendar */}
         {days.map((d, i) => {
            const isCurrentMonth = d.getMonth() === date.getMonth();
            if (!isCurrentMonth) return null;
            const dayString = fmt(d);
            const isToday = dayString === fmt(new Date());
            const entry = user.entries.find(e => e.date === dayString);
            const prevEntry = user.entries.filter(e => e.weight != null && e.date < dayString).pop();
            const diff = entry?.weight != null && prevEntry?.weight != null ? entry.weight - prevEntry.weight : null;
            const eventsOnDay = getEventsForDay(d);
            const specialEvent = eventsOnDay.find(e => e.type === 'especial');
            const otherEvents = eventsOnDay.filter(e => e.type !== 'especial');
            const weekdayAbbr = d.toLocaleDateString('es-ES', { weekday: 'short' }).replace('.', '');
            
            let allIcons = [];
            if (isMedicationDay(d, user.profile.medication)) allIcons.push({ id: `med1-${dayString}`, type: 'injection', event: {id: `med1-${dayString}`, message: `${user.profile.medication.name} - ${user.profile.medication.dose}`} });
            if (isMedicationDay(d, user.profile.medication2)) allIcons.push({ id: `med2-${dayString}`, type: 'pill', event: {id: `med2-${dayString}`, message: `${user.profile.medication2.name} - ${user.profile.medication2.dose}`} });
            if (entry?.meditationTime && entry.meditationTime !== '0min') allIcons.push({ id: `meditation-${dayString}`, type: 'meditation', data: entry, event: {id: `meditation-${dayString}`, message: `Meditación: ${entry.meditationTime}`} });
            otherEvents.forEach(e => allIcons.push({ id: e.id, type: e.type, event: e }));
            
            const hasIcons = allIcons.length > 0 || (entry?.exercises && entry.exercises.some(e => e.exerciseTime && e.exerciseTime !== '0min')) || (entry?.exerciseTime && entry.exerciseTime !== '0min');
            const isSundayWithIcons = d.getDay() === 0 && hasIcons;
            const isSelected = selectedDay === dayString;
            return (
<button 
  key={i} 
  data-date={dayString} 
  /* 5. APLICACIÓN DEL CALLBACK REF: Si es hoy, asignamos la referencia */
  ref={isToday ? todayRef : null}
  onClick={() => handleDayClick(dayString)} 
  className={`relative w-full rounded-lg calendar-cell p-3 text-left hover:shadow-lg transition-all duration-200 flex items-center justify-between ${dayString === fmt(new Date()) ? 'ring-2 ring-blue-500 border-blue-500' : ''} ${isSundayWithIcons ? 'min-h-[6.5rem]' : 'min-h-[4.5rem]'} ${isSelected ? 'bg-blue-200 dark:bg-blue-800' : ''}`}>
    <div className="flex items-center gap-4">
        <div className="flex flex-col items-center justify-center w-12 text-center">
            <span className="text-xs font-bold uppercase text-gray-600 dark:text-gray-300">{weekdayAbbr}</span>
            <span className="text-2xl font-bold leading-tight text-gray-800 dark:text-white">{d.getDate()}</span>
        </div>
        <div>
            {entry?.weight != null ? (
                <div className="flex items-center gap-2">
                    <div>
                        <div className="flex items-baseline gap-2">
                            <span className="text-2xl font-bold text-gray-800 dark:text-white">{entry.weight.toFixed(1)} kg</span>
                            {specialEvent && (
                                <div className="tooltip-wrap" onClick={(e) => handleIconClick(e, specialEvent)}>
                                    <StarIcon className="w-6 h-6" />
                                    <div className={`tooltip ${activeTooltip === specialEvent.id ? 'block' : 'hidden'}`}>{specialEvent.message}</div>
                                </div>
                            )}
                        </div>
                        {diff != null && (
                            <div className={`text-base font-semibold ${diff < 0 ? 'text-green-600' : (diff > 0 ? 'text-red-600' : 'text-gray-500')}`}>
                                {diff < 0 ? '▼' : (diff > 0 ? '▲' : '▬')} {Math.abs(diff).toFixed(1)} kg
                            </div>
                        )}
                    </div>
                </div>
            ) : specialEvent && (
                <div className="tooltip-wrap" onClick={(e) => handleIconClick(e, specialEvent)}>
                    <StarIcon className="w-7 h-7" />
                    <div className={`tooltip ${activeTooltip === specialEvent.id ? 'block' : 'hidden'}`}>{specialEvent.message}</div>
                </div>
            )}
        </div>
    </div>
    <div className="absolute bottom-2 right-2 flex flex-row-reverse flex-wrap-reverse items-end justify-start gap-2" style={{maxWidth: isSundayWithIcons ? 'calc(100% - 9rem)' : 'calc(100% - 5rem)' }}>
        {/* Renderizado de ejercicios para Móvil (CORREGIDO) */}
                            {(entry?.exercises || []).map((ex, exIndex) => {
                                if (!ex || ex.exerciseTime === '0min') return null;
                                const timeLabel = EXERCISE_TIME.find(o => o.value === ex.exerciseTime)?.label || '';
                                return (
                                    <div key={`ex-mob-${dayString}-${exIndex}`} className="flex items-center gap-1 cursor-pointer" onClick={(e) => handleExerciseIconClick(e, dayString, ex, exIndex)}>
                                        <span className="text-xs font-semibold text-gray-800 dark:text-white">{timeLabel}</span>
                                        {getExerciseComponent(ex, "w-7 h-7")}
                                    </div>
                                );
                            })}
                            {/* Compatibilidad con datos de ejercicio antiguos en Móvil */}
                            {(!entry?.exercises || entry.exercises.length === 0) && entry?.exerciseTime && entry.exerciseTime !== '0min' && (
                                <div className="flex items-center gap-1 cursor-pointer" onClick={(e) => handleExerciseIconClick(e, dayString, entry, 0)}>
                                    <span className="text-xs font-semibold text-gray-800 dark:text-white">{EXERCISE_TIME.find(opt => opt.value === entry.exerciseTime)?.label || ''}</span>
                                    {getExerciseComponent(entry, "w-7 h-7")}
                                </div>
                            )}
        {allIcons.map((icon) => <IconRenderer key={icon.id} icon={icon} isMobile={true} />)}
    </div>
    <WeeklyLossAnnotation day={d} entries={user.entries} profile={user.profile} isMobile={true} />
</button>
            );
        })}
    </div>
    {dayModalDate && <DayModal open={!!dayModalDate} onClose={()=>setDayModalDate(null)} date={dayModalDate} data={user} onSave={saveEntry} onDelete={removeEntry} onOpenEventModal={(type, existing) => handleOpenEventModal(dayModalDate, type, existing)} />}
    {eventModal.open && <EventModal open={eventModal.open} onClose={() => setEventModal({ open: false, date: null, type: null, existing: null })} date={eventModal.date} onSave={saveEvent} onDelete={deleteEvent} existingEvent={eventModal.existing} eventType={eventModal.type} />}
    {detailModal.open && <ExerciseDetailModal 
        open={detailModal.open} 
        onClose={() => setDetailModal({ open: false, exercise: null, index: -1 })} 
        exerciseData={detailModal.exercise} 
onEdit={() => {
  // cerramos el modal de detalle
  setDetailModal({ open: false, exercise: null, index: -1, date: null });

  // abrimos el wizard de ejercicio con los datos del ejercicio actual
  setExerciseWizardInitialData(detailModal.exercise);
  setExerciseWizardTargetDate(detailModal.date);
  setEditingExerciseIndexCalendar(detailModal.index);
  setIsExerciseWizardOpen(true);
}}

        onDelete={() => handleDeleteExercise(detailModal.date, detailModal.index)} 
    />}

{isExerciseWizardOpen && (
  <ExerciseWizardModal
    open={isExerciseWizardOpen}
    onClose={() => {
      setIsExerciseWizardOpen(false);
      setExerciseWizardInitialData(null);
      setExerciseWizardTargetDate(null);
      setEditingExerciseIndexCalendar(null);
    }}
    initialData={exerciseWizardInitialData}
    onSave={(exerciseData) => {
      // buscamos la entrada del día
      const updatedEntries = Array.isArray(user.entries) ? [...user.entries] : [];
      const entryIndex = updatedEntries.findIndex(e => e.date === exerciseWizardTargetDate);

      if (entryIndex !== -1) {
        const entry = { ...updatedEntries[entryIndex] };
        entry.exercises = [...(entry.exercises || [])];
        if (editingExerciseIndexCalendar !== null && editingExerciseIndexCalendar >= 0) {
          entry.exercises[editingExerciseIndexCalendar] = exerciseData;
        } else {
          entry.exercises.push(exerciseData);
        }
        updatedEntries[entryIndex] = entry;
      }

      setUser({ ...user, entries: updatedEntries });

      // cerramos el wizard
      setIsExerciseWizardOpen(false);
      setExerciseWizardInitialData(null);
      setExerciseWizardTargetDate(null);
      setEditingExerciseIndexCalendar(null);
    }}
  />
)}

  </div>);
};
// ====================== FIN DEL CÓDIGO FINAL Y COMPLETO PARA CALENDARVIEW ======================
    const MilestoneIndicator = ({label, position}) => (
      <div className="absolute transition-transform duration-500" style={{top: 'calc(100% + 0.5rem)', left: `${position}%`, transform: 'translateX(-50%)'}}>
        <div className="relative flex flex-col items-center">
          <div className="mb-1 w-0 h-0 border-l-4 border-r-4 border-b-4 border-l-transparent border-r-transparent border-b-gray-700 dark:border-b-gray-300"></div>
          <span className="px-2 py-0.5 bg-gray-700 text-white dark:bg-gray-300 dark:text-black text-xs font-bold rounded-md shadow-lg">{label}</span>
        </div>
      </div>
    );
// ====================== INICIO DEL CÓDIGO CORRECTO Y FINAL PARA PROGRESSVIEW ======================
const ProgressView = ({user, scenario})=>{
  const proj = calculateProjectionScenarios(user);
  const feedback = generateDailyFeedback(user, {});
  const {startWeight:firstW, targetWeight} = user.profile;
  const allEntriesSorted = (user.entries || []).slice().sort((a,b)=>new Date(a.date)-new Date(b.date));
  const lastW=(allEntriesSorted.filter(e=>e.weight!=null).pop()?.weight)??firstW;
  const totalToLose=Math.max(0,firstW-targetWeight);
  const lost=Math.max(0,firstW-lastW);
  const pct=totalToLose>0?Math.min(100,(lost/totalToLose)*100):0;
  const target80_kg = (firstW - (totalToLose * 0.8)).toFixed(1);
  const avgWater=allEntriesSorted.length?(allEntriesSorted.reduce((a,e)=>a+waterLiters(e.water),0)/allEntriesSorted.length):0;
  const avgSleep=allEntriesSorted.length?(allEntriesSorted.reduce((a,e)=>a+sleepHours(e.sleep),0)/allEntriesSorted.length):0;
  const { avgExWeek, avgMeditationWeek, avgDailySteps } = React.useMemo(() => {
    if (allEntriesSorted.length < 1) return { avgExWeek: 0, avgMeditationWeek: 0, avgDailySteps: 0 };
    const firstDate = new Date(allEntriesSorted[0].date);
    const lastDate = new Date(allEntriesSorted[allEntriesSorted.length - 1].date);
    const totalDaysSpan = Math.max(1, ((lastDate - firstDate) / 86400000) + 1);
    const totalExerciseHours = allEntriesSorted.reduce((acc, entry) => acc + exerciseHours(entry.exerciseTime || '0min'), 0);
    const totalMeditationMinutes = allEntriesSorted.reduce((acc, entry) => acc + meditationMinutes(entry.meditationTime || '0min'), 0);
    const entriesWithSteps = allEntriesSorted.filter(e => e.dailySteps != null && e.dailySteps > 0);
    const totalSteps = entriesWithSteps.reduce((acc, entry) => acc + entry.dailySteps, 0);
    return {
        avgExWeek: (totalExerciseHours / totalDaysSpan) * 7,
        avgMeditationWeek: (totalMeditationMinutes / totalDaysSpan) * 7,
        avgDailySteps: entriesWithSteps.length > 0 ? totalSteps / entriesWithSteps.length : 0
    };
  }, [allEntriesSorted]);
  const h=user.profile.height/100;
  const currentProjection = proj.results ? proj.results[scenario] : null;
  const kpiCards = [];
  kpiCards.push(<Card key="lost" className="text-center"><div className="text-sm text-gray-600 dark:text-gray-300">Peso perdido</div><div className="text-3xl font-bold text-gray-800 dark:text-white">{lost.toFixed(1)} kg</div><div className="text-xs text-gray-500 dark:text-gray-400 mt-1">Actual: {lastW.toFixed(1)} kg</div></Card>);
  kpiCards.push(<Card key="remaining" className="text-center"><div className="text-sm text-gray-600 dark:text-gray-300">Peso restante</div><div className="text-3xl font-bold text-gray-800 dark:text-white">{(Math.max(0,lastW-targetWeight)).toFixed(1)} kg</div><div className="text-xs text-gray-500 dark:text-gray-400 mt-1">Objetivo: {targetWeight} kg</div></Card>);
  kpiCards.push(
    <Card key="imc" className="text-center">
        <div className="text-sm text-gray-600 dark:text-gray-300">IMC</div>
        {h > 0 ? (
            <div>
                <div className="text-xl font-bold text-gray-800 dark:text-white leading-tight">Ini: {(firstW/(h*h)).toFixed(1)}</div>
                <div className="text-xl font-bold text-gray-800 dark:text-white leading-tight">Act: {(lastW/(h*h)).toFixed(1)}</div>
                <div className="text-xs text-gray-500 dark:text-gray-400 mt-1">Obj: {(targetWeight/(h*h)).toFixed(1)}</div>
            </div>
        ) : ( <div className="text-2xl font-bold text-gray-800 dark:text-white">N/A</div> )}
    </Card>
  );
  if (avgWater > 0) kpiCards.push(<Card key="water" className="text-center"><div className="text-sm text-gray-600 dark:text-gray-300">Media de agua</div><div className="text-2xl font-bold text-gray-800 dark:text-white">{avgWater.toFixed(2)} L</div></Card>);
  if (avgSleep > 0) kpiCards.push(<Card key="sleep" className="text-center"><div className="text-sm text-gray-600 dark:text-gray-300">Media de sueño</div><div className="text-2xl font-bold text-gray-800 dark:text-white">{avgSleep.toFixed(1)} h</div></Card>);
  if (avgExWeek > 0) kpiCards.push(<Card key="exercise" className="text-center"><div className="text-sm text-gray-600 dark:text-gray-300">Ejercicio semanal</div><div className="text-2xl font-bold text-gray-800 dark:text-white">{avgExWeek.toFixed(1)} h</div></Card>);
  if (avgMeditationWeek > 0) kpiCards.push(<Card key="meditation" className="text-center"><div className="text-sm text-gray-600 dark:text-gray-300">Meditación semanal</div><div className="text-2xl font-bold text-gray-800 dark:text-white">{avgMeditationWeek.toFixed(0)} min</div></Card>);
  if (avgDailySteps > 0) kpiCards.push(<Card key="steps" className="text-center"><div className="text-sm text-gray-600 dark:text-gray-300">Media de pasos</div><div className="text-2xl font-bold text-gray-800 dark:text-white">{avgDailySteps.toLocaleString('es-ES', { maximumFractionDigits: 0 })}</div></Card>);
  return(<div className="space-y-4">
    <Card className="p-6">
      {feedback.globalMessage && <div className="mb-4 text-center text-4xl font-handwriting text-gray-800 dark:text-gray-100 bg-gray-100 dark:bg-gray-600/50 p-4 rounded-lg">{feedback.globalMessage}</div>}
      <div className="relative pt-8 pb-12 px-4">
        {pct > 0 && <div className="absolute top-0 transition-transform duration-500" style={{left: `${pct}%`, transform: 'translateX(-50%)'}}>
          <div className="relative flex flex-col items-center">
            <span className="px-2 py-0.5 bg-black dark:bg-white text-white dark:text-black text-sm font-bold rounded-md shadow-lg">{pct.toFixed(1)}%</span>
            <div className="mt-1 w-0 h-0 border-l-4 border-r-4 border-t-4 border-l-transparent border-r-transparent border-t-black dark:border-t-white"></div>
          </div>
        </div>}
        <div className="relative">
            <div className="w-full h-8 bg-gray-200 dark:bg-gray-600 rounded-full border-2 border-gray-400 dark:border-gray-500 shadow-inner overflow-hidden">
                <div className="h-full transition-all duration-500 rounded-full" style={{width: `${pct}%`, background: 'linear-gradient(90deg, #06b6d4 0%, #3b82f6 100%)'}}></div>
            </div>
            <MilestoneIndicator label="80%" position={80} />
            <MilestoneIndicator label="100%" position={100} />
        </div>
      </div>
      {feedback.actionMessages && feedback.actionMessages.length > 0 && <div className="mt-4 text-center text-3xl font-handwriting text-gray-700 dark:text-gray-200 bg-gray-100 dark:bg-gray-600/50 p-4 rounded-lg">{feedback.actionMessages.join(' • ')}</div>}
    </Card>
    <div className="grid grid-cols-1 md:grid-cols-10 gap-4">
      <Card className="col-span-10 md:col-span-7 p-3 text-center">
        <div className="text-sm font-semibold text-gray-700 dark:text-gray-200">Objetivo intermedio <span className="font-bold text-blue-600 dark:text-blue-400">{target80_kg} kg</span> (80%)</div>
        {currentProjection ? (<>
          <div className="text-2xl font-bold text-gray-800 dark:text-white mt-1">{new Date(currentProjection.eta80).toLocaleDateString('es-ES',{day:'2-digit',month:'long', year:'numeric'})}</div>
          <div className="text-xs text-gray-500 dark:text-gray-400">Estimado en {humanizeDays(currentProjection.daysTo80)}</div>
        </>) : <div className="text-lg text-gray-500 mt-2">{proj.message || 'Calculando...'}</div>}
      </Card>
      <Card className="col-span-10 md:col-span-3 p-3 text-center">
        <div className="text-sm font-semibold text-gray-700 dark:text-gray-200">Objetivo final <span className="font-bold text-green-600 dark:text-green-400">{targetWeight} kg</span></div>
        {currentProjection ? (<>
          <div className="text-2xl font-bold text-gray-800 dark:text-white mt-1">{new Date(currentProjection.etaFinal).toLocaleDateString('es-ES',{day:'2-digit',month:'long', year:'numeric'})}</div>
          <div className="text-xs text-gray-500 dark:text-gray-400">Estimado en {humanizeDays(currentProjection.daysToFinal)}</div>
        </>) : <div className="text-lg text-gray-500 mt-2">{proj.message || 'Calculando...'}</div>}
      </Card>
    </div>
    <div className="grid grid-cols-[repeat(auto-fit,minmax(140px,1fr))] gap-4">
      {kpiCards}
    </div>
  </div>); 
};
// ====================== FIN DEL CÓDIGO CORRECTO Y FINAL PARA PROGRESSVIEW ======================
// ====================== INICIO DEL CÓDIGO NUEVO PARA CHARTSVIEW ======================
const ChartsView = ({user, theme})=>{ 
    const refs=[React.useRef(null),React.useRef(null),React.useRef(null),React.useRef(null)]; 
    React.useEffect(()=>{ 
        const charts=[]; 
        const destroy=()=>charts.forEach(c=>c.destroy()); 
        destroy(); 
        const entries=user.entries.slice().sort((a,b)=>new Date(a.date)-new Date(b.date));
        if(entries.length === 0) return;
        const chartEntries = entries.slice(-12);
        const dietMap = { 'estricta': 1, 'correcta': 2, 'incorrecta': 3, 'mala': 4 };
        const dietColors = { 'estricta': 'rgba(34, 197, 94, 0.35)', 'correcta': 'rgba(59, 130, 246, 0.35)', 'incorrecta': 'rgba(245, 158, 11, 0.35)', 'mala': 'rgba(239, 68, 68, 0.35)' };
        const weightsData = chartEntries.map(e => e.weight);
        const shiftedWeights = chartEntries.length > 0 ? [...weightsData.slice(1), null] : [];
        const visibleWeights = weightsData.filter(w => w != null);
        const minWeight = visibleWeights.length ? Math.min(...visibleWeights) : null;
        const maxWeight = visibleWeights.length ? Math.max(...visibleWeights) : null;
        const weights=entries.filter(e=>e.weight!=null); 
        const gluc=entries.filter(e=>e.glucose!=null); 
        const ctxs=refs.map(r=>r.current?.getContext('2d')); 
        const isDark = theme === 'dark';
        const axisColor = isDark ? '#FFFFFF' : '#1f2937';
        const gridColor = isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)'; 
        const commonOptions = { responsive:true, maintainAspectRatio:false, interaction:{ intersect:false, mode:'index'}, plugins:{legend:{labels:{color:axisColor}}}, scales:{x:{ticks:{color:axisColor}, grid:{color:gridColor}}, y:{ticks:{color:axisColor}, grid:{color:gridColor}}} }; 
        if(chartEntries.length&&ctxs[0]){ 
            const labels = chartEntries.map(e => e.date);
            charts.push(new Chart(ctxs[0],{type:'bar', data:{ labels, datasets:[ 
                {type: 'line', label:'Peso(kg)', yAxisID:'y', data: shiftedWeights, borderColor: isDark ? 'rgba(255, 255, 255, 0.9)' : 'rgba(0, 0, 0, 1)', backgroundColor: isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)', borderWidth:4, tension:.3, pointRadius:3, pointHoverRadius:6, order: 0}, 
                {label:'Calidad Dieta', yAxisID: 'y1', data: chartEntries.map(e => dietMap[e.diet] || 0), backgroundColor: chartEntries.map(e => dietColors[e.diet] || 'rgba(128,128,128,0.5)'), order: 4 }, 
                {type: 'line', label:'Ejercicio(h)', yAxisID:'y1', data:chartEntries.map(e=>exerciseHours(e.exerciseTime)), borderColor:'rgb(239, 68, 68)', borderWidth:2.5, pointRadius:3, pointHoverRadius:6, fill: false, order: 1}, 
                {type: 'line', label:'Sueño(h)', yAxisID:'y1', data:chartEntries.map(e=>sleepHours(e.sleep)), borderColor:'rgb(147,51,234)', borderWidth:2.5, pointRadius:3, pointHoverRadius:6, fill: false, order: 2}, 
                {type: 'line', label:'Agua(L)', yAxisID:'y1', data:chartEntries.map(e=>waterLiters(e.water)), borderColor:'rgb(6,182,212)', borderWidth:2.5, pointRadius:3, pointHoverRadius:6, fill: false, order: 3} 
            ] }, options:{...commonOptions, scales:{
                x: { ticks: { color: axisColor, callback: function(value, index) {
                      const entry = chartEntries[index];
                      if (!entry) return '';
                      const d = new Date(entry.date + 'T00:00:00');
                      const dayName = d.toLocaleDateString('es-ES', { weekday: 'short' });
                      return dayName.charAt(0).toUpperCase() + dayName.slice(1).replace('.', '');
                    }}, grid:{color:gridColor}
                },
                y:{position:'left', title:{display:true, text:'Peso (kg)', color:axisColor}, min: minWeight ? Math.floor(minWeight - 1) : undefined, max: maxWeight ? Math.ceil(maxWeight + 1) : undefined, ticks:{color:axisColor}, grid:{color:gridColor}}, 
                y1:{position:'right', title:{display:true, text:'Hábitos (horas/litros/calidad)', color:axisColor}, grid:{drawOnChartArea:false}, ticks: { stepSize: 1, color:axisColor }}
            }}}));
        } 
        if(weights.length&&ctxs[1]){ const data=weights.map(e=>e.weight); charts.push(new Chart(ctxs[1],{type:'line',data:{labels:weights.map(e=>new Date(e.date).toLocaleDateString('es-ES')),datasets:[{label:'Peso(kg)',data,borderColor:'rgb(59,130,246)',backgroundColor:'rgba(59,130,246,0.3)',fill:true,tension:.3, pointRadius:2, pointHoverRadius:5},{label:'Objetivo',data:new Array(data.length).fill(user.profile.targetWeight),borderColor:'rgb(34,197,94)',borderWidth:2,pointRadius:0, borderDash:[5,5]}]},options:commonOptions}));} 
        if(gluc.length&&ctxs[2]){
            const glucoseChartOptions = {
                ...commonOptions,
                scales: {
                    ...commonOptions.scales,
                    x: {
                        ...commonOptions.scales.x,
                        ticks: {
                            ...commonOptions.scales.x.ticks,
                            callback: function(value, index){ 
                                const entry = gluc[index]; 
                                if(!entry) return ''; 
                                const d = new Date(entry.date + 'T00:00:00'); 
                                const dayName = d.toLocaleDateString('es-ES', {weekday:'short'}); 
                                return dayName.charAt(0).toUpperCase() + dayName.slice(1).replace('.','');
                            }
                        }
                    }
                }
            };
            charts.push(new Chart(ctxs[2],{type:'line',data:{labels:gluc.map(e=>e.date),datasets:[{label:'Glucosa(mg/dl)',data:gluc.map(e=>e.glucose),borderColor:'rgb(239,68,68)',backgroundColor:'rgba(239,68,68,0.3)',fill:true,tension:.3, pointRadius:2, pointHoverRadius:5}]},options: glucoseChartOptions}));
        } 
        if(ctxs[3]){const counts=user.entries.reduce((a,e)=>{if(e.diet)a[e.diet]=(a[e.diet]||0)+1;return a},{}); const data=Object.values(counts); if(data.length){charts.push(new Chart(ctxs[3],{type:'doughnut',data:{labels:Object.keys(counts).map(k=>DIET.find(d=>d.value===k)?.label||k),datasets:[{data,backgroundColor:['#22c55e','#3b82f6','#f59e0b','#ef4444'], borderColor: isDark ? '#1f2937' : '#fff', borderWidth:3}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'right',labels:{color:axisColor}}}}}));}} 
        return()=>destroy();
    },[user,theme]); 
    return(<div className="space-y-8">
        <Card className="lg:col-span-2">
            <h4 className="font-semibold text-gray-800 dark:text-white mb-1">Correlación de Hábitos y Peso (Últimos 12 días)</h4>
            <p className="text-xs text-gray-500 dark:text-gray-400 mb-2">ⓘ La línea de peso se muestra desplazada para correlacionar con los hábitos del día anterior.</p>
            <div className="relative h-[320px]"><canvas ref={refs[0]} id="habits-chart"></canvas></div>
        </Card>
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
            <Card><h4 className="font-semibold text-gray-800 dark:text-white mb-2">Evolución del Peso (Histórico)</h4><div className="relative h-72"><canvas ref={refs[1]} id="weight-chart"></canvas></div></Card>
            <Card><h4 className="font-semibold text-gray-800 dark:text-white mb-2">Glucosa (Histórico)</h4><div className="relative h-72"><canvas ref={refs[2]} id="glucose-chart"></canvas></div></Card>
        </div>
        <Card className="lg:col-span-2"><h4 className="font-semibold text-gray-800 dark:text-white mb-2">Distribución de Dieta (Histórico)</h4><div className="relative h-72"><canvas ref={refs[3]} id="diet-chart"></canvas></div></Card>
    </div>);
};
// ====================== FIN DEL CÓDIGO NUEVO PARA CHARTSVIEW ======================
// ====================== INICIO DEL CÓDIGO FINAL CON MEDIDAS (REORDENADO) PARA PROFILEVIEW ======================
const ProfileView = ({user, setUser, theme})=>{ 
    const [local,setLocal]=React.useState({...user.profile});
    const [isSaving, setIsSaving] = React.useState(false);
    const [measurementModal, setMeasurementModal] = React.useState(null); // 'choice', 'add', 'view'
    const [editingMeasurement, setEditingMeasurement] = React.useState(null);
    React.useEffect(()=>{setLocal(user.profile)},[user.profile]); 
    const save = () => {
      setIsSaving(true);
      setUser({...user, profile:local});
      setTimeout(() => setIsSaving(false), 500);
    };
    const handleSaveMeasurement = (measurementData) => {
        const measurements = [...(user.measurements || [])];
        const index = measurements.findIndex(m => m.id === measurementData.id);
        if (index > -1) {
            measurements[index] = measurementData;
        } else {
            measurements.push(measurementData);
        }
        setUser({ ...user, measurements });
        setMeasurementModal('view'); // After saving, go to the view modal
    };
    const handleDeleteMeasurement = (measurementId) => {
        // Se elimina la confirmación emergente
        const measurements = (user.measurements || []).filter(m => m.id !== measurementId);
        setUser({ ...user, measurements });
    };
    const handleEditMeasurement = (measurement) => {
        setEditingMeasurement(measurement);
        setMeasurementModal('add');
    };
    const handleOpenAddModal = () => {
        setEditingMeasurement(null);
        setMeasurementModal('add');
    };
    const exportJSON = (user) => {
        const dataToExport = {
            data_schema: {
                version: "2.4",
                description: "Datos de seguimiento de salud de la app ControlaTuPeso+. La fecha de inicio real del seguimiento es la fecha del primer registro en 'entries'.",
                profile: {
                    processStartDate: "Fecha ISO (YYYY-MM-DD) en la que se creó el perfil. Usar la primera fecha de 'entries' como el inicio real del proceso.",
                    createdAt: "Fecha ISO técnica de creación del perfil en la app."
                },
                entries: "Registros diarios de peso, hábitos, etc.",
                events: "Eventos programados (visitas médicas, días especiales, etc.).",
                measurements: {
                    id: "Timestamp único de la medición.",
                    date: "Fecha de la medición (YYYY-MM-DD).",
                    type: "Tipo de medida (string: 'circunferencia', 'pliegues').",
                    muslos: "Medida en cm o mm (número o null).",
                    cadera: "Medida en cm o mm (número o null).",
                    cintura: "Medida en cm o mm (número o null).",
                    pecho: "Medida en cm o mm (número o null).",
                    brazo: "Medida en cm o mm (número o null)."
                }
            },
            ...user
        };
        const blob = new Blob([JSON.stringify(dataToExport, null, 2)], {type:'application/json'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `ControlaTuPeso+_${user.profile.name}.json`;
        a.click();
        URL.revokeObjectURL(a.href);
    };
    const exportPDF = async (user, theme) => {
        // El código de exportPDF se mantiene igual, no es necesario pegarlo de nuevo, se incluye para que el componente esté completo
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'mm', 'a4');
        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();
        let y = 10;
        doc.setFillColor(30, 64, 175); doc.rect(0, 0, 210, 22, 'F'); doc.setFont('helvetica', 'bold'); doc.setTextColor(255); doc.setFontSize(18); doc.text('ControlaTuPeso+', 14, 15); const today = new Date().toLocaleDateString('es-ES', { year: 'numeric', month: '2-digit', day: '2-digit' }); doc.setFont('helvetica', 'normal'); doc.setFontSize(10); doc.text(`Fecha de descarga: ${today}`, 210 - 14, 15, { align: 'right' }); doc.setTextColor(0, 0, 0); y = 32; doc.setFontSize(14); doc.setFont('helvetica', 'bold'); doc.text('Perfil del Usuario', 14, y); y += 8; doc.setFontSize(11); doc.setFont('helvetica', 'normal'); doc.text(`Nombre: ${user.profile.name}`, 14, y); y += 6; const sortedEntries = user.entries.slice().sort((a, b) => new Date(a.date) - new Date(b.date)); const firstEntryDate = sortedEntries.length > 0 ? new Date(sortedEntries[0].date + 'T00:00:00').toLocaleDateString('es-ES') : new Date(user.profile.processStartDate || user.profile.createdAt).toLocaleDateString('es-ES'); doc.text(`Fecha de inicio del proceso: ${firstEntryDate}`, 14, y); y += 6; doc.text(`Altura: ${user.profile.height} cm`, 14, y); y += 6; doc.text(`Peso inicial / objetivo: ${user.profile.startWeight} kg / ${user.profile.targetWeight} kg`, 14, y); y += 6; if (user.profile.medication?.name) { doc.text(`Medicación 1: ${user.profile.medication.name} | Dosis: ${user.profile.medication.dose||'—'} | Inicio: ${user.profile.medication.startDate ? new Date(user.profile.medication.startDate+'T00:00:00').toLocaleDateString('es-ES') : '—'} | Frecuencia: Cada ${user.profile.medication.frequency||'—'} días`, 14, y); y += 6; } if (user.profile.medication2?.name) { doc.text(`Medicación 2: ${user.profile.medication2.name} | Dosis: ${user.profile.medication2.dose||'—'} | Inicio: ${user.profile.medication2.startDate ? new Date(user.profile.medication2.startDate+'T00:00:00').toLocaleDateString('es-ES') : '—'} | Frecuencia: Cada ${user.profile.medication2.frequency||'—'} días`, 14, y); y += 6; } y += 4; doc.setFontSize(14); doc.setFont('helvetica', 'bold'); doc.text('Resumen del Progreso', 14, y); y += 6; const h = user.profile.height/100; const firstW = user.profile.startWeight; const lastW = (user.entries.filter(e=>e.weight!=null).pop()?.weight) ?? firstW; const totalToLose = Math.max(0, firstW - user.profile.targetWeight); const lost = Math.max(0, firstW - lastW); const pct = totalToLose > 0 ? Math.min(100, (lost/totalToLose)*100) : 0; const proj = calculateProjectionScenarios(user); const projNeutro = proj.results ? proj.results.neutro : null; const { avgWater, avgSleep, avgExWeek, avgMeditationWeek, avgDailySteps } = (() => {
            if (sortedEntries.length < 1) return { avgWater: 0, avgSleep: 0, avgExWeek: 0, avgMeditationWeek: 0, avgDailySteps: 0 };
            const firstDate = new Date(sortedEntries[0].date);
            const lastDate = new Date(sortedEntries[sortedEntries.length - 1].date);
            const totalDaysSpan = Math.max(1, ((lastDate - firstDate) / 86400000) + 1);
            const entriesWithSteps = sortedEntries.filter(e => e.dailySteps != null && e.dailySteps > 0);
            return {
                avgWater: sortedEntries.reduce((a,e)=>a+waterLiters(e.water),0)/sortedEntries.length,
                avgSleep: sortedEntries.reduce((a,e)=>a+sleepHours(e.sleep),0)/sortedEntries.length,
                avgExWeek: (sortedEntries.reduce((a,e)=>a+exerciseHours(e.exerciseTime),0) / totalDaysSpan) * 7,
                avgMeditationWeek: (sortedEntries.reduce((a,e)=>a+meditationMinutes(e.meditationTime),0) / totalDaysSpan) * 7,
                avgDailySteps: entriesWithSteps.length > 0 ? entriesWithSteps.reduce((a,e)=>a+e.dailySteps,0) / entriesWithSteps.length : 0
            };
        })();

        const kpiBoxY = y;
        doc.setDrawColor(200);
        doc.roundedRect(14, kpiBoxY, 182, 62, 3, 3);

        let kpiY = kpiBoxY + 8;
        const xLabel1 = 20, xValue1 = 80, xLabel2 = 110, xValue2 = 170;

        doc.setFontSize(10);
        doc.setFont('helvetica', 'normal');
        doc.text('Progreso alcanzado:', xLabel1, kpiY);
        doc.text(`${pct.toFixed(1)} %`, xValue1, kpiY);
        doc.text('Media consumo agua:', xLabel2, kpiY);
        doc.text(`${avgWater.toFixed(2)} L / día`, xValue2, kpiY);

        kpiY += 7;
        doc.text('Peso perdido:', xLabel1, kpiY);
        doc.text(`${lost.toFixed(1)} kg`, xValue1, kpiY);
        doc.text('Ejercicio semanal:', xLabel2, kpiY);
        doc.text(`${avgExWeek.toFixed(1)} h / sem`, xValue2, kpiY);

        kpiY += 7;
        doc.text('Peso actual:', xLabel1, kpiY);
        doc.text(`${lastW.toFixed(1)} kg`, xValue1, kpiY);
        doc.text('Media de sueño:', xLabel2, kpiY);
        doc.text(`${avgSleep.toFixed(1)} h / día`, xValue2, kpiY);

        kpiY += 7;
        doc.text('Peso por perder:', xLabel1, kpiY);
        doc.text(`${(Math.max(0, lastW - user.profile.targetWeight)).toFixed(1)} kg`, xValue1, kpiY);
        doc.text('Meditación semanal:', xLabel2, kpiY);
        doc.text(`${avgMeditationWeek.toFixed(0)} min / sem`, xValue2, kpiY);

        kpiY += 7;
        const targetIMC = h > 0 ? (user.profile.targetWeight/(h*h)).toFixed(1) : 'N/A';
        doc.text('IMC (ini/act/obj):', xLabel1, kpiY);
        doc.text(h > 0 ? `${(firstW/(h*h)).toFixed(1)} / ${(lastW/(h*h)).toFixed(1)} / ${targetIMC}` : 'N/A', xValue1, kpiY);
        doc.text('Media de pasos:', xLabel2, kpiY);
        doc.text(`${avgDailySteps.toLocaleString('es-ES',{maximumFractionDigits:0})} / día`, xValue2, kpiY);

        kpiY += 10;
        doc.setFont('helvetica', 'bold');
        doc.text('Días pendientes hasta objetivo:', xLabel1, kpiY);
        doc.text(projNeutro ? humanizeDays(projNeutro.daysToFinal) : (proj.message || 'N/A'), xValue1, kpiY);

        kpiY += 6;
        doc.text('Fecha de objetivo alcanzado:', xLabel1, kpiY);
        doc.text(projNeutro ? new Date(projNeutro.etaFinal).toLocaleDateString('es-ES',{day:'2-digit', month:'long', year:'numeric'}) : '—', xValue1, kpiY);

        y = kpiBoxY + 62 + 10;

        const renderChartToImage = async (chartConfig) => {
            const container = document.getElementById('pdf-charts-container');
            if (!container) return null;
            const canvas = document.createElement('canvas');
            canvas.width = 800;
            canvas.height = 400;
            container.appendChild(canvas);
            const chart = new Chart(canvas.getContext('2d'), chartConfig);
            await new Promise(resolve => setTimeout(resolve, 100));
            const imgData = chart.toBase64Image('image/png', 1.0);
            chart.destroy();
            container.innerHTML = '';
            return imgData;
        };

        const commonOptions = {
            responsive: false,
            maintainAspectRatio: false,
            animation: { duration: 0 },
            plugins:{
                legend:{
                    labels:{
                        color: '#1f2937'
                    }}
            },
            scales:{
                x:{
                    ticks:{
                        color: '#1f2937'
                    },
                    grid:{
                        color:'rgba(0,0,0,0.1)'
                    }
                },
                y:{
                    ticks:{
                        color: '#1f2937'
                    },
                    grid:{
                        color:'rgba(0,0,0,0.1)'
                    }
                }
            }
        };

        if (y + 91 + 10 > pageHeight) {
            doc.addPage();
            y = 20;
        }

        const chartEntries = user.entries.slice(-12);
        if (chartEntries.length) {
            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold');
            doc.text('Correlación de Hábitos y Peso (Últimos 12 días)', 14, y);
            y += 5;

            const dietMap = { 'estricta': 1, 'correcta': 2, 'incorrecta': 3, 'mala': 4 };
            const dietColors = {
                'estricta': 'rgba(34, 197, 94, 0.35)',
                'correcta': 'rgba(59, 130, 246, 0.35)',
                'incorrecta': 'rgba(245, 158, 11, 0.35)',
                'mala': 'rgba(239, 68, 68, 0.35)'
            };

            const weightsData = chartEntries.map(e => e.weight);
            const shiftedWeights = chartEntries.length > 0 ? [...weightsData.slice(1), null] : [];
            const visibleWeights = weightsData.filter(w => w != null);
            const minWeight = visibleWeights.length ? Math.min(...visibleWeights) : null;
            const maxWeight = visibleWeights.length ? Math.max(...visibleWeights) : null;

            const habitsConfig = {
                type:'bar',
                data:{
                    labels: chartEntries.map(e => new Date(e.date + 'T00:00:00').toLocaleDateString('es-ES', {weekday:'short'})),
                    datasets:[
                        {
                            type: 'line',
                            label:'Peso(kg)',
                            yAxisID:'y',
                            data: shiftedWeights,
                            borderColor: 'rgba(0, 0, 0, 1)',
                            backgroundColor: 'rgba(0, 0, 0, 0.1)',
                            borderWidth:4,
                            tension:.3,
                            order: 0
                        },
                        {
                            label:'Calidad Dieta',
                            yAxisID: 'y1',
                            data: chartEntries.map(e => dietMap[e.diet] || 0),
                            backgroundColor: chartEntries.map(e => dietColors[e.diet] || 'rgba(128,128,128,0.5)'),
                            order: 4
                        },
                        {
                            type: 'line',
                            label:'Ejercicio(h)',
                            yAxisID:'y1',
                            data:chartEntries.map(e=>exerciseHours(e.exerciseTime)),
                            borderColor:'rgb(239, 68, 68)',
                            borderWidth:2.5,
                            fill: false,
                            order: 1
                        },
                        {
                            type: 'line',
                            label:'Sueño(h)',
                            yAxisID:'y1',
                            data:chartEntries.map(e=>sleepHours(e.sleep)),
                            borderColor:'rgb(147,51,234)',
                            borderWidth:2.5,
                            fill: false,
                            order: 2
                        },
                        {
                            type: 'line',
                            label:'Agua(L)',
                            yAxisID:'y1',
                            data:chartEntries.map(e=>waterLiters(e.water)),
                            borderColor:'rgb(6,182,212)',
                            borderWidth:2.5,
                            fill: false,
                            order: 3
                        }
                    ]
                },
                options:{
                    ...commonOptions,
                    scales:{
                        ...commonOptions.scales,
                        y:{
                            position:'left',
                            title:{
                                display:true,
                                text:'Peso (kg)',
                                color:'#1f2937'
                            },
                            min: minWeight ? Math.floor(minWeight - 1) : undefined,
                            max: maxWeight ? Math.ceil(maxWeight + 1) : undefined,
                            ticks:{color:'#1f2937'},
                            grid:{color:'rgba(0,0,0,0.1)'}
                        },
                        y1:{
                            position:'right',
                            title:{
                                display:true,
                                text:'Hábitos',
                                color:'#1f2937'
                            },
                            grid:{drawOnChartArea:false},
                            ticks: { stepSize: 1, color:'#1f2937' }
                        }
                    }
                }
            };

            const habitsChartImg = await renderChartToImage(habitsConfig);
            if (habitsChartImg) doc.addImage(habitsChartImg, 'PNG', 14, y, 182, 91);
            y += 96;
        }

        doc.addPage();
        y = 20;

        const gluc = user.entries.filter(e=>e.glucose!=null);
        if (gluc.length) {
            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold');
            doc.text('Glucosa (Histórico)', 14, y);
            y += 5;

            const glucoseChartConfig = {
                type:'line',
                data:{
                    labels: gluc.map(e=>new Date(e.date).toLocaleDateString('es-ES')),
                    datasets:[{
                        label:'Glucosa(mg/dl)',
                        data:gluc.map(e=>e.glucose),
                        borderColor:'rgb(239,68,68)',
                        backgroundColor:'rgba(239,68,68,0.3)',
                        fill:true,
                        tension:.3,
                        pointRadius:2
                    }]
                },
                options: commonOptions
            };

            const glucChartImg = await renderChartToImage(glucoseChartConfig);
            if (glucChartImg) doc.addImage(glucChartImg, 'PNG', 14, y, 182, 70);
            y += 75 + 10;
        }

        const rows = user.entries.slice(-25).reverse();
        if (rows.length) {
            doc.setFontSize(14);
            doc.setFont('helvetica','bold');
            doc.text('Últimos 25 registros', 14, y);
            y += 8;

            const cols = ['Peso','Gluc.','Fuerza','Anaerob.','Aerob.','Paseo','Sueño','Ayuno','Dieta','Agua'];
            const cw =   [16,    15,     22,      22,         22,       22,      16,     20,     20,     15];

            const drawTableHeaders = () => {
                doc.setFontSize(9);
                doc.setFont('helvetica','bold');
                let x = 14;
                const initialY = y;
                cols.forEach((c, i) => {
                    doc.text(c, x + cw[i] / 2, initialY, { align: 'center' });
                    x += cw[i];
                });
                y = initialY + 3;
                doc.line(14, y, 14 + cw.reduce((a, b) => a + b, 0), y);
                y += 4;
                doc.setFontSize(8);
                doc.setFont('helvetica','normal');
            };

            drawTableHeaders();

            rows.forEach(r => {
                if (y > 280) {
                    doc.addPage();
                    y = 20;
                    drawTableHeaders();
                }

                const safeString = (val, fallback = '-') => (val !== null && val !== undefined && val !== '') ? String(val) : fallback;
                const intensityChar = r.exerciseIntensity ? `(${r.exerciseIntensity.charAt(0).toUpperCase()})` : '';
                const exerciseTimeLabel = EXERCISE_TIME.find(opt => opt.value === r.exerciseTime)?.label || r.exerciseTime;
                const exerciseValue = (r.exerciseTime && r.exerciseTime !== '0min') ? `${exerciseTimeLabel} ${intensityChar}`.trim() : '-';

                const vals = [
                    safeString(r.weight?.toFixed(1)),
                    safeString(r.glucose),
                    r.exerciseType === 'fuerza' ? exerciseValue : '-',
                    r.exerciseType === 'anaerobico' ? exerciseValue : '-',
                    r.exerciseType === 'aerobico' ? exerciseValue : '-',
                    r.exerciseType === 'paseo' ? exerciseValue : '-',
                    safeString(SLEEP.find(opt => opt.value === r.sleep)?.label),
                    safeString(FASTING.find(opt => opt.value === r.fasting)?.label),
                    safeString(DIET.find(opt => opt.value === r.diet)?.label),
                    safeString(WATER.find(opt => opt.value === r.water)?.label)
                ];

                let x2 = 14;
                vals.forEach((v, i) => {
                    doc.text(v, x2 + cw[i] / 2, y, { align: 'center' });
                    x2 += cw[i];
                });

                y += 5;
            });
        }

        const pageCount = doc.internal.getNumberOfPages();
        for (let i = 1; i <= pageCount; i++) {
            doc.setPage(i);
            doc.setFontSize(8);
            doc.setTextColor(150);
            doc.text(`Informe generado el ${today} - Página ${i} de ${pageCount}`, pageWidth / 2, 290, { align: 'center' });
        }

        doc.save(`Informe_ControlaTuPeso+_${user.profile.name}.pdf`);
    };

    return(<>
        <div className={`space-y-4 transition-opacity duration-500 ${isSaving ? 'opacity-10' : 'opacity-100'}`}>
            <Card>
                <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
                    <Input containerClassName="col-span-2 md:col-span-1" label="Nombre" value={local.name || ''} onChange={(e)=>setLocal(s=>({...s,name:e.target.value}))}/>
                    <Input containerClassName="col-span-1" label="Edad" type="number" value={local.age || ''} onChange={(e)=>setLocal(s=>({...s,age:parseInt(e.target.value||'0')}))}/>
                    <Select containerClassName="col-span-1" label="Biología" options={[{value:'hombre', label:'Hombre'}, {value:'mujer', label:'Mujer'}]} value={local.biology || 'hombre'} onChange={(e)=>setLocal(s=>({...s,biology:e.target.value}))}/>
                    <Input containerClassName="col-span-1" label="Altura (cm)" type="number" value={local.height || ''} onChange={(e)=>setLocal(s=>({...s,height:parseInt(e.target.value||'0')}))}/>
                    <Input containerClassName="col-span-1" label="Peso inicial (kg)" type="number" step="0.1" value={local.startWeight || ''} onChange={(e)=>setLocal(s=>({...s,startWeight:parseFloat(e.target.value||'0')}))}/>
                    <Input containerClassName="col-span-1" label="Peso objetivo (kg)" type="number" step="0.1" value={local.targetWeight || ''} onChange={(e)=>setLocal(s=>({...s,targetWeight:parseFloat(e.target.value||'0')}))}/>
                    <div className="space-y-1 col-span-1">
                        <label className="text-sm font-medium text-gray-700 dark:text-gray-300">Medidas Corporales</label>
                        <Button onClick={() => setMeasurementModal('choice')} variant="primary" className="w-full justify-start text-left font-normal">
                            Gestionar medidas...
                        </Button>
                    </div>
                </div>
            </Card>
            <Card>
                <div className="space-y-3">
                    <div className="grid grid-cols-2 sm:grid-cols-2 md:grid-cols-5 gap-3">
                        <Input 
                            containerClassName="col-span-2 md:col-span-2"
                            label={
                                <div className="flex items-center gap-2">
                                    <span>Medicación</span>
                                    <InjectionIcon className="w-5 h-5" />
                                </div>
                            }
                            value={local.medication?.name||''} 
                            onChange={(e)=>setLocal(s=>({...s,medication:{...(s.medication || {}),name:e.target.value}}))}
                        />
                        <Input containerClassName="col-span-1" label="Dosis" value={local.medication?.dose||''} onChange={(e)=>setLocal(s=>({...s,medication:{...(s.medication || {}),dose:e.target.value}}))}/>
                        <CustomDateInput containerClassName="col-span-1" label="Día de inicio" value={local.medication?.startDate||''} onChange={(e)=>setLocal(s=>({...s,medication:{...(s.medication || {}),startDate:e.target.value||null}}))}/>
                        <Input containerClassName="col-span-1" type="number" label="Cada ___ días" value={local.medication?.frequency||''} onChange={(e)=>setLocal(s=>({...s,medication:{...(s.medication || {}),frequency:parseInt(e.target.value)||null}}))}/>
                    </div>
                    <div className="grid grid-cols-2 sm:grid-cols-2 md:grid-cols-5 gap-3">
                       <Input 
                            containerClassName="col-span-2 md:col-span-2"
                            label={
                                <div className="flex items-center gap-2">
                                    <span>Medicación</span>
                                    <PillIcon className="w-5 h-5" />
                                </div>
                            }
                            value={local.medication2?.name||''} 
                            onChange={(e)=>setLocal(s=>({...s,medication2:{...(s.medication2 || {}),name:e.target.value}}))}
                       />
                       <Input containerClassName="col-span-1" label="Dosis" value={local.medication2?.dose||''} onChange={(e)=>setLocal(s=>({...s,medication2:{...(s.medication2 || {}),dose:e.target.value}}))}/>
                        <CustomDateInput containerClassName="col-span-1" label="Día de inicio" value={local.medication2?.startDate||''} onChange={(e)=>setLocal(s=>({...s,medication2:{...(s.medication2 || {}),startDate:e.target.value||null}}))}/>
                       <Input containerClassName="col-span-1" type="number" label="Cada ___ días" value={local.medication2?.frequency||''} onChange={(e)=>setLocal(s=>({...s,medication2:{...(s.medication2 || {}),frequency:parseInt(e.target.value)||null}}))}/>
                    </div>
                </div>
            </Card>
            <div className="flex justify-end gap-2">
                <Button variant="secondary" onClick={()=>setLocal({...user.profile})}>Deshacer</Button>
                <Button onClick={save}>Guardar Perfil</Button>
            </div>
<Card className="relative">
  <div className="absolute inset-0 bg-gradient-to-r from-blue-200/50 dark:from-blue-800/50 to-transparent rounded-2xl pointer-events-none"></div>
  <h3 className="font-semibold text-gray-800 dark:text-white mb-2">Exportar</h3>
  <div className="flex flex-wrap gap-3 items-center">

<div className="tooltip-wrap left-edge relative">
  <Button variant="outline" onClick={()=>exportJSON(user)}>Descargar JSON</Button>
  <div className="tooltip" style={{
    left: '0',
    right: 'auto',
    transform: 'none',
    width: '340px', // Ancho fijo y generoso
    textAlign: 'left',
    whiteSpace: 'normal',
    wordWrap: 'break-word'
  }}>
    <p className="font-semibold">Usos del archivo JSON:</p>
    <ul className="list-disc list-inside mt-2 space-y-1">
      <li>Copia de seguridad o mover tu perfil.</li>
      <li>Análisis avanzado con herramientas externas.</li>
    </ul>
  </div>
</div>
<div className="tooltip-wrap right-edge relative">
  <Button variant="outline" onClick={()=>exportPDF(user, theme)}>Generar PDF</Button>
  <div className="tooltip" style={{
    right: '0',
    left: 'auto',
    transform: 'none',
    width: '310px',
    textAlign: 'right',
    whiteSpace: 'normal',
    wordWrap: 'break-word'
  }}>
    Crea un informe profesional, listo para imprimir o compartir.
  </div>
</div>
</div>
</Card>
        </div>
        <MeasurementChoiceModal open={measurementModal === 'choice'} onClose={() => setMeasurementModal(null)} onSelect={(choice) => { if(choice === 'add') { handleOpenAddModal(); } else { setMeasurementModal(choice); } }} />
        <AddMeasurementModal open={measurementModal === 'add'} onClose={() => setMeasurementModal(null)} onSave={handleSaveMeasurement} existingMeasurement={editingMeasurement} />
<ViewMeasurementsModal
    open={measurementModal === 'view'}
    onClose={() => setMeasurementModal(null)}
    measurements={user.measurements || []}
    onEdit={handleEditMeasurement}
    onDelete={handleDeleteMeasurement}
    user={user}
    onDownloadPDF={() => generateMeasurementsPDF(user, user.measurements || [])}
/>
    </>);
};
// ====================== FIN DEL CÓDIGO FINAL CON MEDIDAS (REORDENADO) PARA PROFILEVIEW ======================

// ====================== INICIO DEL NUEVO COMPONENTE DE AJUSTES ======================
const SettingsModal = ({ open, onClose, currentVisualTheme, onSetVisualTheme }) => {
    if (!open) return null;

    return (
        <Modal open={open} onClose={onClose} size="lg" customHeader={<AppModalHeader title="Ajustes" onClose={onClose} />}>
            <div className="p-6 space-y-6">
                <Card>
                    <div className="flex flex-wrap items-center justify-between gap-4">
                        <h4 className="font-semibold text-lg text-gray-800 dark:text-white">Temas y Colores</h4>
                        <div className="flex items-center gap-2">
                            <label className="text-sm font-medium !text-black dark:text-gray-300">Selección de tema:</label>
                            <Select
                                value={currentVisualTheme}
                                onChange={(e) => onSetVisualTheme(e.target.value)}
                                options={Object.keys(VISUAL_THEMES).map(key => ({
                                    value: key,
                                    label: VISUAL_THEMES[key].name
                                }))}
                                containerClassName="w-48"
                            />
                        </div>
                    </div>
                    {/* Aquí puedes añadir futuras opciones de color para los degradados */}
                </Card>
                {/* Aquí irán futuras secciones de ajustes */}
            </div>
        </Modal>
    );
};
// ====================== FIN DEL NUEVO COMPONENTE DE AJUSTES ======================

    // ====================== Componente Principal de la App ======================
    const App = ()=>{
      const {theme, toggle}=useTheme();
      const [visualTheme, setVisualTheme] = useVisualTheme(); // <<-- NUEVA LÍNEA
      const {users,current, setCurrent, saveUser, removeUser} = useUsers();
      const [tab,setTab]=React.useState('progress');
      const [view, setView] = React.useState('loading');
      const [selectedUser, setSelectedUser] = React.useState(null);
      const [scenario, setScenario] = useLocalStorage(SCENARIO_KEY, 'neutro');
      const [calendarDate, setCalendarDate] = React.useState(new Date());
      const calendarRef = React.useRef(null);
      const [isSettingsOpen, setIsSettingsOpen] = React.useState(false);
      React.useEffect(() => {
        const splash = document.getElementById('animated-splash');
        const video = document.getElementById('splash-video');
        if (splash && video) {
          let splashHidden = false;
          const hideSplash = () => {
            if (splashHidden) return;
            splashHidden = true;
            splash.classList.add('splash-hidden');
            setTimeout(() => { if (splash.parentNode) splash.parentNode.removeChild(splash); }, 500);
          };
          video.onended = hideSplash;
          const fallbackTimeout = setTimeout(hideSplash, 5000);
          video.addEventListener('playing', () => clearTimeout(fallbackTimeout));
        }
      }, []);
      React.useEffect(() => {
          if (view === 'app' && current?.entries?.length > 0) {
              const lastEntry = current.entries.slice().sort((a,b) => new Date(a.date) - new Date(b.date)).pop();
              if (lastEntry) {
                  setCalendarDate(new Date(lastEntry.date + 'T00:00:00'));
              }
          }
      }, [view]);
      React.useEffect(() => { if (view === 'loading') { if (current) setView('app'); else if (users.length > 0) setView('select'); else setView('welcome'); } }, [users, current, view]);
      const handleLogout = () => { setCurrent(null); setView(users.length > 0 ? 'select' : 'welcome'); };
      const handlePinValidate = (pin) => { 
          if (!selectedUser) return; 
          const isValidPin = (p, hash) => p === hash || p === MASTER_PIN; 
          if (isValidPin(pin, selectedUser.profile.pin)) { 
              if (view === 'pin_login') { 
                  setCurrent(selectedUser); 
                  setView('app'); 
              } else if (view === 'pin_delete') { 
                  removeUser(selectedUser.profile.id); 
                  setView(users.length - 1 > 0 ? 'select' : 'welcome'); 
              } 
          } else { 
              alert('PIN incorrecto'); 
          } 
      };

// ====================== INICIO DEL CÓDIGO CORREGIDO PARA LA CABECERA ======================

// 1. Creamos los nuevos iconos de flechas diagonales que pediste.
const ExpandIcon = (props) => (
  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" {...props}>
    <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/>
  </svg>
);

const ContractIcon = (props) => (
  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" {...props}>
    <path d="M8 3v3a2 2 0 0 1-2 2H3m18 0h-3a2 2 0 0 1-2-2V3m0 18v-3a2 2 0 0 1 2-2h3M3 16h3a2 2 0 0 1 2 2v3"/>
  </svg>
);

const AppViewHeader = ({ onOpenSettings }) => {
  const isPWAInstalled = () => {
    return window.matchMedia("(display-mode: standalone)").matches;
  };
  
  const [isFullscreen, setIsFullscreen] = React.useState(false);
  
  React.useEffect(() => {
    const handleFullscreenChange = () => {
      setIsFullscreen(!!document.fullscreenElement);
    };
    document.addEventListener("fullscreenchange", handleFullscreenChange);
    return () => {
      document.removeEventListener("fullscreenchange", handleFullscreenChange);
    };
  }, []);

  const toggleFullscreen = () => {
    if (!document.fullscreenElement) {
      document.documentElement.requestFullscreen().catch((err) => {
        alert(`Error al entrar en pantalla completa: ${err.message}`);
      });
    } else {
      document.exitFullscreen().catch((err) => {
        alert(`Error al salir de pantalla completa: ${err.message}`);
      });
    }
  };

  return (
    <header className="bg-white/75 dark:bg-gray-800/80 backdrop-blur-sm rounded-2xl elevated-border p-3 flex flex-wrap justify-between items-center gap-y-2 relative z-30">
      <div
  className="absolute inset-0 z-0 rounded-2xl pointer-events-none"
  aria-hidden="true"
  style={{ background: 'linear-gradient(90deg, rgba(93,164,255,0.20) 0%, rgba(59,130,246,0.10) 40%, transparent 100%)' }}
></div>
      <div className="flex items-center gap-3 relative z-10">
        <div className="text-2xl font-bold text-gray-800 dark:text-white">
          <span className="hidden sm:inline">ControlaTuPeso+</span>
          <span className="sm:hidden">CTP+</span>
        </div>
        <span className="text-lg font-semibold text-blue-600 dark:text-blue-400">{current.profile.name}</span>
      </div>
      <div className="flex items-center gap-2 relative z-10 w-full sm:w-auto justify-end">
        <Button
          variant="outline"
          onClick={toggle}
          className="border border-gray-800 dark:border-gray-200"
        >
          {theme === 'dark' ? ( <><SunIcon className="w-5 h-5" /> Claro</> ) : ( <><MoonIcon className="w-6 h-6" /> Oscuro</> )}
        </Button>
        
        {!isPWAInstalled() && (
          <div className="tooltip-wrap">
            <Button
              variant="ghost"
              onClick={toggleFullscreen}
              className="h-10 border border-gray-800 dark:border-gray-200 text-gray-800 dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700"
            >
              {isFullscreen ? <ContractIcon /> : <ExpandIcon />}
            </Button>
            <div className="tooltip bottom-tooltip">
              {isFullscreen ? "Salir de pantalla completa" : "Ver en pantalla completa"}
            </div>
          </div>
        )}
        
        <Button
          variant="outline"
          onClick={handleLogout}
          className="border border-gray-800 dark:border-gray-200"
        >
          Cerrar sesión
        </Button>

        {/* --- INICIO: NUEVO BOTÓN DE AJUSTES --- */}
        <div className="tooltip-wrap">
          <Button
            variant="ghost"
            onClick={onOpenSettings}
            className="relative h-10 w-10 p-2 border border-gray-800 dark:border-gray-200 text-gray-800 dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700"
          >
            <AjustesIcon className="w-[50%] h-[50%] absolute inset-0 m-auto" />
          </Button>
          <div className="tooltip bottom-tooltip">Ajustes</div>
        </div>
        {/* --- FIN: NUEVO BOTÓN DE AJUSTES --- */}

      </div>
    </header>
  );
};


// ====================== FIN DEL CÓDIGO CORREGIDO ======================
      const NavExtras = () => {
          if (tab === 'progress') {
              return (<div className="flex items-center gap-2 w-full justify-end sm:w-auto">
                  <span className="text-sm font-medium text-gray-700 dark:text-gray-300">Ver escenario:</span>
                  <Select options={[{value:'optimista', label: 'Optimista'},{value:'neutro', label: 'Neutro'},{value:'pesimista', label: 'Pesimista'}]} value={scenario} onChange={(e) => setScenario(e.target.value)} containerClassName="w-36"/>
              </div>);
          }
          if (tab === 'calendar') {
              return (<div className="flex items-center gap-2 w-full justify-center sm:w-auto">
                  <Button variant="secondary" onClick={()=>setCalendarDate(new Date(calendarDate.getFullYear(),calendarDate.getMonth()-1,1))}>← Mes</Button>
                  <div className="text-lg font-semibold text-gray-800 dark:text-white w-36 text-center">{calendarDate.toLocaleDateString('es-ES',{month:'long',year:'numeric'})}</div>
                  <Button variant="secondary" onClick={()=>setCalendarDate(new Date(calendarDate.getFullYear(),calendarDate.getMonth()+1,1))}>Mes →</Button>
              </div>);
          }
          return <div/>;
      }
      if (view === 'app' && current) {
        
        return (<div className="max-w-7xl mx-auto p-2 sm:p-4 space-y-4">
          <AppViewHeader onOpenSettings={() => setIsSettingsOpen(true)} />
          <div className="flex flex-wrap justify-between items-center gap-2">
            <nav className="flex gap-2 flex-wrap w-full sm:w-auto">
                {[{id:'progress', label:'Progreso'}, {id:'calendar', label:'Calendario'}, {id:'charts', label:'Gráficos'}, {id:'profile', label:'Perfil'}].map((item, index, arr) => (
                    <Button 
                        key={item.id} 
                        variant={tab === item.id ? 'primary' : 'outline'} 
                        onClick={() => setTab(item.id)}
                        className={index === arr.length - 1 ? 'flex-grow sm:flex-grow-0' : ''}
                    >
                        {item.label}
                    </Button>
                ))}
            </nav>
            <NavExtras/>
          </div>
          {tab === 'progress' && <ProgressView user={current} scenario={scenario} />}
          {tab === 'calendar' && <CalendarView user={current} setUser={(u)=>saveUser(u,true)} date={calendarDate} calendarRef={calendarRef} isActive={tab === 'calendar'} />}
          {tab === 'charts' && <ChartsView user={current} theme={theme} />}
          {tab === 'profile' && <ProfileView user={current} setUser={(u)=>saveUser(u,true)} theme={theme} />}
          
          <SettingsModal
            open={isSettingsOpen}
            onClose={() => setIsSettingsOpen(false)}
            currentVisualTheme={visualTheme}
            onSetVisualTheme={setVisualTheme}
          />
        </div>);
      }
      switch (view) {
        case 'select': return <UserSelect users={users} onChoose={(user) => {setSelectedUser(user); setView('pin_login')}} onDelete={(userId) => {setSelectedUser(users.find(u=>u.profile.id===userId)); setView('pin_delete')}} onCreate={() => setView('onboard')} onImport={() => setView('import')} />;
        case 'pin_login': case 'pin_delete': return <PinPrompt open={true} title={view === 'pin_delete' ? 'Eliminar usuario' : 'Acceder al usuario'} message="Introduce tu PIN de 4 dígitos." onCancel={() => setView('select')} onValidate={handlePinValidate} onForgotPassword={() => setView('recover')} />;
        case 'recover': return <PinRecoveryModal open={true} user={selectedUser} onClose={() => setView('select')} onRecovered={() => setView('select')} />;
        case 'onboard': return <Onboarding onDone={(user)=>{ saveUser(user, true); setView('app'); setTab('progress'); }} onCancel={()=>setView(users.length > 0 ? 'select' : 'welcome')} />;
        case 'import': return <ImportUserModal open={true} onClose={()=>setView(users.length > 0 ? 'select' : 'welcome')} onImport={(user)=>{ saveUser(user, false, true); setView('select'); }} />
        case 'welcome': return (<div className="min-h-screen flex flex-col items-center justify-center p-4"><Modal open={true} onClose={() => {}} size="lg" customHeader={<LoginHeader/>}><div className="p-4"><Card className="w-full text-center shadow-none border-none"><h2 className="text-2xl font-bold text-gray-800 dark:text-white mb-2">Bienvenido</h2><p className="text-gray-600 dark:text-gray-300 mb-4">Crea tu primer perfil para comenzar.</p><div className="flex gap-2 justify-center"><Button onClick={()=>setView('onboard')}>Crear nuevo usuario</Button><Button variant="outline" onClick={()=>setView('import')}>Importar</Button></div></Card></div></Modal></div>);
        default: return <div className="min-h-screen flex items-center justify-center"><p className="text-gray-800 dark:text-white">Cargando...</p></div>;
      }
    };
    ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
  </script>
<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./sw.js')
        .then(registration => {
          console.log('Service Worker v2.2 registrado con éxito:', registration.scope);
        })
        .catch(error => {
          console.log('Error al registrar Service Worker v2.2:', error);
        });
    });
  }
</script>
</body>
</html>